var v9=Object.defineProperty;var df=n=>{throw TypeError(n)};var S9=(n,t,e)=>t in n?v9(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var u=(n,t,e)=>S9(n,typeof t!="symbol"?t+"":t,e),gu=(n,t,e)=>t.has(n)||df("Cannot "+e);var F=(n,t,e)=>(gu(n,t,"read from private field"),e?e.call(n):t.get(n)),fe=(n,t,e)=>t.has(n)?df("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),Be=(n,t,e,r)=>(gu(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),re=(n,t,e)=>(gu(n,t,"access private method"),e);var jn=(n,t,e,r)=>({set _(s){Be(n,t,s,e)},get _(){return F(n,t,r)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();function Vn(){}function u4(n){return n()}function ff(){return Object.create(null)}function po(n){n.forEach(u4)}function h4(n){return typeof n=="function"}function d4(n,t){return n!=n?t==t:n!==t||n&&typeof n=="object"||typeof n=="function"}function R9(n){return Object.keys(n).length===0}function ge(n,t){n.appendChild(t)}function qe(n,t,e){n.insertBefore(t,e||null)}function Ve(n){n.parentNode&&n.parentNode.removeChild(n)}function me(n){return document.createElement(n)}function cr(n){return document.createTextNode(n)}function wt(){return cr(" ")}function Bo(n,t,e,r){return n.addEventListener(t,e,r),()=>n.removeEventListener(t,e,r)}function ze(n,t,e){e==null?n.removeAttribute(t):n.getAttribute(t)!==e&&n.setAttribute(t,e)}function A9(n){return Array.from(n.childNodes)}function bs(n,t){t=""+t,n.data!==t&&(n.data=t)}function I9(n,t,{bubbles:e=!1,cancelable:r=!1}={}){return new CustomEvent(n,{detail:t,bubbles:e,cancelable:r})}let na;function zo(n){na=n}function k9(){if(!na)throw new Error("Function called outside component initialization");return na}function x9(){const n=k9();return(t,e,{cancelable:r=!1}={})=>{const s=n.$$.callbacks[t];if(s){const i=I9(t,e,{cancelable:r});return s.slice().forEach(o=>{o.call(n,i)}),!i.defaultPrevented}return!0}}const ii=[],gf=[];let mi=[];const pf=[],T9=Promise.resolve();let ju=!1;function D9(){ju||(ju=!0,T9.then(f4))}function Ju(n){mi.push(n)}const pu=new Set;let ti=0;function f4(){if(ti!==0)return;const n=na;do{try{for(;ti<ii.length;){const t=ii[ti];ti++,zo(t),C9(t.$$)}}catch(t){throw ii.length=0,ti=0,t}for(zo(null),ii.length=0,ti=0;gf.length;)gf.pop()();for(let t=0;t<mi.length;t+=1){const e=mi[t];pu.has(e)||(pu.add(e),e())}mi.length=0}while(ii.length);for(;pf.length;)pf.pop()();ju=!1,pu.clear(),zo(n)}function C9(n){if(n.fragment!==null){n.update(),po(n.before_update);const t=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,t),n.after_update.forEach(Ju)}}function N9(n){const t=[],e=[];mi.forEach(r=>n.indexOf(r)===-1?t.push(r):e.push(r)),e.forEach(r=>r()),mi=t}const Ec=new Set;let As;function g4(){As={r:0,c:[],p:As}}function p4(){As.r||po(As.c),As=As.p}function Ps(n,t){n&&n.i&&(Ec.delete(n),n.i(t))}function Li(n,t,e,r){if(n&&n.o){if(Ec.has(n))return;Ec.add(n),As.c.push(()=>{Ec.delete(n),r&&(e&&n.d(1),r())}),n.o(t)}else r&&r()}function y4(n){n&&n.c()}function Eh(n,t,e){const{fragment:r,after_update:s}=n.$$;r&&r.m(t,e),Ju(()=>{const i=n.$$.on_mount.map(u4).filter(h4);n.$$.on_destroy?n.$$.on_destroy.push(...i):po(i),n.$$.on_mount=[]}),s.forEach(Ju)}function _h(n,t){const e=n.$$;e.fragment!==null&&(N9(e.after_update),po(e.on_destroy),e.fragment&&e.fragment.d(t),e.on_destroy=e.fragment=null,e.ctx=[])}function L9(n,t){n.$$.dirty[0]===-1&&(ii.push(n),D9(),n.$$.dirty.fill(0)),n.$$.dirty[t/31|0]|=1<<t%31}function m4(n,t,e,r,s,i,o=null,a=[-1]){const c=na;zo(n);const l=n.$$={fragment:null,ctx:[],props:i,update:Vn,not_equal:s,bound:ff(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(c?c.$$.context:[])),callbacks:ff(),dirty:a,skip_bound:!1,root:t.target||c.$$.root};o&&o(l.root);let h=!1;if(l.ctx=e?e(n,t.props||{},(d,f,...p)=>{const m=p.length?p[0]:f;return l.ctx&&s(l.ctx[d],l.ctx[d]=m)&&(!l.skip_bound&&l.bound[d]&&l.bound[d](m),h&&L9(n,d)),f}):[],l.update(),h=!0,po(l.before_update),l.fragment=r?r(l.ctx):!1,t.target){if(t.hydrate){const d=A9(t.target);l.fragment&&l.fragment.l(d),d.forEach(Ve)}else l.fragment&&l.fragment.c();t.intro&&Ps(n.$$.fragment),Eh(n,t.target,t.anchor),f4()}zo(c)}class w4{constructor(){u(this,"$$");u(this,"$$set")}$destroy(){_h(this,1),this.$destroy=Vn}$on(t,e){if(!h4(e))return Vn;const r=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return r.push(e),()=>{const s=r.indexOf(e);s!==-1&&r.splice(s,1)}}$set(t){this.$$set&&!R9(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const P9="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(P9);function O9(n){let t,e,r,s,i;return{c(){t=me("div"),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon svelte-1d9h757" aria-hidden="true" focusable="false" fill="currentColor"><path d="M246.6 9.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 109.3 192 320c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 73.4 73.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-128-128zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-64z"></path></svg>',e=wt(),r=me("input"),ze(t,"id","drop-zone"),ze(t,"class","svelte-1d9h757"),ze(r,"id","file-input"),ze(r,"type","file"),ze(r,"class","svelte-1d9h757")},m(o,a){qe(o,t,a),qe(o,e,a),qe(o,r,a),s||(i=[Bo(t,"click",B9),Bo(t,"drop",n[0]),Bo(t,"dragover",M9),Bo(r,"change",n[1])],s=!0)},p:Vn,i:Vn,o:Vn,d(o){o&&(Ve(t),Ve(e),Ve(r)),s=!1,po(i)}}}function B9(){document.getElementById("file-input").click()}function M9(n){n.preventDefault()}function U9(n){const t=x9();function e(i){i.preventDefault(),i.dataTransfer.items.length===1&&s(i.dataTransfer.items[0].getAsFile())}function r(i){i.target.files.length===1&&s(i.target.files[0])}function s(i){t("fileUpload",{file:i})}return[e,r]}class b4 extends w4{constructor(t){super(),m4(this,t,U9,O9,d4,{})}}const $9=["string","number","bigint","symbol"],F9=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function V9(n){if(n===null)return"null";if(n===void 0)return"undefined";if(n===!0||n===!1)return"boolean";const t=typeof n;if($9.includes(t))return t;if(t==="function")return"Function";if(Array.isArray(n))return"Array";if(H9(n))return"Buffer";const e=K9(n);return e||"Object"}function H9(n){return n&&n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer.call(null,n)}function K9(n){const t=Object.prototype.toString.call(n).slice(8,-1);if(F9.includes(t))return t}class x{constructor(t,e,r){this.major=t,this.majorEncoded=t<<5,this.name=e,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(t){return this.major<t.major?-1:this.major>t.major?1:0}}x.uint=new x(0,"uint",!0);x.negint=new x(1,"negint",!0);x.bytes=new x(2,"bytes",!0);x.string=new x(3,"string",!0);x.array=new x(4,"array",!1);x.map=new x(5,"map",!1);x.tag=new x(6,"tag",!1);x.float=new x(7,"float",!0);x.false=new x(7,"false",!0);x.true=new x(7,"true",!0);x.null=new x(7,"null",!0);x.undefined=new x(7,"undefined",!0);x.break=new x(7,"break",!0);class K{constructor(t,e,r){this.type=t,this.value=e,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const yo=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",z9=new TextDecoder,q9=new TextEncoder;function Oc(n){return yo&&globalThis.Buffer.isBuffer(n)}function vh(n){return n instanceof Uint8Array?Oc(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n:Uint8Array.from(n)}const W9=yo?(n,t,e)=>e-t>64?globalThis.Buffer.from(n.subarray(t,e)).toString("utf8"):mf(n,t,e):(n,t,e)=>e-t>64?z9.decode(n.subarray(t,e)):mf(n,t,e),E4=yo?n=>n.length>64?globalThis.Buffer.from(n):yf(n):n=>n.length>64?q9.encode(n):yf(n),Jn=n=>Uint8Array.from(n),Sh=yo?(n,t,e)=>Oc(n)?new Uint8Array(n.subarray(t,e)):n.slice(t,e):(n,t,e)=>n.slice(t,e),G9=yo?(n,t)=>(n=n.map(e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e)),vh(globalThis.Buffer.concat(n,t))):(n,t)=>{const e=new Uint8Array(t);let r=0;for(let s of n)r+s.length>e.length&&(s=s.subarray(0,e.length-r)),e.set(s,r),r+=s.length;return e},Y9=yo?n=>globalThis.Buffer.allocUnsafe(n):n=>new Uint8Array(n);function Q9(n,t){if(Oc(n)&&Oc(t))return n.compare(t);for(let e=0;e<n.length;e++)if(n[e]!==t[e])return n[e]<t[e]?-1:1;return 0}function yf(n){const t=[];let e=0;for(let r=0;r<n.length;r++){let s=n.charCodeAt(r);s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&r+1<n.length&&(n.charCodeAt(r+1)&64512)===56320?(s=65536+((s&1023)<<10)+(n.charCodeAt(++r)&1023),t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128)}return t}function mf(n,t,e){const r=[];for(;t<e;){const s=n[t];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(t+o<=e){let a,c,l,h;switch(o){case 1:s<128&&(i=s);break;case 2:a=n[t+1],(a&192)===128&&(h=(s&31)<<6|a&63,h>127&&(i=h));break;case 3:a=n[t+1],c=n[t+2],(a&192)===128&&(c&192)===128&&(h=(s&15)<<12|(a&63)<<6|c&63,h>2047&&(h<55296||h>57343)&&(i=h));break;case 4:a=n[t+1],c=n[t+2],l=n[t+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(h=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,h>65535&&h<1114112&&(i=h))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|i&1023),r.push(i),t+=o}return _4(r)}const wf=4096;function _4(n){const t=n.length;if(t<=wf)return String.fromCharCode.apply(String,n);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,n.slice(r,r+=wf));return e}const X9=256;class v4{constructor(t=X9){this.chunkSize=t,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(t){let e=this.chunks[this.chunks.length-1];if(this.cursor+t.length<=this.maxCursor+1){const s=e.length-(this.maxCursor-this.cursor)-1;e.set(t,s)}else{if(e){const s=e.length-(this.maxCursor-this.cursor)-1;s<e.length&&(this.chunks[this.chunks.length-1]=e.subarray(0,s),this.maxCursor=this.cursor-1)}t.length<64&&t.length<this.chunkSize?(e=Y9(this.chunkSize),this.chunks.push(e),this.maxCursor+=e.length,this._initReuseChunk===null&&(this._initReuseChunk=e),e.set(t,0)):(this.chunks.push(t),this.maxCursor+=t.length)}this.cursor+=t.length}toBytes(t=!1){let e;if(this.chunks.length===1){const r=this.chunks[0];t&&this.cursor>r.length/2?(e=this.cursor===r.length?r:r.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):e=Sh(r,0,this.cursor)}else e=G9(this.chunks,this.cursor);return t&&this.reset(),e}}const J="CBOR decode error:",Bc="CBOR encode error:";function mo(n,t,e){if(n.length-t<e)throw new Error(`${J} not enough data for type`)}const bt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Gs(n,t,e){mo(n,t,1);const r=n[t];if(e.strict===!0&&r<bt[0])throw new Error(`${J} integer encoded in more bytes than necessary (strict decode)`);return r}function Ys(n,t,e){mo(n,t,2);const r=n[t]<<8|n[t+1];if(e.strict===!0&&r<bt[1])throw new Error(`${J} integer encoded in more bytes than necessary (strict decode)`);return r}function Qs(n,t,e){mo(n,t,4);const r=n[t]*16777216+(n[t+1]<<16)+(n[t+2]<<8)+n[t+3];if(e.strict===!0&&r<bt[2])throw new Error(`${J} integer encoded in more bytes than necessary (strict decode)`);return r}function Xs(n,t,e){mo(n,t,8);const r=n[t]*16777216+(n[t+1]<<16)+(n[t+2]<<8)+n[t+3],s=n[t+4]*16777216+(n[t+5]<<16)+(n[t+6]<<8)+n[t+7],i=(BigInt(r)<<BigInt(32))+BigInt(s);if(e.strict===!0&&i<bt[3])throw new Error(`${J} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(e.allowBigInt===!0)return i;throw new Error(`${J} integers outside of the safe integer range are not supported`)}function Z9(n,t,e,r){return new K(x.uint,Gs(n,t+1,r),2)}function j9(n,t,e,r){return new K(x.uint,Ys(n,t+1,r),3)}function J9(n,t,e,r){return new K(x.uint,Qs(n,t+1,r),5)}function ep(n,t,e,r){return new K(x.uint,Xs(n,t+1,r),9)}function Zs(n,t){return fn(n,0,t.value)}function fn(n,t,e){if(e<bt[0]){const r=Number(e);n.push([t|r])}else if(e<bt[1]){const r=Number(e);n.push([t|24,r])}else if(e<bt[2]){const r=Number(e);n.push([t|25,r>>>8,r&255])}else if(e<bt[3]){const r=Number(e);n.push([t|26,r>>>24&255,r>>>16&255,r>>>8&255,r&255])}else{const r=BigInt(e);if(r<bt[4]){const s=[t|27,0,0,0,0,0,0,0];let i=Number(r&BigInt(4294967295)),o=Number(r>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,n.push(s)}else throw new Error(`${J} encountered BigInt larger than allowable range`)}}Zs.encodedSize=function(t){return fn.encodedSize(t.value)};fn.encodedSize=function(t){return t<bt[0]?1:t<bt[1]?2:t<bt[2]?3:t<bt[3]?5:9};Zs.compareTokens=function(t,e){return t.value<e.value?-1:t.value>e.value?1:0};function tp(n,t,e,r){return new K(x.negint,-1-Gs(n,t+1,r),2)}function np(n,t,e,r){return new K(x.negint,-1-Ys(n,t+1,r),3)}function rp(n,t,e,r){return new K(x.negint,-1-Qs(n,t+1,r),5)}const Rh=BigInt(-1),S4=BigInt(1);function sp(n,t,e,r){const s=Xs(n,t+1,r);if(typeof s!="bigint"){const i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new K(x.negint,i,9)}if(r.allowBigInt!==!0)throw new Error(`${J} integers outside of the safe integer range are not supported`);return new K(x.negint,Rh-BigInt(s),9)}function Ah(n,t){const e=t.value,r=typeof e=="bigint"?e*Rh-S4:e*-1-1;fn(n,t.type.majorEncoded,r)}Ah.encodedSize=function(t){const e=t.value,r=typeof e=="bigint"?e*Rh-S4:e*-1-1;return r<bt[0]?1:r<bt[1]?2:r<bt[2]?3:r<bt[3]?5:9};Ah.compareTokens=function(t,e){return t.value<e.value?1:t.value>e.value?-1:0};function Da(n,t,e,r){mo(n,t,e+r);const s=Sh(n,t+e,t+e+r);return new K(x.bytes,s,e+r)}function ip(n,t,e,r){return Da(n,t,1,e)}function op(n,t,e,r){return Da(n,t,2,Gs(n,t+1,r))}function ap(n,t,e,r){return Da(n,t,3,Ys(n,t+1,r))}function cp(n,t,e,r){return Da(n,t,5,Qs(n,t+1,r))}function lp(n,t,e,r){const s=Xs(n,t+1,r);if(typeof s=="bigint")throw new Error(`${J} 64-bit integer bytes lengths not supported`);return Da(n,t,9,s)}function Mc(n){return n.encodedBytes===void 0&&(n.encodedBytes=n.type===x.string?E4(n.value):n.value),n.encodedBytes}function Cl(n,t){const e=Mc(t);fn(n,t.type.majorEncoded,e.length),n.push(e)}Cl.encodedSize=function(t){const e=Mc(t);return fn.encodedSize(e.length)+e.length};Cl.compareTokens=function(t,e){return up(Mc(t),Mc(e))};function up(n,t){return n.length<t.length?-1:n.length>t.length?1:Q9(n,t)}function Ca(n,t,e,r,s){const i=e+r;mo(n,t,i);const o=new K(x.string,W9(n,t+e,t+i),i);return s.retainStringBytes===!0&&(o.byteValue=Sh(n,t+e,t+i)),o}function hp(n,t,e,r){return Ca(n,t,1,e,r)}function dp(n,t,e,r){return Ca(n,t,2,Gs(n,t+1,r),r)}function fp(n,t,e,r){return Ca(n,t,3,Ys(n,t+1,r),r)}function gp(n,t,e,r){return Ca(n,t,5,Qs(n,t+1,r),r)}function pp(n,t,e,r){const s=Xs(n,t+1,r);if(typeof s=="bigint")throw new Error(`${J} 64-bit integer string lengths not supported`);return Ca(n,t,9,s,r)}const yp=Cl;function wo(n,t,e,r){return new K(x.array,r,e)}function mp(n,t,e,r){return wo(n,t,1,e)}function wp(n,t,e,r){return wo(n,t,2,Gs(n,t+1,r))}function bp(n,t,e,r){return wo(n,t,3,Ys(n,t+1,r))}function Ep(n,t,e,r){return wo(n,t,5,Qs(n,t+1,r))}function _p(n,t,e,r){const s=Xs(n,t+1,r);if(typeof s=="bigint")throw new Error(`${J} 64-bit integer array lengths not supported`);return wo(n,t,9,s)}function vp(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${J} indefinite length items not allowed`);return wo(n,t,1,1/0)}function Ih(n,t){fn(n,x.array.majorEncoded,t.value)}Ih.compareTokens=Zs.compareTokens;Ih.encodedSize=function(t){return fn.encodedSize(t.value)};function bo(n,t,e,r){return new K(x.map,r,e)}function Sp(n,t,e,r){return bo(n,t,1,e)}function Rp(n,t,e,r){return bo(n,t,2,Gs(n,t+1,r))}function Ap(n,t,e,r){return bo(n,t,3,Ys(n,t+1,r))}function Ip(n,t,e,r){return bo(n,t,5,Qs(n,t+1,r))}function kp(n,t,e,r){const s=Xs(n,t+1,r);if(typeof s=="bigint")throw new Error(`${J} 64-bit integer map lengths not supported`);return bo(n,t,9,s)}function xp(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${J} indefinite length items not allowed`);return bo(n,t,1,1/0)}function kh(n,t){fn(n,x.map.majorEncoded,t.value)}kh.compareTokens=Zs.compareTokens;kh.encodedSize=function(t){return fn.encodedSize(t.value)};function Tp(n,t,e,r){return new K(x.tag,e,1)}function Dp(n,t,e,r){return new K(x.tag,Gs(n,t+1,r),2)}function Cp(n,t,e,r){return new K(x.tag,Ys(n,t+1,r),3)}function Np(n,t,e,r){return new K(x.tag,Qs(n,t+1,r),5)}function Lp(n,t,e,r){return new K(x.tag,Xs(n,t+1,r),9)}function xh(n,t){fn(n,x.tag.majorEncoded,t.value)}xh.compareTokens=Zs.compareTokens;xh.encodedSize=function(t){return fn.encodedSize(t.value)};const Pp=20,Op=21,Bp=22,Mp=23;function Up(n,t,e,r){if(r.allowUndefined===!1)throw new Error(`${J} undefined values are not supported`);return r.coerceUndefinedToNull===!0?new K(x.null,null,1):new K(x.undefined,void 0,1)}function $p(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${J} indefinite length items not allowed`);return new K(x.break,void 0,1)}function Th(n,t,e){if(e){if(e.allowNaN===!1&&Number.isNaN(n))throw new Error(`${J} NaN values are not supported`);if(e.allowInfinity===!1&&(n===1/0||n===-1/0))throw new Error(`${J} Infinity values are not supported`)}return new K(x.float,n,t)}function Fp(n,t,e,r){return Th(Ch(n,t+1),3,r)}function Vp(n,t,e,r){return Th(Nh(n,t+1),5,r)}function Hp(n,t,e,r){return Th(k4(n,t+1),9,r)}function Dh(n,t,e){const r=t.value;if(r===!1)n.push([x.float.majorEncoded|Pp]);else if(r===!0)n.push([x.float.majorEncoded|Op]);else if(r===null)n.push([x.float.majorEncoded|Bp]);else if(r===void 0)n.push([x.float.majorEncoded|Mp]);else{let s,i=!1;(!e||e.float64!==!0)&&(A4(r),s=Ch(mn,1),r===s||Number.isNaN(r)?(mn[0]=249,n.push(mn.slice(0,3)),i=!0):(I4(r),s=Nh(mn,1),r===s&&(mn[0]=250,n.push(mn.slice(0,5)),i=!0))),i||(Kp(r),s=k4(mn,1),mn[0]=251,n.push(mn.slice(0,9)))}}Dh.encodedSize=function(t,e){const r=t.value;if(r===!1||r===!0||r===null||r===void 0)return 1;if(!e||e.float64!==!0){A4(r);let s=Ch(mn,1);if(r===s||Number.isNaN(r))return 3;if(I4(r),s=Nh(mn,1),r===s)return 5}return 9};const R4=new ArrayBuffer(9),nn=new DataView(R4,1),mn=new Uint8Array(R4,0);function A4(n){if(n===1/0)nn.setUint16(0,31744,!1);else if(n===-1/0)nn.setUint16(0,64512,!1);else if(Number.isNaN(n))nn.setUint16(0,32256,!1);else{nn.setFloat32(0,n);const t=nn.getUint32(0),e=(t&2139095040)>>23,r=t&8388607;if(e===255)nn.setUint16(0,31744,!1);else if(e===0)nn.setUint16(0,(n&2147483648)>>16|r>>13,!1);else{const s=e-127;s<-24?nn.setUint16(0,0):s<-14?nn.setUint16(0,(t&2147483648)>>16|1<<24+s,!1):nn.setUint16(0,(t&2147483648)>>16|s+15<<10|r>>13,!1)}}}function Ch(n,t){if(n.length-t<2)throw new Error(`${J} not enough data for float16`);const e=(n[t]<<8)+n[t+1];if(e===31744)return 1/0;if(e===64512)return-1/0;if(e===32256)return NaN;const r=e>>10&31,s=e&1023;let i;return r===0?i=s*2**-24:r!==31?i=(s+1024)*2**(r-25):i=s===0?1/0:NaN,e&32768?-i:i}function I4(n){nn.setFloat32(0,n,!1)}function Nh(n,t){if(n.length-t<4)throw new Error(`${J} not enough data for float32`);const e=(n.byteOffset||0)+t;return new DataView(n.buffer,e,4).getFloat32(0,!1)}function Kp(n){nn.setFloat64(0,n,!1)}function k4(n,t){if(n.length-t<8)throw new Error(`${J} not enough data for float64`);const e=(n.byteOffset||0)+t;return new DataView(n.buffer,e,8).getFloat64(0,!1)}Dh.compareTokens=Zs.compareTokens;function xe(n,t,e){throw new Error(`${J} encountered invalid minor (${e}) for major ${n[t]>>>5}`)}function Nl(n){return()=>{throw new Error(`${J} ${n}`)}}const H=[];for(let n=0;n<=23;n++)H[n]=xe;H[24]=Z9;H[25]=j9;H[26]=J9;H[27]=ep;H[28]=xe;H[29]=xe;H[30]=xe;H[31]=xe;for(let n=32;n<=55;n++)H[n]=xe;H[56]=tp;H[57]=np;H[58]=rp;H[59]=sp;H[60]=xe;H[61]=xe;H[62]=xe;H[63]=xe;for(let n=64;n<=87;n++)H[n]=ip;H[88]=op;H[89]=ap;H[90]=cp;H[91]=lp;H[92]=xe;H[93]=xe;H[94]=xe;H[95]=Nl("indefinite length bytes/strings are not supported");for(let n=96;n<=119;n++)H[n]=hp;H[120]=dp;H[121]=fp;H[122]=gp;H[123]=pp;H[124]=xe;H[125]=xe;H[126]=xe;H[127]=Nl("indefinite length bytes/strings are not supported");for(let n=128;n<=151;n++)H[n]=mp;H[152]=wp;H[153]=bp;H[154]=Ep;H[155]=_p;H[156]=xe;H[157]=xe;H[158]=xe;H[159]=vp;for(let n=160;n<=183;n++)H[n]=Sp;H[184]=Rp;H[185]=Ap;H[186]=Ip;H[187]=kp;H[188]=xe;H[189]=xe;H[190]=xe;H[191]=xp;for(let n=192;n<=215;n++)H[n]=Tp;H[216]=Dp;H[217]=Cp;H[218]=Np;H[219]=Lp;H[220]=xe;H[221]=xe;H[222]=xe;H[223]=xe;for(let n=224;n<=243;n++)H[n]=Nl("simple values are not supported");H[244]=xe;H[245]=xe;H[246]=xe;H[247]=Up;H[248]=Nl("simple values are not supported");H[249]=Fp;H[250]=Vp;H[251]=Hp;H[252]=xe;H[253]=xe;H[254]=xe;H[255]=$p;const Xn=[];for(let n=0;n<24;n++)Xn[n]=new K(x.uint,n,1);for(let n=-1;n>=-24;n--)Xn[31-n]=new K(x.negint,n,1);Xn[64]=new K(x.bytes,new Uint8Array(0),1);Xn[96]=new K(x.string,"",1);Xn[128]=new K(x.array,0,1);Xn[160]=new K(x.map,0,1);Xn[244]=new K(x.false,!1,1);Xn[245]=new K(x.true,!0,1);Xn[246]=new K(x.null,null,1);function zp(n){switch(n.type){case x.false:return Jn([244]);case x.true:return Jn([245]);case x.null:return Jn([246]);case x.bytes:return n.value.length?void 0:Jn([64]);case x.string:return n.value===""?Jn([96]):void 0;case x.array:return n.value===0?Jn([128]):void 0;case x.map:return n.value===0?Jn([160]):void 0;case x.uint:return n.value<24?Jn([Number(n.value)]):void 0;case x.negint:if(n.value>=-24)return Jn([31-Number(n.value)])}}const qp={float64:!1,mapSorter:Yp,quickEncodeToken:zp};function Wp(){const n=[];return n[x.uint.major]=Zs,n[x.negint.major]=Ah,n[x.bytes.major]=Cl,n[x.string.major]=yp,n[x.array.major]=Ih,n[x.map.major]=kh,n[x.tag.major]=xh,n[x.float.major]=Dh,n}const x4=Wp(),yu=new v4;class Uc{constructor(t,e){this.obj=t,this.parent=e}includes(t){let e=this;do if(e.obj===t)return!0;while(e=e.parent);return!1}static createCheck(t,e){if(t&&t.includes(e))throw new Error(`${Bc} object contains circular references`);return new Uc(e,t)}}const Tr={null:new K(x.null,null),undefined:new K(x.undefined,void 0),true:new K(x.true,!0),false:new K(x.false,!1),emptyArray:new K(x.array,0),emptyMap:new K(x.map,0)},Jr={number(n,t,e,r){return!Number.isInteger(n)||!Number.isSafeInteger(n)?new K(x.float,n):n>=0?new K(x.uint,n):new K(x.negint,n)},bigint(n,t,e,r){return n>=BigInt(0)?new K(x.uint,n):new K(x.negint,n)},Uint8Array(n,t,e,r){return new K(x.bytes,n)},string(n,t,e,r){return new K(x.string,n)},boolean(n,t,e,r){return n?Tr.true:Tr.false},null(n,t,e,r){return Tr.null},undefined(n,t,e,r){return Tr.undefined},ArrayBuffer(n,t,e,r){return new K(x.bytes,new Uint8Array(n))},DataView(n,t,e,r){return new K(x.bytes,new Uint8Array(n.buffer,n.byteOffset,n.byteLength))},Array(n,t,e,r){if(!n.length)return e.addBreakTokens===!0?[Tr.emptyArray,new K(x.break)]:Tr.emptyArray;r=Uc.createCheck(r,n);const s=[];let i=0;for(const o of n)s[i++]=_c(o,e,r);return e.addBreakTokens?[new K(x.array,n.length),s,new K(x.break)]:[new K(x.array,n.length),s]},Object(n,t,e,r){const s=t!=="Object",i=s?n.keys():Object.keys(n),o=s?n.size:i.length;if(!o)return e.addBreakTokens===!0?[Tr.emptyMap,new K(x.break)]:Tr.emptyMap;r=Uc.createCheck(r,n);const a=[];let c=0;for(const l of i)a[c++]=[_c(l,e,r),_c(s?n.get(l):n[l],e,r)];return Gp(a,e),e.addBreakTokens?[new K(x.map,o),a,new K(x.break)]:[new K(x.map,o),a]}};Jr.Map=Jr.Object;Jr.Buffer=Jr.Uint8Array;for(const n of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Jr[`${n}Array`]=Jr.DataView;function _c(n,t={},e){const r=V9(n),s=t&&t.typeEncoders&&t.typeEncoders[r]||Jr[r];if(typeof s=="function"){const o=s(n,r,t,e);if(o!=null)return o}const i=Jr[r];if(!i)throw new Error(`${Bc} unsupported type: ${r}`);return i(n,r,t,e)}function Gp(n,t){t.mapSorter&&n.sort(t.mapSorter)}function Yp(n,t){const e=Array.isArray(n[0])?n[0][0]:n[0],r=Array.isArray(t[0])?t[0][0]:t[0];if(e.type!==r.type)return e.type.compare(r.type);const s=e.type.major,i=x4[s].compareTokens(e,r);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function T4(n,t,e,r){if(Array.isArray(t))for(const s of t)T4(n,s,e,r);else e[t.type.major](n,t,r)}function Qp(n,t,e){const r=_c(n,e);if(!Array.isArray(r)&&e.quickEncodeToken){const s=e.quickEncodeToken(r);if(s)return s;const i=t[r.type.major];if(i.encodedSize){const o=i.encodedSize(r,e),a=new v4(o);if(i(a,r,e),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${r} was wrong`);return vh(a.chunks[0])}}return yu.reset(),T4(yu,r,t,e),yu.toBytes(!0)}function e1(n,t){return t=Object.assign({},qp,t),Qp(n,x4,t)}const Xp={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class Zp{constructor(t,e={}){this._pos=0,this.data=t,this.options=e}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const t=this.data[this._pos];let e=Xn[t];if(e===void 0){const r=H[t];if(!r)throw new Error(`${J} no decoder for major type ${t>>>5} (byte 0x${t.toString(16).padStart(2,"0")})`);const s=t&31;e=r(this.data,this._pos,s,this.options)}return this._pos+=e.encodedLength,e}}const ra=Symbol.for("DONE"),Ll=Symbol.for("BREAK");function jp(n,t,e){const r=[];for(let s=0;s<n.value;s++){const i=sa(t,e);if(i===Ll){if(n.value===1/0)break;throw new Error(`${J} got unexpected break to lengthed array`)}if(i===ra)throw new Error(`${J} found array but not enough entries (got ${s}, expected ${n.value})`);r[s]=i}return r}function Jp(n,t,e){const r=e.useMaps===!0,s=r?void 0:{},i=r?new Map:void 0;for(let o=0;o<n.value;o++){const a=sa(t,e);if(a===Ll){if(n.value===1/0)break;throw new Error(`${J} got unexpected break to lengthed map`)}if(a===ra)throw new Error(`${J} found map but not enough entries (got ${o} [no key], expected ${n.value})`);if(r!==!0&&typeof a!="string")throw new Error(`${J} non-string keys not supported (got ${typeof a})`);if(e.rejectDuplicateMapKeys===!0&&(r&&i.has(a)||!r&&a in s))throw new Error(`${J} found repeat map key "${a}"`);const c=sa(t,e);if(c===ra)throw new Error(`${J} found map but not enough entries (got ${o} [no value], expected ${n.value})`);r?i.set(a,c):s[a]=c}return r?i:s}function sa(n,t){if(n.done())return ra;const e=n.next();if(e.type===x.break)return Ll;if(e.type.terminal)return e.value;if(e.type===x.array)return jp(e,n,t);if(e.type===x.map)return Jp(e,n,t);if(e.type===x.tag){if(t.tags&&typeof t.tags[e.value]=="function"){const r=sa(n,t);return t.tags[e.value](r)}throw new Error(`${J} tag not supported (${e.value})`)}throw new Error("unsupported")}function ey(n,t){if(!(n instanceof Uint8Array))throw new Error(`${J} data to decode must be a Uint8Array`);t=Object.assign({},Xp,t);const e=t.tokenizer||new Zp(n,t),r=sa(e,t);if(r===ra)throw new Error(`${J} did not find any content to decode`);if(r===Ll)throw new Error(`${J} got unexpected break`);return[r,n.subarray(e.pos())]}function Cs(n,t){const[e,r]=ey(n,t);if(r.length>0)throw new Error(`${J} too many terminals, data makes no sense`);return e}const ty=new Uint8Array(0);function ny(n){const t=n.match(/../g);return t!=null?new Uint8Array(t.map(e=>parseInt(e,16))):ty}function ry(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function Eo(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function sy(n){return new TextEncoder().encode(n)}function iy(n){return new TextDecoder().decode(n)}function oy(n,t){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),r=0;r<e.length;r++)e[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(e[o]!==255)throw new TypeError(i+" is ambiguous");e[o]=s}var a=n.length,c=n.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function d(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var g=0,y=0,w=0,_=m.length;w!==_&&m[w]===0;)w++,g++;for(var b=(_-w)*h+1>>>0,v=new Uint8Array(b);w!==_;){for(var A=m[w],R=0,k=b-1;(A!==0||R<y)&&k!==-1;k--,R++)A+=256*v[k]>>>0,v[k]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");y=R,w++}for(var C=b-y;C!==b&&v[C]===0;)C++;for(var S=c.repeat(g);C<b;++C)S+=n.charAt(v[C]);return S}function f(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var g=0;if(m[g]!==" "){for(var y=0,w=0;m[g]===c;)y++,g++;for(var _=(m.length-g)*l+1>>>0,b=new Uint8Array(_);m[g];){var v=e[m.charCodeAt(g)];if(v===255)return;for(var A=0,R=_-1;(v!==0||A<w)&&R!==-1;R--,A++)v+=a*b[R]>>>0,b[R]=v%256>>>0,v=v/256>>>0;if(v!==0)throw new Error("Non-zero carry");w=A,g++}if(m[g]!==" "){for(var k=_-w;k!==_&&b[k]===0;)k++;for(var C=new Uint8Array(y+(_-k)),S=y;k!==_;)C[S++]=b[k++];return C}}}function p(m){var g=f(m);if(g)return g;throw new Error(`Non-${t} character`)}return{encode:d,decodeUnsafe:f,decode:p}}var ay=oy,cy=ay;let ly=class{constructor(t,e,r){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=t,this.prefix=e,this.baseEncode=r}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},uy=class{constructor(t,e,r){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=t,this.prefix=e;const s=e.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return D4(this,t)}};class hy{constructor(t){u(this,"decoders");this.decoders=t}or(t){return D4(this,t)}decode(t){const e=t[0],r=this.decoders[e];if(r!=null)return r.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function D4(n,t){return new hy({...n.decoders??{[n.prefix]:n},...t.decoders??{[t.prefix]:t}})}class dy{constructor(t,e,r,s){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=t,this.prefix=e,this.baseEncode=r,this.baseDecode=s,this.encoder=new ly(t,e,r),this.decoder=new uy(t,e,s)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}function Pl({name:n,prefix:t,encode:e,decode:r}){return new dy(n,t,e,r)}function Na({name:n,prefix:t,alphabet:e}){const{encode:r,decode:s}=cy(e,n);return Pl({prefix:t,name:n,encode:r,decode:i=>Eo(s(i))})}function fy(n,t,e,r){const s={};for(let h=0;h<t.length;++h)s[t[h]]=h;let i=n.length;for(;n[i-1]==="=";)--i;const o=new Uint8Array(i*e/8|0);let a=0,c=0,l=0;for(let h=0;h<i;++h){const d=s[n[h]];if(d===void 0)throw new SyntaxError(`Non-${r} character`);c=c<<e|d,a+=e,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=e||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function gy(n,t,e){const r=t[t.length-1]==="=",s=(1<<e)-1;let i="",o=0,a=0;for(let c=0;c<n.length;++c)for(a=a<<8|n[c],o+=8;o>e;)o-=e,i+=t[s&a>>o];if(o!==0&&(i+=t[s&a<<e-o]),r)for(;i.length*e&7;)i+="=";return i}function St({name:n,prefix:t,bitsPerChar:e,alphabet:r}){return Pl({prefix:t,name:n,encode(s){return gy(s,r,e)},decode(s){return fy(s,r,e,n)}})}const zt=St({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),py=St({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),yy=St({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),my=St({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),wy=St({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),by=St({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ey=St({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),_y=St({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),vy=St({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Sy=Object.freeze(Object.defineProperty({__proto__:null,base32:zt,base32hex:wy,base32hexpad:Ey,base32hexpadupper:_y,base32hexupper:by,base32pad:yy,base32padupper:my,base32upper:py,base32z:vy},Symbol.toStringTag,{value:"Module"})),yr=Na({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Ry=Na({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Ay=Object.freeze(Object.defineProperty({__proto__:null,base36:yr,base36upper:Ry},Symbol.toStringTag,{value:"Module"})),kt=Na({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Iy=Na({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),ky=Object.freeze(Object.defineProperty({__proto__:null,base58btc:kt,base58flickr:Iy},Symbol.toStringTag,{value:"Module"}));var xy=C4,bf=128,Ty=127,Dy=~Ty,Cy=Math.pow(2,31);function C4(n,t,e){t=t||[],e=e||0;for(var r=e;n>=Cy;)t[e++]=n&255|bf,n/=128;for(;n&Dy;)t[e++]=n&255|bf,n>>>=7;return t[e]=n|0,C4.bytes=e-r+1,t}var Ny=t1,Ly=128,Ef=127;function t1(n,r){var e=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw t1.bytes=0,new RangeError("Could not decode varint");o=n[i++],e+=s<28?(o&Ef)<<s:(o&Ef)*Math.pow(2,s),s+=7}while(o>=Ly);return t1.bytes=i-r,e}var Py=Math.pow(2,7),Oy=Math.pow(2,14),By=Math.pow(2,21),My=Math.pow(2,28),Uy=Math.pow(2,35),$y=Math.pow(2,42),Fy=Math.pow(2,49),Vy=Math.pow(2,56),Hy=Math.pow(2,63),Ky=function(n){return n<Py?1:n<Oy?2:n<By?3:n<My?4:n<Uy?5:n<$y?6:n<Fy?7:n<Vy?8:n<Hy?9:10},zy={encode:xy,decode:Ny,encodingLength:Ky},$c=zy;function n1(n,t=0){return[$c.decode(n,t),$c.decode.bytes]}function Fc(n,t,e=0){return $c.encode(n,t,e),t}function Vc(n){return $c.encodingLength(n)}function Os(n,t){const e=t.byteLength,r=Vc(n),s=r+Vc(e),i=new Uint8Array(s+e);return Fc(n,i,0),Fc(e,i,r),i.set(t,s),new Lh(n,e,t,i)}function cs(n){const t=Eo(n),[e,r]=n1(t),[s,i]=n1(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Lh(e,s,o,t)}function qy(n,t){if(n===t)return!0;{const e=t;return n.code===e.code&&n.size===e.size&&e.bytes instanceof Uint8Array&&ry(n.bytes,e.bytes)}}class Lh{constructor(t,e,r,s){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=t,this.size=e,this.digest=r,this.bytes=s}}function _f(n,t){const{bytes:e,version:r}=n;switch(r){case 0:return Gy(e,r1(n),t??kt.encoder);default:return Yy(e,r1(n),t??zt.encoder)}}const vf=new WeakMap;function r1(n){const t=vf.get(n);if(t==null){const e=new Map;return vf.set(n,e),e}return t}var t3;class Q{constructor(t,e,r,s){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,t3,"CID");this.code=e,this.version=t,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:t,multihash:e}=this;if(t!==Do)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==Qy)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Q.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:t,digest:e}=this.multihash,r=Os(t,e);return Q.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return Q.equals(this,t)}static equals(t,e){const r=e;return r!=null&&t.code===r.code&&t.version===r.version&&qy(t.multihash,r.multihash)}toString(t){return _f(this,t)}toJSON(){return{"/":_f(this)}}link(){return this}[(t3=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;const e=t;if(e instanceof Q)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){const{version:r,code:s,multihash:i,bytes:o}=e;return new Q(r,s,i,o??Sf(r,s,i.bytes))}else if(e[Xy]===!0){const{version:r,multihash:s,code:i}=e,o=cs(s);return Q.create(r,i,o)}else return null}static create(t,e,r){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==Do)throw new Error(`Version 0 CID must use dag-pb (code: ${Do}) block encoding`);return new Q(t,e,r,r.bytes)}case 1:{const s=Sf(t,e,r.bytes);return new Q(t,e,r,s)}default:throw new Error("Invalid version")}}static createV0(t){return Q.create(0,Do,t)}static createV1(t,e){return Q.create(1,t,e)}static decode(t){const[e,r]=Q.decodeFirst(t);if(r.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){const e=Q.inspectBytes(t),r=e.size-e.multihashSize,s=Eo(t.subarray(r,r+e.multihashSize));if(s.byteLength!==e.multihashSize)throw new Error("Incorrect length");const i=s.subarray(e.multihashSize-e.digestSize),o=new Lh(e.multihashCode,e.digestSize,i,s);return[e.version===0?Q.createV0(o):Q.createV1(e.codec,o),t.subarray(e.size)]}static inspectBytes(t){let e=0;const r=()=>{const[d,f]=n1(t.subarray(e));return e+=f,d};let s=r(),i=Do;if(s===18?(s=0,e=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=e,a=r(),c=r(),l=e+c,h=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:h,size:l}}static parse(t,e){const[r,s]=Wy(t,e),i=Q.decode(s);if(i.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return r1(i).set(r,t),i}}function Wy(n,t){switch(n[0]){case"Q":{const e=t??kt;return[kt.prefix,e.decode(`${kt.prefix}${n}`)]}case kt.prefix:{const e=t??kt;return[kt.prefix,e.decode(n)]}case zt.prefix:{const e=t??zt;return[zt.prefix,e.decode(n)]}case yr.prefix:{const e=t??yr;return[yr.prefix,e.decode(n)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],t.decode(n)]}}}function Gy(n,t,e){const{prefix:r}=e;if(r!==kt.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);const s=t.get(r);if(s==null){const i=e.encode(n).slice(1);return t.set(r,i),i}else return s}function Yy(n,t,e){const{prefix:r}=e,s=t.get(r);if(s==null){const i=e.encode(n);return t.set(r,i),i}else return s}const Do=112,Qy=18;function Sf(n,t,e){const r=Vc(n),s=r+Vc(t),i=new Uint8Array(s+e.byteLength);return Fc(n,i,0),Fc(t,i,r),i.set(e,s),i}const Xy=Symbol.for("@ipld/js-cid/CID"),N4=42;function L4(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}function Zy(n){if(n.asCID!==n&&n["/"]!==n.bytes)return null;const t=Q.asCID(n);if(!t)return null;const e=new Uint8Array(t.bytes.byteLength+1);return e.set(t.bytes,1),[new K(x.tag,N4),new K(x.bytes,e)]}function jy(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function Jy(n){if(Number.isNaN(n))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(n===1/0||n===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const s1={float64:!0,typeEncoders:{Object:Zy,undefined:jy,number:Jy}},em={...s1,typeEncoders:{...s1.typeEncoders}};function tm(n){if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Q.decode(n.subarray(1))}const Hc={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Hc.tags[N4]=tm;const nm={...Hc,tags:Hc.tags.slice()},rm="dag-cbor",Ph=113,sm=n=>e1(n,s1),Oh=n=>Cs(L4(n),Hc),im=Object.freeze(Object.defineProperty({__proto__:null,code:Ph,decode:Oh,decodeOptions:nm,encode:sm,encodeOptions:em,name:rm,toByteView:L4},Symbol.toStringTag,{value:"Module"}));function Bh({name:n,code:t,encode:e}){return new om(n,t,e)}class om{constructor(t,e,r){u(this,"name");u(this,"code");u(this,"encode");this.name=t,this.code=e,this.encode=r}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?Os(this.code,e):e.then(r=>Os(this.code,r))}else throw Error("Unknown type, must be binary type")}}function Qa({enumerable:n=!0,configurable:t=!1}={}){return{enumerable:n,configurable:t,writable:!1}}function*am(n,t){if(t!=null&&typeof t=="object")if(Array.isArray(t))for(const[e,r]of t.entries()){const s=[...n,e],i=Q.asCID(r);i!=null?yield[s.join("/"),i]:typeof r=="object"&&(yield*i1(r,s))}else{const e=Q.asCID(t);e!=null?yield[n.join("/"),e]:yield*i1(t,n)}}function*i1(n,t){if(n==null||n instanceof Uint8Array)return;const e=Q.asCID(n);e!=null&&(yield[t.join("/"),e]);for(const[r,s]of Object.entries(n)){const i=[...t,r];yield*am(i,s)}}function*cm(n,t){if(Array.isArray(t))for(const[e,r]of t.entries()){const s=[...n,e];yield s.join("/"),typeof r=="object"&&Q.asCID(r)==null&&(yield*o1(r,s))}else yield*o1(t,n)}function*o1(n,t){if(!(n==null||typeof n!="object"))for(const[e,r]of Object.entries(n)){const s=[...t,e];yield s.join("/"),r!=null&&!(r instanceof Uint8Array)&&typeof r=="object"&&Q.asCID(r)==null&&(yield*cm(s,r))}}function lm(n,t){let e=n;for(const[r,s]of t.entries()){if(e=e[s],e==null)throw new Error(`Object has no property at ${t.slice(0,r+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=Q.asCID(e);if(i!=null)return{value:i,remaining:t.slice(r+1).join("/")}}return{value:e}}let um=class{constructor({cid:t,bytes:e,value:r}){u(this,"cid");u(this,"bytes");u(this,"value");u(this,"asBlock");if(t==null||e==null||typeof r>"u")throw new Error("Missing required argument");this.cid=t,this.bytes=e,this.value=r,this.asBlock=this,Object.defineProperties(this,{cid:Qa(),bytes:Qa(),value:Qa(),asBlock:Qa()})}links(){return i1(this.value,[])}tree(){return o1(this.value,[])}get(t="/"){return lm(this.value,t.split("/").filter(Boolean))}};async function hm({value:n,codec:t,hasher:e}){if(typeof n>"u")throw new Error('Missing required argument "value"');if(t==null||e==null)throw new Error("Missing required argument: codec or hasher");const r=t.encode(n),s=await e.digest(r),i=Q.create(1,t.code,s);return new um({value:n,bytes:r,cid:i})}function P4(n){return async t=>new Uint8Array(await crypto.subtle.digest(n,t))}const We=Bh({name:"sha2-256",code:18,encode:P4("SHA-256")}),dm=Bh({name:"sha2-512",code:19,encode:P4("SHA-512")});/*! noble-ed25519 - MIT License (c) 2019 Paul Miller (paulmillr.com) */const mt=2n**255n-19n,qo=2n**252n+27742317777372353535851937790883648493n,a1=0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51an,c1=0x6666666666666666666666666666666666666666666666666666666666666658n,Xa={a:-1n,d:37095705934669439343138083508754565189542113879843219016388785533085940283555n,p:mt,n:qo,h:8,Gx:a1,Gy:c1},Nt=(n="")=>{throw new Error(n)},O4=n=>typeof n=="string",fm=n=>n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array",Kc=(n,t)=>!fm(n)||typeof t=="number"&&t>0&&n.length!==t?Nt("Uint8Array of valid length expected"):n,Pi=n=>new Uint8Array(n),l1=(n,t)=>Kc(O4(n)?Uh(n):Pi(Kc(n)),t),ee=(n,t=mt)=>{let e=n%t;return e>=0n?e:t+e},Rf=n=>n instanceof qt?n:Nt("Point expected");class qt{constructor(t,e,r,s){this.ex=t,this.ey=e,this.ez=r,this.et=s}static fromAffine(t){return new qt(t.x,t.y,1n,ee(t.x*t.y))}static fromHex(t,e=!1){const{d:r}=Xa;t=l1(t,32);const s=t.slice(),i=t[31];s[31]=i&-129;const o=$h(s);e&&!(0n<=o&&o<2n**256n)&&Nt("bad y coord 1"),!e&&!(0n<=o&&o<mt)&&Nt("bad y coord 2");const a=ee(o*o),c=ee(a-1n),l=ee(r*a+1n);let{isValid:h,value:d}=ym(c,l);h||Nt("bad y coordinate 3");const f=(d&1n)===1n,p=(i&128)!==0;return!e&&d===0n&&p&&Nt("bad y coord 3"),p!==f&&(d=ee(-d)),new qt(d,o,1n,ee(d*o))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}equals(t){const{ex:e,ey:r,ez:s}=this,{ex:i,ey:o,ez:a}=Rf(t),c=ee(e*a),l=ee(i*s),h=ee(r*a),d=ee(o*s);return c===l&&h===d}is0(){return this.equals(Mo)}negate(){return new qt(ee(-this.ex),this.ey,this.ez,ee(-this.et))}double(){const{ex:t,ey:e,ez:r}=this,{a:s}=Xa,i=ee(t*t),o=ee(e*e),a=ee(2n*ee(r*r)),c=ee(s*i),l=t+e,h=ee(ee(l*l)-i-o),d=c+o,f=d-a,p=c-o,m=ee(h*f),g=ee(d*p),y=ee(h*p),w=ee(f*d);return new qt(m,g,w,y)}add(t){const{ex:e,ey:r,ez:s,et:i}=this,{ex:o,ey:a,ez:c,et:l}=Rf(t),{a:h,d}=Xa,f=ee(e*o),p=ee(r*a),m=ee(i*d*l),g=ee(s*c),y=ee((e+r)*(o+a)-f-p),w=ee(g-m),_=ee(g+m),b=ee(p-h*f),v=ee(y*w),A=ee(_*b),R=ee(y*b),k=ee(w*_);return new qt(v,A,k,R)}mul(t,e=!0){if(t===0n)return e===!0?Nt("cannot multiply by 0"):Mo;if(typeof t=="bigint"&&0n<t&&t<qo||Nt("invalid scalar, must be < L"),!e&&this.is0()||t===1n)return this;if(this.equals(ia))return Sm(t).p;let r=Mo,s=ia;for(let i=this;t>0n;i=i.double(),t>>=1n)t&1n?r=r.add(i):e&&(s=s.add(i));return r}multiply(t){return this.mul(t)}clearCofactor(){return this.mul(BigInt(Xa.h),!1)}isSmallOrder(){return this.clearCofactor().is0()}isTorsionFree(){let t=this.mul(qo/2n,!1).double();return qo%2n&&(t=t.add(this)),t.is0()}toAffine(){const{ex:t,ey:e,ez:r}=this;if(this.equals(Mo))return{x:0n,y:1n};const s=M4(r);return ee(r*s)!==1n&&Nt("invalid inverse"),{x:ee(t*s),y:ee(e*s)}}toRawBytes(){const{x:t,y:e}=this.toAffine(),r=gm(e);return r[31]|=t&1n?128:0,r}toHex(){return Mh(this.toRawBytes())}}qt.BASE=new qt(a1,c1,1n,ee(a1*c1));qt.ZERO=new qt(0n,1n,1n,0n);const{BASE:ia,ZERO:Mo}=qt,B4=(n,t)=>n.toString(16).padStart(t,"0"),Mh=n=>Array.from(n).map(t=>B4(t,2)).join(""),Uh=n=>{const t=n.length;(!O4(n)||t%2)&&Nt("hex invalid 1");const e=Pi(t/2);for(let r=0;r<e.length;r++){const s=r*2,i=n.slice(s,s+2),o=Number.parseInt(i,16);(Number.isNaN(o)||o<0)&&Nt("hex invalid 2"),e[r]=o}return e},gm=n=>Uh(B4(n,32*2)).reverse(),$h=n=>BigInt("0x"+Mh(Pi(Kc(n)).reverse())),u1=(...n)=>{const t=Pi(n.reduce((r,s)=>r+Kc(s).length,0));let e=0;return n.forEach(r=>{t.set(r,e),e+=r.length}),t},M4=(n,t=mt)=>{(n===0n||t<=0n)&&Nt("no inverse n="+n+" mod="+t);let e=ee(n,t),r=t,s=0n,i=1n;for(;e!==0n;){const o=r/e,a=r%e,c=s-i*o;r=e,e=a,s=i,i=c}return r===1n?ee(s,t):Nt("no inverse")},kn=(n,t)=>{let e=n;for(;t-- >0n;)e*=e,e%=mt;return e},pm=n=>{const e=n*n%mt*n%mt,r=kn(e,2n)*e%mt,s=kn(r,1n)*n%mt,i=kn(s,5n)*s%mt,o=kn(i,10n)*i%mt,a=kn(o,20n)*o%mt,c=kn(a,40n)*a%mt,l=kn(c,80n)*c%mt,h=kn(l,80n)*c%mt,d=kn(h,10n)*i%mt;return{pow_p_5_8:kn(d,2n)*n%mt,b2:e}},Af=19681161376707505956807079304988542015446066515923890162744021073123829784752n,ym=(n,t)=>{const e=ee(t*t*t),r=ee(e*e*t),s=pm(n*r).pow_p_5_8;let i=ee(n*e*s);const o=ee(t*i*i),a=i,c=ee(i*Af),l=o===n,h=o===ee(-n),d=o===ee(-n*Af);return l&&(i=a),(h||d)&&(i=c),(ee(i)&1n)===1n&&(i=ee(-i)),{isValid:l||h,value:i}},mm=n=>ee($h(n),qo);let mu;const wm=(...n)=>$4.sha512Async(...n);function bm(n,t){return wm(t.hashable).then(t.finish)}const U4={zip215:!0},Em=(n,t,e,r=U4)=>{t=l1(t),n=l1(n,64);const{zip215:s}=r;let i,o,a,c,l=new Uint8Array;try{i=qt.fromHex(e,s),o=qt.fromHex(n.slice(0,32),s),a=$h(n.slice(32,64)),c=ia.mul(a,!1),l=u1(o.toRawBytes(),i.toRawBytes(),t)}catch{}return{hashable:l,finish:d=>{if(c==null||!s&&i.isSmallOrder())return!1;const f=mm(d);return o.add(i.mul(f,!1)).add(c.negate()).clearCofactor().is0()}}},_m=async(n,t,e,r=U4)=>bm(!0,Em(n,t,e,r)),If=()=>typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0,$4={bytesToHex:Mh,hexToBytes:Uh,concatBytes:u1,mod:ee,invert:M4,randomBytes:(n=32)=>{const t=If();return(!t||!t.getRandomValues)&&Nt("crypto.getRandomValues must be defined"),t.getRandomValues(Pi(n))},sha512Async:async(...n)=>{const t=If();(!t||!t.subtle)&&Nt("crypto.subtle or etc.sha512Async must be defined");const e=u1(...n);return Pi(await t.subtle.digest("SHA-512",e.buffer))},sha512Sync:void 0};Object.defineProperties($4,{sha512Sync:{configurable:!1,get(){return mu},set(n){mu||(mu=n)}}});const Es=8,vm=()=>{const n=[],t=256/Es+1;let e=ia,r=e;for(let s=0;s<t;s++){r=e,n.push(r);for(let i=1;i<2**(Es-1);i++)r=r.add(e),n.push(r);e=r.double()}return n};let kf;const Sm=n=>{const t=kf||(kf=vm()),e=(h,d)=>{let f=d.negate();return h?f:d};let r=Mo,s=ia;const i=1+256/Es,o=2**(Es-1),a=BigInt(2**Es-1),c=2**Es,l=BigInt(Es);for(let h=0;h<i;h++){const d=h*o;let f=Number(n&a);n>>=l,f>o&&(f-=c,n+=1n);const p=d,m=d+Math.abs(f)-1,g=h%2!==0,y=f<0;f===0?s=s.add(e(g,t[p])):r=r.add(e(y,t[m]))}return{p:r,f:s}},Rm=Symbol.for("@libp2p/connection"),Oi=Symbol.for("@libp2p/content-routing"),zc=Symbol.for("@libp2p/peer-discovery"),Ol=Symbol.for("@libp2p/peer-id");function Bl(n){return n!=null&&!!n[Ol]}const Bi=Symbol.for("@libp2p/peer-routing"),Am="keep-alive",La=Symbol.for("@libp2p/transport");var wi;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(wi||(wi={}));var hr;let Ml=(hr=class extends Error{constructor(e="The operation was aborted"){super(e);u(this,"code");u(this,"type");this.name="AbortError",this.code=hr.code,this.type=hr.type}},u(hr,"code","ABORT_ERR"),u(hr,"type","aborted"),hr),E=class extends Error{constructor(e,r,s){super(e);u(this,"code");u(this,"props");this.code=r,this.name=(s==null?void 0:s.name)??"CodeError",this.props=s??{}}};class Im extends AggregateError{constructor(e,r,s,i){super(e,r);u(this,"code");u(this,"props");this.code=s,this.name=(i==null?void 0:i.name)??"AggregateCodeError",this.props=i??{}}}const Mi="ERR_TIMEOUT",ws="ERR_INVALID_MESSAGE";const j=(n,...t)=>{try{[...t]}catch{}};var Bn;class _t extends EventTarget{constructor(){super();fe(this,Bn,new Map);j(1/0,this)}listenerCount(e){const r=F(this,Bn).get(e);return r==null?0:r.length}addEventListener(e,r,s){super.addEventListener(e,r,s);let i=F(this,Bn).get(e);i==null&&(i=[],F(this,Bn).set(e,i)),i.push({callback:r,once:(s!==!0&&s!==!1&&(s==null?void 0:s.once))??!1})}removeEventListener(e,r,s){super.removeEventListener(e.toString(),r??null,s);let i=F(this,Bn).get(e);i!=null&&(i=i.filter(({callback:o})=>o!==r),F(this,Bn).set(e,i))}dispatchEvent(e){const r=super.dispatchEvent(e);let s=F(this,Bn).get(e.type);return s==null||(s=s.filter(({once:i})=>!i),F(this,Bn).set(e.type,s)),r}safeDispatchEvent(e,r={}){return this.dispatchEvent(new Sn(e,r))}}Bn=new WeakMap;const Sn=globalThis.CustomEvent;function Fh(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function _o(...n){const t=[];for(const e of n)Fh(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function vo(...n){const t=[];for(const e of n)Fh(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}const Bt=Symbol.for("@libp2p/service-capabilities"),Ui=Symbol.for("@libp2p/service-dependencies");function Ze(n){const t=new globalThis.AbortController;function e(){t.abort();for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",e)}for(const i of n){if((i==null?void 0:i.aborted)===!0){e();break}(i==null?void 0:i.addEventListener)!=null&&i.addEventListener("abort",e)}function r(){for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",e)}const s=t.signal;return s.clear=r,s}function pe(){const n={};return n.promise=new Promise((t,e)=>{n.resolve=t,n.reject=e}),n}class xf{constructor(t){u(this,"buffer");u(this,"mask");u(this,"top");u(this,"btm");u(this,"next");if(!(t>0)||t-1&t)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){const t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}}class wu{constructor(t={}){u(this,"size");u(this,"hwm");u(this,"head");u(this,"tail");this.hwm=t.splitLimit??16,this.head=new xf(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return(t==null?void 0:t.byteLength)!=null?t.byteLength:1}push(t){if((t==null?void 0:t.value)!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){const e=this.head;this.head=e.next=new xf(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return(t==null?void 0:t.value)!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}let km=class extends Error{constructor(e,r){super(e??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function ls(n={}){return xm(e=>{const r=e.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function xm(n,t){t=t??{};let e=t.onEnd,r=new wu,s,i,o,a=pe();const c=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((y,w)=>{i=_=>{i=null,r.push(_);try{y(n(r))}catch(b){w(b)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=pe()})}},l=y=>i!=null?i(y):(r.push(y),s),h=y=>(r=new wu,i!=null?i({error:y}):(r.push({error:y}),s)),d=y=>{if(o)return s;if((t==null?void 0:t.objectMode)!==!0&&(y==null?void 0:y.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},f=y=>o?s:(o=!0,y!=null?h(y):l({done:!0})),p=()=>(r=new wu,f(),{done:!0}),m=y=>(f(y),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:p,throw:m,push:d,end:f,get readableLength(){return r.size},onEmpty:async y=>{const w=y==null?void 0:y.signal;if(w==null||w.throwIfAborted(),r.isEmpty())return;let _,b;w!=null&&(_=new Promise((v,A)=>{b=()=>{A(new km)},w.addEventListener("abort",b)}));try{await Promise.race([a.promise,_])}finally{b!=null&&w!=null&&(w==null||w.removeEventListener("abort",b))}}},e==null)return s;const g=s;return s={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(y){return g.throw(y),e!=null&&(e(y),e=void 0),{done:!0}},return(){return g.return(),e!=null&&(e(),e=void 0),{done:!0}},push:d,end(y){return g.end(y),e!=null&&(e(y),e=void 0),s},get readableLength(){return g.readableLength},onEmpty:y=>g.onEmpty(y)},s}let Tm=class extends Error{constructor(e,r){super(e??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}};async function pr(n,t,e,r){const s=new Tm(r==null?void 0:r.errorMessage,r==null?void 0:r.errorCode);return(e==null?void 0:e.aborted)===!0?Promise.reject(s):new Promise((i,o)=>{function a(){e==null||e.removeEventListener("abort",h),n.removeEventListener(t,c),(r==null?void 0:r.errorEvent)!=null&&n.removeEventListener(r.errorEvent,l)}const c=d=>{var f;try{if(((f=r==null?void 0:r.filter)==null?void 0:f.call(r,d))===!1)return}catch(p){a(),o(p);return}a(),i(d)},l=d=>{a(),o(d.detail)},h=()=>{a(),o(s)};e==null||e.addEventListener("abort",h),n.addEventListener(t,c),(r==null?void 0:r.errorEvent)!=null&&n.addEventListener(r.errorEvent,l)})}let Tf=class extends Error{constructor(e,r,s){super(e??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=r??"ABORT_ERR"}};async function dt(n,t,e){if(t==null)return n;if(t.aborted)return Promise.reject(new Tf(e==null?void 0:e.errorMessage,e==null?void 0:e.errorCode,e==null?void 0:e.errorName));let r;const s=new Tf(e==null?void 0:e.errorMessage,e==null?void 0:e.errorCode,e==null?void 0:e.errorName);try{return await Promise.race([n,new Promise((i,o)=>{r=()=>{o(s)},t.addEventListener("abort",r)})])}finally{r!=null&&t.removeEventListener("abort",r)}}class Dm{constructor(t){u(this,"deferred");u(this,"signal");var e;this.signal=t,this.deferred=pe(),this.onAbort=this.onAbort.bind(this),(e=this.signal)==null||e.addEventListener("abort",this.onAbort)}onAbort(){var t;this.deferred.reject(((t=this.signal)==null?void 0:t.reason)??new Ml)}cleanup(){var t;(t=this.signal)==null||t.removeEventListener("abort",this.onAbort)}}function Cm(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class Nm{constructor(t,e){u(this,"id");u(this,"fn");u(this,"options");u(this,"recipients");u(this,"status");u(this,"timeline");u(this,"controller");this.id=Cm(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,j(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,r)=>{var s;return e&&((s=r.signal)==null?void 0:s.aborted)===!0},!0)&&(this.controller.abort(new Ml),this.cleanup())}async join(t={}){var r;const e=new Dm(t.signal);return this.recipients.push(e),(r=t.signal)==null||r.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const t=await dt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{var e;t.cleanup(),(e=t.signal)==null||e.removeEventListener("abort",this.onAbort)})}}class $i extends _t{constructor(e={}){var r;super();u(this,"concurrency");u(this,"queue");u(this,"pending");u(this,"sort");this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&((r=e.metrics)==null||r.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(const r of this.queue)if(r.status==="queued"){e=r;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===e){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,r){var i;(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const s=new Nm(e,r);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(r).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===s){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ml)}),this.clear()}async onEmpty(e){this.size!==0&&await pr(this,"empty",e==null?void 0:e.signal)}async onSizeLessThan(e,r){this.size<e||await pr(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await pr(this,"idle",e==null?void 0:e.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){var l,h,d;(l=e==null?void 0:e.signal)==null||l.throwIfAborted();const r=ls({objectMode:!0}),s=f=>{f!=null?this.abort():this.clear(),r.end(f)},i=f=>{f.detail!=null&&r.push(f.detail)},o=f=>{s(f.detail)},a=()=>{s()},c=()=>{s(new E("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",a),(h=e==null?void 0:e.signal)==null||h.addEventListener("abort",c);try{yield*r}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",a),(d=e==null?void 0:e.signal)==null||d.removeEventListener("abort",c),s()}}}class So extends $i{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}}function Lm(n){return n[Symbol.asyncIterator]!=null}function Bs(n){if(Lm(n))return(async()=>{for await(const t of n);})();for(const t of n);}function Pe(n=0){return new Uint8Array(n)}function Jt(n=0){return new Uint8Array(n)}const Pm=Math.pow(2,7),Om=Math.pow(2,14),Bm=Math.pow(2,21),Vh=Math.pow(2,28),Hh=Math.pow(2,35),Kh=Math.pow(2,42),zh=Math.pow(2,49),De=128,At=127;function He(n){if(n<Pm)return 1;if(n<Om)return 2;if(n<Bm)return 3;if(n<Vh)return 4;if(n<Hh)return 5;if(n<Kh)return 6;if(n<zh)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function F4(n,t,e=0){switch(He(n)){case 8:t[e++]=n&255|De,n/=128;case 7:t[e++]=n&255|De,n/=128;case 6:t[e++]=n&255|De,n/=128;case 5:t[e++]=n&255|De,n/=128;case 4:t[e++]=n&255|De,n>>>=7;case 3:t[e++]=n&255|De,n>>>=7;case 2:t[e++]=n&255|De,n>>>=7;case 1:{t[e++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return t}function Mm(n,t,e=0){switch(He(n)){case 8:t.set(e++,n&255|De),n/=128;case 7:t.set(e++,n&255|De),n/=128;case 6:t.set(e++,n&255|De),n/=128;case 5:t.set(e++,n&255|De),n/=128;case 4:t.set(e++,n&255|De),n>>>=7;case 3:t.set(e++,n&255|De),n>>>=7;case 2:t.set(e++,n&255|De),n>>>=7;case 1:{t.set(e++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return t}function V4(n,t){let e=n[t],r=0;if(r+=e&At,e<De||(e=n[t+1],r+=(e&At)<<7,e<De)||(e=n[t+2],r+=(e&At)<<14,e<De)||(e=n[t+3],r+=(e&At)<<21,e<De)||(e=n[t+4],r+=(e&At)*Vh,e<De)||(e=n[t+5],r+=(e&At)*Hh,e<De)||(e=n[t+6],r+=(e&At)*Kh,e<De)||(e=n[t+7],r+=(e&At)*zh,e<De))return r;throw new RangeError("Could not decode varint")}function Um(n,t){let e=n.get(t),r=0;if(r+=e&At,e<De||(e=n.get(t+1),r+=(e&At)<<7,e<De)||(e=n.get(t+2),r+=(e&At)<<14,e<De)||(e=n.get(t+3),r+=(e&At)<<21,e<De)||(e=n.get(t+4),r+=(e&At)*Vh,e<De)||(e=n.get(t+5),r+=(e&At)*Hh,e<De)||(e=n.get(t+6),r+=(e&At)*Kh,e<De)||(e=n.get(t+7),r+=(e&At)*zh,e<De))return r;throw new RangeError("Could not decode varint")}function Ot(n,t,e=0){return t==null&&(t=Jt(He(n))),t instanceof Uint8Array?F4(n,t,e):Mm(n,t,e)}function _r(n,t=0){return n instanceof Uint8Array?V4(n,t):Um(n,t)}function gt(n,t){t==null&&(t=n.reduce((s,i)=>s+i.length,0));const e=Jt(t);let r=0;for(const s of n)e.set(s,r),r+=s.length;return e}function ve(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}const H4=Symbol.for("@achingbrain/uint8arraylist");function Df(n,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(const r of n){const s=e+r.byteLength;if(t<s)return{buf:r,index:t-e};e=s}throw new RangeError("index is out of bounds")}function Za(n){return!!(n!=null&&n[H4])}var n3;class Ie{constructor(...t){u(this,"bufs");u(this,"length");u(this,n3,!0);this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[(n3=H4,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(const r of t)if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.push(r);else if(Za(r))e+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(const r of t.reverse())if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.unshift(r);else if(Za(r))e+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){const e=Df(this.bufs,t);return e.buf[e.index]}set(t,e){const r=Df(this.bufs,t);r.buf[r.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let r=0;r<t.length;r++)this.set(e+r,t[r]);else if(Za(t))for(let r=0;r<t.length;r++)this.set(e+r,t.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){const{bufs:r,length:s}=this._subList(t,e);return gt(r,s)}subarray(t,e){const{bufs:r,length:s}=this._subList(t,e);return r.length===1?r[0]:gt(r,s)}sublist(t,e){const{bufs:r,length:s}=this._subList(t,e),i=new Ie;return i.length=s,i.bufs=[...r],i}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,t>=c)continue;const l=t>=a&&t<c,h=e>a&&e<=c;if(l&&h){if(t===a&&e===c){r.push(o);break}const d=t-a;r.push(o.subarray(d,d+(e-t)));break}if(l){if(t===0){r.push(o);continue}r.push(o.subarray(t-a));continue}if(h){if(e===c){r.push(o);break}r.push(o.subarray(0,e-a));break}r.push(o)}return{bufs:r,length:e-t}}indexOf(t,e=0){if(!Za(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let d=0;d<i;d++)o[d]=-1;for(let d=0;d<s;d++)o[r[d]]=d;const a=o,c=this.byteLength-r.byteLength,l=r.byteLength-1;let h;for(let d=e;d<=c;d+=h){h=0;for(let f=l;f>=0;f--){const p=this.get(d+f);if(r[f]!==p){h=Math.max(1,f-a[p]);break}}if(h===0)return d}return-1}getInt8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){const r=Jt(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,e),this.write(r,t)}getInt16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,e)}setInt16(t,e,r){const s=Pe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,e,r),this.write(s,t)}getInt32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,e)}setInt32(t,e,r){const s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,e,r),this.write(s,t)}getBigInt64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,e)}setBigInt64(t,e,r){const s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,e,r),this.write(s,t)}getUint8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){const r=Jt(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,e),this.write(r,t)}getUint16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,e)}setUint16(t,e,r){const s=Pe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,e,r),this.write(s,t)}getUint32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,e)}setUint32(t,e,r){const s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,e,r),this.write(s,t)}getBigUint64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,e)}setBigUint64(t,e,r){const s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,e,r),this.write(s,t)}getFloat32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,e)}setFloat32(t,e,r){const s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,e,r),this.write(s,t)}getFloat64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,e)}setFloat64(t,e,r){const s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,e,r),this.write(s,t)}equals(t){if(t==null||!(t instanceof Ie)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!ve(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){const r=new Ie;return r.bufs=t,e==null&&(e=t.reduce((s,i)=>s+i.byteLength,0)),r.length=e,r}}function K4(n){return n[Symbol.asyncIterator]!=null}const Ul=n=>{const t=He(n),e=Jt(t);return Ot(n,e),Ul.bytes=t,e};Ul.bytes=0;function es(n,t){t=t??{};const e=t.lengthEncoder??Ul;function*r(s){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return K4(n)?async function*(){for await(const s of n)yield*r(s)}():function*(){for(const s of n)yield*r(s)}()}es.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??Ul;return new Ie(e(n.byteLength),n)};let $m=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},Fm=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},Vm=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},Cf=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};const Hm=8,Km=1024*1024*4;var _s;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(_s||(_s={}));const qh=n=>{const t=_r(n);return qh.bytes=He(t),t};qh.bytes=0;function ts(n,t){const e=new Ie;let r=_s.LENGTH,s=-1;const i=(t==null?void 0:t.lengthDecoder)??qh,o=(t==null?void 0:t.maxLengthLength)??Hm,a=(t==null?void 0:t.maxDataLength)??Km;function*c(){for(;e.byteLength>0;){if(r===_s.LENGTH)try{if(s=i(e),s<0)throw new $m("Invalid message length");if(s>a)throw new Fm("Message length too long");const l=i.bytes;e.consume(l),(t==null?void 0:t.onLength)!=null&&t.onLength(s),r=_s.DATA}catch(l){if(l instanceof RangeError){if(e.byteLength>o)throw new Vm("Message length length too long");break}throw l}if(r===_s.DATA){if(e.byteLength<s)break;const l=e.sublist(0,s);e.consume(s),(t==null?void 0:t.onData)!=null&&t.onData(l),yield l,r=_s.LENGTH}}}return K4(n)?async function*(){for await(const l of n)e.append(l),yield*c();if(e.byteLength>0)throw new Cf("Unexpected end of input")}():function*(){for(const l of n)e.append(l),yield*c();if(e.byteLength>0)throw new Cf("Unexpected end of input")}()}ts.fromReader=(n,t)=>{let e=1;const r=async function*(){for(;;)try{const{done:i,value:o}=await n.next(e);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{e=1}}();return ts(r,{...t??{},onLength:i=>{e=i}})};function Wh(n){const[t,e]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[e](){return this}}}function zm(n){return n[Symbol.asyncIterator]!=null}function vr(n,t){let e=0;if(zm(n))return async function*(){for await(const c of n)yield t(c,e++)}();const r=Wh(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){yield await o;for await(const c of r)yield t(c,e++)}();const a=t;return function*(){yield o;for(const c of r)yield a(c,e++)}()}function qm(n){return n[Symbol.asyncIterator]!=null}function Gr(...n){const t=[];for(const e of n)qm(e)||t.push(e);return t.length===n.length?function*(){for(const e of t)yield*e}():async function*(){const e=ls({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(n.map(async r=>{for await(const s of r)e.push(s)})),e.end()}catch(r){e.end(r)}}),yield*e}()}function vt(n,...t){if(n==null)throw new Error("Empty pipeline");if(bu(n)){const r=n;n=()=>r.source}else if(q4(n)||z4(n)){const r=n;n=()=>r}const e=[n,...t];if(e.length>1&&bu(e[e.length-1])&&(e[e.length-1]=e[e.length-1].sink),e.length>2)for(let r=1;r<e.length-1;r++)bu(e[r])&&(e[r]=Gm(e[r]));return Wm(...e)}const Wm=(...n)=>{let t;for(;n.length>0;)t=n.shift()(t);return t},z4=n=>(n==null?void 0:n[Symbol.asyncIterator])!=null,q4=n=>(n==null?void 0:n[Symbol.iterator])!=null,bu=n=>n==null?!1:n.sink!=null&&n.source!=null,Gm=n=>t=>{const e=n.sink(t);if((e==null?void 0:e.then)!=null){const r=ls({objectMode:!0});e.then(()=>{r.end()},o=>{r.end(o)});let s;const i=n.source;if(z4(i))s=async function*(){yield*i,r.end()};else if(q4(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Gr(r,s())}return n.source};function Ym(n){return n[Symbol.asyncIterator]!=null}function qc(n,t){return Ym(n)?async function*(){let e=0;if(!(t<1)){for await(const r of n)if(yield r,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(const r of n)if(yield r,e++,e===t)return}}()}class G extends Event{constructor(e,r){super(e);u(this,"type");u(this,"detail");this.type=e,this.detail=r}}const ja="/ipfs/bitswap/1.2.0",Qm=1024,Xm=1024,Zm=1024,jm=5e3,Jm=10,ew=50,tw=!1,nw=3,W4=1024*1024*4,rw=W4,Gh=new Float32Array([-0]),Kr=new Uint8Array(Gh.buffer);function sw(n,t,e){Gh[0]=n,t[e]=Kr[0],t[e+1]=Kr[1],t[e+2]=Kr[2],t[e+3]=Kr[3]}function iw(n,t){return Kr[0]=n[t],Kr[1]=n[t+1],Kr[2]=n[t+2],Kr[3]=n[t+3],Gh[0]}const Yh=new Float64Array([-0]),It=new Uint8Array(Yh.buffer);function ow(n,t,e){Yh[0]=n,t[e]=It[0],t[e+1]=It[1],t[e+2]=It[2],t[e+3]=It[3],t[e+4]=It[4],t[e+5]=It[5],t[e+6]=It[6],t[e+7]=It[7]}function aw(n,t){return It[0]=n[t],It[1]=n[t+1],It[2]=n[t+2],It[3]=n[t+3],It[4]=n[t+4],It[5]=n[t+5],It[6]=n[t+6],It[7]=n[t+7],Yh[0]}const cw=BigInt(Number.MAX_SAFE_INTEGER),lw=BigInt(Number.MIN_SAFE_INTEGER);class xt{constructor(t,e){u(this,"lo");u(this,"hi");this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(e+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(BigInt(e)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){const t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){const t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){const t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:r<128?9:10}static fromBigInt(t){if(t===0n)return Ns;if(t<cw&&t>lw)return this.fromNumber(Number(t));const e=t<0n;e&&(t=-t);let r=t>>32n,s=t-(r<<32n);return e&&(r=~r|0n,s=~s|0n,++s>Nf&&(s=0n,++r>Nf&&(r=0n))),new xt(Number(s),Number(r))}static fromNumber(t){if(t===0)return Ns;const e=t<0;e&&(t=-t);let r=t>>>0,s=(t-r)/4294967296>>>0;return e&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new xt(r,s)}static from(t){return typeof t=="number"?xt.fromNumber(t):typeof t=="bigint"?xt.fromBigInt(t):typeof t=="string"?xt.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new xt(t.low>>>0,t.high>>>0):Ns}}const Ns=new xt(0,0);Ns.toBigInt=function(){return 0n};Ns.zzEncode=Ns.zzDecode=function(){return this};Ns.length=function(){return 1};const Nf=4294967296n;function uw(n){let t=0,e=0;for(let r=0;r<n.length;++r)e=n.charCodeAt(r),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,t+=4):t+=3;return t}function hw(n,t,e){if(e-t<1)return"";let s;const i=[];let o=0,a;for(;t<e;)a=n[t++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|n[t++]&63:a>239&&a<365?(a=((a&7)<<18|(n[t++]&63)<<12|(n[t++]&63)<<6|n[t++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(n[t++]&63)<<6|n[t++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function G4(n,t,e){const r=e;let s,i;for(let o=0;o<n.length;++o)s=n.charCodeAt(o),s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128);return e-r}function pn(n,t){return RangeError(`index out of range: ${n.pos} + ${t??1} > ${n.len}`)}function Ja(n,t){return(n[t-4]|n[t-3]<<8|n[t-2]<<16|n[t-1]<<24)>>>0}class dw{constructor(t){u(this,"buf");u(this,"pos");u(this,"len");u(this,"_slice",Uint8Array.prototype.subarray);this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,pn(this,10);return t}int32(){return this.uint32()|0}sint32(){const t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw pn(this,4);return Ja(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw pn(this,4);return Ja(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw pn(this,4);const t=iw(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw pn(this,4);const t=aw(this.buf,this.pos);return this.pos+=8,t}bytes(){const t=this.uint32(),e=this.pos,r=this.pos+t;if(r>this.len)throw pn(this,t);return this.pos+=t,e===r?new Uint8Array(0):this.buf.subarray(e,r)}string(){const t=this.bytes();return hw(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw pn(this,t);this.pos+=t}else do if(this.pos>=this.len)throw pn(this);while(this.buf[this.pos++]&128);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){const t=new xt(0,0);let e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw pn(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw pn(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw pn(this,8);const t=Ja(this.buf,this.pos+=4),e=Ja(this.buf,this.pos+=4);return new xt(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const t=V4(this.buf,this.pos);return this.pos+=He(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function fw(n){return new dw(n instanceof Uint8Array?n:n.subarray())}function ue(n,t,e){const r=fw(n);return t.decode(r,void 0,e)}const gw=Na({prefix:"9",name:"base10",alphabet:"0123456789"}),pw=Object.freeze(Object.defineProperty({__proto__:null,base10:gw},Symbol.toStringTag,{value:"Module"})),yw=St({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),mw=St({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),ww=Object.freeze(Object.defineProperty({__proto__:null,base16:yw,base16upper:mw},Symbol.toStringTag,{value:"Module"})),bw=St({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Ew=Object.freeze(Object.defineProperty({__proto__:null,base2:bw},Symbol.toStringTag,{value:"Module"})),Y4=Array.from(""),_w=Y4.reduce((n,t,e)=>(n[e]=t,n),[]),vw=Y4.reduce((n,t,e)=>{const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);return n[r]=e,n},[]);function Sw(n){return n.reduce((t,e)=>(t+=_w[e],t),"")}function Rw(n){const t=[];for(const e of n){const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);const s=vw[r];if(s==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(s)}return new Uint8Array(t)}const Aw=Pl({prefix:"",name:"base256emoji",encode:Sw,decode:Rw}),Iw=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Aw},Symbol.toStringTag,{value:"Module"})),ln=St({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),kw=St({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Q4=St({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),xw=St({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Tw=Object.freeze(Object.defineProperty({__proto__:null,base64:ln,base64pad:kw,base64url:Q4,base64urlpad:xw},Symbol.toStringTag,{value:"Module"})),Dw=St({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Cw=Object.freeze(Object.defineProperty({__proto__:null,base8:Dw},Symbol.toStringTag,{value:"Module"})),Nw=Pl({prefix:"\0",name:"identity",encode:n=>iy(n),decode:n=>sy(n)}),Lw=Object.freeze(Object.defineProperty({__proto__:null,identity:Nw},Symbol.toStringTag,{value:"Module"}));new TextEncoder;const Pw=new TextDecoder,X4=512;function Ow(n){return JSON.parse(Pw.decode(n))}const Bw="raw",Wn=85;function Mw(n){return Eo(n)}function Uw(n){return Eo(n)}const $w=Object.freeze(Object.defineProperty({__proto__:null,code:Wn,decode:Uw,encode:Mw,name:Bw},Symbol.toStringTag,{value:"Module"})),Z4=0,Fw="identity",j4=Eo;function Vw(n){return Os(Z4,j4(n))}const Er={code:Z4,name:Fw,encode:j4,digest:Vw},Ms={...Lw,...Ew,...Cw,...pw,...ww,...Sy,...Ay,...ky,...Tw,...Iw};function J4(n,t,e,r){return{name:n,prefix:t,encoder:{name:n,prefix:t,encode:e},decoder:{decode:r}}}const Lf=J4("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),Eu=J4("ascii","a",n=>{let t="a";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return t},n=>{n=n.substring(1);const t=Jt(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}),e6={utf8:Lf,"utf-8":Lf,hex:Ms.base16,latin1:Eu,ascii:Eu,binary:Eu,...Ms};function V(n,t="utf8"){const e=e6[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${n}`)}function Hw(n){let r,s=8192;return function(o){if(o<1||o>4096)return Jt(o);s+o>8192&&(r=Jt(8192),s=0);const a=r.subarray(s,s+=o);return s&7&&(s=(s|7)+1),a}}class Uo{constructor(t,e,r){u(this,"fn");u(this,"len");u(this,"next");u(this,"val");this.fn=t,this.len=e,this.next=void 0,this.val=r}}function _u(){}class Kw{constructor(t){u(this,"head");u(this,"tail");u(this,"len");u(this,"next");this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}}const zw=Hw();function qw(n){return globalThis.Buffer!=null?Jt(n):zw(n)}class h1{constructor(){u(this,"len");u(this,"head");u(this,"tail");u(this,"states");this.len=0,this.head=new Uo(_u,0,0),this.tail=this.head,this.states=null}_push(t,e,r){return this.tail=this.tail.next=new Uo(t,e,r),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new Gw((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(ec,10,xt.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){const e=xt.fromBigInt(t);return this._push(ec,e.length(),e)}uint64Number(t){return this._push(F4,He(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){const e=xt.fromBigInt(t).zzEncode();return this._push(ec,e.length(),e)}sint64Number(t){const e=xt.fromNumber(t).zzEncode();return this._push(ec,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(vu,1,t?1:0)}fixed32(t){return this._push(Co,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){const e=xt.fromBigInt(t);return this._push(Co,4,e.lo)._push(Co,4,e.hi)}fixed64Number(t){const e=xt.fromNumber(t);return this._push(Co,4,e.lo)._push(Co,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(sw,4,t)}double(t){return this._push(ow,8,t)}bytes(t){const e=t.length>>>0;return e===0?this._push(vu,1,0):this.uint32(e)._push(Yw,e,t)}string(t){const e=uw(t);return e!==0?this.uint32(e)._push(G4,e,t):this._push(vu,1,0)}fork(){return this.states=new Kw(this),this.head=this.tail=new Uo(_u,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Uo(_u,0,0),this.len=0),this}ldelim(){const t=this.head,e=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=t.next,this.tail=e,this.len+=r),this}finish(){let t=this.head.next;const e=qw(this.len);let r=0;for(;t!=null;)t.fn(t.val,e,r),r+=t.len,t=t.next;return e}}function vu(n,t,e){t[e]=n&255}function Ww(n,t,e){for(;n>127;)t[e++]=n&127|128,n>>>=7;t[e]=n}class Gw extends Uo{constructor(e,r){super(Ww,e,r);u(this,"next");this.next=void 0}}function ec(n,t,e){for(;n.hi!==0;)t[e++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)t[e++]=n.lo&127|128,n.lo=n.lo>>>7;t[e++]=n.lo}function Co(n,t,e){t[e]=n&255,t[e+1]=n>>>8&255,t[e+2]=n>>>16&255,t[e+3]=n>>>24}function Yw(n,t,e){t.set(n,e)}globalThis.Buffer!=null&&(h1.prototype.bytes=function(n){const t=n.length>>>0;return this.uint32(t),t>0&&this._push(Qw,t,n),this},h1.prototype.string=function(n){const t=globalThis.Buffer.byteLength(n);return this.uint32(t),t>0&&this._push(Xw,t,n),this});function Qw(n,t,e){t.set(n,e)}function Xw(n,t,e){n.length<40?G4(n,t,e):t.utf8Write!=null?t.utf8Write(n,e):t.set(V(n),e)}function Zw(){return new h1}function he(n,t){const e=Zw();return t.encode(n,e,{lengthDelimited:!1}),e.finish()}var Wc;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(Wc||(Wc={}));function t6(n,t,e,r){return{name:n,type:t,encode:e,decode:r}}function Mt(n){function t(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const e=function(i,o){const a=t(i);o.int32(a)},r=function(i){const o=i.int32();return t(o)};return t6("enum",Wc.VARINT,e,r)}function de(n,t){return t6("message",Wc.LENGTH_DELIMITED,n,t)}let Us=class extends Error{constructor(e,r){super(e);u(this,"code");this.code=r}};var ht;(function(n){n.WantBlock="WantBlock",n.WantHave="WantHave"})(ht||(ht={}));var d1;(function(n){n[n.WantBlock=0]="WantBlock",n[n.WantHave=1]="WantHave"})(d1||(d1={}));(function(n){n.codec=()=>Mt(d1)})(ht||(ht={}));var oa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.cid!=null&&e.cid.byteLength>0&&(r.uint32(10),r.bytes(e.cid)),e.priority!=null&&e.priority!==0&&(r.uint32(16),r.int32(e.priority)),e.cancel!=null&&(r.uint32(24),r.bool(e.cancel)),e.wantType!=null&&(r.uint32(32),ht.codec().encode(e.wantType,r)),e.sendDontHave!=null&&(r.uint32(40),r.bool(e.sendDontHave)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={cid:Pe(0),priority:0},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.cid=e.bytes();break}case 2:{i.priority=e.int32();break}case 3:{i.cancel=e.bool();break}case 4:{i.wantType=ht.codec().decode(e);break}case 5:{i.sendDontHave=e.bool();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(oa||(oa={}));var Gc;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.entries!=null)for(const i of e.entries)r.uint32(10),oa.codec().encode(i,r);e.full!=null&&(r.uint32(16),r.bool(e.full)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a,c;const i={entries:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const l=e.uint32();switch(l>>>3){case 1:{if(((a=s.limits)==null?void 0:a.entries)!=null&&i.entries.length===s.limits.entries)throw new Us('decode error - map field "entries" had too many elements',"ERR_MAX_LENGTH");i.entries.push(oa.codec().decode(e,e.uint32(),{limits:(c=s.limits)==null?void 0:c.entries$}));break}case 2:{i.full=e.bool();break}default:{e.skipType(l&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(Gc||(Gc={}));var aa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.prefix!=null&&e.prefix.byteLength>0&&(r.uint32(10),r.bytes(e.prefix)),e.data!=null&&e.data.byteLength>0&&(r.uint32(18),r.bytes(e.data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={prefix:Pe(0),data:Pe(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.prefix=e.bytes();break}case 2:{i.data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(aa||(aa={}));var Hn;(function(n){n.HaveBlock="HaveBlock",n.DontHaveBlock="DontHaveBlock"})(Hn||(Hn={}));var Yc;(function(n){n[n.HaveBlock=0]="HaveBlock",n[n.DontHaveBlock=1]="DontHaveBlock"})(Yc||(Yc={}));(function(n){n.codec=()=>Mt(Yc)})(Hn||(Hn={}));var ca;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.cid!=null&&e.cid.byteLength>0&&(r.uint32(10),r.bytes(e.cid)),e.type!=null&&Yc[e.type]!==0&&(r.uint32(16),Hn.codec().encode(e.type,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={cid:Pe(0),type:Hn.HaveBlock},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.cid=e.bytes();break}case 2:{i.type=Hn.codec().decode(e);break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(ca||(ca={}));var la;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.wantlist!=null&&(r.uint32(10),Gc.codec().encode(e.wantlist,r)),e.blocks!=null)for(const i of e.blocks)r.uint32(26),aa.codec().encode(i,r);if(e.blockPresences!=null)for(const i of e.blockPresences)r.uint32(34),ca.codec().encode(i,r);e.pendingBytes!=null&&e.pendingBytes!==0&&(r.uint32(40),r.int32(e.pendingBytes)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a,c,l,h,d;const i={blocks:[],blockPresences:[],pendingBytes:0},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const f=e.uint32();switch(f>>>3){case 1:{i.wantlist=Gc.codec().decode(e,e.uint32(),{limits:(a=s.limits)==null?void 0:a.wantlist});break}case 3:{if(((c=s.limits)==null?void 0:c.blocks)!=null&&i.blocks.length===s.limits.blocks)throw new Us('decode error - map field "blocks" had too many elements',"ERR_MAX_LENGTH");i.blocks.push(aa.codec().decode(e,e.uint32(),{limits:(l=s.limits)==null?void 0:l.blocks$}));break}case 4:{if(((h=s.limits)==null?void 0:h.blockPresences)!=null&&i.blockPresences.length===s.limits.blockPresences)throw new Us('decode error - map field "blockPresences" had too many elements',"ERR_MAX_LENGTH");i.blockPresences.push(ca.codec().decode(e,e.uint32(),{limits:(d=s.limits)==null?void 0:d.blockPresences$}));break}case 5:{i.pendingBytes=e.int32();break}default:{e.skipType(f&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(la||(la={}));function jw(n,t){for(const[e,r]of t.wantlist.entries()){const s=n.wantlist.get(e);s!=null&&(s.priority>r.priority&&(r.priority=s.priority),r.cancel=r.cancel??s.cancel,r.wantType=r.wantType??s.wantType,r.sendDontHave=r.sendDontHave??s.sendDontHave),n.wantlist.set(e,r)}for(const[e,r]of t.blockPresences.entries())n.blockPresences.set(e,r);for(const[e,r]of t.blocks.entries())n.blocks.set(e,r);return t.full&&!n.full&&(n.full=!0),n}const Jw=4193648,eb=Jw+16;function*tb(n,t){const e=[...n.wantlist.values()],r=[...n.blockPresences.values()],s=[...n.blocks.values()];let i=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:n.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let h=la.encode(l).byteLength,{added:d,hasMore:f,newSize:p}=Su(s,l.blocks,a,t,h,nb);a+=d,h=p;const m=f;({added:d,hasMore:f,newSize:p}=Su(r,l.blockPresences,o,t,h,rb)),o+=d,h=p;const g=f;if({added:d,hasMore:f,newSize:p}=Su(e,l.wantlist.entries,i,t,h,sb),i+=d,h=p,c=!m&&!g&&!f,c||(l.wantlist.full=!1),yield la.encode(l),c)break}}function Su(n,t,e,r,s,i){let o=0,a=!1;for(let c=e;c<n.length;c++){const l=n[c],h=i(l);if(h>eb)throw new E("Cannot send block as after encoding it is over the max message size","ERR_BLOCK_TOO_LARGE");const d=s+h;if(d>r){a=!0;break}t.push(l),o++,s=d}return{hasMore:a,added:o,newSize:s}}function nb(n){return Qh(3,aa.encode(n))}function rb(n){return Qh(4,ca.encode(n))}function sb(n){return Qh(1,oa.encode(n))}function Qh(n,t){const e=He(n),r=He(t.byteLength);return e+r+t.byteLength}let ib=class extends _t{constructor(e,r={}){var s,i;super();u(this,"log");u(this,"libp2p");u(this,"routing");u(this,"protocols");u(this,"running");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"messageReceiveTimeout");u(this,"registrarIds");u(this,"metrics");u(this,"sendQueue");u(this,"runOnTransientConnections");u(this,"maxOutgoingMessageSize");u(this,"maxIncomingMessageSize");this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=r.protocols??[ja],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=r.maxInboundStreams??Xm,this.maxOutboundStreams=r.maxOutboundStreams??Zm,this.messageReceiveTimeout=r.messageReceiveTimeout??jm,this.runOnTransientConnections=r.runOnTransientConnections??tw,this.maxIncomingMessageSize=r.maxIncomingMessageSize??W4,this.maxOutgoingMessageSize=r.maxOutgoingMessageSize??r.maxIncomingMessageSize??rw,this.metrics={blocksSent:(s=e.metrics)==null?void 0:s.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:(i=e.metrics)==null?void 0:i.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new So({concurrency:r.messageSendConcurrency??ew,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",o=>{this.log.error("error sending wantlist to peer",o.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnections});const e={onConnect:r=>{this.safeDispatchEvent("peer:connected",{detail:r})},onDisconnect:r=>{this.safeDispatchEvent("peer:disconnected",{detail:r})}};this.registrarIds=[];for(const r of this.protocols)this.registrarIds.push(await this.libp2p.register(r,e));this.libp2p.getConnections().forEach(r=>{this.safeDispatchEvent("peer:connected",{detail:r.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:r,connection:s}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",r.protocol,s.remotePeer);const i=()=>{r.status==="open"?r.abort(new E(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`,"ERR_TIMEOUT")):this.log("stream aborted with status %s",r.status)};let o=AbortSignal.timeout(this.messageReceiveTimeout);j(1/0,o),o.addEventListener("abort",i),await r.closeWrite(),await vt(r,a=>ts(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(const c of a)try{const l=la.decode(c);this.log("incoming new bitswap %s message from %p on stream",r.protocol,s.remotePeer,r.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:s.remotePeer,message:l}}),o.removeEventListener("abort",i),o=AbortSignal.timeout(this.messageReceiveTimeout),j(1/0,o),o.addEventListener("abort",i)}catch(l){this.log.error("error reading incoming bitswap message from %p on stream",s.remotePeer,r.id,l),r.abort(l);break}})}).catch(i=>{this.log.error("error handling incoming stream from %p",s.remotePeer,i),r.abort(i)})}async*findProviders(e,r){var s;(s=r==null?void 0:r.onProgress)==null||s.call(r,new G("bitswap:network:find-providers",e));for await(const i of this.routing.findProviders(e,r))await this.libp2p.isDialable(i.multiaddrs,{runOnTransientConnection:this.runOnTransientConnections})&&(yield i)}async findAndConnect(e,r){await Bs(vr(qc(this.findProviders(e,r),(r==null?void 0:r.maxProviders)??nw),async s=>this.connectTo(s.id,r))).catch(s=>{this.log.error(s)})}async sendMessage(e,r,s){if(!this.running)throw new Error("network isn't running");const i=this.sendQueue.queue.find(o=>e.equals(o.options.peerId)&&o.status==="queued");if(i!=null){i.options.message=jw(i.options.message,r),await i.join({signal:s==null?void 0:s.signal});return}await this.sendQueue.add(async o=>{var l,h;const a=o==null?void 0:o.message;if(a==null)throw new E("No message to send","ERR_NO_MESSAGE");this.log("sendMessage to %p",e),(l=o==null?void 0:o.onProgress)==null||l.call(o,new G("bitswap:network:send-wantlist",e));const c=await this.libp2p.dialProtocol(e,ja,o);await c.closeRead();try{await vt(tb(a,this.maxOutgoingMessageSize),d=>es(d),c),await c.close(o)}catch(d){(h=o==null?void 0:o.onProgress)==null||h.call(o,new G("bitswap:network:send-wantlist:error",{peer:e,error:d})),this.log.error("error sending message to %p",e,d),c.abort(d)}this._updateSentStats(a.blocks)},{peerId:e,signal:s==null?void 0:s.signal,message:r})}async connectTo(e,r){var i;if(!this.running)throw new E("Network isn't running","ERR_NOT_STARTED");(i=r==null?void 0:r.onProgress)==null||i.call(r,new G("bitswap:network:dial",e));const[s]=await Promise.all([this.libp2p.dial(e,r),pr(this.libp2p,"peer:identify",r==null?void 0:r.signal,{filter:o=>{if(!o.detail.peerId.equals(e))return!1;if(o.detail.protocols.includes(ja))return!0;throw new E(`${e} did not support ${ja}`,"ERR_BITSWAP_UNSUPPORTED_BY_PEER")}})]);return s}_updateSentStats(e){var s,i;let r=0;for(const o of e.values())r+=o.data.byteLength;(s=this.metrics.dataSent)==null||s.increment(r),(i=this.metrics.blocksSent)==null||i.increment(e.size)}};function W(n,t="utf8"){const e=e6[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(n).substring(1)}const n6=Symbol.for("nodejs.util.inspect.custom"),ob=Object.values(Ms).map(n=>n.decoder).reduce((n,t)=>n.or(t),Ms.identity.decoder),r6=114,Xh=36,Zh=37;var r3;class jh{constructor(t){u(this,"type");u(this,"multihash");u(this,"privateKey");u(this,"publicKey");u(this,"string");u(this,r3,!0);this.type=t.type,this.multihash=t.multihash,this.privateKey=t.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=kt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Q.createV1(r6,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(t){var e;if(t==null)return!1;if(t instanceof Uint8Array)return ve(this.multihash.bytes,t);if(typeof t=="string")return Je(t).equals(this);if(((e=t==null?void 0:t.multihash)==null?void 0:e.bytes)!=null)return ve(this.multihash.bytes,t.multihash.bytes);throw new Error("not valid Id")}[(r3=Ol,n6)](){return`PeerId(${this.toString()})`}}class Pa extends jh{constructor(e){super({...e,type:"RSA"});u(this,"type","RSA");u(this,"publicKey");this.publicKey=e.publicKey}}class Oa extends jh{constructor(e){super({...e,type:"Ed25519"});u(this,"type","Ed25519");u(this,"publicKey");this.publicKey=e.multihash.digest}}class Ba extends jh{constructor(e){super({...e,type:"secp256k1"});u(this,"type","secp256k1");u(this,"publicKey");this.publicKey=e.multihash.digest}}const f1=2336;var s3,i3;class ab{constructor(t){u(this,"type","url");u(this,"multihash");u(this,"privateKey");u(this,"publicKey");u(this,"url");u(this,s3,!0);this.url=t.toString(),this.multihash=Er.digest(V(this.url))}[(i3=n6,s3=Ol,i3)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return Q.createV1(f1,this.multihash)}toBytes(){return this.toCID().bytes}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=W(t)),t.toString()===this.toString())}}function cb(n){if(n.type==="RSA")return new Pa(n);if(n.type==="Ed25519")return new Oa(n);if(n.type==="secp256k1")return new Ba(n);throw new E("Not a PeerId","ERR_INVALID_PARAMETERS")}function Je(n,t){if(n.charAt(0)==="1"||n.charAt(0)==="Q"){const e=cs(kt.decode(`z${n}`));return n.startsWith("12D")?new Oa({multihash:e}):n.startsWith("16U")?new Ba({multihash:e}):new Pa({multihash:e})}return Rn(ob.decode(n))}function Rn(n){try{const t=cs(n);if(t.code===Er.code){if(t.digest.length===Xh)return new Oa({multihash:t});if(t.digest.length===Zh)return new Ba({multihash:t})}if(t.code===We.code)return new Pa({multihash:t})}catch{return lb(Q.decode(n))}throw new Error("Supplied PeerID CID is invalid")}function lb(n){if((n==null?void 0:n.multihash)==null||n.version==null||n.version===1&&n.code!==r6&&n.code!==f1)throw new Error("Supplied PeerID CID is invalid");if(n.code===f1){const e=W(n.multihash.digest);return new ab(new URL(e))}const t=n.multihash;if(t.code===We.code)return new Pa({multihash:n.multihash});if(t.code===Er.code){if(t.digest.length===Xh)return new Oa({multihash:n.multihash});if(t.digest.length===Zh)return new Ba({multihash:n.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function Gn(n,t){return n.length===Xh?new Oa({multihash:Os(Er.code,n),privateKey:t}):n.length===Zh?new Ba({multihash:Os(Er.code,n),privateKey:t}):new Pa({multihash:await We.digest(n),publicKey:n,privateKey:t})}function Qc(n,t){const e={[Symbol.iterator]:()=>e,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:t(s)}}};return e}class Sr{constructor(t){u(this,"map");if(this.map=new Map,t!=null)for(const[e,r]of t.entries())this.map.set(e.toString(),r)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return Qc(this.map.entries(),t=>[Je(t[0]),t[1]])}forEach(t){this.map.forEach((e,r)=>{t(e,Je(r),this)})}get(t){return this.map.get(t.toString())}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),e)}keys(){return Qc(this.map.keys(),t=>Je(t))}values(){return this.map.values()}get size(){return this.map.size}}class _n{constructor(t){u(this,"set");if(this.set=new Set,t!=null)for(const e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return Qc(this.set.entries(),t=>{const e=Je(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{const r=Je(e);t(r,r,this)})}has(t){return this.set.has(t.toString())}values(){return Qc(this.set.values(),t=>Je(t))}intersection(t){const e=new _n;for(const r of t)this.has(r)&&e.add(r);return e}difference(t){const e=new _n;for(const r of this)t.has(r)||e.add(r);return e}union(t){const e=new _n;for(const r of t)e.add(r);for(const r of this)e.add(r);return e}}const hn={get(n=globalThis){const t=n.crypto;if((t==null?void 0:t.subtle)==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return t}};function us(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function bi(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function ub(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function $l(n,...t){if(!ub(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${n.length}`)}function Fl(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");bi(n.outputLen),bi(n.blockLen)}function Xc(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function hb(n,t){$l(n);const e=t.outputLen;if(n.length<e)throw new Error(`digestInto() expects output buffer of length at least ${e}`)}const ni=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Wo=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),xn=(n,t)=>n<<32-t|n>>>t,Ru=(n,t)=>n<<t|n>>>32-t>>>0;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const db=async()=>{};async function fb(n,t,e){let r=Date.now();for(let s=0;s<n;s++){e(s);const i=Date.now()-r;i>=0&&i<t||(await db(),r+=i)}}function gb(n){if(typeof n!="string")throw new Error(`utf8ToBytes expected string, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function $s(n){return typeof n=="string"&&(n=gb(n)),$l(n),n}function pb(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];$l(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}class s6{clone(){return this._cloneInto()}}const yb={}.toString;function mb(n,t){if(t!==void 0&&yb.call(t)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(n,t)}function Jh(n){const t=r=>n().update($s(r)).digest(),e=n();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>n(),t}function Vl(n=32){if(ni&&typeof ni.getRandomValues=="function")return ni.getRandomValues(new Uint8Array(n));if(ni&&typeof ni.randomBytes=="function")return ni.randomBytes(n);throw new Error("crypto.getRandomValues must be defined")}function wb(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),c=r?4:0,l=r?0:4;n.setUint32(t+c,o,r),n.setUint32(t+l,a,r)}const i6=(n,t,e)=>n&t^~n&e,o6=(n,t,e)=>n&t^n&e^t&e;class ed extends s6{constructor(t,e,r,s){super(),this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=Wo(this.buffer)}update(t){Xc(this);const{view:e,buffer:r,blockLen:s}=this;t=$s(t);const i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=Wo(t);for(;s<=i-o;o+=s)this.process(c,o);continue}r.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Xc(this),hb(t,this),this.finished=!0;const{buffer:e,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;e[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let d=o;d<s;d++)e[d]=0;wb(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=Wo(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<l;d++)a.setUint32(4*d,h[d],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return t.length=s,t.pos=a,t.finished=i,t.destroyed=o,s%e&&t.buffer.set(r),t}}const tc=BigInt(2**32-1),g1=BigInt(32);function a6(n,t=!1){return t?{h:Number(n&tc),l:Number(n>>g1&tc)}:{h:Number(n>>g1&tc)|0,l:Number(n&tc)|0}}function bb(n,t=!1){let e=new Uint32Array(n.length),r=new Uint32Array(n.length);for(let s=0;s<n.length;s++){const{h:i,l:o}=a6(n[s],t);[e[s],r[s]]=[i,o]}return[e,r]}const Eb=(n,t)=>BigInt(n>>>0)<<g1|BigInt(t>>>0),_b=(n,t,e)=>n>>>e,vb=(n,t,e)=>n<<32-e|t>>>e,Sb=(n,t,e)=>n>>>e|t<<32-e,Rb=(n,t,e)=>n<<32-e|t>>>e,Ab=(n,t,e)=>n<<64-e|t>>>e-32,Ib=(n,t,e)=>n>>>e-32|t<<64-e,kb=(n,t)=>t,xb=(n,t)=>n,Tb=(n,t,e)=>n<<e|t>>>32-e,Db=(n,t,e)=>t<<e|n>>>32-e,Cb=(n,t,e)=>t<<e-32|n>>>64-e,Nb=(n,t,e)=>n<<e-32|t>>>64-e;function Lb(n,t,e,r){const s=(t>>>0)+(r>>>0);return{h:n+e+(s/2**32|0)|0,l:s|0}}const Pb=(n,t,e)=>(n>>>0)+(t>>>0)+(e>>>0),Ob=(n,t,e,r)=>t+e+r+(n/2**32|0)|0,Bb=(n,t,e,r)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0),Mb=(n,t,e,r,s)=>t+e+r+s+(n/2**32|0)|0,Ub=(n,t,e,r,s)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0)+(s>>>0),$b=(n,t,e,r,s,i)=>t+e+r+s+i+(n/2**32|0)|0,ae={fromBig:a6,split:bb,toBig:Eb,shrSH:_b,shrSL:vb,rotrSH:Sb,rotrSL:Rb,rotrBH:Ab,rotrBL:Ib,rotr32H:kb,rotr32L:xb,rotlSH:Tb,rotlSL:Db,rotlBH:Cb,rotlBL:Nb,add:Lb,add3L:Pb,add3H:Ob,add4L:Bb,add4H:Mb,add5H:$b,add5L:Ub},[Fb,Vb]=ae.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),Dr=new Uint32Array(80),Cr=new Uint32Array(80);class Hb extends ed{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:t,Al:e,Bh:r,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:d,Fl:f,Gh:p,Gl:m,Hh:g,Hl:y}=this;return[t,e,r,s,i,o,a,c,l,h,d,f,p,m,g,y]}set(t,e,r,s,i,o,a,c,l,h,d,f,p,m,g,y){this.Ah=t|0,this.Al=e|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=d|0,this.Fl=f|0,this.Gh=p|0,this.Gl=m|0,this.Hh=g|0,this.Hl=y|0}process(t,e){for(let b=0;b<16;b++,e+=4)Dr[b]=t.getUint32(e),Cr[b]=t.getUint32(e+=4);for(let b=16;b<80;b++){const v=Dr[b-15]|0,A=Cr[b-15]|0,R=ae.rotrSH(v,A,1)^ae.rotrSH(v,A,8)^ae.shrSH(v,A,7),k=ae.rotrSL(v,A,1)^ae.rotrSL(v,A,8)^ae.shrSL(v,A,7),C=Dr[b-2]|0,S=Cr[b-2]|0,B=ae.rotrSH(C,S,19)^ae.rotrBH(C,S,61)^ae.shrSH(C,S,6),O=ae.rotrSL(C,S,19)^ae.rotrBL(C,S,61)^ae.shrSL(C,S,6),M=ae.add4L(k,O,Cr[b-7],Cr[b-16]),U=ae.add4H(M,R,B,Dr[b-7],Dr[b-16]);Dr[b]=U|0,Cr[b]=M|0}let{Ah:r,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:d,El:f,Fh:p,Fl:m,Gh:g,Gl:y,Hh:w,Hl:_}=this;for(let b=0;b<80;b++){const v=ae.rotrSH(d,f,14)^ae.rotrSH(d,f,18)^ae.rotrBH(d,f,41),A=ae.rotrSL(d,f,14)^ae.rotrSL(d,f,18)^ae.rotrBL(d,f,41),R=d&p^~d&g,k=f&m^~f&y,C=ae.add5L(_,A,k,Vb[b],Cr[b]),S=ae.add5H(C,w,v,R,Fb[b],Dr[b]),B=C|0,O=ae.rotrSH(r,s,28)^ae.rotrBH(r,s,34)^ae.rotrBH(r,s,39),M=ae.rotrSL(r,s,28)^ae.rotrBL(r,s,34)^ae.rotrBL(r,s,39),U=r&i^r&a^i&a,N=s&o^s&c^o&c;w=g|0,_=y|0,g=p|0,y=m|0,p=d|0,m=f|0,{h:d,l:f}=ae.add(l|0,h|0,S|0,B|0),l=a|0,h=c|0,a=i|0,c=o|0,i=r|0,o=s|0;const D=ae.add3L(B,M,N);r=ae.add3H(D,S,O,U),s=D|0}({h:r,l:s}=ae.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:o}=ae.add(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=ae.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=ae.add(this.Dh|0,this.Dl|0,l|0,h|0),{h:d,l:f}=ae.add(this.Eh|0,this.El|0,d|0,f|0),{h:p,l:m}=ae.add(this.Fh|0,this.Fl|0,p|0,m|0),{h:g,l:y}=ae.add(this.Gh|0,this.Gl|0,g|0,y|0),{h:w,l:_}=ae.add(this.Hh|0,this.Hl|0,w|0,_|0),this.set(r,s,i,o,a,c,l,h,d,f,p,m,g,y,w,_)}roundClean(){Dr.fill(0),Cr.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Hl=Jh(()=>new Hb);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const td=BigInt(0),Kl=BigInt(1),Kb=BigInt(2);function Fs(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function Ma(n){if(!Fs(n))throw new Error("Uint8Array expected")}function mr(n,t){if(typeof t!="boolean")throw new Error(`${n} must be valid boolean, got "${t}".`)}const zb=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0"));function Vs(n){Ma(n);let t="";for(let e=0;e<n.length;e++)t+=zb[n[e]];return t}function oi(n){const t=n.toString(16);return t.length&1?`0${t}`:t}function nd(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return BigInt(n===""?"0":`0x${n}`)}const er={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Pf(n){if(n>=er._0&&n<=er._9)return n-er._0;if(n>=er._A&&n<=er._F)return n-(er._A-10);if(n>=er._a&&n<=er._f)return n-(er._a-10)}function Fi(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);const t=n.length,e=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(e);for(let s=0,i=0;s<e;s++,i+=2){const o=Pf(n.charCodeAt(i)),a=Pf(n.charCodeAt(i+1));if(o===void 0||a===void 0){const c=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}r[s]=o*16+a}return r}function Ls(n){return nd(Vs(n))}function Yr(n){return Ma(n),nd(Vs(Uint8Array.from(n).reverse()))}function Vi(n,t){return Fi(n.toString(16).padStart(t*2,"0"))}function Hi(n,t){return Vi(n,t).reverse()}function qb(n){return Fi(oi(n))}function tt(n,t,e){let r;if(typeof t=="string")try{r=Fi(t)}catch(i){throw new Error(`${n} must be valid hex string, got "${t}". Cause: ${i}`)}else if(Fs(t))r=Uint8Array.from(t);else throw new Error(`${n} must be hex string or Uint8Array`);const s=r.length;if(typeof e=="number"&&s!==e)throw new Error(`${n} expected ${e} bytes, got ${s}`);return r}function Hs(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];Ma(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}function Wb(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}function Gb(n){if(typeof n!="string")throw new Error(`utf8ToBytes expected string, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}const Au=n=>typeof n=="bigint"&&td<=n;function zl(n,t,e){return Au(n)&&Au(t)&&Au(e)&&t<=n&&n<e}function Wt(n,t,e,r){if(!zl(t,e,r))throw new Error(`expected valid ${n}: ${e} <= n < ${r}, got ${typeof t} ${t}`)}function c6(n){let t;for(t=0;n>td;n>>=Kl,t+=1);return t}function Yb(n,t){return n>>BigInt(t)&Kl}function Qb(n,t,e){return n|(e?Kl:td)<<BigInt(t)}const rd=n=>(Kb<<BigInt(n-1))-Kl,Iu=n=>new Uint8Array(n),Of=n=>Uint8Array.from(n);function l6(n,t,e){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let r=Iu(n),s=Iu(n),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...d)=>e(s,r,...d),c=(d=Iu())=>{s=a(Of([0]),d),r=a(),d.length!==0&&(s=a(Of([1]),d),r=a())},l=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const f=[];for(;d<t;){r=a();const p=r.slice();f.push(p),d+=r.length}return Hs(...f)};return(d,f)=>{o(),c(d);let p;for(;!(p=f(l()));)c();return o(),p}}const Xb={bigint:n=>typeof n=="bigint",function:n=>typeof n=="function",boolean:n=>typeof n=="boolean",string:n=>typeof n=="string",stringOrUint8Array:n=>typeof n=="string"||Fs(n),isSafeInteger:n=>Number.isSafeInteger(n),array:n=>Array.isArray(n),field:(n,t)=>t.Fp.isValid(n),hash:n=>typeof n=="function"&&Number.isSafeInteger(n.outputLen)};function js(n,t,e={}){const r=(s,i,o)=>{const a=Xb[i];if(typeof a!="function")throw new Error(`Invalid validator "${i}", expected function`);const c=n[s];if(!(o&&c===void 0)&&!a(c,n))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${i}`)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(e))r(s,i,!0);return n}const Zb=()=>{throw new Error("not implemented")};function ua(n){const t=new WeakMap;return(e,...r)=>{const s=t.get(e);if(s!==void 0)return s;const i=n(e,...r);return t.set(e,i),i}}const jb=Object.freeze(Object.defineProperty({__proto__:null,aInRange:Wt,abool:mr,abytes:Ma,bitGet:Yb,bitLen:c6,bitMask:rd,bitSet:Qb,bytesToHex:Vs,bytesToNumberBE:Ls,bytesToNumberLE:Yr,concatBytes:Hs,createHmacDrbg:l6,ensureBytes:tt,equalBytes:Wb,hexToBytes:Fi,hexToNumber:nd,inRange:zl,isBytes:Fs,memoized:ua,notImplemented:Zb,numberToBytesBE:Vi,numberToBytesLE:Hi,numberToHexUnpadded:oi,numberToVarBytesBE:qb,utf8ToBytes:Gb,validateObject:js},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ft=BigInt(0),Ye=BigInt(1),vs=BigInt(2),Jb=BigInt(3),p1=BigInt(4),Bf=BigInt(5),Mf=BigInt(8);BigInt(9);BigInt(16);function Me(n,t){const e=n%t;return e>=ft?e:t+e}function u6(n,t,e){if(e<=ft||t<ft)throw new Error("Expected power/modulo > 0");if(e===Ye)return ft;let r=Ye;for(;t>ft;)t&Ye&&(r=r*n%e),n=n*n%e,t>>=Ye;return r}function Ge(n,t,e){let r=n;for(;t-- >ft;)r*=r,r%=e;return r}function y1(n,t){if(n===ft||t<=ft)throw new Error(`invert: expected positive integers, got n=${n} mod=${t}`);let e=Me(n,t),r=t,s=ft,i=Ye;for(;e!==ft;){const a=r/e,c=r%e,l=s-i*a;r=e,e=c,s=i,i=l}if(r!==Ye)throw new Error("invert: does not exist");return Me(s,t)}function eE(n){const t=(n-Ye)/vs;let e,r,s;for(e=n-Ye,r=0;e%vs===ft;e/=vs,r++);for(s=vs;s<n&&u6(s,t,n)!==n-Ye;s++);if(r===1){const o=(n+Ye)/p1;return function(c,l){const h=c.pow(l,o);if(!c.eql(c.sqr(h),l))throw new Error("Cannot find square root");return h}}const i=(e+Ye)/vs;return function(a,c){if(a.pow(c,t)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=r,h=a.pow(a.mul(a.ONE,s),e),d=a.pow(c,i),f=a.pow(c,e);for(;!a.eql(f,a.ONE);){if(a.eql(f,a.ZERO))return a.ZERO;let p=1;for(let g=a.sqr(f);p<l&&!a.eql(g,a.ONE);p++)g=a.sqr(g);const m=a.pow(h,Ye<<BigInt(l-p-1));h=a.sqr(m),d=a.mul(d,m),f=a.mul(f,h),l=p}return d}}function tE(n){if(n%p1===Jb){const t=(n+Ye)/p1;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(n%Mf===Bf){const t=(n-Bf)/Mf;return function(r,s){const i=r.mul(s,vs),o=r.pow(i,t),a=r.mul(s,o),c=r.mul(r.mul(a,vs),o),l=r.mul(a,r.sub(c,r.ONE));if(!r.eql(r.sqr(l),s))throw new Error("Cannot find square root");return l}}return eE(n)}const nE=(n,t)=>(Me(n,t)&Ye)===Ye,rE=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function sE(n){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},e=rE.reduce((r,s)=>(r[s]="function",r),t);return js(n,e)}function iE(n,t,e){if(e<ft)throw new Error("Expected power > 0");if(e===ft)return n.ONE;if(e===Ye)return t;let r=n.ONE,s=t;for(;e>ft;)e&Ye&&(r=n.mul(r,s)),s=n.sqr(s),e>>=Ye;return r}function oE(n,t){const e=new Array(t.length),r=t.reduce((i,o,a)=>n.is0(o)?i:(e[a]=i,n.mul(i,o)),n.ONE),s=n.inv(r);return t.reduceRight((i,o,a)=>n.is0(o)?i:(e[a]=n.mul(i,e[a]),n.mul(i,o)),s),e}function h6(n,t){const e=t!==void 0?t:n.toString(2).length,r=Math.ceil(e/8);return{nBitLength:e,nByteLength:r}}function ql(n,t,e=!1,r={}){if(n<=ft)throw new Error(`Expected Field ORDER > 0, got ${n}`);const{nBitLength:s,nByteLength:i}=h6(n,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=tE(n),a=Object.freeze({ORDER:n,BITS:s,BYTES:i,MASK:rd(s),ZERO:ft,ONE:Ye,create:c=>Me(c,n),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return ft<=c&&c<n},is0:c=>c===ft,isOdd:c=>(c&Ye)===Ye,neg:c=>Me(-c,n),eql:(c,l)=>c===l,sqr:c=>Me(c*c,n),add:(c,l)=>Me(c+l,n),sub:(c,l)=>Me(c-l,n),mul:(c,l)=>Me(c*l,n),pow:(c,l)=>iE(a,c,l),div:(c,l)=>Me(c*y1(l,n),n),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>y1(c,n),sqrt:r.sqrt||(c=>o(a,c)),invertBatch:c=>oE(a,c),cmov:(c,l,h)=>h?l:c,toBytes:c=>e?Hi(c,i):Vi(c,i),fromBytes:c=>{if(c.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${c.length}`);return e?Yr(c):Ls(c)}});return Object.freeze(a)}function d6(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const t=n.toString(2).length;return Math.ceil(t/8)}function f6(n){const t=d6(n);return t+Math.ceil(t/2)}function aE(n,t,e=!1){const r=n.length,s=d6(t),i=f6(t);if(r<16||r<i||r>1024)throw new Error(`expected ${i}-1024 bytes of input, got ${r}`);const o=e?Ls(n):Yr(n),a=Me(o,t-Ye)+Ye;return e?Hi(a,s):Vi(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const cE=BigInt(0),ku=BigInt(1),xu=new WeakMap,Uf=new WeakMap;function g6(n,t){const e=(i,o)=>{const a=o.negate();return i?a:o},r=i=>{if(!Number.isSafeInteger(i)||i<=0||i>t)throw new Error(`Wrong window size=${i}, should be [1..${t}]`)},s=i=>{r(i);const o=Math.ceil(t/i)+1,a=2**(i-1);return{windows:o,windowSize:a}};return{constTimeNegate:e,unsafeLadder(i,o){let a=n.ZERO,c=i;for(;o>cE;)o&ku&&(a=a.add(c)),c=c.double(),o>>=ku;return a},precomputeWindow(i,o){const{windows:a,windowSize:c}=s(o),l=[];let h=i,d=h;for(let f=0;f<a;f++){d=h,l.push(d);for(let p=1;p<c;p++)d=d.add(h),l.push(d);h=d.double()}return l},wNAF(i,o,a){const{windows:c,windowSize:l}=s(i);let h=n.ZERO,d=n.BASE;const f=BigInt(2**i-1),p=2**i,m=BigInt(i);for(let g=0;g<c;g++){const y=g*l;let w=Number(a&f);a>>=m,w>l&&(w-=p,a+=ku);const _=y,b=y+Math.abs(w)-1,v=g%2!==0,A=w<0;w===0?d=d.add(e(v,o[_])):h=h.add(e(A,o[b]))}return{p:h,f:d}},wNAFCached(i,o,a){const c=Uf.get(i)||1;let l=xu.get(i);return l||(l=this.precomputeWindow(i,c),c!==1&&xu.set(i,a(l))),this.wNAF(c,l,o)},setWindowSize(i,o){r(o),Uf.set(i,o),xu.delete(i)}}}function p6(n,t,e,r){if(!Array.isArray(e)||!Array.isArray(r)||r.length!==e.length)throw new Error("arrays of points and scalars must have equal length");r.forEach((h,d)=>{if(!t.isValid(h))throw new Error(`wrong scalar at index ${d}`)}),e.forEach((h,d)=>{if(!(h instanceof n))throw new Error(`wrong point at index ${d}`)});const s=c6(BigInt(e.length)),i=s>12?s-3:s>4?s-2:s?2:1,o=(1<<i)-1,a=new Array(o+1).fill(n.ZERO),c=Math.floor((t.BITS-1)/i)*i;let l=n.ZERO;for(let h=c;h>=0;h-=i){a.fill(n.ZERO);for(let f=0;f<r.length;f++){const p=r[f],m=Number(p>>BigInt(h)&BigInt(o));a[m]=a[m].add(e[f])}let d=n.ZERO;for(let f=a.length-1,p=n.ZERO;f>0;f--)p=p.add(a[f]),d=d.add(p);if(l=l.add(d),h!==0)for(let f=0;f<i;f++)l=l.double()}return l}function sd(n){return sE(n.Fp),js(n,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...h6(n.n,n.nBitLength),...n,p:n.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const yn=BigInt(0),$t=BigInt(1),nc=BigInt(2),lE=BigInt(8),uE={zip215:!0};function hE(n){const t=sd(n);return js(n,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}function dE(n){const t=hE(n),{Fp:e,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:c}=t,l=nc<<BigInt(a*8)-$t,h=e.create,d=ql(t.n,t.nBitLength),f=t.uvRatio||((T,I)=>{try{return{isValid:!0,value:e.sqrt(T*e.inv(I))}}catch{return{isValid:!1,value:yn}}}),p=t.adjustScalarBytes||(T=>T),m=t.domain||((T,I,P)=>{if(mr("phflag",P),I.length||P)throw new Error("Contexts/pre-hash are not supported");return T});function g(T,I){Wt("coordinate "+T,I,yn,l)}function y(T){if(!(T instanceof b))throw new Error("ExtendedPoint expected")}const w=ua((T,I)=>{const{ex:P,ey:L,ez:$}=T,z=T.is0();I==null&&(I=z?lE:e.inv($));const q=h(P*I),te=h(L*I),ne=h($*I);if(z)return{x:yn,y:$t};if(ne!==$t)throw new Error("invZ was invalid");return{x:q,y:te}}),_=ua(T=>{const{a:I,d:P}=t;if(T.is0())throw new Error("bad point: ZERO");const{ex:L,ey:$,ez:z,et:q}=T,te=h(L*L),ne=h($*$),oe=h(z*z),ce=h(oe*oe),be=h(te*I),ye=h(oe*h(be+ne)),Le=h(ce+h(P*h(te*ne)));if(ye!==Le)throw new Error("bad point: equation left != right (1)");const rt=h(L*$),Ke=h(z*q);if(rt!==Ke)throw new Error("bad point: equation left != right (2)");return!0});class b{constructor(I,P,L,$){this.ex=I,this.ey=P,this.ez=L,this.et=$,g("x",I),g("y",P),g("z",L),g("t",$),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(I){if(I instanceof b)throw new Error("extended point not allowed");const{x:P,y:L}=I||{};return g("x",P),g("y",L),new b(P,L,$t,h(P*L))}static normalizeZ(I){const P=e.invertBatch(I.map(L=>L.ez));return I.map((L,$)=>L.toAffine(P[$])).map(b.fromAffine)}static msm(I,P){return p6(b,d,I,P)}_setWindowSize(I){R.setWindowSize(this,I)}assertValidity(){_(this)}equals(I){y(I);const{ex:P,ey:L,ez:$}=this,{ex:z,ey:q,ez:te}=I,ne=h(P*te),oe=h(z*$),ce=h(L*te),be=h(q*$);return ne===oe&&ce===be}is0(){return this.equals(b.ZERO)}negate(){return new b(h(-this.ex),this.ey,this.ez,h(-this.et))}double(){const{a:I}=t,{ex:P,ey:L,ez:$}=this,z=h(P*P),q=h(L*L),te=h(nc*h($*$)),ne=h(I*z),oe=P+L,ce=h(h(oe*oe)-z-q),be=ne+q,ye=be-te,Le=ne-q,rt=h(ce*ye),Ke=h(be*Le),Qe=h(ce*Le),lt=h(ye*be);return new b(rt,Ke,lt,Qe)}add(I){y(I);const{a:P,d:L}=t,{ex:$,ey:z,ez:q,et:te}=this,{ex:ne,ey:oe,ez:ce,et:be}=I;if(P===BigInt(-1)){const sf=h((z-$)*(oe+ne)),of=h((z+$)*(oe-ne)),fu=h(of-sf);if(fu===yn)return this.double();const af=h(q*nc*be),cf=h(te*nc*ce),lf=cf+af,uf=of+sf,hf=cf-af,w9=h(lf*fu),b9=h(uf*hf),E9=h(lf*hf),_9=h(fu*uf);return new b(w9,b9,_9,E9)}const ye=h($*ne),Le=h(z*oe),rt=h(te*L*be),Ke=h(q*ce),Qe=h(($+z)*(ne+oe)-ye-Le),lt=Ke-rt,st=Ke+rt,we=h(Le-P*ye),Rt=h(Qe*lt),p9=h(st*we),y9=h(Qe*we),m9=h(lt*st);return new b(Rt,p9,m9,y9)}subtract(I){return this.add(I.negate())}wNAF(I){return R.wNAFCached(this,I,b.normalizeZ)}multiply(I){const P=I;Wt("scalar",P,$t,r);const{p:L,f:$}=this.wNAF(P);return b.normalizeZ([L,$])[0]}multiplyUnsafe(I){const P=I;return Wt("scalar",P,yn,r),P===yn?A:this.equals(A)||P===$t?this:this.equals(v)?this.wNAF(P).p:R.unsafeLadder(this,P)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return R.unsafeLadder(this,r).is0()}toAffine(I){return w(this,I)}clearCofactor(){const{h:I}=t;return I===$t?this:this.multiplyUnsafe(I)}static fromHex(I,P=!1){const{d:L,a:$}=t,z=e.BYTES;I=tt("pointHex",I,z),mr("zip215",P);const q=I.slice(),te=I[z-1];q[z-1]=te&-129;const ne=Yr(q),oe=P?l:e.ORDER;Wt("pointHex.y",ne,yn,oe);const ce=h(ne*ne),be=h(ce-$t),ye=h(L*ce-$);let{isValid:Le,value:rt}=f(be,ye);if(!Le)throw new Error("Point.fromHex: invalid y coordinate");const Ke=(rt&$t)===$t,Qe=(te&128)!==0;if(!P&&rt===yn&&Qe)throw new Error("Point.fromHex: x=0 and x_0=1");return Qe!==Ke&&(rt=h(-rt)),b.fromAffine({x:rt,y:ne})}static fromPrivateKey(I){return S(I).point}toRawBytes(){const{x:I,y:P}=this.toAffine(),L=Hi(P,e.BYTES);return L[L.length-1]|=I&$t?128:0,L}toHex(){return Vs(this.toRawBytes())}}b.BASE=new b(t.Gx,t.Gy,$t,h(t.Gx*t.Gy)),b.ZERO=new b(yn,$t,$t,yn);const{BASE:v,ZERO:A}=b,R=g6(b,a*8);function k(T){return Me(T,r)}function C(T){return k(Yr(T))}function S(T){const I=a;T=tt("private key",T,I);const P=tt("hashed private key",i(T),2*I),L=p(P.slice(0,I)),$=P.slice(I,2*I),z=C(L),q=v.multiply(z),te=q.toRawBytes();return{head:L,prefix:$,scalar:z,point:q,pointBytes:te}}function B(T){return S(T).pointBytes}function O(T=new Uint8Array,...I){const P=Hs(...I);return C(i(m(P,tt("context",T),!!s)))}function M(T,I,P={}){T=tt("message",T),s&&(T=s(T));const{prefix:L,scalar:$,pointBytes:z}=S(I),q=O(P.context,L,T),te=v.multiply(q).toRawBytes(),ne=O(P.context,te,z,T),oe=k(q+ne*$);Wt("signature.s",oe,yn,r);const ce=Hs(te,Hi(oe,e.BYTES));return tt("result",ce,a*2)}const U=uE;function N(T,I,P,L=U){const{context:$,zip215:z}=L,q=e.BYTES;T=tt("signature",T,2*q),I=tt("message",I),z!==void 0&&mr("zip215",z),s&&(I=s(I));const te=Yr(T.slice(q,2*q));let ne,oe,ce;try{ne=b.fromHex(P,z),oe=b.fromHex(T.slice(0,q),z),ce=v.multiplyUnsafe(te)}catch{return!1}if(!z&&ne.isSmallOrder())return!1;const be=O($,oe.toRawBytes(),ne.toRawBytes(),I);return oe.add(ne.multiplyUnsafe(be)).subtract(ce).clearCofactor().equals(b.ZERO)}return v._setWindowSize(8),{CURVE:t,getPublicKey:B,sign:M,verify:N,ExtendedPoint:b,utils:{getExtendedPublicKey:S,randomPrivateKey:()=>o(e.BYTES),precompute(T=8,I=b.BASE){return I._setWindowSize(T),I.multiply(BigInt(3)),I}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ri=BigInt(0),Tu=BigInt(1);function fE(n){return js(n,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...n})}function gE(n){const t=fE(n),{P:e}=t,r=_=>Me(_,e),s=t.montgomeryBits,i=Math.ceil(s/8),o=t.nByteLength,a=t.adjustScalarBytes||(_=>_),c=t.powPminus2||(_=>u6(_,e-BigInt(2),e));function l(_,b,v){const A=r(_*(b-v));return b=r(b-A),v=r(v+A),[b,v]}const h=(t.a-BigInt(2))/BigInt(4);function d(_,b){Wt("u",_,ri,e),Wt("scalar",b,ri,e);const v=b,A=_;let R=Tu,k=ri,C=_,S=Tu,B=ri,O;for(let U=BigInt(s-1);U>=ri;U--){const N=v>>U&Tu;B^=N,O=l(B,R,C),R=O[0],C=O[1],O=l(B,k,S),k=O[0],S=O[1],B=N;const D=R+k,T=r(D*D),I=R-k,P=r(I*I),L=T-P,$=C+S,z=C-S,q=r(z*D),te=r($*I),ne=q+te,oe=q-te;C=r(ne*ne),S=r(A*r(oe*oe)),R=r(T*P),k=r(L*(T+r(h*L)))}O=l(B,R,C),R=O[0],C=O[1],O=l(B,k,S),k=O[0],S=O[1];const M=c(k);return r(R*M)}function f(_){return Hi(r(_),i)}function p(_){const b=tt("u coordinate",_,i);return o===32&&(b[31]&=127),Yr(b)}function m(_){const b=tt("scalar",_),v=b.length;if(v!==i&&v!==o)throw new Error(`Expected ${i} or ${o} bytes, got ${v}`);return Yr(a(b))}function g(_,b){const v=p(b),A=m(_),R=d(v,A);if(R===ri)throw new Error("Invalid private or public key received");return f(R)}const y=f(t.Gu);function w(_){return g(_,y)}return{scalarMult:g,scalarMultBase:w,getSharedSecret:(_,b)=>g(_,b),getPublicKey:_=>w(_),utils:{randomPrivateKey:()=>t.randomBytes(t.nByteLength)},GuBytes:y}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ha=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),$f=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const pE=BigInt(1),Ff=BigInt(2),yE=BigInt(3),mE=BigInt(5),wE=BigInt(8);function y6(n){const t=BigInt(10),e=BigInt(20),r=BigInt(40),s=BigInt(80),i=ha,a=n*n%i*n%i,c=Ge(a,Ff,i)*a%i,l=Ge(c,pE,i)*n%i,h=Ge(l,mE,i)*l%i,d=Ge(h,t,i)*h%i,f=Ge(d,e,i)*d%i,p=Ge(f,r,i)*f%i,m=Ge(p,s,i)*p%i,g=Ge(m,s,i)*p%i,y=Ge(g,t,i)*h%i;return{pow_p_5_8:Ge(y,Ff,i)*n%i,b2:a}}function m6(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}function bE(n,t){const e=ha,r=Me(t*t*t,e),s=Me(r*r*t,e),i=y6(n*s).pow_p_5_8;let o=Me(n*r*i,e);const a=Me(t*o*o,e),c=o,l=Me(o*$f,e),h=a===n,d=a===Me(-n,e),f=a===Me(-n*$f,e);return h&&(o=c),(d||f)&&(o=l),nE(o,e)&&(o=Me(-o,e)),{isValid:h||d,value:o}}const EE=ql(ha,void 0,!0),_E={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:EE,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:wE,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:Hl,randomBytes:Vl,adjustScalarBytes:m6,uvRatio:bE},da=dE(_E),rc=gE({P:ha,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:n=>{const t=ha,{pow_p_5_8:e,b2:r}=y6(n);return Me(Ge(e,yE,t)*r,t)},adjustScalarBytes:m6,randomBytes:Vl}),fa=32,Br=64,Zc=32;function vE(){const n=da.utils.randomPrivateKey(),t=da.getPublicKey(n);return{privateKey:w6(n,t),publicKey:t}}function SE(n){if(n.length!==Zc)throw new TypeError('"seed" must be 32 bytes in length.');if(!(n instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=n,e=da.getPublicKey(t);return{privateKey:w6(t,e),publicKey:e}}function RE(n,t){const e=n.subarray(0,Zc);return da.sign(t instanceof Uint8Array?t:t.subarray(),e)}function AE(n,t,e){return da.verify(t,e instanceof Uint8Array?e:e.subarray(),n)}function w6(n,t){const e=new Uint8Array(Br);for(let r=0;r<Zc;r++)e[r]=n[r],e[Zc+r]=t[r];return e}const Du={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function b6(n){const t="AES-GCM";let e=16;const r=12,s="SHA-256",i=16,o=32767,a=hn.get();e*=8;async function c(d,f){const p=a.getRandomValues(new Uint8Array(i)),m=a.getRandomValues(new Uint8Array(r)),g={name:t,iv:m};typeof f=="string"&&(f=V(f));let y;if(f.length===0){y=await a.subtle.importKey("jwk",Du,{name:"AES-GCM"},!0,["encrypt"]);try{const _={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(_,b,{name:t,length:e},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Du,{name:"AES-GCM"},!0,["encrypt"])}}else{const _={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(_,b,{name:t,length:e},!0,["encrypt"])}const w=await a.subtle.encrypt(g,y,d);return gt([p,g.iv,new Uint8Array(w)])}async function l(d,f){const p=d.subarray(0,i),m=d.subarray(i,i+r),g=d.subarray(i+r),y={name:t,iv:m};typeof f=="string"&&(f=V(f));let w;if(f.length===0)try{const b={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},v=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,v,{name:t,length:e},!0,["decrypt"])}catch{w=await a.subtle.importKey("jwk",Du,{name:"AES-GCM"},!0,["decrypt"])}else{const b={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},v=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,v,{name:t,length:e},!0,["decrypt"])}const _=await a.subtle.decrypt(y,w,g);return new Uint8Array(_)}return{encrypt:c,decrypt:l}}async function id(n,t){const r=await b6().encrypt(n,t);return ln.encode(r)}var ot;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.Secp256k1="Secp256k1"})(ot||(ot={}));var m1;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.Secp256k1=2]="Secp256k1"})(m1||(m1={}));(function(n){n.codec=()=>Mt(m1)})(ot||(ot={}));var Ki;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),ot.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.Type=ot.codec().decode(e);break;case 2:s.Data=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Ki||(Ki={}));var zi;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),ot.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.Type=ot.codec().decode(e);break;case 2:s.Data=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(zi||(zi={}));class od{constructor(t){u(this,"_key");this._key=qi(t,fa)}verify(t,e){return AE(this._key,e,t)}marshal(){return this._key}get bytes(){return Ki.encode({Type:ot.Ed25519,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}hash(){const t=We.digest(this.bytes);return us(t)?t.then(({bytes:e})=>e):t.bytes}}class ga{constructor(t,e){u(this,"_key");u(this,"_publicKey");this._key=qi(t,Br),this._publicKey=qi(e,fa)}sign(t){return RE(this._key,t)}get public(){return new od(this._publicKey)}marshal(){return this._key}get bytes(){return zi.encode({Type:ot.Ed25519,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}async hash(){const t=We.digest(this.bytes);let e;return us(t)?{bytes:e}=await t:e=t.bytes,e}async id(){const t=Er.digest(this.public.bytes);return kt.encode(t.bytes).substring(1)}async export(t,e="libp2p-key"){if(e==="libp2p-key")return id(this.bytes,t);throw new E(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function IE(n){if(n.length>Br){n=qi(n,Br+fa);const r=n.subarray(0,Br),s=n.subarray(Br,n.length);return new ga(r,s)}n=qi(n,Br);const t=n.subarray(0,Br),e=n.subarray(fa);return new ga(t,e)}function kE(n){return n=qi(n,fa),new od(n)}async function xE(){const{privateKey:n,publicKey:t}=vE();return new ga(n,t)}async function TE(n){const{privateKey:t,publicKey:e}=SE(n);return new ga(t,e)}function qi(n,t){if(n=Uint8Array.from(n??[]),n.length!==t)throw new E(`Key must be a Uint8Array of length ${t}, got ${n.length}`,"ERR_INVALID_KEY_TYPE");return n}const DE=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:ga,Ed25519PublicKey:od,generateKeyPair:xE,generateKeyPairFromSeed:TE,unmarshalEd25519PrivateKey:IE,unmarshalEd25519PublicKey:kE},Symbol.toStringTag,{value:"Module"}));async function CE(n,t){const e=ln.decode(n);return b6().decrypt(e,t)}function Yn(n){if(isNaN(n)||n<=0)throw new E("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Vl(n)}class E6 extends s6{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,Fl(t);const r=$s(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return Xc(this),this.iHash.update(t),this}digestInto(t){Xc(this),$l(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ua=(n,t,e)=>new E6(n,t).update(e).digest();Ua.create=(n,t)=>new E6(n,t);function _6(n,t,e,r){Fl(n);const s=mb({dkLen:32,asyncTick:10},r),{c:i,dkLen:o,asyncTick:a}=s;if(bi(i),bi(o),bi(a),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const c=$s(t),l=$s(e),h=new Uint8Array(o),d=Ua.create(n,c),f=d._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:h,PRF:d,PRFSalt:f}}function v6(n,t,e,r,s){return n.destroy(),t.destroy(),r&&r.destroy(),s.fill(0),e}function NE(n,t,e,r){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=_6(n,t,e,r);let l;const h=new Uint8Array(4),d=Wo(h),f=new Uint8Array(a.outputLen);for(let p=1,m=0;m<i;p++,m+=a.outputLen){const g=o.subarray(m,m+a.outputLen);d.setInt32(0,p,!1),(l=c._cloneInto(l)).update(h).digestInto(f),g.set(f.subarray(0,g.length));for(let y=1;y<s;y++){a._cloneInto(l).update(f).digestInto(f);for(let w=0;w<g.length;w++)g[w]^=f[w]}}return v6(a,c,o,l,f)}async function S6(n,t,e,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=_6(n,t,e,r);let h;const d=new Uint8Array(4),f=Wo(d),p=new Uint8Array(c.outputLen);for(let m=1,g=0;g<i;m++,g+=c.outputLen){const y=a.subarray(g,g+c.outputLen);f.setInt32(0,m,!1),(h=l._cloneInto(h)).update(d).digestInto(p),y.set(p.subarray(0,y.length)),await fb(s-1,o,()=>{c._cloneInto(h).update(p).digestInto(p);for(let w=0;w<y.length;w++)y[w]^=p[w]})}return v6(c,l,a,h,p)}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2022 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const LE="[object ArrayBuffer]";class Oe{static isArrayBuffer(t){return Object.prototype.toString.call(t)===LE}static toArrayBuffer(t){return this.isArrayBuffer(t)?t:t.byteLength===t.buffer.byteLength||t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:this.toUint8Array(t.buffer).slice(t.byteOffset,t.byteOffset+t.byteLength).buffer}static toUint8Array(t){return this.toView(t,Uint8Array)}static toView(t,e){if(t.constructor===e)return t;if(this.isArrayBuffer(t))return new e(t);if(this.isArrayBufferView(t))return new e(t.buffer,t.byteOffset,t.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(t){return this.isArrayBufferView(t)||this.isArrayBuffer(t)}static isArrayBufferView(t){return ArrayBuffer.isView(t)||t&&this.isArrayBuffer(t.buffer)}static isEqual(t,e){const r=Oe.toUint8Array(t),s=Oe.toUint8Array(e);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...t){let e;Array.isArray(t[0])&&!(t[1]instanceof Function)||Array.isArray(t[0])&&t[1]instanceof Function?e=t[0]:t[t.length-1]instanceof Function?e=t.slice(0,t.length-1):e=t;let r=0;for(const o of e)r+=o.byteLength;const s=new Uint8Array(r);let i=0;for(const o of e){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return t[t.length-1]instanceof Function?this.toView(s,t[t.length-1]):s.buffer}}const Cu="string",PE=/^[0-9a-f]+$/i,OE=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,BE=/^[a-zA-Z0-9-_]+$/;class Vf{static fromString(t){const e=unescape(encodeURIComponent(t)),r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r.buffer}static toString(t){const e=Oe.toUint8Array(t);let r="";for(let i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return decodeURIComponent(escape(r))}}class Tn{static toString(t,e=!1){const r=Oe.toArrayBuffer(t),s=new DataView(r);let i="";for(let o=0;o<r.byteLength;o+=2){const a=s.getUint16(o,e);i+=String.fromCharCode(a)}return i}static fromString(t,e=!1){const r=new ArrayBuffer(t.length*2),s=new DataView(r);for(let i=0;i<t.length;i++)s.setUint16(i*2,t.charCodeAt(i),e);return r}}class je{static isHex(t){return typeof t===Cu&&PE.test(t)}static isBase64(t){return typeof t===Cu&&OE.test(t)}static isBase64Url(t){return typeof t===Cu&&BE.test(t)}static ToString(t,e="utf8"){const r=Oe.toUint8Array(t);switch(e.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Tn.toString(r,!0);case"utf16":case"utf16be":return Tn.toString(r);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromString(t,e="utf8"){if(!t)return new ArrayBuffer(0);switch(e.toLowerCase()){case"utf8":return this.FromUtf8String(t);case"binary":return this.FromBinary(t);case"hex":return this.FromHex(t);case"base64":return this.FromBase64(t);case"base64url":return this.FromBase64Url(t);case"utf16le":return Tn.fromString(t,!0);case"utf16":case"utf16be":return Tn.fromString(t);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToBase64(t){const e=Oe.toUint8Array(t);if(typeof btoa<"u"){const r=this.ToString(e,"binary");return btoa(r)}else return Buffer.from(e).toString("base64")}static FromBase64(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!je.isBase64(e))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(e)):new Uint8Array(Buffer.from(e,"base64")).buffer}static FromBase64Url(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!je.isBase64Url(e))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(t){return this.ToBase64(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(t,e=je.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.FromBinary(t);case"utf8":return Vf.fromString(t);case"utf16":case"utf16be":return Tn.fromString(t);case"utf16le":case"usc2":return Tn.fromString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToUtf8String(t,e=je.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.ToBinary(t);case"utf8":return Vf.toString(t);case"utf16":case"utf16be":return Tn.toString(t);case"utf16le":case"usc2":return Tn.toString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromBinary(t){const e=t.length,r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);return r.buffer}static ToBinary(t){const e=Oe.toUint8Array(t);let r="";for(let s=0;s<e.length;s++)r+=String.fromCharCode(e[s]);return r}static ToHex(t){const e=Oe.toUint8Array(t);let r="";const s=e.length;for(let i=0;i<s;i++){const o=e[i];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(t){let e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!je.isHex(e))throw new TypeError("Argument 'hexString' is not HEX encoded");e.length%2&&(e=`0${e}`);const r=new Uint8Array(e.length/2);for(let s=0;s<e.length;s=s+2){const i=e.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(t,e=!1){return Tn.toString(t,e)}static FromUtf16String(t,e=!1){return Tn.fromString(t,e)}static Base64Padding(t){const e=4-t.length%4;if(e<4)for(let r=0;r<e;r++)t+="=";return t}static formatString(t){return(t==null?void 0:t.replace(/[\n\r\t ]/g,""))||""}}je.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Wi(n,t){let e=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)e+=n[n.length-1-r]*Math.pow(2,t*r);return e}function Ks(n,t,e=-1){const r=e;let s=n,i=0,o=Math.pow(2,t);for(let a=1;a<8;a++){if(n<o){let c;if(r<0)c=new ArrayBuffer(a),i=a;else{if(r<a)return new ArrayBuffer(0);c=new ArrayBuffer(r),i=r}const l=new Uint8Array(c);for(let h=a-1;h>=0;h--){const d=Math.pow(2,h*t);l[i-h-1]=Math.floor(s/d),s-=l[i-h-1]*d}return c}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function w1(...n){let t=0,e=0;for(const i of n)t+=i.length;const r=new ArrayBuffer(t),s=new Uint8Array(r);for(const i of n)s.set(i,e),e+=i.length;return s}function R6(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,c=n[0]===0&&(n[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),e=new Uint8Array(t);for(let a=0;a<this.valueHex.byteLength;a++)e[a]=0;e[0]=n[0]&128;const r=Wi(e,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=n[a];return i[0]&=127,Wi(i,8)-r}function ME(n){const t=n<0?n*-1:n;let e=128;for(let r=1;r<8;r++){if(t<=e){if(n<0){const o=e-t,a=Ks(o,8,r),c=new Uint8Array(a);return c[0]|=128,a}let s=Ks(t,8,r),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}e*=Math.pow(2,8)}return new ArrayBuffer(0)}function UE(n,t){if(n.byteLength!==t.byteLength)return!1;const e=new Uint8Array(n),r=new Uint8Array(t);for(let s=0;s<e.length;s++)if(e[s]!==r[s])return!1;return!0}function Xt(n,t){const e=n.toString(10);if(t<e.length)return"";const r=t-e.length,s=new Array(r);for(let o=0;o<r;o++)s[o]="0";return s.join("").concat(e)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function jc(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function ad(n){let t=0,e=0;for(let s=0;s<n.length;s++){const i=n[s];t+=i.byteLength}const r=new Uint8Array(t);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),e),e+=i.byteLength}return r.buffer}function Rr(n,t,e,r){return t instanceof Uint8Array?t.byteLength?e<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):t.byteLength-e-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class cd{constructor(){this.items=[]}write(t){this.items.push(t)}final(){return ad(this.items)}}const No=[new Uint8Array([1])],Hf="0123456789",Ro="",An=new ArrayBuffer(0),ld=new Uint8Array(0),pa="EndOfContent",A6="OCTET STRING",I6="BIT STRING";function Ar(n){var t;return t=class extends n{constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?Oe.toUint8Array(i.valueHex):ld}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}fromBER(r,s,i){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!Rr(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",An)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:je.ToHex(this.valueHexView)}}},t.NAME="hexBlock",t}class Js{constructor({blockLength:t=0,error:e=Ro,warnings:r=[],valueBeforeDecode:s=ld}={}){this.blockLength=t,this.error=e,this.warnings=r,this.valueBeforeDecodeView=Oe.toUint8Array(s)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(t){this.valueBeforeDecodeView=new Uint8Array(t)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:je.ToHex(this.valueBeforeDecodeView)}}}Js.NAME="baseBlock";class Yt extends Js{fromBER(t,e,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(t,e){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Yt.NAME="valueBlock";class k6 extends Ar(Js){constructor({idBlock:t={}}={}){var e,r,s,i;super(),t?(this.isHexOnly=(e=t.isHexOnly)!==null&&e!==void 0?e:!1,this.valueHexView=t.valueHex?Oe.toUint8Array(t.valueHex):ld,this.tagClass=(r=t.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=t.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=t.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(t=!1){let e=0;switch(this.tagClass){case 1:e|=0;break;case 2:e|=64;break;case 3:e|=128;break;case 4:e|=192;break;default:return this.error="Unknown tag class",An}if(this.isConstructed&&(e|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!t){let i=this.tagNumber;i&=31,e|=i,s[0]=e}return s.buffer}if(!this.isHexOnly){const s=Ks(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=e|31,!t){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=e|31,!t){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(t,e,r){const s=Oe.toUint8Array(t);if(!Rr(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),h=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===h){h+=255;const f=new Uint8Array(h);for(let p=0;p<l.length;p++)f[p]=l[p];l=this.valueHexView=new Uint8Array(h)}}this.blockLength=c+1,l[c-1]=i[c]&127;const d=new Uint8Array(c);for(let f=0;f<c;f++)d[f]=l[f];l=this.valueHexView=new Uint8Array(c),l.set(d),this.blockLength<=9?this.tagNumber=Wi(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return e+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}k6.NAME="identificationBlock";class x6 extends Js{constructor({lenBlock:t={}}={}){var e,r,s;super(),this.isIndefiniteForm=(e=t.isIndefiniteForm)!==null&&e!==void 0?e:!1,this.longFormUsed=(r=t.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=t.length)!==null&&s!==void 0?s:0}fromBER(t,e,r){const s=Oe.toUint8Array(t);if(!Rr(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,e+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,e+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=e+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Wi(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,e+this.blockLength}toBER(t=!1){let e,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=128),e;if(this.longFormUsed){const s=Ks(this.length,8);if(s.byteLength>127)return this.error="Too big length",An;if(e=new ArrayBuffer(s.byteLength+1),t)return e;const i=new Uint8Array(s);r=new Uint8Array(e),r[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)r[o+1]=i[o];return e}return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=this.length),e}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}x6.NAME="lengthBlock";const Y={};class Ut extends Js{constructor({name:t=Ro,optional:e=!1,primitiveSchema:r,...s}={},i){super(s),this.name=t,this.optional=e,r&&(this.primitiveSchema=r),this.idBlock=new k6(s),this.lenBlock=new x6(s),this.valueBlock=i?new i(s):new Yt(s)}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(t,e){const r=e||new cd;e||T6(this);const s=this.idBlock.toBER(t);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(t,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(t);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(t);r.write(o),r.write(i)}return e?An:r.final()}toJSON(){const t={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(t.primitiveSchema=this.primitiveSchema.toJSON()),t}toString(t="ascii"){return t==="ascii"?this.onAsciiEncoding():je.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${je.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(t){if(this===t)return!0;if(!(t instanceof this.constructor))return!1;const e=this.toBER(),r=t.toBER();return UE(e,r)}}Ut.NAME="BaseBlock";function T6(n){if(n instanceof Y.Constructed)for(const t of n.valueBlock.value)T6(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!n.lenBlock.isIndefiniteForm}class D6 extends Ut{constructor({value:t=Ro,...e}={},r){super(e,r),t&&this.fromString(t)}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}D6.NAME="BaseStringBlock";class C6 extends Ar(Yt){constructor({isHexOnly:t=!0,...e}={}){super(e),this.isHexOnly=t}}C6.NAME="PrimitiveValueBlock";var N6;class L6 extends Ut{constructor(t={}){super(t,C6),this.idBlock.isConstructed=!1}}N6=L6;Y.Primitive=N6;L6.NAME="PRIMITIVE";function $E(n,t){if(n instanceof t)return n;const e=new t;return e.idBlock=n.idBlock,e.lenBlock=n.lenBlock,e.warnings=n.warnings,e.valueBeforeDecodeView=n.valueBeforeDecodeView,e}function Wl(n,t=0,e=n.length){const r=t;let s=new Ut({},Yt);const i=new Js;if(!Rr(i,n,t,e))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(t,t+e).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(n,t,e);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(t=a,e-=s.idBlock.blockLength,a=s.lenBlock.fromBER(n,t,e),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(t=a,e-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=Ut;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=Y.EndOfContent;break;case 1:c=Y.Boolean;break;case 2:c=Y.Integer;break;case 3:c=Y.BitString;break;case 4:c=Y.OctetString;break;case 5:c=Y.Null;break;case 6:c=Y.ObjectIdentifier;break;case 10:c=Y.Enumerated;break;case 12:c=Y.Utf8String;break;case 13:c=Y.RelativeObjectIdentifier;break;case 14:c=Y.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=Y.Sequence;break;case 17:c=Y.Set;break;case 18:c=Y.NumericString;break;case 19:c=Y.PrintableString;break;case 20:c=Y.TeletexString;break;case 21:c=Y.VideotexString;break;case 22:c=Y.IA5String;break;case 23:c=Y.UTCTime;break;case 24:c=Y.GeneralizedTime;break;case 25:c=Y.GraphicString;break;case 26:c=Y.VisibleString;break;case 27:c=Y.GeneralString;break;case 28:c=Y.UniversalString;break;case 29:c=Y.CharacterString;break;case 30:c=Y.BmpString;break;case 31:c=Y.DATE;break;case 32:c=Y.TimeOfDay;break;case 33:c=Y.DateTime;break;case 34:c=Y.Duration;break;default:{const l=s.idBlock.isConstructed?new Y.Constructed:new Y.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?Y.Constructed:Y.Primitive}return s=$E(s,c),a=s.fromBER(n,t,s.lenBlock.isIndefiniteForm?e:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:a,result:s}}function Go(n){if(!n.byteLength){const t=new Ut({},Yt);return t.error="Input buffer has zero length",{offset:-1,result:t}}return Wl(Oe.toUint8Array(n).slice(),0,n.byteLength)}function FE(n,t){return n?1:t}class Qr extends Yt{constructor({value:t=[],isIndefiniteForm:e=!1,...r}={}){super(r),this.value=t,this.isIndefiniteForm=e}fromBER(t,e,r){const s=Oe.toUint8Array(t);if(!Rr(this,s,e,r))return-1;if(this.valueBeforeDecodeView=s.subarray(e,e+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),e;let i=e;for(;FE(this.isIndefiniteForm,r)>0;){const o=Wl(s,i,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===pa)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===pa?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(t,e){const r=e||new cd;for(let s=0;s<this.value.length;s++)this.value[s].toBER(t,r);return e?An:r.final()}toJSON(){const t={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const e of this.value)t.value.push(e.toJSON());return t}}Qr.NAME="ConstructedValueBlock";var P6;class Ao extends Ut{constructor(t={}){super(t,Qr),this.idBlock.isConstructed=!0}fromBER(t,e,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const t=[];for(const r of this.valueBlock.value)t.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const e=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return t.length?`${e} :
${t.join(`
`)}`:`${e} :`}}P6=Ao;Y.Constructed=P6;Ao.NAME="CONSTRUCTED";class O6 extends Yt{fromBER(t,e,r){return e}toBER(t){return An}}O6.override="EndOfContentValueBlock";var B6;class M6 extends Ut{constructor(t={}){super(t,O6),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}B6=M6;Y.EndOfContent=B6;M6.NAME=pa;var U6;class ya extends Ut{constructor(t={}){super(t,Yt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(t,e,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,e+r>t.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):e+r}toBER(t,e){const r=new ArrayBuffer(2);if(!t){const s=new Uint8Array(r);s[0]=5,s[1]=0}return e&&e.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}U6=ya;Y.Null=U6;ya.NAME="NULL";class $6 extends Ar(Yt){constructor({value:t,...e}={}){super(e),e.valueHex?this.valueHexView=Oe.toUint8Array(e.valueHex):this.valueHexView=new Uint8Array(1),t&&(this.value=t)}get value(){for(const t of this.valueHexView)if(t>0)return!0;return!1}set value(t){this.valueHexView[0]=t?255:0}fromBER(t,e,r){const s=Oe.toUint8Array(t);return Rr(this,s,e,r)?(this.valueHexView=s.subarray(e,e+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,R6.call(this),this.blockLength=r,e+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}$6.NAME="BooleanValueBlock";var F6;let V6=class extends Ut{constructor(t={}){super(t,$6),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};F6=V6;Y.Boolean=F6;V6.NAME="BOOLEAN";class H6 extends Ar(Qr){constructor({isConstructed:t=!1,...e}={}){super(e),this.isConstructed=t}fromBER(t,e,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Qr.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===pa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==A6)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(t,e,r),this.blockLength=r;return s}toBER(t,e){return this.isConstructed?Qr.prototype.toBER.call(this,t,e):t?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}H6.NAME="OctetStringValueBlock";var K6;class zr extends Ut{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},H6),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(t,e,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),e;if(!this.valueBlock.isConstructed){const i=(t instanceof ArrayBuffer?new Uint8Array(t):t).subarray(e,e+r);try{if(i.byteLength){const o=Wl(i,0,i.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(t,e,r)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?Ao.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${je.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const t=[];for(const e of this.valueBlock.value)e instanceof zr&&t.push(e.valueBlock.valueHexView);return Oe.concat(t)}}K6=zr;Y.OctetString=K6;zr.NAME=A6;class z6 extends Ar(Qr){constructor({unusedBits:t=0,isConstructed:e=!1,...r}={}){super(r),this.unusedBits=t,this.isConstructed=e,this.blockLength=this.valueHexView.byteLength}fromBER(t,e,r){if(!r)return e;let s=-1;if(this.isConstructed){if(s=Qr.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===pa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==I6)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}const i=Oe.toUint8Array(t);if(!Rr(this,i,e,r))return-1;const o=i.subarray(e,e+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=Wl(a,0,a.byteLength);c.offset!==-1&&c.offset===r-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,e+r}toBER(t,e){if(this.isConstructed)return Qr.prototype.toBER.call(this,t,e);if(t)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return An;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}z6.NAME="BitStringValueBlock";var q6;class ud extends Ut{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},z6),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(t,e,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(t,e,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Ao.prototype.onAsciiEncoding.call(this);{const t=[],e=this.valueBlock.valueHexView;for(const s of e)t.push(s.toString(2).padStart(8,"0"));const r=t.join("");return`${this.constructor.NAME} : ${r.substring(0,r.length-this.valueBlock.unusedBits)}`}}}q6=ud;Y.BitString=q6;ud.NAME=I6;var W6;function VE(n,t){const e=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(t);let i=r.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0;const h=c<o?o:c;let d=0;for(let f=h;f>=0;f--,d++){switch(!0){case d<a.length:l=i[o-d]+a[c-d]+e[0];break;default:l=i[o-d]+e[0]}switch(e[0]=l/10,!0){case d>=i.length:i=w1(new Uint8Array([l%10]),i);break;default:i[o-d]=l%10}}return e[0]>0&&(i=w1(e,i)),i}function Kf(n){if(n>=No.length)for(let t=No.length;t<=n;t++){const e=new Uint8Array([0]);let r=No[t-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+e[0]]);e[0]=i[0]/10,r[s]=i[0]%10}e[0]>0&&(r=w1(e,r)),No.push(r)}return No[n]}function HE(n,t){let e=0;const r=new Uint8Array(n),s=new Uint8Array(t),i=r.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,h=0;for(let d=c;d>=0;d--,h++)switch(l=i[o-h]-a[c-h]-e,!0){case l<0:e=1,i[o-h]=l+10;break;default:e=0,i[o-h]=l}if(e>0)for(let d=o-c+1;d>=0;d--,h++)if(l=i[o-h]-e,l<0)e=1,i[o-h]=l+10;else{e=0,i[o-h]=l;break}return i.slice()}class hd extends Ar(Yt){constructor({value:t,...e}={}){super(e),this._valueDec=0,e.valueHex&&this.setValueHex(),t!==void 0&&(this.valueDec=t)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=R6.call(this)))}set valueDec(t){this._valueDec=t,this.isHexOnly=!1,this.valueHexView=new Uint8Array(ME(t))}get valueDec(){return this._valueDec}fromDER(t,e,r,s=0){const i=this.fromBER(t,e,r);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(t=!1){const e=this.valueHexView;switch(!0){case(e[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(e,1),this.valueHexView=r}break;case(e[0]===0&&(e[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(t)}fromBER(t,e,r){const s=super.fromBER(t,e,r);return s===-1||this.setValueHex(),s}toBER(t){return t?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const t=this.valueHexView.length*8-1;let e=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let l=0;l<8;l++){if((s&1)===1)switch(r){case t:e=HE(Kf(r),e),o="-";break;default:e=VE(e,Kf(r))}r++,s>>=1}}for(let c=0;c<e.length;c++)e[c]&&(a=!0),a&&(o+=Hf.charAt(e[c]));return a===!1&&(o+=Hf.charAt(0)),o}}W6=hd;hd.NAME="IntegerValueBlock";Object.defineProperty(W6.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var G6;class et extends Ut{constructor(t={}){super(t,hd),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return jc(),BigInt(this.valueBlock.toString())}static fromBigInt(t){jc();const e=BigInt(t),r=new cd,s=e.toString(16).replace(/^-/,""),i=new Uint8Array(je.FromHex(s));if(e<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${je.ToHex(a)}`)+e,h=Oe.toUint8Array(je.FromHex(l.toString(16)));h[0]|=128,r.write(h)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new et({valueHex:r.final()})}convertToDER(){const t=new et({valueHex:this.valueBlock.valueHexView});return t.valueBlock.toDER(),t}convertFromDER(){return new et({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}G6=et;Y.Integer=G6;et.NAME="INTEGER";var Y6;class Q6 extends et{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Y6=Q6;Y.Enumerated=Y6;Q6.NAME="ENUMERATED";class b1 extends Ar(Yt){constructor({valueDec:t=-1,isFirstSid:e=!1,...r}={}){super(r),this.valueDec=t,this.isFirstSid=e}fromBER(t,e,r){if(!r)return e;const s=Oe.toUint8Array(t);if(!Rr(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Wi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}set valueBigInt(t){jc();let e=BigInt(t).toString(2);for(;e.length%7;)e="0"+e;const r=new Uint8Array(e.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(e.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=Ks(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",An;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r}toString(){let t="";if(this.isHexOnly)t=je.ToHex(this.valueHexView);else if(this.isFirstSid){let e=this.valueDec;this.valueDec<=39?t="0.":this.valueDec<=79?(t="1.",e-=40):(t="2.",e-=80),t+=e.toString()}else t=this.valueDec.toString();return t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}b1.NAME="sidBlock";class X6 extends Yt{constructor({value:t=Ro,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new b1;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t){const e=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(t);if(s.byteLength===0)return this.error=this.value[r].error,An;e.push(s)}return ad(e)}fromString(t){this.value=[];let e=0,r=0,s="",i=!1;do if(r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new b1;if(s>Number.MAX_SAFE_INTEGER){jc();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(r!==-1)}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e?(s=`{${s}}`,this.value[r].isFirstSid?t=`2.{${s} - 80}`:t+=s):t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}X6.NAME="ObjectIdentifierValueBlock";var Z6;class $r extends Ut{constructor(t={}){super(t,X6),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Z6=$r;Y.ObjectIdentifier=Z6;$r.NAME="OBJECT IDENTIFIER";class E1 extends Ar(Js){constructor({valueDec:t=0,...e}={}){super(e),this.valueDec=t}fromBER(t,e,r){if(r===0)return e;const s=Oe.toUint8Array(t);if(!Rr(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Wi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=Ks(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",An;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r.buffer}toString(){let t="";return this.isHexOnly?t=je.ToHex(this.valueHexView):t=this.valueDec.toString(),t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}E1.NAME="relativeSidBlock";class j6 extends Yt{constructor({value:t=Ro,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new E1;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t,e){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(t);if(i.byteLength===0)return this.error=this.value[s].error,An;r.push(i)}return ad(r)}fromString(t){this.value=[];let e=0,r=0,s="";do{r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1;const i=new E1;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e&&(s=`{${s}}`),t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}j6.NAME="RelativeObjectIdentifierValueBlock";var J6;class e5 extends Ut{constructor(t={}){super(t,j6),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}J6=e5;Y.RelativeObjectIdentifier=J6;e5.NAME="RelativeObjectIdentifier";var t5;class Ct extends Ao{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}t5=Ct;Y.Sequence=t5;Ct.NAME="SEQUENCE";var n5;let r5=class extends Ao{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};n5=r5;Y.Set=n5;r5.NAME="SET";class s5 extends Ar(Yt){constructor({...t}={}){super(t),this.isHexOnly=!0,this.value=Ro}toJSON(){return{...super.toJSON(),value:this.value}}}s5.NAME="StringValueBlock";class i5 extends s5{}i5.NAME="SimpleStringValueBlock";class tn extends D6{constructor({...t}={}){super(t,i5)}fromBuffer(t){this.valueBlock.value=String.fromCharCode.apply(null,Oe.toUint8Array(t))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);this.valueBlock.value=t}}tn.NAME="SIMPLE STRING";class o5 extends tn{fromBuffer(t){this.valueBlock.valueHexView=Oe.toUint8Array(t);try{this.valueBlock.value=je.ToUtf8String(t)}catch(e){this.warnings.push(`Error during "decodeURIComponent": ${e}, using raw string`),this.valueBlock.value=je.ToBinary(t)}}fromString(t){this.valueBlock.valueHexView=new Uint8Array(je.FromUtf8String(t)),this.valueBlock.value=t}}o5.NAME="Utf8StringValueBlock";var a5;class ei extends o5{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}a5=ei;Y.Utf8String=a5;ei.NAME="UTF8String";class c5 extends tn{fromBuffer(t){this.valueBlock.value=je.ToUtf16String(t),this.valueBlock.valueHexView=Oe.toUint8Array(t)}fromString(t){this.valueBlock.value=t,this.valueBlock.valueHexView=new Uint8Array(je.FromUtf16String(t))}}c5.NAME="BmpStringValueBlock";var l5;class u5 extends c5{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}l5=u5;Y.BmpString=l5;u5.NAME="BMPString";class h5 extends tn{fromBuffer(t){const e=ArrayBuffer.isView(t)?t.slice().buffer:t.slice(0),r=new Uint8Array(e);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(e))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e*4);for(let s=0;s<e;s++){const i=Ks(t.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)r[s*4+c+a]=o[c]}this.valueBlock.value=t}}h5.NAME="UniversalStringValueBlock";var d5;class f5 extends h5{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}d5=f5;Y.UniversalString=d5;f5.NAME="UniversalString";var g5;class p5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}g5=p5;Y.NumericString=g5;p5.NAME="NumericString";var y5;class m5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}y5=m5;Y.PrintableString=y5;m5.NAME="PrintableString";var w5;class b5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}w5=b5;Y.TeletexString=w5;b5.NAME="TeletexString";var E5;class _5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}E5=_5;Y.VideotexString=E5;_5.NAME="VideotexString";var v5;class S5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}v5=S5;Y.IA5String=v5;S5.NAME="IA5String";var R5;class A5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}R5=A5;Y.GraphicString=R5;A5.NAME="GraphicString";var I5;class dd extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}I5=dd;Y.VisibleString=I5;dd.NAME="VisibleString";var k5;class x5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}k5=x5;Y.GeneralString=k5;x5.NAME="GeneralString";var T5;class D5 extends tn{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}T5=D5;Y.CharacterString=T5;D5.NAME="CharacterString";var C5;class fd extends dd{constructor({value:t,valueDate:e,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,t){this.fromString(t),this.valueBlock.valueHexView=new Uint8Array(t.length);for(let s=0;s<t.length;s++)this.valueBlock.valueHexView[s]=t.charCodeAt(s)}e&&(this.fromDate(e),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(t){this.fromString(String.fromCharCode.apply(null,Oe.toUint8Array(t)))}toBuffer(){const t=this.toString(),e=new ArrayBuffer(t.length),r=new Uint8Array(e);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return e}fromDate(t){this.year=t.getUTCFullYear(),this.month=t.getUTCMonth()+1,this.day=t.getUTCDate(),this.hour=t.getUTCHours(),this.minute=t.getUTCMinutes(),this.second=t.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(t){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(t);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(t="iso"){if(t==="iso"){const e=new Array(7);return e[0]=Xt(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=Xt(this.month,2),e[2]=Xt(this.day,2),e[3]=Xt(this.hour,2),e[4]=Xt(this.minute,2),e[5]=Xt(this.second,2),e[6]="Z",e.join("")}return super.toString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}C5=fd;Y.UTCTime=C5;fd.NAME="UTCTime";var N5;class L5 extends fd{constructor(t={}){var e;super(t),(e=this.millisecond)!==null&&e!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(t){super.fromDate(t),this.millisecond=t.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(t){let e=!1,r="",s="",i=0,o,a=0,c=0;if(t[t.length-1]==="Z")r=t.substring(0,t.length-1),e=!0;else{const d=new Number(t[t.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");r=t}if(e){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,f=r.indexOf("+"),p="";if(f===-1&&(f=r.indexOf("-"),d=-1),f!==-1){if(p=r.substring(f+1),r=r.substring(0,f),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(p.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*m,p.length===4){if(m=parseInt(p.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=d*m}}}let l=r.indexOf(".");if(l===-1&&(l=r.indexOf(",")),l!==-1){const d=new Number(`0${r.substring(l)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");i=d.valueOf(),s=r.substring(0,l)}else s=r;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*i;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*i;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const d=1e3*i;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const h=o.exec(s);if(h===null)throw new Error("Wrong input string for conversion");for(let d=1;d<h.length;d++)switch(d){case 1:this.year=parseInt(h[d],10);break;case 2:this.month=parseInt(h[d],10);break;case 3:this.day=parseInt(h[d],10);break;case 4:this.hour=parseInt(h[d],10)+a;break;case 5:this.minute=parseInt(h[d],10)+c;break;case 6:this.second=parseInt(h[d],10);break;default:throw new Error("Wrong input string for conversion")}if(e===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(t="iso"){if(t==="iso"){const e=[];return e.push(Xt(this.year,4)),e.push(Xt(this.month,2)),e.push(Xt(this.day,2)),e.push(Xt(this.hour,2)),e.push(Xt(this.minute,2)),e.push(Xt(this.second,2)),this.millisecond!==0&&(e.push("."),e.push(Xt(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(t)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}N5=L5;Y.GeneralizedTime=N5;L5.NAME="GeneralizedTime";var P5;class O5 extends ei{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}P5=O5;Y.DATE=P5;O5.NAME="DATE";var B5;class M5 extends ei{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}B5=M5;Y.TimeOfDay=B5;M5.NAME="TimeOfDay";var U5;class $5 extends ei{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}U5=$5;Y.DateTime=U5;$5.NAME="DateTime";var F5;class V5 extends ei{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}F5=V5;Y.Duration=F5;V5.NAME="Duration";var H5;class K5 extends ei{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}H5=K5;Y.TIME=H5;K5.NAME="TIME";function KE(n){const{result:t}=Go(n),e=t.valueBlock.value;return{n:W(Cn(e[1].toBigInt()),"base64url"),e:W(Cn(e[2].toBigInt()),"base64url"),d:W(Cn(e[3].toBigInt()),"base64url"),p:W(Cn(e[4].toBigInt()),"base64url"),q:W(Cn(e[5].toBigInt()),"base64url"),dp:W(Cn(e[6].toBigInt()),"base64url"),dq:W(Cn(e[7].toBigInt()),"base64url"),qi:W(Cn(e[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function zE(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new E("JWK was missing components","ERR_INVALID_PARAMETERS");const e=new Ct({value:[new et({value:0}),et.fromBigInt(Nn(V(n.n,"base64url"))),et.fromBigInt(Nn(V(n.e,"base64url"))),et.fromBigInt(Nn(V(n.d,"base64url"))),et.fromBigInt(Nn(V(n.p,"base64url"))),et.fromBigInt(Nn(V(n.q,"base64url"))),et.fromBigInt(Nn(V(n.dp,"base64url"))),et.fromBigInt(Nn(V(n.dq,"base64url"))),et.fromBigInt(Nn(V(n.qi,"base64url")))]}).toBER();return new Uint8Array(e,0,e.byteLength)}function qE(n){const{result:t}=Go(n),e=t.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:W(Cn(e[0].toBigInt()),"base64url"),e:W(Cn(e[1].toBigInt()),"base64url")}}function WE(n){if(n.n==null||n.e==null)throw new E("JWK was missing components","ERR_INVALID_PARAMETERS");const e=new Ct({value:[new Ct({value:[new $r({value:"1.2.840.113549.1.1.1"}),new ya]}),new ud({valueHex:new Ct({value:[et.fromBigInt(Nn(V(n.n,"base64url"))),et.fromBigInt(Nn(V(n.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(e,0,e.byteLength)}function Cn(n){let t=n.toString(16);t.length%2>0&&(t=`0${t}`);const e=t.length/2,r=new Uint8Array(e);let s=0,i=0;for(;s<e;)r[s]=parseInt(t.slice(i,i+2),16),s+=1,i+=2;return r}function Nn(n){const t=[];return n.forEach(function(e){let r=e.toString(16);r.length%2>0&&(r=`0${r}`),t.push(r)}),BigInt("0x"+t.join(""))}const GE=16,_1=32,v1=1e4;async function YE(n,t){const e=hn.get(),s=new Ct({value:[new et({value:0}),new Ct({value:[new $r({value:"1.2.840.113549.1.1.1"}),new ya]}),new zr({valueHex:n.marshal()})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=Yn(GE),a=await S6(Hl,t,o,{c:v1,dkLen:_1}),c=Yn(16),l=await e.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),h=await e.subtle.encrypt({name:"AES-CBC",iv:c},l,i),d=new Ct({value:[new zr({valueHex:o}),new et({value:v1}),new et({value:_1}),new Ct({value:[new $r({value:"1.2.840.113549.2.11"}),new ya]})]}),f=new Ct({value:[new $r({value:"1.2.840.113549.1.5.13"}),new Ct({value:[new Ct({value:[new $r({value:"1.2.840.113549.1.5.12"}),d]}),new Ct({value:[new $r({value:"2.16.840.1.101.3.4.1.42"}),new zr({valueHex:c})]})]})]}),m=new Ct({value:[f,new zr({valueHex:h})]}).toBER(),g=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...W(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function QE(n,t){const e=hn.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=V(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:i}=Go(s),{iv:o,salt:a,iterations:c,keySize:l,cipherText:h}=XE(i),d=await S6(Hl,t,a,{c,dkLen:l}),f=await e.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),p=Yo(await e.subtle.decrypt({name:"AES-CBC",iv:o},f,h)),{result:m}=Go(p);r=zf(m)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const s=V(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:i}=Go(s);r=zf(i)}else throw new E("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return W5(r)}function XE(n){const t=n.valueBlock.value[0];if(t.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new E("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");const r=t.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new E("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");const i=r.valueBlock.value[1],o=Yo(i.valueBlock.value[0].getValue());let a=v1,c=_1;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new E("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");const l=t.valueBlock.value[1].valueBlock.value[1],h=l.valueBlock.value[0].toString();if(h!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(h!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new E("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}const d=Yo(l.valueBlock.value[1].getValue());return{cipherText:Yo(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:d}}function zf(n){return Yo(n.valueBlock.value[2].getValue())}function Yo(n){return new Uint8Array(n,0,n.byteLength)}async function ZE(n){const t=await hn.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),e=await q5(t);return{privateKey:e[0],publicKey:e[1]}}async function z5(n){const e=[await hn.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await e_(n)],r=await q5({privateKey:e[0],publicKey:e[1]});return{privateKey:r[0],publicKey:r[1]}}async function jE(n,t){const e=await hn.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await hn.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}async function JE(n,t,e){const r=await hn.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return hn.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,e instanceof Uint8Array?e:e.subarray())}async function q5(n){if(n.privateKey==null||n.publicKey==null)throw new E("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([hn.get().subtle.exportKey("jwk",n.privateKey),hn.get().subtle.exportKey("jwk",n.publicKey)])}async function e_(n){return hn.get().subtle.importKey("jwk",{kty:n.kty,n:n.n,e:n.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function gd(n){if(n.kty!=="RSA")throw new E("invalid key type","ERR_INVALID_KEY_TYPE");if(n.n==null)throw new E("invalid key modulus","ERR_INVALID_KEY_MODULUS");return V(n.n,"base64url").length*8}const $a=8192;class pd{constructor(t){u(this,"_key");this._key=t}verify(t,e){return JE(this._key,e,t)}marshal(){return WE(this._key)}get bytes(){return Ki.encode({Type:ot.RSA,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}hash(){const t=We.digest(this.bytes);return us(t)?t.then(({bytes:e})=>e):t.bytes}}class Gl{constructor(t,e){u(this,"_key");u(this,"_publicKey");this._key=t,this._publicKey=e}genSecret(){return Yn(16)}sign(t){return jE(this._key,t)}get public(){if(this._publicKey==null)throw new E("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new pd(this._publicKey)}marshal(){return zE(this._key)}get bytes(){return zi.encode({Type:ot.RSA,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}hash(){const t=We.digest(this.bytes);return us(t)?t.then(({bytes:e})=>e):t.bytes}async id(){const t=await this.public.hash();return W(t,"base58btc")}async export(t,e="pkcs-8"){if(e==="pkcs-8")return YE(this,t);if(e==="libp2p-key")return id(this.bytes,t);throw new E(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function W5(n){const t=KE(n);if(gd(t)>$a)throw new E("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await z5(t);return new Gl(e.privateKey,e.publicKey)}function t_(n){const t=qE(n);if(gd(t)>$a)throw new E("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new pd(t)}async function n_(n){if(gd(n)>$a)throw new E("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await z5(n);return new Gl(t.privateKey,t.publicKey)}async function r_(n){if(n>$a)throw new E("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await ZE(n);return new Gl(t.privateKey,t.publicKey)}const s_=Object.freeze(Object.defineProperty({__proto__:null,MAX_RSA_KEY_SIZE:$a,RsaPrivateKey:Gl,RsaPublicKey:pd,fromJwk:n_,generateKeyPair:r_,unmarshalRsaPrivateKey:W5,unmarshalRsaPublicKey:t_},Symbol.toStringTag,{value:"Module"})),i_=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Nr=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Lr=new Uint32Array(64);class o_ extends ed{constructor(){super(64,32,8,!1),this.A=Nr[0]|0,this.B=Nr[1]|0,this.C=Nr[2]|0,this.D=Nr[3]|0,this.E=Nr[4]|0,this.F=Nr[5]|0,this.G=Nr[6]|0,this.H=Nr[7]|0}get(){const{A:t,B:e,C:r,D:s,E:i,F:o,G:a,H:c}=this;return[t,e,r,s,i,o,a,c]}set(t,e,r,s,i,o,a,c){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(t,e){for(let d=0;d<16;d++,e+=4)Lr[d]=t.getUint32(e,!1);for(let d=16;d<64;d++){const f=Lr[d-15],p=Lr[d-2],m=xn(f,7)^xn(f,18)^f>>>3,g=xn(p,17)^xn(p,19)^p>>>10;Lr[d]=g+Lr[d-7]+m+Lr[d-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let d=0;d<64;d++){const f=xn(a,6)^xn(a,11)^xn(a,25),p=h+f+i6(a,c,l)+i_[d]+Lr[d]|0,g=(xn(r,2)^xn(r,13)^xn(r,22))+o6(r,s,i)|0;h=l,l=c,c=a,a=o+p|0,o=i,i=s,s=r,r=p+g|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(r,s,i,o,a,c,l,h)}roundClean(){Lr.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const Qo=Jh(()=>new o_);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function qf(n){n.lowS!==void 0&&mr("lowS",n.lowS),n.prehash!==void 0&&mr("prehash",n.prehash)}function a_(n){const t=sd(n);js(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:e,Fp:r,a:s}=t;if(e){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof e!="object"||typeof e.beta!="bigint"||typeof e.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:c_,hexToBytes:l_}=jb,or={Err:class extends Error{constructor(t=""){super(t)}},_tlv:{encode:(n,t)=>{const{Err:e}=or;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");const r=t.length/2,s=oi(r);if(s.length/2&128)throw new e("tlv.encode: long form length too big");const i=r>127?oi(s.length/2|128):"";return`${oi(n)}${i}${s}${t}`},decode(n,t){const{Err:e}=or;let r=0;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[r++]!==n)throw new e("tlv.decode: wrong tlv");const s=t[r++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new e("tlv.decode(long): indefinite length not supported");if(c>4)throw new e("tlv.decode(long): byte length is too big");const l=t.subarray(r,r+c);if(l.length!==c)throw new e("tlv.decode: length bytes not complete");if(l[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(r+=c,o<128)throw new e("tlv.decode(long): not minimal encoding")}const a=t.subarray(r,r+o);if(a.length!==o)throw new e("tlv.decode: wrong value length");return{v:a,l:t.subarray(r+o)}}},_int:{encode(n){const{Err:t}=or;if(n<lr)throw new t("integer: negative integers are not allowed");let e=oi(n);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected assertion");return e},decode(n){const{Err:t}=or;if(n[0]&128)throw new t("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return c_(n)}},toSig(n){const{Err:t,_int:e,_tlv:r}=or,s=typeof n=="string"?l_(n):n;Ma(s);const{v:i,l:o}=r.decode(48,s);if(o.length)throw new t("Invalid signature: left bytes after parsing");const{v:a,l:c}=r.decode(2,i),{v:l,l:h}=r.decode(2,c);if(h.length)throw new t("Invalid signature: left bytes after parsing");return{r:e.decode(a),s:e.decode(l)}},hexFromSig(n){const{_tlv:t,_int:e}=or,r=`${t.encode(2,e.encode(n.r))}${t.encode(2,e.encode(n.s))}`;return t.encode(48,r)}},lr=BigInt(0),ut=BigInt(1);BigInt(2);const Wf=BigInt(3);BigInt(4);function u_(n){const t=a_(n),{Fp:e}=t,r=ql(t.n,t.nBitLength),s=t.toBytes||((g,y,w)=>{const _=y.toAffine();return Hs(Uint8Array.from([4]),e.toBytes(_.x),e.toBytes(_.y))}),i=t.fromBytes||(g=>{const y=g.subarray(1),w=e.fromBytes(y.subarray(0,e.BYTES)),_=e.fromBytes(y.subarray(e.BYTES,2*e.BYTES));return{x:w,y:_}});function o(g){const{a:y,b:w}=t,_=e.sqr(g),b=e.mul(_,g);return e.add(e.add(b,e.mul(g,y)),w)}if(!e.eql(e.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(g){return zl(g,ut,t.n)}function c(g){const{allowedPrivateKeyLengths:y,nByteLength:w,wrapPrivateKey:_,n:b}=t;if(y&&typeof g!="bigint"){if(Fs(g)&&(g=Vs(g)),typeof g!="string"||!y.includes(g.length))throw new Error("Invalid key");g=g.padStart(w*2,"0")}let v;try{v=typeof g=="bigint"?g:Ls(tt("private key",g,w))}catch{throw new Error(`private key must be ${w} bytes, hex or bigint, not ${typeof g}`)}return _&&(v=Me(v,b)),Wt("private key",v,ut,b),v}function l(g){if(!(g instanceof f))throw new Error("ProjectivePoint expected")}const h=ua((g,y)=>{const{px:w,py:_,pz:b}=g;if(e.eql(b,e.ONE))return{x:w,y:_};const v=g.is0();y==null&&(y=v?e.ONE:e.inv(b));const A=e.mul(w,y),R=e.mul(_,y),k=e.mul(b,y);if(v)return{x:e.ZERO,y:e.ZERO};if(!e.eql(k,e.ONE))throw new Error("invZ was invalid");return{x:A,y:R}}),d=ua(g=>{if(g.is0()){if(t.allowInfinityPoint&&!e.is0(g.py))return;throw new Error("bad point: ZERO")}const{x:y,y:w}=g.toAffine();if(!e.isValid(y)||!e.isValid(w))throw new Error("bad point: x or y not FE");const _=e.sqr(w),b=o(y);if(!e.eql(_,b))throw new Error("bad point: equation left != right");if(!g.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class f{constructor(y,w,_){if(this.px=y,this.py=w,this.pz=_,y==null||!e.isValid(y))throw new Error("x required");if(w==null||!e.isValid(w))throw new Error("y required");if(_==null||!e.isValid(_))throw new Error("z required");Object.freeze(this)}static fromAffine(y){const{x:w,y:_}=y||{};if(!y||!e.isValid(w)||!e.isValid(_))throw new Error("invalid affine point");if(y instanceof f)throw new Error("projective point not allowed");const b=v=>e.eql(v,e.ZERO);return b(w)&&b(_)?f.ZERO:new f(w,_,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){const w=e.invertBatch(y.map(_=>_.pz));return y.map((_,b)=>_.toAffine(w[b])).map(f.fromAffine)}static fromHex(y){const w=f.fromAffine(i(tt("pointHex",y)));return w.assertValidity(),w}static fromPrivateKey(y){return f.BASE.multiply(c(y))}static msm(y,w){return p6(f,r,y,w)}_setWindowSize(y){m.setWindowSize(this,y)}assertValidity(){d(this)}hasEvenY(){const{y}=this.toAffine();if(e.isOdd)return!e.isOdd(y);throw new Error("Field doesn't support isOdd")}equals(y){l(y);const{px:w,py:_,pz:b}=this,{px:v,py:A,pz:R}=y,k=e.eql(e.mul(w,R),e.mul(v,b)),C=e.eql(e.mul(_,R),e.mul(A,b));return k&&C}negate(){return new f(this.px,e.neg(this.py),this.pz)}double(){const{a:y,b:w}=t,_=e.mul(w,Wf),{px:b,py:v,pz:A}=this;let R=e.ZERO,k=e.ZERO,C=e.ZERO,S=e.mul(b,b),B=e.mul(v,v),O=e.mul(A,A),M=e.mul(b,v);return M=e.add(M,M),C=e.mul(b,A),C=e.add(C,C),R=e.mul(y,C),k=e.mul(_,O),k=e.add(R,k),R=e.sub(B,k),k=e.add(B,k),k=e.mul(R,k),R=e.mul(M,R),C=e.mul(_,C),O=e.mul(y,O),M=e.sub(S,O),M=e.mul(y,M),M=e.add(M,C),C=e.add(S,S),S=e.add(C,S),S=e.add(S,O),S=e.mul(S,M),k=e.add(k,S),O=e.mul(v,A),O=e.add(O,O),S=e.mul(O,M),R=e.sub(R,S),C=e.mul(O,B),C=e.add(C,C),C=e.add(C,C),new f(R,k,C)}add(y){l(y);const{px:w,py:_,pz:b}=this,{px:v,py:A,pz:R}=y;let k=e.ZERO,C=e.ZERO,S=e.ZERO;const B=t.a,O=e.mul(t.b,Wf);let M=e.mul(w,v),U=e.mul(_,A),N=e.mul(b,R),D=e.add(w,_),T=e.add(v,A);D=e.mul(D,T),T=e.add(M,U),D=e.sub(D,T),T=e.add(w,b);let I=e.add(v,R);return T=e.mul(T,I),I=e.add(M,N),T=e.sub(T,I),I=e.add(_,b),k=e.add(A,R),I=e.mul(I,k),k=e.add(U,N),I=e.sub(I,k),S=e.mul(B,T),k=e.mul(O,N),S=e.add(k,S),k=e.sub(U,S),S=e.add(U,S),C=e.mul(k,S),U=e.add(M,M),U=e.add(U,M),N=e.mul(B,N),T=e.mul(O,T),U=e.add(U,N),N=e.sub(M,N),N=e.mul(B,N),T=e.add(T,N),M=e.mul(U,T),C=e.add(C,M),M=e.mul(I,T),k=e.mul(D,k),k=e.sub(k,M),M=e.mul(D,U),S=e.mul(I,S),S=e.add(S,M),new f(k,C,S)}subtract(y){return this.add(y.negate())}is0(){return this.equals(f.ZERO)}wNAF(y){return m.wNAFCached(this,y,f.normalizeZ)}multiplyUnsafe(y){Wt("scalar",y,lr,t.n);const w=f.ZERO;if(y===lr)return w;if(y===ut)return this;const{endo:_}=t;if(!_)return m.unsafeLadder(this,y);let{k1neg:b,k1:v,k2neg:A,k2:R}=_.splitScalar(y),k=w,C=w,S=this;for(;v>lr||R>lr;)v&ut&&(k=k.add(S)),R&ut&&(C=C.add(S)),S=S.double(),v>>=ut,R>>=ut;return b&&(k=k.negate()),A&&(C=C.negate()),C=new f(e.mul(C.px,_.beta),C.py,C.pz),k.add(C)}multiply(y){const{endo:w,n:_}=t;Wt("scalar",y,ut,_);let b,v;if(w){const{k1neg:A,k1:R,k2neg:k,k2:C}=w.splitScalar(y);let{p:S,f:B}=this.wNAF(R),{p:O,f:M}=this.wNAF(C);S=m.constTimeNegate(A,S),O=m.constTimeNegate(k,O),O=new f(e.mul(O.px,w.beta),O.py,O.pz),b=S.add(O),v=B.add(M)}else{const{p:A,f:R}=this.wNAF(y);b=A,v=R}return f.normalizeZ([b,v])[0]}multiplyAndAddUnsafe(y,w,_){const b=f.BASE,v=(R,k)=>k===lr||k===ut||!R.equals(b)?R.multiplyUnsafe(k):R.multiply(k),A=v(this,w).add(v(y,_));return A.is0()?void 0:A}toAffine(y){return h(this,y)}isTorsionFree(){const{h:y,isTorsionFree:w}=t;if(y===ut)return!0;if(w)return w(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:y,clearCofactor:w}=t;return y===ut?this:w?w(f,this):this.multiplyUnsafe(t.h)}toRawBytes(y=!0){return mr("isCompressed",y),this.assertValidity(),s(f,this,y)}toHex(y=!0){return mr("isCompressed",y),Vs(this.toRawBytes(y))}}f.BASE=new f(t.Gx,t.Gy,e.ONE),f.ZERO=new f(e.ZERO,e.ONE,e.ZERO);const p=t.nBitLength,m=g6(f,t.endo?Math.ceil(p/2):p);return{CURVE:t,ProjectivePoint:f,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:a}}function h_(n){const t=sd(n);return js(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function d_(n){const t=h_(n),{Fp:e,n:r}=t,s=e.BYTES+1,i=2*e.BYTES+1;function o(N){return Me(N,r)}function a(N){return y1(N,r)}const{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:h,isWithinCurveOrder:d}=u_({...t,toBytes(N,D,T){const I=D.toAffine(),P=e.toBytes(I.x),L=Hs;return mr("isCompressed",T),T?L(Uint8Array.from([D.hasEvenY()?2:3]),P):L(Uint8Array.from([4]),P,e.toBytes(I.y))},fromBytes(N){const D=N.length,T=N[0],I=N.subarray(1);if(D===s&&(T===2||T===3)){const P=Ls(I);if(!zl(P,ut,e.ORDER))throw new Error("Point is not on curve");const L=h(P);let $;try{$=e.sqrt(L)}catch(te){const ne=te instanceof Error?": "+te.message:"";throw new Error("Point is not on curve"+ne)}const z=($&ut)===ut;return(T&1)===1!==z&&($=e.neg($)),{x:P,y:$}}else if(D===i&&T===4){const P=e.fromBytes(I.subarray(0,e.BYTES)),L=e.fromBytes(I.subarray(e.BYTES,2*e.BYTES));return{x:P,y:L}}else throw new Error(`Point of length ${D} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),f=N=>Vs(Vi(N,t.nByteLength));function p(N){const D=r>>ut;return N>D}function m(N){return p(N)?o(-N):N}const g=(N,D,T)=>Ls(N.slice(D,T));class y{constructor(D,T,I){this.r=D,this.s=T,this.recovery=I,this.assertValidity()}static fromCompact(D){const T=t.nByteLength;return D=tt("compactSignature",D,T*2),new y(g(D,0,T),g(D,T,2*T))}static fromDER(D){const{r:T,s:I}=or.toSig(tt("DER",D));return new y(T,I)}assertValidity(){Wt("r",this.r,ut,r),Wt("s",this.s,ut,r)}addRecoveryBit(D){return new y(this.r,this.s,D)}recoverPublicKey(D){const{r:T,s:I,recovery:P}=this,L=R(tt("msgHash",D));if(P==null||![0,1,2,3].includes(P))throw new Error("recovery id invalid");const $=P===2||P===3?T+t.n:T;if($>=e.ORDER)throw new Error("recovery id 2 or 3 invalid");const z=P&1?"03":"02",q=c.fromHex(z+f($)),te=a($),ne=o(-L*te),oe=o(I*te),ce=c.BASE.multiplyAndAddUnsafe(q,ne,oe);if(!ce)throw new Error("point at infinify");return ce.assertValidity(),ce}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Fi(this.toDERHex())}toDERHex(){return or.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Fi(this.toCompactHex())}toCompactHex(){return f(this.r)+f(this.s)}}const w={isValidPrivateKey(N){try{return l(N),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const N=f6(t.n);return aE(t.randomBytes(N),t.n)},precompute(N=8,D=c.BASE){return D._setWindowSize(N),D.multiply(BigInt(3)),D}};function _(N,D=!0){return c.fromPrivateKey(N).toRawBytes(D)}function b(N){const D=Fs(N),T=typeof N=="string",I=(D||T)&&N.length;return D?I===s||I===i:T?I===2*s||I===2*i:N instanceof c}function v(N,D,T=!0){if(b(N))throw new Error("first arg must be private key");if(!b(D))throw new Error("second arg must be public key");return c.fromHex(D).multiply(l(N)).toRawBytes(T)}const A=t.bits2int||function(N){const D=Ls(N),T=N.length*8-t.nBitLength;return T>0?D>>BigInt(T):D},R=t.bits2int_modN||function(N){return o(A(N))},k=rd(t.nBitLength);function C(N){return Wt(`num < 2^${t.nBitLength}`,N,lr,k),Vi(N,t.nByteLength)}function S(N,D,T=B){if(["recovered","canonical"].some(ye=>ye in T))throw new Error("sign() legacy options not supported");const{hash:I,randomBytes:P}=t;let{lowS:L,prehash:$,extraEntropy:z}=T;L==null&&(L=!0),N=tt("msgHash",N),qf(T),$&&(N=tt("prehashed msgHash",I(N)));const q=R(N),te=l(D),ne=[C(te),C(q)];if(z!=null&&z!==!1){const ye=z===!0?P(e.BYTES):z;ne.push(tt("extraEntropy",ye))}const oe=Hs(...ne),ce=q;function be(ye){const Le=A(ye);if(!d(Le))return;const rt=a(Le),Ke=c.BASE.multiply(Le).toAffine(),Qe=o(Ke.x);if(Qe===lr)return;const lt=o(rt*o(ce+Qe*te));if(lt===lr)return;let st=(Ke.x===Qe?0:2)|Number(Ke.y&ut),we=lt;return L&&p(lt)&&(we=m(lt),st^=1),new y(Qe,we,st)}return{seed:oe,k2sig:be}}const B={lowS:t.lowS,prehash:!1},O={lowS:t.lowS,prehash:!1};function M(N,D,T=B){const{seed:I,k2sig:P}=S(N,D,T),L=t;return l6(L.hash.outputLen,L.nByteLength,L.hmac)(I,P)}c.BASE._setWindowSize(8);function U(N,D,T,I=O){var Ke;const P=N;if(D=tt("msgHash",D),T=tt("publicKey",T),"strict"in I)throw new Error("options.strict was renamed to lowS");qf(I);const{lowS:L,prehash:$}=I;let z,q;try{if(typeof P=="string"||Fs(P))try{z=y.fromDER(P)}catch(Qe){if(!(Qe instanceof or.Err))throw Qe;z=y.fromCompact(P)}else if(typeof P=="object"&&typeof P.r=="bigint"&&typeof P.s=="bigint"){const{r:Qe,s:lt}=P;z=new y(Qe,lt)}else throw new Error("PARSE");q=c.fromHex(T)}catch(Qe){if(Qe.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(L&&z.hasHighS())return!1;$&&(D=t.hash(D));const{r:te,s:ne}=z,oe=R(D),ce=a(ne),be=o(oe*ce),ye=o(te*ce),Le=(Ke=c.BASE.multiplyAndAddUnsafe(q,be,ye))==null?void 0:Ke.toAffine();return Le?o(Le.x)===te:!1}return{CURVE:t,getPublicKey:_,getSharedSecret:v,sign:M,verify:U,ProjectivePoint:c,Signature:y,utils:w}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function f_(n){return{hash:n,hmac:(t,...e)=>Ua(n,t,pb(...e)),randomBytes:Vl}}function g_(n,t){const e=r=>d_({...n,...f_(r)});return Object.freeze({...e(t),create:e})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const G5=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Gf=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),p_=BigInt(1),S1=BigInt(2),Yf=(n,t)=>(n+t/S1)/t;function y_(n){const t=G5,e=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=n*n*n%t,h=l*l*n%t,d=Ge(h,e,t)*h%t,f=Ge(d,e,t)*h%t,p=Ge(f,S1,t)*l%t,m=Ge(p,s,t)*p%t,g=Ge(m,i,t)*m%t,y=Ge(g,a,t)*g%t,w=Ge(y,c,t)*y%t,_=Ge(w,a,t)*g%t,b=Ge(_,e,t)*h%t,v=Ge(b,o,t)*m%t,A=Ge(v,r,t)*l%t,R=Ge(A,S1,t);if(!R1.eql(R1.sqr(R),n))throw new Error("Cannot find square root");return R}const R1=ql(G5,void 0,void 0,{sqrt:y_}),Qn=g_({a:BigInt(0),b:BigInt(7),Fp:R1,n:Gf,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:n=>{const t=Gf,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-p_*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=e,o=BigInt("0x100000000000000000000000000000000"),a=Yf(i*n,t),c=Yf(-r*n,t);let l=Me(n-a*e-c*s,t),h=Me(-a*r-c*i,t);const d=l>o,f=h>o;if(d&&(l=t-l),f&&(h=t-h),l>o||h>o)throw new Error("splitScalar: Endomorphism failed, k="+n);return{k1neg:d,k1:l,k2neg:f,k2:h}}}},Qo);BigInt(0);Qn.ProjectivePoint;function m_(){return Qn.utils.randomPrivateKey()}function w_(n,t){const e=We.digest(t instanceof Uint8Array?t:t.subarray());if(us(e))return e.then(({digest:r})=>Qn.sign(r,n).toDERRawBytes()).catch(r=>{throw new E(String(r),"ERR_INVALID_INPUT")});try{return Qn.sign(e.digest,n).toDERRawBytes()}catch(r){throw new E(String(r),"ERR_INVALID_INPUT")}}function b_(n,t,e){const r=We.digest(e instanceof Uint8Array?e:e.subarray());if(us(r))return r.then(({digest:s})=>Qn.verify(t,s,n)).catch(s=>{throw new E(String(s),"ERR_INVALID_INPUT")});try{return Qn.verify(t,r.digest,n)}catch(s){throw new E(String(s),"ERR_INVALID_INPUT")}}function E_(n){return Qn.ProjectivePoint.fromHex(n).toRawBytes(!0)}function __(n){try{Qn.getPublicKey(n,!0)}catch(t){throw new E(String(t),"ERR_INVALID_PRIVATE_KEY")}}function Y5(n){try{Qn.ProjectivePoint.fromHex(n)}catch(t){throw new E(String(t),"ERR_INVALID_PUBLIC_KEY")}}function v_(n){try{return Qn.getPublicKey(n,!0)}catch(t){throw new E(String(t),"ERR_INVALID_PRIVATE_KEY")}}class yd{constructor(t){u(this,"_key");Y5(t),this._key=t}verify(t,e){return b_(this._key,e,t)}marshal(){return E_(this._key)}get bytes(){return Ki.encode({Type:ot.Secp256k1,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}async hash(){const t=We.digest(this.bytes);let e;return us(t)?{bytes:e}=await t:e=t.bytes,e}}class md{constructor(t,e){u(this,"_key");u(this,"_publicKey");this._key=t,this._publicKey=e??v_(t),__(this._key),Y5(this._publicKey)}sign(t){return w_(this._key,t)}get public(){return new yd(this._publicKey)}marshal(){return this._key}get bytes(){return zi.encode({Type:ot.Secp256k1,Data:this.marshal()}).subarray()}equals(t){return ve(this.bytes,t.bytes)}hash(){const t=We.digest(this.bytes);return us(t)?t.then(({bytes:e})=>e):t.bytes}async id(){const t=await this.public.hash();return W(t,"base58btc")}async export(t,e="libp2p-key"){if(e==="libp2p-key")return id(this.bytes,t);throw new E(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function S_(n){return new md(n)}function R_(n){return new yd(n)}async function A_(){const n=m_();return new md(n)}const I_=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:md,Secp256k1PublicKey:yd,generateKeyPair:A_,unmarshalSecp256k1PrivateKey:S_,unmarshalSecp256k1PublicKey:R_},Symbol.toStringTag,{value:"Module"})),Xr={rsa:s_,ed25519:DE,secp256k1:I_};function wd(n){const t=Object.keys(Xr).join(" / ");return new E(`invalid or unsupported key type ${n}. Must be ${t}`,"ERR_UNSUPPORTED_KEY_TYPE")}function bd(n){if(n=n.toLowerCase(),n==="rsa"||n==="ed25519"||n==="secp256k1")return Xr[n];throw wd(n)}async function Q5(n,t){return bd(n).generateKeyPair(t??2048)}function ma(n){const t=Ki.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case ot.RSA:return Xr.rsa.unmarshalRsaPublicKey(e);case ot.Ed25519:return Xr.ed25519.unmarshalEd25519PublicKey(e);case ot.Secp256k1:return Xr.secp256k1.unmarshalSecp256k1PublicKey(e);default:throw wd(t.Type??"unknown")}}function X5(n,t){return t=(t??"rsa").toLowerCase(),bd(t),n.bytes}async function Gi(n){const t=zi.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case ot.RSA:return Xr.rsa.unmarshalRsaPrivateKey(e);case ot.Ed25519:return Xr.ed25519.unmarshalEd25519PrivateKey(e);case ot.Secp256k1:return Xr.secp256k1.unmarshalSecp256k1PrivateKey(e);default:throw wd(t.Type??"RSA")}}function k_(n,t){return t=(t??"rsa").toLowerCase(),bd(t),n.bytes}async function sc(n,t){try{const e=await CE(n,t);return await Gi(e)}catch{}if(!n.includes("BEGIN"))throw new E("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return QE(n,t)}const Lo=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),Pr=new Uint32Array(80);class x_ extends ed{constructor(){super(64,20,8,!1),this.A=Lo[0]|0,this.B=Lo[1]|0,this.C=Lo[2]|0,this.D=Lo[3]|0,this.E=Lo[4]|0}get(){const{A:t,B:e,C:r,D:s,E:i}=this;return[t,e,r,s,i]}set(t,e,r,s,i){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0}process(t,e){for(let c=0;c<16;c++,e+=4)Pr[c]=t.getUint32(e,!1);for(let c=16;c<80;c++)Pr[c]=Ru(Pr[c-3]^Pr[c-8]^Pr[c-14]^Pr[c-16],1);let{A:r,B:s,C:i,D:o,E:a}=this;for(let c=0;c<80;c++){let l,h;c<20?(l=i6(s,i,o),h=1518500249):c<40?(l=s^i^o,h=1859775393):c<60?(l=o6(s,i,o),h=2400959708):(l=s^i^o,h=3395469782);const d=Ru(r,5)+l+a+h+Pr[c]|0;a=o,o=i,i=Ru(s,30),s=r,r=d}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(r,s,i,o,a)}roundClean(){Pr.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}}const T_=Jh(()=>new x_),Qf={sha1:T_,"sha2-256":Qo,"sha2-512":Hl};function Xf(n,t,e,r,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(Qf).join(" / ");throw new E(`Hash '${s}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}const i=Qf[s],o=NE(i,n,t,{c:e,dkLen:r});return ln.encode(o).substring(1)}var Z5=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ir(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var A1={exports:{}};(function(n,t){(function(e,r){var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(g){if(!Array.isArray(g)&&!ArrayBuffer.isView(g))return!1;for(var y=0;y<g.length;y++)if(!Number.isInteger(g[y])||g[y]<0||g[y]>255)return!1;return!0}function o(g,y){return(g&65535)*y+(((g>>>16)*y&65535)<<16)}function a(g,y){return g<<y|g>>>32-y}function c(g){return g^=g>>>16,g=o(g,2246822507),g^=g>>>13,g=o(g,3266489909),g^=g>>>16,g}function l(g,y){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],y=[y[0]>>>16,y[0]&65535,y[1]>>>16,y[1]&65535];var w=[0,0,0,0];return w[3]+=g[3]+y[3],w[2]+=w[3]>>>16,w[3]&=65535,w[2]+=g[2]+y[2],w[1]+=w[2]>>>16,w[2]&=65535,w[1]+=g[1]+y[1],w[0]+=w[1]>>>16,w[1]&=65535,w[0]+=g[0]+y[0],w[0]&=65535,[w[0]<<16|w[1],w[2]<<16|w[3]]}function h(g,y){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],y=[y[0]>>>16,y[0]&65535,y[1]>>>16,y[1]&65535];var w=[0,0,0,0];return w[3]+=g[3]*y[3],w[2]+=w[3]>>>16,w[3]&=65535,w[2]+=g[2]*y[3],w[1]+=w[2]>>>16,w[2]&=65535,w[2]+=g[3]*y[2],w[1]+=w[2]>>>16,w[2]&=65535,w[1]+=g[1]*y[3],w[0]+=w[1]>>>16,w[1]&=65535,w[1]+=g[2]*y[2],w[0]+=w[1]>>>16,w[1]&=65535,w[1]+=g[3]*y[1],w[0]+=w[1]>>>16,w[1]&=65535,w[0]+=g[0]*y[3]+g[1]*y[2]+g[2]*y[1]+g[3]*y[0],w[0]&=65535,[w[0]<<16|w[1],w[2]<<16|w[3]]}function d(g,y){return y%=64,y===32?[g[1],g[0]]:y<32?[g[0]<<y|g[1]>>>32-y,g[1]<<y|g[0]>>>32-y]:(y-=32,[g[1]<<y|g[0]>>>32-y,g[0]<<y|g[1]>>>32-y])}function f(g,y){return y%=64,y===0?g:y<32?[g[0]<<y|g[1]>>>32-y,g[1]<<y]:[g[1]<<y-32,0]}function p(g,y){return[g[0]^y[0],g[1]^y[1]]}function m(g){return g=p(g,[0,g[0]>>>1]),g=h(g,[4283543511,3981806797]),g=p(g,[0,g[0]>>>1]),g=h(g,[3301882366,444984403]),g=p(g,[0,g[0]>>>1]),g}s.x86.hash32=function(g,y){if(s.inputValidation&&!i(g))return r;y=y||0;for(var w=g.length%4,_=g.length-w,b=y,v=0,A=3432918353,R=461845907,k=0;k<_;k=k+4)v=g[k]|g[k+1]<<8|g[k+2]<<16|g[k+3]<<24,v=o(v,A),v=a(v,15),v=o(v,R),b^=v,b=a(b,13),b=o(b,5)+3864292196;switch(v=0,w){case 3:v^=g[k+2]<<16;case 2:v^=g[k+1]<<8;case 1:v^=g[k],v=o(v,A),v=a(v,15),v=o(v,R),b^=v}return b^=g.length,b=c(b),b>>>0},s.x86.hash128=function(g,y){if(s.inputValidation&&!i(g))return r;y=y||0;for(var w=g.length%16,_=g.length-w,b=y,v=y,A=y,R=y,k=0,C=0,S=0,B=0,O=597399067,M=2869860233,U=951274213,N=2716044179,D=0;D<_;D=D+16)k=g[D]|g[D+1]<<8|g[D+2]<<16|g[D+3]<<24,C=g[D+4]|g[D+5]<<8|g[D+6]<<16|g[D+7]<<24,S=g[D+8]|g[D+9]<<8|g[D+10]<<16|g[D+11]<<24,B=g[D+12]|g[D+13]<<8|g[D+14]<<16|g[D+15]<<24,k=o(k,O),k=a(k,15),k=o(k,M),b^=k,b=a(b,19),b+=v,b=o(b,5)+1444728091,C=o(C,M),C=a(C,16),C=o(C,U),v^=C,v=a(v,17),v+=A,v=o(v,5)+197830471,S=o(S,U),S=a(S,17),S=o(S,N),A^=S,A=a(A,15),A+=R,A=o(A,5)+2530024501,B=o(B,N),B=a(B,18),B=o(B,O),R^=B,R=a(R,13),R+=b,R=o(R,5)+850148119;switch(k=0,C=0,S=0,B=0,w){case 15:B^=g[D+14]<<16;case 14:B^=g[D+13]<<8;case 13:B^=g[D+12],B=o(B,N),B=a(B,18),B=o(B,O),R^=B;case 12:S^=g[D+11]<<24;case 11:S^=g[D+10]<<16;case 10:S^=g[D+9]<<8;case 9:S^=g[D+8],S=o(S,U),S=a(S,17),S=o(S,N),A^=S;case 8:C^=g[D+7]<<24;case 7:C^=g[D+6]<<16;case 6:C^=g[D+5]<<8;case 5:C^=g[D+4],C=o(C,M),C=a(C,16),C=o(C,U),v^=C;case 4:k^=g[D+3]<<24;case 3:k^=g[D+2]<<16;case 2:k^=g[D+1]<<8;case 1:k^=g[D],k=o(k,O),k=a(k,15),k=o(k,M),b^=k}return b^=g.length,v^=g.length,A^=g.length,R^=g.length,b+=v,b+=A,b+=R,v+=b,A+=b,R+=b,b=c(b),v=c(v),A=c(A),R=c(R),b+=v,b+=A,b+=R,v+=b,A+=b,R+=b,("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(A>>>0).toString(16)).slice(-8)+("00000000"+(R>>>0).toString(16)).slice(-8)},s.x64.hash128=function(g,y){if(s.inputValidation&&!i(g))return r;y=y||0;for(var w=g.length%16,_=g.length-w,b=[0,y],v=[0,y],A=[0,0],R=[0,0],k=[2277735313,289559509],C=[1291169091,658871167],S=0;S<_;S=S+16)A=[g[S+4]|g[S+5]<<8|g[S+6]<<16|g[S+7]<<24,g[S]|g[S+1]<<8|g[S+2]<<16|g[S+3]<<24],R=[g[S+12]|g[S+13]<<8|g[S+14]<<16|g[S+15]<<24,g[S+8]|g[S+9]<<8|g[S+10]<<16|g[S+11]<<24],A=h(A,k),A=d(A,31),A=h(A,C),b=p(b,A),b=d(b,27),b=l(b,v),b=l(h(b,[0,5]),[0,1390208809]),R=h(R,C),R=d(R,33),R=h(R,k),v=p(v,R),v=d(v,31),v=l(v,b),v=l(h(v,[0,5]),[0,944331445]);switch(A=[0,0],R=[0,0],w){case 15:R=p(R,f([0,g[S+14]],48));case 14:R=p(R,f([0,g[S+13]],40));case 13:R=p(R,f([0,g[S+12]],32));case 12:R=p(R,f([0,g[S+11]],24));case 11:R=p(R,f([0,g[S+10]],16));case 10:R=p(R,f([0,g[S+9]],8));case 9:R=p(R,[0,g[S+8]]),R=h(R,C),R=d(R,33),R=h(R,k),v=p(v,R);case 8:A=p(A,f([0,g[S+7]],56));case 7:A=p(A,f([0,g[S+6]],48));case 6:A=p(A,f([0,g[S+5]],40));case 5:A=p(A,f([0,g[S+4]],32));case 4:A=p(A,f([0,g[S+3]],24));case 3:A=p(A,f([0,g[S+2]],16));case 2:A=p(A,f([0,g[S+1]],8));case 1:A=p(A,[0,g[S]]),A=h(A,k),A=d(A,31),A=h(A,C),b=p(b,A)}return b=p(b,[0,g.length]),v=p(v,[0,g.length]),b=l(b,v),v=l(v,b),b=m(b),v=m(v),b=l(b,v),v=l(v,b),("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)+("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)},n.exports&&(t=n.exports=s),t.murmurHash3=s})()})(A1,A1.exports);var D_=A1.exports,C_=D_;const wa=Ir(C_),N_=Math.LN2*Math.LN2;let L_=class{constructor(t={}){u(this,"seeds");u(this,"bits");u(this,"buffer");t.seeds!=null?this.seeds=t.seeds:this.seeds=B_(t.hashes??8),this.bits=t.bits??1024,this.buffer=Pe(Math.ceil(this.bits/8))}add(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.seeds.length;e++){const s=wa.x86.hash32(t,this.seeds[e])%this.bits;this.setbit(s)}}has(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.seeds.length;e++){const s=wa.x86.hash32(t,this.seeds[e])%this.bits;if(!this.getbit(s))return!1}return!0}clear(){this.buffer.fill(0)}setbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;let s=this.buffer[e];s|=1<<r,this.buffer[e]=s}getbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;return(this.buffer[e]&1<<r)!==0}};function P_(n,t=.005){const e=O_(n,t);return new L_(e)}function O_(n,t=.005){const e=Math.round(-1*n*Math.log(t)/N_),r=Math.round(e/n*Math.LN2);return{bits:e,hashes:r}}function B_(n){let t,e;const r=[];for(let s=0;s<n;s++)for(t=new Ie(Yn(4)),r[s]=t.getUint32(0,!0),e=0;e<s;e++)if(r[s]===r[e]){s--;break}return r}const j5=64;class Is{constructor(t,e,r,s=2){u(this,"fp");u(this,"h");u(this,"seed");if(s>j5)throw new TypeError("Invalid Fingerprint Size");const i=e.hashV(t,r),o=Pe(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=e,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return(t==null?void 0:t.fp)instanceof Uint8Array?ve(this.fp,t.fp):!1}}function Jc(n,t){return Math.floor(Math.random()*(t-n))+n}let ic=class{constructor(t){u(this,"contents");this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof Is))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof Is))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof Is))throw new TypeError("Invalid Fingerprint");const e=Jc(0,this.contents.length-1),r=this.contents[e];return this.contents[e]=t,r}remove(t){if(!(t instanceof Is))throw new TypeError("Invalid Fingerprint");const e=this.contents.findIndex(r=>t.equals(r));return e>-1?(this.contents[e]=null,!0):!1}};const Ed={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},J5={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},e8=new globalThis.TextEncoder;function M_(n,t){const e=Ed[t];let r=J5[t];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(t,r*e);return r}function U_(n,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Ed[t];let s=J5[t],i=n;for(;i.length>0;){const o=e8.encodeInto(i,e);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(e[a]),s=BigInt.asUintN(t,s*r)}return s}function $_(n,{size:t=32,utf8Buffer:e}={}){if(!Ed[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(e)return U_(n,t,e);n=e8.encode(n)}return M_(n,t)}const _d={hash:n=>Number($_(n,{size:32})),hashV:(n,t)=>F_(_d.hash(n,t))};function F_(n){let t=n.toString(16);return t.length%2===1&&(t=`0${t}`),V(t,"base16")}const V_=500;class Zf{constructor(t){u(this,"bucketSize");u(this,"filterSize");u(this,"fingerprintSize");u(this,"buckets");u(this,"count");u(this,"hash");u(this,"seed");this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??_d,this.seed=t.seed??Jc(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=V(t));const e=new Is(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=(r^e.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new ic(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new ic(this.bucketSize)),this.buckets[r].add(e)||this.buckets[s].add(e))return this.count++,!0;const i=[r,s];let o=i[Jc(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new ic(this.bucketSize));for(let a=0;a<V_;a++){const c=this.buckets[o].swap(e);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new ic(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(t){var o,a;typeof t=="string"&&(t=V(t));const e=new Is(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=((o=this.buckets[r])==null?void 0:o.has(e))??!1;if(s)return s;const i=(r^e.hash())%this.filterSize;return((a=this.buckets[i])==null?void 0:a.has(e))??!1}remove(t){var a,c;typeof t=="string"&&(t=V(t));const e=new Is(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=((a=this.buckets[r])==null?void 0:a.remove(e))??!1;if(s)return this.count--,s;const i=(r^e.hash())%this.filterSize,o=((c=this.buckets[i])==null?void 0:c.remove(e))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const H_={1:.5,2:.84,4:.95,8:.98};function K_(n=.001){return n>.002?2:n>1e-5?4:8}function z_(n,t=.001){const e=K_(t),r=H_[e],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*e)),j5);return{filterSize:s,bucketSize:e,fingerprintSize:i}}class q_{constructor(t){u(this,"filterSize");u(this,"bucketSize");u(this,"fingerprintSize");u(this,"scale");u(this,"filterSeries");u(this,"hash");u(this,"seed");this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??_d,this.seed=t.seed??Jc(0,Math.pow(2,10)),this.filterSeries=[new Zf({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=V(t)),this.has(t))return!0;let e=this.filterSeries.find(r=>r.reliable);if(e==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new Zf({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}}function t8(n,t=.001,e){return new q_({...z_(n,t)})}class W_{constructor(t,e){u(this,"filter");this.filter=t8(t,e)}has(t){return this.filter.has(t.toBytes())}add(t){this.filter.add(t.toBytes())}remove(t){var e,r;(r=(e=this.filter).remove)==null||r.call(e,t.toBytes())}}function G_(n,t=.001){return new W_(n,t)}class Y_ extends Sr{constructor(e){super();u(this,"metric");const{name:r,metrics:s}=e;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(e,r){return super.set(e,r),this.updateComponentMetric(),this}delete(e){const r=super.delete(e);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function n8(n){const{name:t,metrics:e}=n;let r;return e!=null?r=new Y_({name:t,metrics:e}):r=new Sr,r}class $o{constructor(t=!1,e=0){u(this,"full");u(this,"pendingBytes");u(this,"wantlist");u(this,"blocks");u(this,"blockPresences");this.full=t,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(t,e){const r=ln.encode(t.multihash.bytes);this.wantlist.set(r,e)}addBlockPresence(t,e){const r=ln.encode(t.multihash.bytes);this.blockPresences.set(r,e)}addBlock(t,e){const r=ln.encode(t.multihash.bytes);this.blocks.set(r,e)}}function Q_(n){let t=new Uint8Array(n.reduce((r,s)=>r+He(s),0)),e=0;for(const r of n)t=Ot(r,t,e),e+=He(r);return t}function jf(n){return Q_([n.version,n.code,n.multihash.code,n.multihash.digest.byteLength])}class X_{constructor(t,e){u(this,"peerId");u(this,"blockstore");u(this,"network");u(this,"wants");u(this,"exchangeCount");u(this,"bytesSent");u(this,"bytesReceived");u(this,"lastExchange");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");this.peerId=t.peerId,this.blockstore=t.blockstore,this.network=t.network,this.wants=new Map,this.log=t.logger.forComponent(`helia:bitswap:ledger:${t.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=e.maxSizeReplaceHasWithBlock??Qm}sentBytes(t){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=t}receivedBytes(t){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=t}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(t){const e=new $o,r=new Set;for(const[s,i]of this.wants.entries())try{const o=await this.blockstore.get(i.cid,t);i.wantType===ht.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),r.add(s),e.addBlock(i.cid,{data:o,prefix:jf(i.cid)})):(this.log("sending have for %c",i.cid),e.addBlockPresence(i.cid,{cid:i.cid.bytes,type:Hn.HaveBlock})):(this.log("sending block for %c",i.cid),r.add(s),e.addBlock(i.cid,{data:o,prefix:jf(i.cid)}))}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDontHave===!0)continue;i.sentDontHave=!0,e.addBlockPresence(i.cid,{cid:i.cid.bytes,type:Hn.DontHaveBlock})}if(e.blocks.size>0||e.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,e,t),this.log("sent message"),this.sentBytes([...e.blocks.values()].reduce((s,i)=>s+i.data.byteLength,0));for(const s of r)this.wants.delete(s)}}}class Z_{constructor(t,e={}){u(this,"blockstore");u(this,"network");u(this,"ledgerMap");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");u(this,"logger");this.blockstore=t.blockstore,this.network=t.network,this.maxSizeReplaceHasWithBlock=e.maxSizeReplaceHasWithBlock,this.log=t.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=t.logger,this.ledgerMap=n8({name:"helia_bitswap_ledger_map",metrics:t.metrics}),this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,s)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}ledgerForPeer(t){const e=this.ledgerMap.get(t);if(e!=null)return{peer:e.peerId,value:e.debtRatio(),sent:e.bytesSent,received:e.bytesReceived,exchanged:e.exchangeCount}}wantListForPeer(t){const e=this.ledgerMap.get(t);if(e!=null)return[...e.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(t=>t.peerId)}async receiveMessage(t,e){var s;let r=this.ledgerMap.get(t);if(r==null&&(r=new X_({peerId:t,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(t,r)),r.receivedBytes(((s=e.blocks)==null?void 0:s.reduce((i,o)=>i+o.data.byteLength,0))??0),e.wantlist!=null){e.wantlist.full===!0&&r.wants.clear();for(const i of e.wantlist.entries){const o=Q.decode(i.cid),a=W(o.multihash.bytes,"base64");i.cancel===!0?(this.log("peer %p cancelled want of block for %c",t,o),r.wants.delete(a)):(i.wantType===ht.WantHave?this.log("peer %p wanted block presence for %c",t,o):this.log("peer %p wanted block for %c",t,o),r.wants.set(a,{cid:o,priority:i.priority,wantType:i.wantType??ht.WantBlock,sendDontHave:i.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(t,e){const r=W(t.multihash.bytes,"base64"),s=[];for(const i of this.ledgerMap.values())i.wants.has(r)&&s.push(i);await Promise.all(s.map(async i=>i.sendBlocksToPeer(e)))}peerDisconnected(t){this.ledgerMap.delete(t)}}const Yi=1e3,Qi=Yi*60,Xi=Qi*60,zs=Xi*24,j_=zs*7,J_=zs*365.25;function r8(n,t){try{if(typeof n=="string"&&n.length>0)return ev(n);if(typeof n=="number"&&isFinite(n))return t!=null&&t.long?nv(n):tv(n);throw new Error("Value is not a string or number.")}catch(e){const r=rv(e)?`${e.message}. value=${JSON.stringify(n)}`:"An unknown error has occured.";throw new Error(r)}}function ev(n){if(n=String(n),n.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!t)return NaN;const e=parseFloat(t[1]),r=(t[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return e*J_;case"weeks":case"week":case"w":return e*j_;case"days":case"day":case"d":return e*zs;case"hours":case"hour":case"hrs":case"hr":case"h":return e*Xi;case"minutes":case"minute":case"mins":case"min":case"m":return e*Qi;case"seconds":case"second":case"secs":case"sec":case"s":return e*Yi;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function tv(n){const t=Math.abs(n);return t>=zs?`${Math.round(n/zs)}d`:t>=Xi?`${Math.round(n/Xi)}h`:t>=Qi?`${Math.round(n/Qi)}m`:t>=Yi?`${Math.round(n/Yi)}s`:`${n}ms`}function nv(n){const t=Math.abs(n);return t>=zs?oc(n,t,zs,"day"):t>=Xi?oc(n,t,Xi,"hour"):t>=Qi?oc(n,t,Qi,"minute"):t>=Yi?oc(n,t,Yi,"second"):`${n} ms`}function oc(n,t,e,r){const s=t>=e*1.5;return`${Math.round(n/e)} ${r}${s?"s":""}`}function rv(n){return typeof n=="object"&&n!==null&&"message"in n}function sv(n){e.debug=e,e.default=e,e.coerce=c,e.disable=i,e.enable=s,e.enabled=o,e.humanize=r8,e.destroy=l,Object.keys(n).forEach(h=>{e[h]=n[h]}),e.names=[],e.skips=[],e.formatters={};function t(h){let d=0;for(let f=0;f<h.length;f++)d=(d<<5)-d+h.charCodeAt(f),d|=0;return e.colors[Math.abs(d)%e.colors.length]}e.selectColor=t;function e(h){let d,f=null,p,m;function g(...y){if(!g.enabled)return;const w=g,_=Number(new Date),b=_-(d||_);w.diff=b,w.prev=d,w.curr=_,d=_,y[0]=e.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let v=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(R,k)=>{if(R==="%%")return"%";v++;const C=e.formatters[k];if(typeof C=="function"){const S=y[v];R=C.call(w,S),y.splice(v,1),v--}return R}),e.formatArgs.call(w,y),(w.log||e.log).apply(w,y)}return g.namespace=h,g.useColors=e.useColors(),g.color=e.selectColor(h),g.extend=r,g.destroy=e.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(p!==e.namespaces&&(p=e.namespaces,m=e.enabled(h)),m),set:y=>{f=y}}),typeof e.init=="function"&&e.init(g),g}function r(h,d){const f=e(this.namespace+(typeof d>"u"?":":d)+h);return f.log=this.log,f}function s(h){e.save(h),e.namespaces=h,e.names=[],e.skips=[];let d;const f=(typeof h=="string"?h:"").split(/[\s,]+/),p=f.length;for(d=0;d<p;d++)f[d]&&(h=f[d].replace(/\*/g,".*?"),h[0]==="-"?e.skips.push(new RegExp("^"+h.substr(1)+"$")):e.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...e.names.map(a),...e.skips.map(a).map(d=>"-"+d)].join(",");return e.enable(""),h}function o(h){if(h[h.length-1]==="*")return!0;let d,f;for(d=0,f=e.skips.length;d<f;d++)if(e.skips[d].test(h))return!1;for(d=0,f=e.names.length;d<f;d++)if(e.names[d].test(h))return!0;return!1}function a(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function c(h){return h instanceof Error?h.stack??h.message:h}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.setupFormatters(e.formatters),e.enable(e.load()),e}var iv={};const Un=dv(),ov=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function av(){var n,t,e,r,s;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((e=(t=document.documentElement)==null?void 0:t.style)==null?void 0:e.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((s=navigator.userAgent)==null?void 0:s.toLowerCase().match(/applewebkit\/(\d+)/))}function cv(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+r8(this.diff),!this.useColors)return;const t="color: "+this.color;n.splice(1,0,t,"color: inherit");let e=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(e++,s==="%c"&&(r=e))}),n.splice(r,0,t)}const lv=console.debug??console.log??(()=>{});function uv(n){try{n?Un==null||Un.setItem("debug",n):Un==null||Un.removeItem("debug")}catch{}}function hv(){let n;try{n=Un==null?void 0:Un.getItem("debug")}catch{}return!n&&typeof process<"u"&&"env"in process&&(n=iv.DEBUG),n}function dv(){try{return localStorage}catch{}}function fv(n){n.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}const an=sv({formatArgs:cv,save:uv,load:hv,useColors:av,setupFormatters:fv,colors:ov,storage:Un,log:lv});an.formatters.b=n=>n==null?"undefined":kt.baseEncode(n);an.formatters.t=n=>n==null?"undefined":zt.baseEncode(n);an.formatters.m=n=>n==null?"undefined":ln.baseEncode(n);an.formatters.p=n=>n==null?"undefined":n.toString();an.formatters.c=n=>n==null?"undefined":n.toString();an.formatters.k=n=>n==null?"undefined":n.toString();an.formatters.a=n=>n==null?"undefined":n.toString();function gv(n){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=n,t.destroy=()=>!0,t.extend=()=>t,t}function Yl(){return{forComponent(n){return Tt(n)}}}function Tt(n){let t=gv(`${n}:trace`);return an.enabled(`${n}:trace`)&&an.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=an(`${n}:trace`)),Object.assign(an(n),{error:an(`${n}:error`),trace:t})}var s8={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function s(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function i(c,l,h,d,f){if(typeof h!="function")throw new TypeError("The listener must be a function");var p=new s(h,d||c,f),m=e?e+l:l;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],p]:c._events[m].push(p):(c._events[m]=p,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],h,d;if(this._eventsCount===0)return l;for(d in h=this._events)t.call(h,d)&&l.push(e?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},a.prototype.listeners=function(l){var h=e?e+l:l,d=this._events[h];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,p=d.length,m=new Array(p);f<p;f++)m[f]=d[f].fn;return m},a.prototype.listenerCount=function(l){var h=e?e+l:l,d=this._events[h];return d?d.fn?1:d.length:0},a.prototype.emit=function(l,h,d,f,p,m){var g=e?e+l:l;if(!this._events[g])return!1;var y=this._events[g],w=arguments.length,_,b;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),w){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,h),!0;case 3:return y.fn.call(y.context,h,d),!0;case 4:return y.fn.call(y.context,h,d,f),!0;case 5:return y.fn.call(y.context,h,d,f,p),!0;case 6:return y.fn.call(y.context,h,d,f,p,m),!0}for(b=1,_=new Array(w-1);b<w;b++)_[b-1]=arguments[b];y.fn.apply(y.context,_)}else{var v=y.length,A;for(b=0;b<v;b++)switch(y[b].once&&this.removeListener(l,y[b].fn,void 0,!0),w){case 1:y[b].fn.call(y[b].context);break;case 2:y[b].fn.call(y[b].context,h);break;case 3:y[b].fn.call(y[b].context,h,d);break;case 4:y[b].fn.call(y[b].context,h,d,f);break;default:if(!_)for(A=1,_=new Array(w-1);A<w;A++)_[A-1]=arguments[A];y[b].fn.apply(y[b].context,_)}}return!0},a.prototype.on=function(l,h,d){return i(this,l,h,d,!1)},a.prototype.once=function(l,h,d){return i(this,l,h,d,!0)},a.prototype.removeListener=function(l,h,d,f){var p=e?e+l:l;if(!this._events[p])return this;if(!h)return o(this,p),this;var m=this._events[p];if(m.fn)m.fn===h&&(!f||m.once)&&(!d||m.context===d)&&o(this,p);else{for(var g=0,y=[],w=m.length;g<w;g++)(m[g].fn!==h||f&&!m[g].once||d&&m[g].context!==d)&&y.push(m[g]);y.length?this._events[p]=y.length===1?y[0]:y:o(this,p)}return this},a.prototype.removeAllListeners=function(l){var h;return l?(h=e?e+l:l,this._events[h]&&o(this,h)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,n.exports=a})(s8);var pv=s8.exports;const yv=Ir(pv);class vd extends Error{constructor(t){super(t),this.name="TimeoutError"}}let mv=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}};const Jf=n=>globalThis.DOMException===void 0?new mv(n):new DOMException(n),e2=n=>{const t=n.reason===void 0?Jf("This operation was aborted."):n.reason;return t instanceof Error?t:Jf(t)};function Fa(n,t){const{milliseconds:e,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o;const c=new Promise((l,h)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){const{signal:f}=t;f.aborted&&h(e2(f)),f.addEventListener("abort",()=>{h(e2(f))})}if(e===Number.POSITIVE_INFINITY){n.then(l,h);return}const d=new vd;o=i.setTimeout.call(void 0,()=>{if(r){try{l(r())}catch(f){h(f)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?l():s instanceof Error?h(s):(d.message=s??`Promise timed out after ${e} milliseconds`,h(d))},e),(async()=>{try{l(await n)}catch(f){h(f)}})()}).finally(()=>{c.clear()});return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}function wv(n,t,e){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let o=r+i;e(n[o],t)<=0?(r=++o,s-=i+1):s=i}return r}var Mn,o3;let bv=(o3=class{constructor(){fe(this,Mn,[])}enqueue(t,e){e={priority:0,...e};const r={priority:e.priority,run:t};if(this.size&&F(this,Mn)[this.size-1].priority>=e.priority){F(this,Mn).push(r);return}const s=wv(F(this,Mn),r,(i,o)=>o.priority-i.priority);F(this,Mn).splice(s,0,r)}dequeue(){const t=F(this,Mn).shift();return t==null?void 0:t.run}filter(t){return F(this,Mn).filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return F(this,Mn).length}},Mn=new WeakMap,o3);var Si,Ri,Vr,Sa,Ai,Ra,rn,Ii,Ht,Aa,sn,ki,ar,Ia,ke,i8,o8,a8,c8,l8,vc,I1,k1,Sc,u8,Rc;class Zi extends yv{constructor(e){var r,s;super();fe(this,ke);fe(this,Si);fe(this,Ri);fe(this,Vr,0);fe(this,Sa);fe(this,Ai);fe(this,Ra,0);fe(this,rn);fe(this,Ii);fe(this,Ht);fe(this,Aa);fe(this,sn,0);fe(this,ki);fe(this,ar);fe(this,Ia);u(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:bv,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=e.intervalCap)==null?void 0:r.toString())??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((s=e.interval)==null?void 0:s.toString())??""}\` (${typeof e.interval})`);Be(this,Si,e.carryoverConcurrencyCount),Be(this,Ri,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),Be(this,Sa,e.intervalCap),Be(this,Ai,e.interval),Be(this,Ht,new e.queueClass),Be(this,Aa,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,Be(this,Ia,e.throwOnTimeout===!0),Be(this,ar,e.autoStart===!1)}get concurrency(){return F(this,ki)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);Be(this,ki,e),re(this,ke,Sc).call(this)}async add(e,r={}){return r={timeout:this.timeout,throwOnTimeout:F(this,Ia),...r},new Promise((s,i)=>{F(this,Ht).enqueue(async()=>{var o;jn(this,sn)._++,jn(this,Vr)._++;try{(o=r.signal)==null||o.throwIfAborted();let a=e({signal:r.signal});r.timeout&&(a=Fa(Promise.resolve(a),{milliseconds:r.timeout})),r.signal&&(a=Promise.race([a,re(this,ke,u8).call(this,r.signal)]));const c=await a;s(c),this.emit("completed",c)}catch(a){if(a instanceof vd&&!r.throwOnTimeout){s();return}i(a),this.emit("error",a)}finally{re(this,ke,a8).call(this)}},r),this.emit("add"),re(this,ke,vc).call(this)})}async addAll(e,r){return Promise.all(e.map(async s=>this.add(s,r)))}start(){return F(this,ar)?(Be(this,ar,!1),re(this,ke,Sc).call(this),this):this}pause(){Be(this,ar,!0)}clear(){Be(this,Ht,new(F(this,Aa)))}async onEmpty(){F(this,Ht).size!==0&&await re(this,ke,Rc).call(this,"empty")}async onSizeLessThan(e){F(this,Ht).size<e||await re(this,ke,Rc).call(this,"next",()=>F(this,Ht).size<e)}async onIdle(){F(this,sn)===0&&F(this,Ht).size===0||await re(this,ke,Rc).call(this,"idle")}get size(){return F(this,Ht).size}sizeBy(e){return F(this,Ht).filter(e).length}get pending(){return F(this,sn)}get isPaused(){return F(this,ar)}}Si=new WeakMap,Ri=new WeakMap,Vr=new WeakMap,Sa=new WeakMap,Ai=new WeakMap,Ra=new WeakMap,rn=new WeakMap,Ii=new WeakMap,Ht=new WeakMap,Aa=new WeakMap,sn=new WeakMap,ki=new WeakMap,ar=new WeakMap,Ia=new WeakMap,ke=new WeakSet,i8=function(){return F(this,Ri)||F(this,Vr)<F(this,Sa)},o8=function(){return F(this,sn)<F(this,ki)},a8=function(){jn(this,sn)._--,re(this,ke,vc).call(this),this.emit("next")},c8=function(){re(this,ke,k1).call(this),re(this,ke,I1).call(this),Be(this,Ii,void 0)},l8=function(){const e=Date.now();if(F(this,rn)===void 0){const r=F(this,Ra)-e;if(r<0)Be(this,Vr,F(this,Si)?F(this,sn):0);else return F(this,Ii)===void 0&&Be(this,Ii,setTimeout(()=>{re(this,ke,c8).call(this)},r)),!0}return!1},vc=function(){if(F(this,Ht).size===0)return F(this,rn)&&clearInterval(F(this,rn)),Be(this,rn,void 0),this.emit("empty"),F(this,sn)===0&&this.emit("idle"),!1;if(!F(this,ar)){const e=!F(this,ke,l8);if(F(this,ke,i8)&&F(this,ke,o8)){const r=F(this,Ht).dequeue();return r?(this.emit("active"),r(),e&&re(this,ke,I1).call(this),!0):!1}}return!1},I1=function(){F(this,Ri)||F(this,rn)!==void 0||(Be(this,rn,setInterval(()=>{re(this,ke,k1).call(this)},F(this,Ai))),Be(this,Ra,Date.now()+F(this,Ai)))},k1=function(){F(this,Vr)===0&&F(this,sn)===0&&F(this,rn)&&(clearInterval(F(this,rn)),Be(this,rn,void 0)),Be(this,Vr,F(this,Si)?F(this,sn):0),re(this,ke,Sc).call(this)},Sc=function(){for(;re(this,ke,vc).call(this););},u8=async function(e){return new Promise((r,s)=>{e.addEventListener("abort",()=>{s(e.reason)},{once:!0})})},Rc=async function(e,r){return new Promise(s=>{const i=()=>{r&&!r()||(this.off(e,i),s())};this.on(e,i)})};function h8(n){const t=[ns.A];return n==null?t:Array.isArray(n)?n.length===0?t:n:[n]}const d8=60;function f8(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(t=>({name:t.name,type:ns[t.type]})),Answer:(n.Answer??n.answers??[]).map(t=>({name:t.name,type:ns[t.type],TTL:t.TTL??t.ttl??d8,data:t.data instanceof Uint8Array?W(t.data):t.data}))}}const Ev=4;function t2(n,t={}){const e=new Zi({concurrency:t.queryConcurrency??Ev});return async(r,s={})=>{var a;const i=new URLSearchParams;i.set("name",r),h8(s.types).forEach(c=>{i.append("type",ns[c])}),(a=s.onProgress)==null||a.call(s,new G("dns:query",{detail:r}));const o=await e.add(async()=>{var h;const c=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s==null?void 0:s.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=f8(await c.json());return(h=s.onProgress)==null||h.call(s,new G("dns:response",{detail:l})),l},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function _v(){return[t2("https://cloudflare-dns.com/dns-query"),t2("https://dns.google/resolve")]}var vv=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),r=Object.create(null);function s(i,o){e[i]=o,t++,t>=n&&(t=0,r=e,e=Object.create(null))}return{has:function(i){return e[i]!==void 0||r[i]!==void 0},remove:function(i){e[i]!==void 0&&(e[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var o=e[i];if(o!==void 0)return o;if((o=r[i])!==void 0)return s(i,o),o},set:function(i,o){e[i]!==void 0?e[i]=o:s(i,o)},clear:function(){e=Object.create(null),r=Object.create(null)}}};const g8=Ir(vv);class Sv{constructor(t){u(this,"lru");this.lru=g8(t)}get(t,e){let r=!0;const s=[];for(const i of e){const o=this.getAnswers(t,i);if(o.length===0){r=!1;break}s.push(...o)}if(r)return f8({answers:s})}getAnswers(t,e){const r=`${t.toLowerCase()}-${e}`,s=this.lru.get(r);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:ns[a.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(t,e){const r=`${t.toLowerCase()}-${e.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(e.TTL??d8)*1e3,value:e}),this.lru.set(r,s)}remove(t,e){const r=`${t.toLowerCase()}-${e}`;this.lru.remove(r)}clear(){this.lru.clear()}}function Rv(n){return new Sv(n)}const Av=1e3;let Iv=class{constructor(t){u(this,"resolvers");u(this,"cache");this.resolvers={},this.cache=Rv(t.cacheSize??Av),Object.entries(t.resolvers??{}).forEach(([e,r])=>{Array.isArray(r)||(r=[r]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=r}),this.resolvers["."]==null&&(this.resolvers["."]=_v())}async query(t,e={}){var c,l,h;const r=h8(e.types),s=e.cached!==!1?this.cache.get(t,r):void 0;if(s!=null)return(c=e.onProgress)==null||c.call(e,new G("dns:cache",{detail:s})),s;const i=`${t.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const d of o){if(((l=e.signal)==null?void 0:l.aborted)===!0)break;try{const f=await d(t,{...e,types:r});for(const p of f.Answer)this.cache.add(t,p);return f}catch(f){a.push(f),(h=e.onProgress)==null||h.call(e,new G("dns:error",{detail:f}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${r} failed`)}};var ns;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(ns||(ns={}));function p8(n={}){return new Iv(n)}const rr="/",y8=new TextEncoder().encode(rr),ac=y8[0];class $e{constructor(t,e){u(this,"_buf");if(typeof t=="string")this._buf=V(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==ac)throw new Error("Invalid key")}toString(t="utf8"){return W(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new $e(t.join(rr))}static random(){return new $e(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new $e(t):typeof t.uint8Array=="function"?new $e(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=y8),this._buf[0]!==ac){const t=new Uint8Array(this._buf.byteLength+1);t.fill(ac,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===ac;)this._buf=this._buf.subarray(0,-1)}less(t){const e=this.list(),r=t.list();for(let s=0;s<e.length;s++){if(r.length<s+1)return!1;const i=e[s],o=r[s];if(i<o)return!0;if(i>o)return!1}return e.length<r.length}reverse(){return $e.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(rr).slice(1)}type(){return kv(this.baseNamespace())}name(){return xv(this.baseNamespace())}instance(t){return new $e(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(rr)||(t+=rr),t+=this.type(),new $e(t)}parent(){const t=this.list();return t.length===1?new $e(rr):new $e(t.slice(0,-1).join(rr))}child(t){return this.toString()===rr?t:t.toString()===rr?this:new $e(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return $e.withNamespaces([...this.namespaces(),...Tv(t.map(e=>e.namespaces()))])}}function kv(n){const t=n.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function xv(n){const t=n.split(":");return t[t.length-1]}function Tv(n){return[].concat(...n)}const m8="/pin/",n2="/pinned-block/",x1=yr,r2=1;function s2(n){return n.version===0&&(n=n.toV1()),new $e(`${m8}${n.toString(x1)}`)}var br,Ac,T1;class Dv{constructor(t,e,r){fe(this,br);u(this,"datastore");u(this,"blockstore");u(this,"dagWalkers");this.datastore=t,this.blockstore=e,this.dagWalkers=r}async*add(t,e={}){const r=s2(t);if(await this.datastore.has(r))throw new Error("Already pinned");const s=Math.round(e.depth??1/0);if(s<0)throw new Error("Depth must be greater than or equal to 0");const i=new $i({concurrency:r2});for await(const a of re(this,br,Ac).call(this,t,i,{...e,depth:s}))await re(this,br,T1).call(this,a,c=>c.pinnedBy.find(l=>ve(l,t.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(t.bytes),!0),e),yield a;const o={depth:s,metadata:e.metadata??{}};await this.datastore.put(r,e1(o),e)}async*rm(t,e={}){const r=s2(t),s=await this.datastore.get(r,e),i=Cs(s);await this.datastore.delete(r,e);const o=new $i({concurrency:r2});for await(const a of re(this,br,Ac).call(this,t,o,{...e,depth:i.depth}))await re(this,br,T1).call(this,a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>ve(l,t.bytes)),!0),{...e,depth:i.depth}),yield a}async*ls(t={}){for await(const{key:e,value:r}of this.datastore.query({prefix:m8+(t.cid!=null?`${t.cid.toString(yr)}`:"")},t)){const s=Q.parse(e.toString().substring(5),yr),i=Cs(r);yield{cid:s,...i}}}async isPinned(t,e={}){const r=new $e(`${n2}${x1.encode(t.multihash.bytes)}`);return this.datastore.has(r,e)}}br=new WeakSet,Ac=async function*(t,e,r){if(r.depth===-1)return;const s=this.dagWalkers[t.code];if(s==null)throw new Error(`No dag walker found for cid codec ${t.code}`);const i=await this.blockstore.get(t,r);yield t;for await(const o of s.walk(i))yield*await e.add(async()=>re(this,br,Ac).call(this,o,e,{...r,depth:r.depth-1}))},T1=async function(t,e,r){var a;const s=new $e(`${n2}${x1.encode(t.multihash.bytes)}`);let i={pinCount:0,pinnedBy:[]};try{i=Cs(await this.datastore.get(s,r))}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}if(e(i)){if(i.pinCount===0&&await this.datastore.has(s)){await this.datastore.delete(s);return}await this.datastore.put(s,e1(i),r),(a=r.onProgress)==null||a.call(r,new G("helia:pin:add",t))}};const Cv=5;class Nv{constructor(t,e){u(this,"log");u(this,"routers");u(this,"providerLookupConcurrency");this.log=t.logger.forComponent("helia:routing"),this.routers=e.routers??[],this.providerLookupConcurrency=e.providerLookupConcurrency??Cv}async start(){await _o(...this.routers)}async stop(){await vo(...this.routers)}async*findProviders(t,e={}){if(this.routers.length===0)throw new E("No content routers available","ERR_NO_ROUTERS_AVAILABLE");const r=new So({concurrency:this.providerLookupConcurrency});r.addEventListener("error",()=>{});for await(const s of Gr(r.toGenerator(),...si(this.routers,"findProviders").map(i=>i.findProviders(t,e))))if(s!=null){if(s.multiaddrs.length===0){if(r.find(s.id)!=null)continue;r.add(async()=>{try{const i=await this.findPeer(s.id,e);return i.multiaddrs.length===0?null:i}catch(i){return this.log.error("could not load multiaddrs for peer %p",s.id,i),null}},{peerId:s.id,signal:e.signal}).catch(i=>{this.log.error("could not load multiaddrs for peer %p",s.id,i)})}yield s}}async provide(t,e={}){if(this.routers.length===0)throw new E("No content routers available","ERR_NO_ROUTERS_AVAILABLE");await Promise.all(si(this.routers,"provide").map(async r=>{await r.provide(t,e)}))}async put(t,e,r){await Promise.all(si(this.routers,"put").map(async s=>{await s.put(t,e,r)}))}async get(t,e){return Promise.any(si(this.routers,"get").map(async r=>r.get(t,e)))}async findPeer(t,e){if(this.routers.length===0)throw new E("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");const r=this,s=Gr(...si(this.routers,"findPeer").map(i=>async function*(){try{yield await i.findPeer(t,e)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i;throw new E("Could not find peer in routing","ERR_NOT_FOUND")}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new E("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");for await(const r of Gr(...si(this.routers,"getClosestPeers").map(s=>s.getClosestPeers(t,e))))r!=null&&(yield r)}}function si(n,t){return n.filter(e=>e[t]!=null)}const Zr={},qs=n=>{n.addEventListener("message",t=>{qs.dispatchEvent("message",n,t)}),n.port!=null&&n.port.addEventListener("message",t=>{qs.dispatchEvent("message",n,t)})};qs.addEventListener=(n,t)=>{Zr[n]==null&&(Zr[n]=[]),Zr[n].push(t)};qs.removeEventListener=(n,t)=>{Zr[n]!=null&&(Zr[n]=Zr[n].filter(e=>e===t))};qs.dispatchEvent=function(n,t,e){Zr[n]!=null&&Zr[n].forEach(r=>r(t,e))};const i2="lock:worker:request-read",o2="lock:worker:release-read",a2="lock:master:grant-read",c2="lock:worker:request-write",l2="lock:worker:release-write",u2="lock:master:grant-write",Lv=(n=21)=>Math.random().toString().substring(2),h2=(n,t,e,r,s)=>(i,o)=>{if(o.data.type!==e)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};n.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const l=h=>{if(h==null||h.data==null)return;const d={type:h.data.type,name:h.data.name,identifier:h.data.identifier};d.type===r&&d.identifier===a.identifier&&(i.removeEventListener("message",l),c())};i.addEventListener("message",l)})}}}))},d2=(n,t,e,r)=>async()=>{const s=Lv();return globalThis.postMessage({type:t,identifier:s,name:n}),new Promise(i=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===e&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:r,identifier:s,name:n})}))};globalThis.addEventListener("message",o)})},Pv={singleProcess:!1},Ov=n=>{if(n=Object.assign({},Pv,n),!!globalThis.document||n.singleProcess){const e=new EventTarget;return qs.addEventListener("message",h2(e,"requestReadLock",i2,o2,a2)),qs.addEventListener("message",h2(e,"requestWriteLock",c2,l2,u2)),e}return{isWorker:!0,readLock:e=>d2(e,i2,a2,o2),writeLock:e=>d2(e,c2,u2,l2)}},fs={};let Fr;async function Nu(n,t){let e;const r=new Promise(s=>{e=s});return n.add(async()=>Fa((async()=>{await new Promise(s=>{e(()=>{s()})})})(),{milliseconds:t.timeout})),r}const Bv=(n,t)=>{if(Fr.isWorker===!0)return{readLock:Fr.readLock(n,t),writeLock:Fr.writeLock(n,t)};const e=new Zi({concurrency:1});let r;return{async readLock(){if(r!=null)return Nu(r,t);r=new Zi({concurrency:t.concurrency,autoStart:!1});const s=r,i=Nu(r,t);return e.add(async()=>{s.start(),await s.onIdle().then(()=>{r===s&&(r=null)})}),i},async writeLock(){return r=null,Nu(e,t)}}},Mv={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function w8(n){const t=Object.assign({},Mv,n);return Fr==null&&(Fr=Ov(t),Fr.isWorker!==!0&&(Fr.addEventListener("requestReadLock",e=>{fs[e.data.name]!=null&&fs[e.data.name].readLock().then(async r=>e.data.handler().finally(()=>{r()}))}),Fr.addEventListener("requestWriteLock",async e=>{fs[e.data.name]!=null&&fs[e.data.name].writeLock().then(async r=>e.data.handler().finally(()=>{r()}))}))),fs[t.name]==null&&(fs[t.name]=Bv(t.name,t)),fs[t.name]}class Uv{constructor(t,e,r={}){u(this,"lock");u(this,"child");u(this,"pins");u(this,"started");this.child=t,this.pins=e,this.lock=w8({singleProcess:r.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await _o(this.child),this.started=!0}async stop(){await vo(this.child),this.started=!1}unwrap(){return this.child}async put(t,e,r={}){var i;(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const s=await this.lock.readLock();try{return await this.child.put(t,e,r)}finally{s()}}async*putMany(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.putMany(t,e)}finally{r()}}async get(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.get(t,e)}finally{r()}}async*getMany(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.getMany(t,e)}finally{r()}}async delete(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.writeLock();try{if(await this.pins.isPinned(t))throw new Error("CID was pinned");await this.child.delete(t,e)}finally{r()}}async*deleteMany(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.writeLock();try{const i=this;yield*this.child.deleteMany(async function*(){for await(const o of t){if(await i.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),e)}finally{r()}}async has(t,e={}){var s;(s=e==null?void 0:e.signal)==null||s.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.has(t,e)}finally{r()}}async*getAll(t={}){var r;(r=t==null?void 0:t.signal)==null||r.throwIfAborted();const e=await this.lock.readLock();try{yield*this.child.getAll(t)}finally{e()}}createSession(t,e){var r;return(r=e==null?void 0:e.signal)==null||r.throwIfAborted(),this.child.createSession(t,e)}}class mB extends Array{constructor(){super(),this.inRecursive=[]}prefix(t){const e=this.inRecursive[this.inRecursive.length-1];e&&(e.type===x.array&&(e.elements++,e.elements!==1&&t.push([44])),e.type===x.map&&(e.elements++,e.elements!==1&&(e.elements%2===1?t.push([44]):t.push([58]))))}[x.uint.major](t,e){this.prefix(t);const r=String(e.value),s=[];for(let i=0;i<r.length;i++)s[i]=r.charCodeAt(i);t.push(s)}[x.negint.major](t,e){this[x.uint.major](t,e)}[x.bytes.major](t,e){throw new Error(`${Bc} unsupported type: Uint8Array`)}[x.string.major](t,e){this.prefix(t);const r=E4(JSON.stringify(e.value));t.push(r.length>32?vh(r):r)}[x.array.major](t,e){this.prefix(t),this.inRecursive.push({type:x.array,elements:0}),t.push([91])}[x.map.major](t,e){this.prefix(t),this.inRecursive.push({type:x.map,elements:0}),t.push([123])}[x.tag.major](t,e){}[x.float.major](t,e){if(e.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===x.array)t.push([93]);else if(o.type===x.map)t.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(e.value===void 0)throw new Error(`${Bc} unsupported type: undefined`);if(this.prefix(t),e.type.name==="true"){t.push([116,114,117,101]);return}else if(e.type.name==="false"){t.push([102,97,108,115,101]);return}else if(e.type.name==="null"){t.push([110,117,108,108]);return}const r=String(e.value),s=[];let i=!1;for(let o=0;o<r.length;o++)s[o]=r.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),t.push(s)}}class Sd{constructor(t,e={}){this._pos=0,this.data=t,this.options=e,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let t=this.ch();for(;t===32||t===9||t===13||t===10;)t=this.data[++this._pos]}expect(t){if(this.data.length-this._pos<t.length)throw new Error(`${J} unexpected end of input at position ${this._pos}`);for(let e=0;e<t.length;e++)if(this.data[this._pos++]!==t[e])throw new Error(`${J} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...t)}'`)}parseNumber(){const t=this._pos;let e=!1,r=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(e=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,r=!0;else return new K(x.uint,0,this._pos-t);if(s([48,49,50,51,52,53,54,55,56,57]),e&&this._pos===t+1)throw new Error(`${J} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(r)throw new Error(`${J} unexpected token at position ${this._pos}`);r=!0,this._pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(r=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(t,this._pos)),o=parseFloat(i);return r?new K(x.float,o,this._pos-t):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new K(o>=0?x.uint:x.negint,o,this._pos-t):new K(o>=0?x.uint:x.negint,BigInt(i),this._pos-t)}parseString(){if(this.ch()!==34)throw new Error(`${J} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new K(x.string,c,o)}}const t=this._pos,e=[],r=()=>{if(this._pos+4>=this.data.length)throw new Error(`${J} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${J} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${J} unexpected unicode sequence at position ${this._pos}`);let c,l,h,d;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(d=(i&31)<<6|c&63,d>127&&(o=d));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(d=(i&15)<<12|(c&63)<<6|l&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],h=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(h&192)===128&&(d=(i&15)<<18|(c&63)<<12|(l&63)<<6|h&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,e.push(o>>>10&1023|55296),o=56320|o&1023),e.push(o),this._pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${J} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:e.push(o);break;case 98:e.push(8);break;case 116:e.push(9);break;case 110:e.push(10);break;case 102:e.push(12);break;case 114:e.push(13);break;case 117:e.push(r());break;default:throw new Error(`${J} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new K(x.string,_4(e),this._pos-t);default:if(i<32)throw new Error(`${J} invalid control character at position ${this._pos}`);i<128?(e.push(i),this._pos++):s()}}throw new Error(`${J} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new K(x.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new K(x.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new K(x.null,null,4);case 102:return this.expect([102,97,108,115,101]),new K(x.false,!1,5);case 116:return this.expect([116,114,117,101]),new K(x.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${J} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new K(x.break,void 0,1);if(this.ch()!==44)throw new Error(`${J} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new K(x.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new K(x.break,void 0,1);if(this.ch()!==44)throw new Error(`${J} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new K(x.break,void 0,1);const t=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${J} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),t}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${J} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function b8(n,t){return t=Object.assign({tokenizer:new Sd(n,t)},t),Cs(n,t)}function $v(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}let Fv=class extends Sd{constructor(t,e){super(t,e),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const t=this._next();if(t.type===x.map){const e=this._next();if(e.type===x.string&&e.value==="/"){const r=this._next();if(r.type===x.string){if(this._next().type!==x.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(r),new K(x.tag,42,0)}if(r.type===x.map){const s=this._next();if(s.type===x.string&&s.value==="bytes"){const i=this._next();if(i.type===x.string){for(let a=0;a<2;a++)if(this._next().type!==x.break)throw new Error("Invalid encoded Bytes form");const o=ln.decode(`m${i.value}`);return new K(x.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(r)}this.tokenBuffer.push(e)}return t}};const D1={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};D1.tags[42]=Q.parse;const E8=297,Vv=n=>{const t=$v(n),e=Object.assign(D1,{tokenizer:new Fv(t,D1)});return b8(t,e)};new TextDecoder;new TextEncoder;const Hv=new TextDecoder;function Rd(n,t){let e=0;for(let r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(t>=n.length)throw new Error("protobuf: unexpected end of data");const s=n[t++];if(e+=r<28?(s&127)<<r:(s&127)*2**r,s<128)break}return[e,t]}function el(n,t){let e;[e,t]=Rd(n,t);const r=t+e;if(e<0||r<0)throw new Error("protobuf: invalid length");if(r>n.length)throw new Error("protobuf: unexpected end of data");return[n.subarray(t,r),r]}function _8(n,t){let e;return[e,t]=Rd(n,t),[e&7,e>>3,t]}function Kv(n){const t={},e=n.length;let r=0;for(;r<e;){let s,i;if([s,i,r]=_8(n,r),i===1){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(t.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(t.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,r]=el(n,r)}else if(i===2){if(t.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(t.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,r]=el(n,r),t.Name=Hv.decode(o)}else if(i===3){if(t.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[t.Tsize,r]=Rd(n,r)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(r>e)throw new Error("protobuf: (PBLink) unexpected end of data");return t}function zv(n){const t=n.length;let e=0,r,s=!1,i;for(;e<t;){let a,c;if([a,c,e]=_8(n,e),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,e]=el(n,e),r&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");r||(r=[]);let l;[l,e]=el(n,e),r.push(Kv(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(e>t)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return i&&(o.Data=i),o.Links=r||[],o}const v8=new TextEncoder,f2=2**32,qv=2**31;function Wv(n,t){let e=t.length;if(typeof n.Tsize=="number"){if(n.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(n.Tsize))throw new Error("Tsize too large for encoding");e=Xo(t,e,n.Tsize)-1,t[e]=24}if(typeof n.Name=="string"){const r=v8.encode(n.Name);e-=r.length,t.set(r,e),e=Xo(t,e,r.length)-1,t[e]=18}return n.Hash&&(e-=n.Hash.length,t.set(n.Hash,e),e=Xo(t,e,n.Hash.length)-1,t[e]=10),t.length-e}function Gv(n){const t=Qv(n),e=new Uint8Array(t);let r=t;if(n.Data&&(r-=n.Data.length,e.set(n.Data,r),r=Xo(e,r,n.Data.length)-1,e[r]=10),n.Links)for(let s=n.Links.length-1;s>=0;s--){const i=Wv(n.Links[s],e.subarray(0,r));r-=i,r=Xo(e,r,i)-1,e[r]=18}return e}function Yv(n){let t=0;if(n.Hash){const e=n.Hash.length;t+=1+e+Ei(e)}if(typeof n.Name=="string"){const e=v8.encode(n.Name).length;t+=1+e+Ei(e)}return typeof n.Tsize=="number"&&(t+=1+Ei(n.Tsize)),t}function Qv(n){let t=0;if(n.Data){const e=n.Data.length;t+=1+e+Ei(e)}if(n.Links)for(const e of n.Links){const r=Yv(e);t+=1+r+Ei(r)}return t}function Xo(n,t,e){t-=Ei(e);const r=t;for(;e>=qv;)n[t++]=e&127|128,e/=128;for(;e>=128;)n[t++]=e&127|128,e>>>=7;return n[t]=e,r}function Ei(n){return n%2===0&&n++,Math.floor((Xv(n)+6)/7)}function Xv(n){let t=0;return n>=f2&&(n=Math.floor(n/f2),t=32),n>=65536&&(n>>>=16,t+=16),n>=256&&(n>>>=8,t+=8),t+Zv[n]}const Zv=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],jv=["Data","Links"],Jv=["Hash","Name","Tsize"],C1=new TextEncoder;function S8(n,t){if(n===t)return 0;const e=n.Name?C1.encode(n.Name):[],r=t.Name?C1.encode(t.Name):[];let s=e.length,i=r.length;for(let o=0,a=Math.min(s,i);o<a;++o)if(e[o]!==r[o]){s=e[o],i=r[o];break}return s<i?-1:i<s?1:0}function g2(n,t){return!Object.keys(n).some(e=>!t.includes(e))}function R8(n){if(typeof n.asCID=="object"){const e=Q.asCID(n);if(!e)throw new TypeError("Invalid DAG-PB form");return{Hash:e}}if(typeof n!="object"||Array.isArray(n))throw new TypeError("Invalid DAG-PB form");const t={};if(n.Hash){let e=Q.asCID(n.Hash);try{e||(typeof n.Hash=="string"?e=Q.parse(n.Hash):n.Hash instanceof Uint8Array&&(e=Q.decode(n.Hash)))}catch(r){throw new TypeError(`Invalid DAG-PB form: ${r.message}`)}e&&(t.Hash=e)}if(!t.Hash)throw new TypeError("Invalid DAG-PB form");return typeof n.Name=="string"&&(t.Name=n.Name),typeof n.Tsize=="number"&&(t.Tsize=n.Tsize),t}function en(n){if((n instanceof Uint8Array||typeof n=="string")&&(n={Data:n}),typeof n!="object"||Array.isArray(n))throw new TypeError("Invalid DAG-PB form");const t={};if(n.Data!==void 0)if(typeof n.Data=="string")t.Data=C1.encode(n.Data);else if(n.Data instanceof Uint8Array)t.Data=n.Data;else throw new TypeError("Invalid DAG-PB form");if(n.Links!==void 0)if(Array.isArray(n.Links))t.Links=n.Links.map(R8),t.Links.sort(S8);else throw new TypeError("Invalid DAG-PB form");else t.Links=[];return t}function A8(n){if(!n||typeof n!="object"||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form");if(!g2(n,jv))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(n.Data!==void 0&&!(n.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(n.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let t=0;t<n.Links.length;t++){const e=n.Links[t];if(!e||typeof e!="object"||Array.isArray(e)||e instanceof Uint8Array||e["/"]&&e["/"]===e.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!g2(e,Jv))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(e.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(e.Hash==null||!e.Hash["/"]||e.Hash["/"]!==e.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(e.Name!==void 0&&typeof e.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(e.Tsize!==void 0){if(typeof e.Tsize!="number"||e.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(e.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(t>0&&S8(e,n.Links[t-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function eS(n,t=[]){return en({Data:n,Links:t})}function tS(n,t,e){return R8({Hash:e,Name:n,Tsize:t})}function nS(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}const rS="dag-pb",Zn=112;function nt(n){A8(n);const t={};return n.Links&&(t.Links=n.Links.map(e=>{const r={};return e.Hash&&(r.Hash=e.Hash.bytes),e.Name!==void 0&&(r.Name=e.Name),e.Tsize!==void 0&&(r.Tsize=e.Tsize),r})),n.Data&&(t.Data=n.Data),Gv(t)}function gn(n){const t=nS(n),e=zv(t),r={};return e.Data&&(r.Data=e.Data),e.Links&&(r.Links=e.Links.map(s=>{const i={};try{i.Hash=Q.decode(s.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return s.Name!==void 0&&(i.Name=s.Name),s.Tsize!==void 0&&(i.Tsize=s.Tsize),i})),r}const Ql=Object.freeze(Object.defineProperty({__proto__:null,code:Zn,createLink:tS,createNode:eS,decode:gn,encode:nt,name:rS,prepare:en,validate:A8},Symbol.toStringTag,{value:"Module"})),sS={codec:Zn,*walk(n){yield*gn(n).Links.map(e=>e.Hash)}},iS={codec:Wn,*walk(){}},I8=42,oS={codec:Ph,*walk(n){const t=[],e=[];e[I8]=r=>{if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");const s=Q.decode(r.subarray(1));return t.push(s),s},Cs(n,{tags:e}),yield*t}};class aS extends Sd{constructor(e,r){super(e,r);u(this,"tokenBuffer");this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===x.map){const r=this._next();if(r.type===x.string&&r.value==="/"){const s=this._next();if(s.type===x.string){if(this._next().type!==x.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(s),new K(x.tag,42,0)}if(s.type===x.map){const i=this._next();if(i.type===x.string&&i.value==="bytes"){const o=this._next();if(o.type===x.string){for(let c=0;c<2;c++)if(this._next().type!==x.break)throw new Error("Invalid encoded Bytes form");const a=ln.decode(`m${o.value}`);return new K(x.bytes,a,o.value.length)}this.tokenBuffer.push(o)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(r)}return e}}const cS={codec:E8,*walk(n){const t=[],e=[];e[I8]=r=>{const s=Q.parse(r);return t.push(s),s},b8(n,{tags:e,tokenizer:new aS(n,{tags:e,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*t}},lS={codec:X4,*walk(){}};function uS(n=[]){const t={};return[sS,iS,oS,cS,lS,...n].forEach(e=>{t[e.codec]=e}),t}const Lu=new $e("/version"),p2=1;async function hS(n){if(!await n.has(Lu)){await n.put(Lu,V(`${p2}`));return}const t=await n.get(Lu),e=W(t);if(parseInt(e,10)!==p2)throw new Error("Unknown datastore version, a datastore migration may be required")}function dS(n=[]){const t={};return[We,dm,Er,...n].forEach(e=>{t[e.code]=e}),t}class k8{has(t,e){return Promise.reject(new Error(".has is not implemented"))}put(t,e,r){return Promise.reject(new Error(".put is not implemented"))}async*putMany(t,e){for await(const{cid:r,block:s}of t)await this.put(r,s,e),yield r}get(t,e){return Promise.reject(new Error(".get is not implemented"))}async*getMany(t,e){for await(const r of t)yield{cid:r,block:await this.get(r,e)}}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(t,e){for await(const r of t)await this.delete(r,e),yield r}async*getAll(t){throw new Error(".getAll is not implemented")}}function y2(n,t){for(const e in t)Object.defineProperty(n,e,{value:t[e],enumerable:!0,configurable:!0});return n}function fS(n,t,e){if(!n||typeof n=="string")throw new TypeError("Please pass an Error to err-code");e||(e={}),typeof t=="object"&&(e=t,t=""),t&&(e.code=t);try{return y2(n,e)}catch{e.message=n.message,e.stack=n.stack;const s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(n)),y2(new s,e)}}var gS=fS;const Fe=Ir(gS);function pS(n){return n=n??new Error("Open failed"),Fe(n,"ERR_OPEN_FAILED")}function yS(n){return n=n??new Error("Close failed"),Fe(n,"ERR_CLOSE_FAILED")}function mS(n){return n=n??new Error("Put failed"),Fe(n,"ERR_PUT_FAILED")}function wS(n){return n=n??new Error("Get failed"),Fe(n,"ERR_GET_FAILED")}function bS(n){return n=n??new Error("Delete failed"),Fe(n,"ERR_DELETE_FAILED")}function ES(n){return n=n??new Error("Has failed"),Fe(n,"ERR_HAS_FAILED")}function x8(n){return n=n??new Error("Not Found"),Fe(n,"ERR_NOT_FOUND")}function _S(n){return n=n??new Error("Aborted"),Fe(n,"ERR_ABORTED")}const vS=Object.freeze(Object.defineProperty({__proto__:null,abortedError:_S,closeFailedError:yS,deleteFailedError:bS,getFailedError:wS,hasFailedError:ES,notFoundError:x8,openFailedError:pS,putFailedError:mS},Symbol.toStringTag,{value:"Module"}));class SS extends k8{constructor(){super();u(this,"data");this.data=new Map}put(e,r){return this.data.set(zt.encode(e.multihash.bytes),r),e}get(e){const r=this.data.get(zt.encode(e.multihash.bytes));if(r==null)throw x8();return r}has(e){return this.data.has(zt.encode(e.multihash.bytes))}async delete(e){this.data.delete(zt.encode(e.multihash.bytes))}async*getAll(){for(const[e,r]of this.data.entries())yield{cid:Q.createV1(Wn,cs(zt.decode(e))),block:r}}}function RS(n){return n[Symbol.asyncIterator]!=null}function Mr(n,t){let e=0;if(RS(n))return async function*(){for await(const c of n)await t(c,e++)&&(yield c)}();const r=Wh(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for await(const c of r)await t(c,e++)&&(yield c)}();const a=t;return function*(){o===!0&&(yield s);for(const c of r)a(c,e++)&&(yield c)}()}Tt("blockstore:core:tiered");const AS={...vS},cc=0;class IS extends k8{constructor(e){super();u(this,"child");this.child=e}put(e,r){return e.multihash.code===cc||this.child==null?e:this.child.put(e,r)}get(e){if(e.multihash.code===cc)return e.multihash.digest;if(this.child==null)throw AS.notFoundError();return this.child.get(e)}has(e){return e.multihash.code===cc?!0:this.child==null?!1:this.child.has(e)}delete(e){if(e.code!==cc&&this.child!=null)return this.child.delete(e)}getAll(e){return this.child!=null?this.child.getAll(e):[]}}function kS(n){return n[Symbol.asyncIterator]!=null}function m2(n){return(n==null?void 0:n.then)!=null}function N1(n,t){let e=0;if(kS(n))return async function*(){for await(const c of n){const l=t(c,e++);m2(l)&&await l,yield c}}();const r=Wh(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield s;for await(const c of r){const l=t(c,e++);m2(l)&&await l,yield c}}();const a=t;return function*(){yield s;for(const c of r)a(c,e++),yield c}()}class T8{constructor(t){u(this,"child");u(this,"hashers");u(this,"log");u(this,"logger");u(this,"components");this.log=t.logger.forComponent("helia:networked-storage"),this.logger=t.logger,this.components=t,this.child=new IS(t.blockstore),this.hashers=t.hashers??{}}async put(t,e,r={}){var s,i,o;return await this.child.has(t,r)?((s=r.onProgress)==null||s.call(r,new G("blocks:put:duplicate",t)),t):((i=r.onProgress)==null||i.call(r,new G("blocks:put:providers:notify",t)),await Promise.all(this.components.blockBrokers.map(async a=>{var c;return(c=a.announce)==null?void 0:c.call(a,t,e,r)})),(o=r.onProgress)==null||o.call(r,new G("blocks:put:blockstore:put",t)),this.child.put(t,e,r))}async*putMany(t,e={}){var i;const r=Mr(t,async({cid:o})=>{var c;const a=await this.child.has(o,e);return a&&((c=e.onProgress)==null||c.call(e,new G("blocks:put-many:duplicate",o))),!a}),s=N1(r,async({cid:o,block:a})=>{var c;(c=e.onProgress)==null||c.call(e,new G("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async l=>{var h;return(h=l.announce)==null?void 0:h.call(l,o,a,e)}))});(i=e.onProgress)==null||i.call(e,new G("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(s,e)}async get(t,e={}){var r,s,i,o;if(e.offline!==!0&&!await this.child.has(t,e)){(r=e.onProgress)==null||r.call(e,new G("blocks:get:providers:get",t));const a=await w2(t,this.components.blockBrokers,this.hashers[t.multihash.code],{...e,log:this.log});return(s=e.onProgress)==null||s.call(e,new G("blocks:get:blockstore:put",t)),await this.child.put(t,a,e),(i=e.onProgress)==null||i.call(e,new G("blocks:get:providers:notify",t)),await Promise.all(this.components.blockBrokers.map(async c=>{var l;return(l=c.announce)==null?void 0:l.call(c,t,a,e)})),a}return(o=e.onProgress)==null||o.call(e,new G("blocks:get:blockstore:get",t)),this.child.get(t,e)}async*getMany(t,e={}){var r;(r=e.onProgress)==null||r.call(e,new G("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(N1(t,async s=>{var i,o,a;if(e.offline!==!0&&!await this.child.has(s,e)){(i=e.onProgress)==null||i.call(e,new G("blocks:get-many:providers:get",s));const c=await w2(s,this.components.blockBrokers,this.hashers[s.multihash.code],{...e,log:this.log});(o=e.onProgress)==null||o.call(e,new G("blocks:get-many:blockstore:put",s)),await this.child.put(s,c,e),(a=e.onProgress)==null||a.call(e,new G("blocks:get-many:providers:notify",s)),await Promise.all(this.components.blockBrokers.map(async l=>{var h;return(h=l.announce)==null?void 0:h.call(l,s,c,e)}))}}))}async delete(t,e={}){var r;(r=e.onProgress)==null||r.call(e,new G("blocks:delete:blockstore:delete",t)),await this.child.delete(t,e)}async*deleteMany(t,e={}){var r;(r=e.onProgress)==null||r.call(e,new G("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const s of t)yield s}(),e)}async has(t,e={}){return this.child.has(t,e)}async*getAll(t={}){var e;(e=t.onProgress)==null||e.call(t,new G("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(t)}}class xS extends T8{constructor(e){super(e);u(this,"started");this.started=!1}isStarted(){return this.started}async start(){await _o(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await vo(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,r){const s=this.components.blockBrokers.map(i=>i.createSession==null?i:i.createSession(r));return new TS({blockstore:this.child,blockBrokers:s,hashers:this.hashers,logger:this.logger},{root:e})}}class TS extends T8{constructor(e,r){super(e);u(this,"closeController");this.closeController=new AbortController,j(1/0,this.closeController.signal),this.log=e.logger.forComponent(`helia:session-storage:${r.root}`)}close(){this.closeController.abort()}async put(e,r,s={}){const i=Ze([this.closeController.signal,s.signal]);j(1/0,i);try{return await super.put(e,r,{...s,signal:i})}finally{i.clear()}}async*putMany(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{yield*super.putMany(e,{...r,signal:s})}finally{s.clear()}}async get(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{return await super.get(e,{...r,signal:s})}finally{s.clear()}}async*getMany(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{yield*super.getMany(e,{...r,signal:s})}finally{s.clear()}}async delete(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{await super.delete(e,{...r,signal:s})}finally{s.clear()}}async*deleteMany(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{yield*super.deleteMany(e,{...r,signal:s})}finally{s.clear()}}async has(e,r={}){const s=Ze([this.closeController.signal,r.signal]);j(1/0,s);try{return await super.has(e,{...r,signal:s})}finally{s.clear()}}async*getAll(e={}){const r=Ze([this.closeController.signal,e.signal]);j(1/0,r);try{yield*super.getAll({...e,signal:r})}finally{r.clear()}}}function DS(n){return typeof n.retrieve=="function"}const CS=(n,t)=>{if(t==null)throw new E(`No hasher configured for multihash code 0x${n.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async e=>{const r=await t.digest(e);if(!ve(r.digest,n.multihash.digest))throw new E("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function w2(n,t,e,r){const s=CS(n,e),i=new AbortController,o=Ze([i.signal,r.signal]);j(1/0,i.signal,o);const a=[];for(const c of t)DS(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const h=await c.retrieve(n,{...r,signal:o,validateFn:async d=>{await s(d),l=!0}});return l||await s(h),h}catch(l){throw r.log.error("could not retrieve verified block for %c",n,l),l}}))}finally{i.abort(),o.clear()}}const NS=1,LS=5,PS=Math.LN2*Math.LN2;class Ad{constructor(t={}){u(this,"seeds");u(this,"bits");u(this,"buffer");t.seeds!=null?this.seeds=t.seeds:this.seeds=BS(t.hashes??8),this.bits=t.bits??1024,this.buffer=Pe(Math.ceil(this.bits/8))}static create(t,e=.005){const r=OS(t,e);return new Ad(r)}add(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.seeds.length;e++){const s=wa.x86.hash32(t,this.seeds[e])%this.bits;this.setbit(s)}}has(t){typeof t=="string"&&(t=V(t));for(let e=0;e<this.seeds.length;e++){const s=wa.x86.hash32(t,this.seeds[e])%this.bits;if(!this.getbit(s))return!1}return!0}clear(){this.buffer.fill(0)}setbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;let s=this.buffer[e];s|=1<<r,this.buffer[e]=s}getbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;return(this.buffer[e]&1<<r)!==0}}function OS(n,t=.005){const e=Math.round(-1*n*Math.log(t)/PS),r=Math.round(e/n*Math.LN2);return{bits:e,hashes:r}}function BS(n){let t,e;const r=[];for(let s=0;s<n;s++)for(t=new Ie(Yn(4)),r[s]=t.getUint32(0,!0),e=0;e<s;e++)if(r[s]===r[e]){s--;break}return r}class D8 extends _t{constructor(e,r){super();u(this,"intialPeerSearchComplete");u(this,"requests");u(this,"name");u(this,"log");u(this,"logger");u(this,"minProviders");u(this,"maxProviders");u(this,"providers");u(this,"evictionFilter");j(1/0,this),this.name=r.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=r.minProviders??NS,this.maxProviders=r.maxProviders??LS,this.providers=[],this.evictionFilter=Ad.create(this.maxProviders)}async retrieve(e,r={}){const s=ln.encode(e.multihash.bytes),i=this.requests.get(s);if(i!=null)return this.log("join existing request for %c",e),i;const o=pe();if(this.requests.set(s,o.promise),this.providers.length===0){let h=!1;this.intialPeerSearchComplete==null&&(h=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.intialPeerSearchComplete=this.findProviders(e,this.minProviders,r)),await this.intialPeerSearchComplete,h&&this.log("found initial session peers for %c",e)}let a=!1;const c=new $i({concurrency:this.maxProviders});c.addEventListener("error",()=>{}),c.addEventListener("failure",h=>{this.log.error("error querying provider %o, evicting from session",h.detail.job.options.provider,h.detail.error),this.evict(h.detail.job.options.provider)}),c.addEventListener("success",h=>{a=!0,o.resolve(h.detail.result)}),c.addEventListener("idle",()=>{var h;a||((h=r.signal)==null?void 0:h.aborted)===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let d=0;d<this.minProviders&&this.providers.length!==0;d++){const f=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(f)}await this.findProviders(e,this.minProviders,r),this.log("found new providers re-retrieving %c",e),this.requests.delete(s),o.resolve(await this.retrieve(e,r))}).catch(d=>{this.log.error("could not find new providers for %c",e,d),o.reject(d)})});const l=h=>{c.add(async()=>this.queryProvider(e,h.detail,r),{provider:h.detail}).catch(d=>{var f;((f=r.signal)==null?void 0:f.aborted)!==!0&&this.log.error("error retrieving session block for %c",e,d)})};this.addEventListener("provider",l),Promise.all([...this.providers].map(async h=>c.add(async()=>this.queryProvider(e,h,r),{provider:h}))).catch(h=>{var d;((d=r.signal)==null?void 0:d.aborted)!==!0&&this.log.error("error retrieving session block for %c",e,h)});try{return await o.promise}finally{this.removeEventListener("provider",l),c.clear(),this.requests.delete(s)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const r=this.providers.findIndex(s=>this.equals(s,e));r!==-1&&this.providers.splice(r,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(r=>this.equals(r,e))!=null||this.isEvicted(e))}async findProviders(e,r,s){const i=pe();let o=0;return Promise.resolve().then(async()=>{var a;this.log("finding %d-%d new provider(s) for %c",r,this.maxProviders,e);for await(const c of this.findNewProviders(e,s)){if(o===this.maxProviders||((a=s.signal)==null?void 0:a.aborted)===!0)break;if(!this.hasProvider(c)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(c),this.safeDispatchEvent("provider",{detail:c}),o++,o===r&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<r)throw new E(`Found ${o} of ${r} ${this.name} providers for ${e}`,"ERR_INSUFFICIENT_PROVIDERS_FOUND")}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",e,a.errors??a),i.reject(a)}),i.promise}}class MS{constructor(t){u(this,"blockstore");u(this,"datastore");u(this,"pins");u(this,"logger");u(this,"routing");u(this,"dagWalkers");u(this,"hashers");u(this,"dns");u(this,"metrics");u(this,"log");this.logger=t.logger??Yl(),this.log=this.logger.forComponent("helia"),this.hashers=dS(t.hashers),this.dagWalkers=uS(t.dagWalkers),this.dns=t.dns??p8(),this.metrics=t.metrics;const e={blockstore:t.blockstore,datastore:t.datastore,hashers:this.hashers,dagWalkers:this.dagWalkers,logger:this.logger,blockBrokers:[],dns:this.dns,metrics:this.metrics,...t.components??{}};this.routing=e.routing=new Nv(e,{routers:(t.routers??[]).flatMap(s=>{const i=[s];return s[Oi]!=null&&i.push(s[Oi]),s[Bi]!=null&&i.push(s[Bi]),i}),providerLookupConcurrency:t.providerLookupConcurrency});const r=new xS(e);this.pins=new Dv(t.datastore,r,this.dagWalkers),this.blockstore=new Uv(r,this.pins,{holdGcLock:t.holdGcLock??!0}),this.datastore=t.datastore,e.blockBrokers=t.blockBrokers.map(s=>s(e))}async start(){await hS(this.datastore),await _o(this.blockstore,this.datastore,this.routing)}async stop(){await vo(this.blockstore,this.datastore,this.routing)}async gc(t={}){const e=await this.blockstore.lock.writeLock();try{const r=this,s=this.blockstore.unwrap();this.log("gc start"),await Bs(s.deleteMany(async function*(){var i,o;for await(const{cid:a}of s.getAll())try{if(await r.pins.isPinned(a,t))continue;yield a,(i=t.onProgress)==null||i.call(t,new G("helia:gc:deleted",a))}catch(c){r.log.error("Error during gc",c),(o=t.onProgress)==null||o.call(t,new G("helia:gc:error",c))}}()))}finally{e()}this.log("gc finished")}}class US extends D8{constructor(e,r){super(e,{...r,name:"helia:bitswap:session"});u(this,"wantList");u(this,"network");this.wantList=e.wantList,this.network=e.network}async queryProvider(e,r,s){this.log("sending WANT-BLOCK for %c to %p",e,r);const i=await this.wantList.wantSessionBlock(e,r,s);if(this.log("%p %s %c",r,i.has?"has":"does not have",e),i.has&&i.block!=null)return i.block;throw new Error("Provider did not have block")}async*findNewProviders(e,r={}){for await(const s of this.network.findProviders(e,r))yield s.id}toEvictionKey(e){return e.toBytes()}equals(e,r){return e.equals(r)}}function $S(n,t){return new US(n,t)}class FS{constructor(t){u(this,"blocksReceived");u(this,"duplicateBlocksReceived");u(this,"dataReceived");u(this,"duplicateDataReceived");var e,r,s,i;this.blocksReceived=(e=t.metrics)==null?void 0:e.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=(r=t.metrics)==null?void 0:r.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=(s=t.metrics)==null?void 0:s.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=(i=t.metrics)==null?void 0:i.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(t=1,e){var s;const r={global:t};e!=null&&(r[e.toString()]=t),(s=this.blocksReceived)==null||s.increment(r)}updateDuplicateBlocksReceived(t=1,e){var s;const r={global:t};e!=null&&(r[e.toString()]=t),(s=this.duplicateBlocksReceived)==null||s.increment(r)}updateDataReceived(t,e){var s;const r={global:t};e!=null&&(r[e.toString()]=t),(s=this.dataReceived)==null||s.increment(r)}updateDuplicateDataReceived(t,e){var s;const r={global:t};e!=null&&(r[e.toString()]=t),(s=this.duplicateDataReceived)==null||s.increment(r)}}class VS extends Map{constructor(e){super();u(this,"metric");const{name:r,metrics:s}=e;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(e,r){return super.set(e,r),this.updateComponentMetric(),this}delete(e){const r=super.delete(e);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function C8(n){const{name:t,metrics:e}=n;let r;return e!=null?r=new VS({name:t,metrics:e}):r=new Map,r}function HS(n){if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const t=[];for(;n.length>0;){const e=_r(n);t.push(e),n=n.slice(He(e))}return t}class KS extends _t{constructor(e,r={}){super();u(this,"peers");u(this,"wants");u(this,"network");u(this,"log");u(this,"sendMessagesDelay");u(this,"sendMessagesTimeout");u(this,"hashLoader");u(this,"sendingMessages");j(1/0,this),this.peers=n8({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=C8({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=r.sendMessagesDelay??Jm,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=r.hashLoader,this.network.addEventListener("bitswap:message",s=>{this.receiveMessage(s.detail.peer,s.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",s.detail.peer,i)})}),this.network.addEventListener("peer:connected",s=>{this.peerConnected(s.detail).catch(i=>{this.log.error("error processing newly connected bitswap peer %p",s.detail,i)})}),this.network.addEventListener("peer:disconnected",s=>{this.peerDisconnected(s.detail)})}async addEntry(e,r){var o;const s=W(e.multihash.bytes,"base64");let i=this.wants.get(s);i==null&&(i={cid:e,priority:r.priority??1,wantType:r.wantType??ht.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(s,i)),i.wantType===ht.WantHave&&r.wantType===ht.WantBlock&&(i.wantType=ht.WantBlock),await this.sendMessagesDebounced();try{return r.wantType===ht.WantBlock?(await pr(this,"block",r==null?void 0:r.signal,{filter:l=>ve(e.multihash.digest,l.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await pr(this,"presence",r==null?void 0:r.signal,{filter:c=>ve(e.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{((o=r.signal)==null?void 0:o.aborted)===!0&&(this.log("want for %c was aborted, cancelling want",e),i.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){var e;await((e=this.sendingMessages)==null?void 0:e.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(r=>{this.log("error sending messages to peers",r)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=pe(),await Promise.all([...this.peers.entries()].map(async([e,r])=>{const s=new Set,i=new $o;for(const[o,a]of this.wants.entries())r.has(o)||a.cancel||(s.add(o),i.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(i.wantlist.size!==0)try{await this.network.sendMessage(e,i);for(const o of s)r.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(e=>{this.log.error("error sending messages",e)});for(const[e,r]of this.wants)if(r.cancel){this.wants.delete(e);for(const s of this.peers.values())s.delete(e)}this.sendingMessages.resolve()}has(e){const r=W(e.multihash.bytes,"base64");return this.wants.has(r)}async wantSessionPresence(e,r,s={}){const i=new $o;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:ht.WantHave,priority:1}),await this.network.sendMessage(r,i),(await pr(this,"presence",s.signal,{filter:a=>r.equals(a.detail.sender)&&ve(e.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(e,r={}){return this.addEntry(e,{...r,wantType:ht.WantBlock})}async wantSessionBlock(e,r,s={}){const i=new $o;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:ht.WantBlock,priority:1}),await this.network.sendMessage(r,i),(await pr(this,"presence",s.signal,{filter:a=>r.equals(a.detail.sender)&&ve(e.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(e,r){const s=W(e.multihash.bytes,"base64"),i=this.wants.get(s);i!=null&&(i.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,r){var i;this.log("received message from %p with %d blocks",e,r.blocks.length);let s=!1;for(const o of r.blocks){if(o.prefix==null||o.data==null)continue;const a=HS(o.prefix),c=a[0],l=a[1],h=a[2],d=h===We.code?We:await((i=this.hashLoader)==null?void 0:i.getHasher(h));if(d==null){this.log.error("unknown hash algorithm",h);continue}let f=d.digest(o.data);f.then!=null&&(f=await f);const p=Q.create(c===0?0:1,l,f);this.log("received block from %p for %c",e,p),this.safeDispatchEvent("block",{detail:{sender:e,cid:p,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:p,has:!0,block:o.data}});const m=W(p.multihash.bytes,"base64"),g=this.wants.get(m);g!=null&&(g.cancel=!0,s=!0)}for(const{cid:o,type:a}of r.blockPresences){const c=Q.decode(o);this.log("received %s from %p for %c",a,e,c),this.safeDispatchEvent("presence",{detail:{sender:e,cid:c,has:a===Hn.HaveBlock}})}s&&await this.sendMessagesDebounced()}async peerConnected(e){const r=new Set,s=new $o(!0);for(const[i,o]of this.wants.entries())o.cancel||(r.add(i),s.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:ht.WantBlock,cancel:!1,sendDontHave:!1}));if(s.wantlist.size===0){this.peers.set(e,r);return}try{await this.network.sendMessage(e,s),this.peers.set(e,r)}catch(i){this.log.error("error sending full wantlist to new peer %p",e,i)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class zS{constructor(t,e={}){u(this,"log");u(this,"logger");u(this,"stats");u(this,"network");u(this,"blockstore");u(this,"peerWantLists");u(this,"wantList");this.logger=t.logger,this.log=t.logger.forComponent("helia:bitswap"),this.blockstore=t.blockstore,this.stats=new FS(t),this.network=new ib(t,e),this.peerWantLists=new Z_({...t,network:this.network},e),this.wantList=new KS({...t,network:this.network},e)}createSession(t={}){return $S({wantList:this.wantList,network:this.network,logger:this.logger},t)}async want(t,e={}){const r=new AbortController,s=Ze([r.signal,e.signal]);j(1/0,r.signal,s),this.network.findAndConnect(t,{...e,signal:s}).catch(i=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",t,i)});try{return(await this.wantList.wantBlock(t,{...e,signal:s})).block}finally{r.abort(),s.clear()}}async notify(t,e,r={}){await Promise.all([this.peerWantLists.receivedBlock(t,r),this.wantList.receivedBlock(t,r)])}getWantlist(){return[...this.wantList.wants.values()].filter(t=>!t.cancel).map(t=>({cid:t.cid,priority:t.priority,wantType:t.wantType}))}getPeerWantlist(t){return this.peerWantLists.wantListForPeer(t)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const qS=(n,t={})=>new zS(n,t);class WS{constructor(t,e={}){u(this,"bitswap");u(this,"started");const{hashers:r}=t;this.bitswap=qS(t,{hashLoader:{getHasher:async s=>{let i;if(typeof s=="string"?i=Object.values(r).find(o=>o.name===s):i=r[s],i!=null)return i;throw new Error(`Could not load hasher for code/name "${s}"`)}},...e}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(t,e,r){await this.bitswap.notify(t,e,r)}async retrieve(t,e={}){return this.bitswap.want(t,e)}createSession(t){const e=this.bitswap.createSession(t);return{announce:async(r,s,i)=>{await this.bitswap.notify(r,s,i)},retrieve:async(r,s)=>e.retrieve(r,s)}}}function GS(n={}){return t=>new WS(t,n)}class YS{constructor(){u(this,"index",0);u(this,"input","")}new(t){return this.index=0,this.input=t,this}readAtomically(t){const e=this.index,r=t();return r===void 0&&(this.index=e),r}parseWith(t){const e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{const e=this.readChar();if(e===t)return e})}readSeparator(t,e,r){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return r()})}readNumber(t,e,r,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const h=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const f=Number.parseInt(d,t);if(!Number.isNaN(f))return f});if(h===void 0)break;if(i*=t,i+=h,i>l||(o+=1,e!==void 0&&o>e))return}if(o!==0)return!r&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const t=new Uint8Array(4);for(let e=0;e<t.length;e++){const r=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;t[e]=r}return t})}readIPv6Addr(){const t=e=>{for(let r=0;r<e.length/2;r++){const s=r*2;if(r<e.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return e[s]=o[0],e[s+1]=o[1],e[s+2]=o[2],e[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];e[s]=i>>8,e[s+1]=i&255}return[e.length,!1]};return this.readAtomically(()=>{const e=new Uint8Array(16),[r,s]=t(e);if(r===16)return e;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(r+2),[a]=t(i.subarray(0,o));return e.set(i.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const N8=45,QS=15,ji=new YS;function XS(n){if(!(n.length>QS))return ji.new(n).parseWith(()=>ji.readIPv4Addr())}function ZS(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>N8))return ji.new(n).parseWith(()=>ji.readIPv6Addr())}function jS(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>N8))return ji.new(n).parseWith(()=>ji.readIPAddr())}function Id(n){return!!XS(n)}function kd(n){return!!ZS(n)}function L8(n){return!!jS(n)}var P8;(function(){var n,t,e,r,s,i,o,a;a=function(c){var l,h,d,f;return l=(c&255<<24)>>>24,h=(c&255<<16)>>>16,d=(c&65280)>>>8,f=c&255,[l,h,d,f].join(".")},o=function(c){var l,h,d,f,p,m;for(l=[],d=f=0;f<=3&&c.length!==0;d=++f){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=t(c),p=m[0],h=m[1],c=c.substring(h),l.push(p)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},e=function(c){return c.charCodeAt(0)},r=e("0"),i=e("a"),s=e("A"),t=function(c){var l,h,d,f,p;for(f=0,l=10,h="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,l=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,l=8,h="7")),p=d;d<c.length;){if("0"<=c[d]&&c[d]<=h)f=f*l+(e(c[d])-r)>>>0;else if(l===16)if("a"<=c[d]&&c[d]<="f")f=f*l+(10+e(c[d])-i)>>>0;else if("A"<=c[d]&&c[d]<="F")f=f*l+(10+e(c[d])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");d++}if(d===p)throw new Error("empty octet");return[f,d]},n=function(){function c(l,h){var d,f,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(h||(p=l.split("/",2),l=p[0],h=p[1]),h||(h=32),typeof h=="string"&&h.indexOf(".")>-1){try{this.maskLong=o(h)}catch{throw new Error("Invalid mask: "+h)}for(d=f=32;f>=0;d=--f)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(h||h===0)this.bitmask=parseInt(h,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+h);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var h,d,f;for(f=o(this.first),d=o(this.last),h=0;f<=d;)l(a(f),f,h),h++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),P8=n}).call(Z5);const JS=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],eR=JS.map(n=>new P8(n));function xd(n){for(const t of eR)if(t.contains(n))return!0;return!1}function tR(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function nR(n){const t=n.split(":");if(t.length<2)return!1;const e=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0"),s=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(e.substring(0,2),16)}.${parseInt(e.substring(2),16)}`;return xd(s)}function rR(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function sR(n){const t=n.split(":"),e=t[t.length-1];return xd(e)}function iR(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function rs(n){return Id(n)?xd(n):tR(n)?nR(n):rR(n)?sR(n):kd(n)?iR(n):void 0}const b2=Id,oR=kd,O8=function(n){let t=0;if(n=n.toString().trim(),b2(n)){const e=new Uint8Array(t+4);return n.split(/\./g).forEach(r=>{e[t++]=parseInt(r,10)&255}),e}if(oR(n)){const e=n.split(":",8);let r;for(r=0;r<e.length;r++){const i=b2(e[r]);let o;i&&(o=O8(e[r]),e[r]=W(o.slice(0,2),"base16")),o!=null&&++r<8&&e.splice(r,0,W(o.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(r=0;r<e.length&&e[r]!=="";r++);const i=[r,1];for(r=9-e.length;r>0;r--)i.push("0");e.splice.apply(e,i)}const s=new Uint8Array(t+16);for(r=0;r<e.length;r++){const i=parseInt(e[r],16);s[t++]=i>>8&255,s[t++]=i&255}return s}throw new Error("invalid ip address")},aR=function(n,t=0,e){t=~~t,e=e??n.length-t;const r=new DataView(n.buffer);if(e===4){const s=[];for(let i=0;i<e;i++)s.push(n[t+i]);return s.join(".")}if(e===16){const s=[];for(let i=0;i<e;i+=2)s.push(r.getUint16(t+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Qt=-1,ba={},L1={},cR=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Qt,"ip6zone"],[43,8,"ipcidr"],[53,Qt,"dns",!0],[54,Qt,"dns4",!0],[55,Qt,"dns6",!0],[56,Qt,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Qt,"unix",!1,!0],[421,Qt,"ipfs"],[421,Qt,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Qt,"garlic64"],[448,0,"tls"],[449,Qt,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Qt,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,Qt,"http-path"],[777,Qt,"memory"]];cR.forEach(n=>{const t=lR(...n);L1[t.code]=t,ba[t.name]=t});function lR(n,t,e,r,s){return{code:n,size:t,name:e,resolvable:!!r,path:!!s}}function se(n){if(typeof n=="number"){if(L1[n]!=null)return L1[n];throw new Error(`no protocol with code: ${n}`)}else if(typeof n=="string"){if(ba[n]!=null)return ba[n];throw new Error(`no protocol with name: ${n}`)}throw new Error(`invalid protocol id type: ${typeof n}`)}se("ip4");se("ip6");se("ipcidr");function B8(n,t){switch(se(n).code){case 4:case 41:return hR(t);case 42:return Bu(t);case 6:case 273:case 33:case 132:return M8(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Bu(t);case 421:return pR(t);case 444:return v2(t);case 445:return v2(t);case 466:return gR(t);case 481:return globalThis.encodeURIComponent(Bu(t));default:return W(t,"base16")}}function E2(n,t){switch(se(n).code){case 4:return _2(t);case 41:return _2(t);case 42:return Ou(t);case 6:case 273:case 33:case 132:return Td(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Ou(t);case 421:return dR(t);case 444:return yR(t);case 445:return mR(t);case 466:return fR(t);case 481:return Ou(globalThis.decodeURIComponent(t));default:return V(t,"base16")}}const Pu=Object.values(Ms).map(n=>n.decoder),uR=function(){let n=Pu[0].or(Pu[1]);return Pu.slice(2).forEach(t=>n=n.or(t)),n}();function _2(n){if(!L8(n))throw new Error("invalid ip address");return O8(n)}function hR(n){const t=aR(n,0,n.length);if(t==null)throw new Error("ipBuff is required");if(!L8(t))throw new Error("invalid ip address");return t}function Td(n){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,n),new Uint8Array(t)}function M8(n){return new DataView(n.buffer).getUint16(n.byteOffset)}function Ou(n){const t=V(n),e=Uint8Array.from(Ot(t.length));return gt([e,t],e.length+t.length)}function Bu(n){const t=_r(n);if(n=n.slice(He(t)),n.length!==t)throw new Error("inconsistent lengths");return W(n)}function dR(n){let t;n[0]==="Q"||n[0]==="1"?t=cs(kt.decode(`z${n}`)).bytes:t=Q.parse(n).multihash.bytes;const e=Uint8Array.from(Ot(t.length));return gt([e,t],e.length+t.length)}function fR(n){const t=uR.decode(n),e=Uint8Array.from(Ot(t.length));return gt([e,t],e.length+t.length)}function gR(n){const t=_r(n),e=n.slice(He(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+W(e,"base64url")}function pR(n){const t=_r(n),e=n.slice(He(t));if(e.length!==t)throw new Error("inconsistent lengths");return W(e,"base58btc")}function yR(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const e=zt.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Td(r);return gt([e,s],e.length+s.length)}function mR(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const e=zt.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Td(r);return gt([e,s],e.length+s.length)}function v2(n){const t=n.slice(0,n.length-2),e=n.slice(n.length-2),r=W(t,"base32"),s=M8(e);return`${r}:${s}`}function wR(n){n=P1(n);const t=[],e=[];let r=null;const s=n.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=se(o);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(i++,i>=s.length)throw F8("invalid address: "+n);if(a.path===!0){r=P1(s.slice(i).join("/")),t.push([a.code,E2(a.code,r)]),e.push([a.code,r]);break}const c=E2(a.code,s[i]);t.push([a.code,c]),e.push([a.code,B8(a.code,c)])}return{string:U8(e),bytes:$8(t),tuples:t,stringTuples:e,path:r}}function S2(n){const t=[],e=[];let r=null,s=0;for(;s<n.length;){const i=_r(n,s),o=He(i),a=se(i),c=bR(a,n.slice(s+o));if(c===0){t.push([i]),e.push([i]),s+=o;continue}const l=n.slice(s+o,s+o+c);if(s+=c+o,s>n.length)throw F8("Invalid address Uint8Array: "+W(n,"base16"));t.push([i,l]);const h=B8(i,l);if(e.push([i,h]),a.path===!0){r=h;break}}return{bytes:Uint8Array.from(n),string:U8(e),tuples:t,stringTuples:e,path:r}}function U8(n){const t=[];return n.map(e=>{const r=se(e[0]);return t.push(r.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),P1(t.join("/"))}function $8(n){return gt(n.map(t=>{const e=se(t[0]);let r=Uint8Array.from(Ot(e.code));return t.length>1&&t[1]!=null&&(r=gt([r,t[1]])),r}))}function bR(n,t){if(n.size>0)return n.size/8;if(n.size===0)return 0;{const e=_r(t instanceof Uint8Array?t:Uint8Array.from(t));return e+He(e)}}function P1(n){return"/"+n.trim().split("/").filter(t=>t).join("/")}function F8(n){return new Error("Error parsing address: "+n)}const ER=Symbol.for("nodejs.util.inspect.custom"),V8=Symbol.for("@multiformats/js-multiaddr/multiaddr"),_R=[se("dns").code,se("dns4").code,se("dns6").code,se("dnsaddr").code];class vR extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}}var a3,xi,Hr,ka,xa;const ci=class ci{constructor(t){u(this,"bytes");fe(this,xi);fe(this,Hr);fe(this,ka);fe(this,xa);u(this,a3,!0);t==null&&(t="");let e;if(t instanceof Uint8Array)e=S2(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=wR(t)}else if(Xl(t))e=S2(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,Be(this,xi,e.string),Be(this,Hr,e.tuples),Be(this,ka,e.stringTuples),Be(this,xa,e.path)}toString(){return F(this,xi)}toJSON(){return this.toString()}toOptions(){let t,e,r,s,i="";const o=se("tcp"),a=se("udp"),c=se("ip4"),l=se("ip6"),h=se("dns6"),d=se("ip6zone");for(const[p,m]of this.stringTuples())p===d.code&&(i=`%${m??""}`),_R.includes(p)&&(e=o.name,s=443,r=`${m??""}${i}`,t=p===h.code?6:4),(p===o.code||p===a.code)&&(e=se(p).name,s=parseInt(m??"")),(p===c.code||p===l.code)&&(e=se(p).name,r=`${m??""}${i}`,t=p===l.code?6:4);if(t==null||e==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:r,transport:e,port:s}}protos(){return F(this,Hr).map(([t])=>Object.assign({},se(t)))}protoCodes(){return F(this,Hr).map(([t])=>t)}protoNames(){return F(this,Hr).map(([t])=>se(t).name)}tuples(){return F(this,Hr)}stringTuples(){return F(this,ka)}encapsulate(t){return t=new ci(t),new ci(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),r=this.toString(),s=r.lastIndexOf(e);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new ci(r.slice(0,s))}decapsulateCode(t){const e=this.tuples();for(let r=e.length-1;r>=0;r--)if(e[r][0]===t)return new ci($8(e.slice(0,r)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([r,s])=>{r===ba.p2p.code&&t.push([r,s]),r===ba["p2p-circuit"].code&&(t=[])});const e=t.pop();if((e==null?void 0:e[1])!=null){const r=e[1];return r[0]==="Q"||r[0]==="1"?W(kt.decode(`z${r}`),"base58btc"):W(Q.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return F(this,xa)}equals(t){return ve(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find(i=>i.resolvable);if(e==null)return[this];const r=Dd.get(e.name);if(r==null)throw new vR(`no available resolver for ${e.name}`);return(await r(this,t)).map(i=>le(i))}nodeAddress(){const t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[(a3=V8,ER)](){return`Multiaddr(${F(this,xi)})`}};xi=new WeakMap,Hr=new WeakMap,ka=new WeakMap,xa=new WeakMap;let O1=ci;const Dd=new Map;function Xl(n){return!!(n!=null&&n[V8])}function le(n){return new O1(n)}const SR=n=>n.toString().split("/").slice(1),Va=n=>({match:t=>t.length<1?!1:n(t[0])?t.slice(1):!1,pattern:"fn"}),Te=n=>({match:t=>Va(e=>e===n).match(t),pattern:n}),Zl=()=>({match:n=>Va(t=>typeof t=="string").match(n),pattern:"{string}"}),jl=()=>({match:n=>Va(t=>!isNaN(parseInt(t))).match(n),pattern:"{number}"}),Et=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{kt.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),tl=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{Q4.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),ct=n=>({match:t=>{const e=n.match(t);return e===!1?t:e},pattern:`optional(${n.pattern})`}),dn=(...n)=>({match:t=>{let e;for(const r of n){const s=r.match(t);s!==!1&&(e==null||s.length<e.length)&&(e=s)}return e??!1},pattern:`or(${n.map(t=>t.pattern).join(", ")})`}),Ne=(...n)=>({match:t=>{for(const e of n){const r=e.match(t);if(r===!1)return!1;t=r}return t},pattern:`and(${n.map(t=>t.pattern).join(", ")})`});function kr(...n){function t(s){let i=SR(s);for(const o of n){const a=o.match(i);if(a===!1)return!1;i=a}return i}function e(s){return t(s)!==!1}function r(s){const i=t(s);return i===!1?!1:i.length===0}return{matches:e,exactMatch:r}}const H8=Ne(Te("dns4"),Zl()),K8=Ne(Te("dns6"),Zl()),z8=Ne(Te("dnsaddr"),Zl()),q8=Ne(Te("dns"),Zl()),W8=kr(dn(q8,z8,H8,K8)),RR=Ne(Te("ip4"),Va(Id)),AR=Ne(Te("ip6"),Va(kd)),G8=dn(RR,AR),Kn=dn(G8,q8,H8,K8,z8),IR=kr(Kn),kR=kr(G8),Y8=Ne(Kn,Te("tcp"),jl()),Jl=Ne(Kn,Te("udp"),jl()),Q8=Ne(Jl,Te("quic")),Cd=Ne(Jl,Te("quic-v1")),xR=dn(Q8,Cd),B1=dn(Kn,Y8,Jl,Q8,Cd),TR=dn(Ne(B1,Te("ws"),ct(Et()))),DR=dn(Ne(B1,Te("wss"),ct(Et())),Ne(B1,Te("tls"),Te("ws"),ct(Et()))),X8=Ne(Jl,Te("webrtc-direct"),ct(tl()),ct(tl()),ct(Et())),CR=kr(X8),Z8=Ne(Cd,Te("webtransport"),ct(tl()),ct(tl()),ct(Et())),j8=kr(Z8),M1=dn(TR,DR,Ne(Y8,ct(Et())),Ne(xR,ct(Et())),Ne(Kn,ct(Et())),X8,Z8,Et()),NR=Ne(M1,Te("p2p-circuit"),Et()),nl=kr(NR),LR=dn(Ne(M1,Te("p2p-circuit"),Te("webrtc"),ct(Et())),Ne(M1,Te("webrtc"),ct(Et())),Te("webrtc")),PR=kr(LR),OR=dn(Ne(Kn,Te("tcp"),jl(),Te("http"),ct(Et())),Ne(Kn,Te("http"),ct(Et()))),BR=kr(OR),MR=dn(Ne(Kn,Te("tcp"),dn(Ne(Te("443"),Te("http")),Ne(jl(),Te("https"))),ct(Et())),Ne(Kn,Te("tls"),Te("http"),ct(Et())),Ne(Kn,Te("https"),ct(Et()))),UR=kr(MR),$R=[se("tcp").code,se("dns").code,se("dnsaddr").code,se("dns4").code,se("dns6").code];function R2(n){let t;try{t=se("sni").code}catch{return null}for(const[e,r]of n)if(e===t&&r!==void 0)return r;return null}function A2(n){return n.some(([t,e])=>t===se("tls").code)}function Ft(n,t,e){const r=J8[se(n).name];if(r===void 0)throw new Error(`Can't interpret protocol ${se(n).name}`);const s=r(t,e);return n===se("ip6").code?`[${s}]`:s}const J8={ip4:(n,t)=>n,ip6:(n,t)=>t.length===0?n:`[${n}]`,tcp:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${Ft(e[0],e[1]??"",t)}:${n}`},udp:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${Ft(e[0],e[1]??"",t)}:${n}`},dnsaddr:(n,t)=>n,dns4:(n,t)=>n,dns6:(n,t)=>n,dns:(n,t)=>n,ipfs:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${Ft(e[0],e[1]??"",t)}/ipfs/${n}`},p2p:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${Ft(e[0],e[1]??"",t)}/p2p/${n}`},http:(n,t)=>{const e=A2(t),r=R2(t);if(e&&r!==null)return`https://${r}`;const s=e?"https://":"http://",i=t.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=Ft(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},"http-path":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");const r=Ft(e[0],e[1]??"",t),s=decodeURIComponent(n);return`${r}/${s}`},tls:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return Ft(e[0],e[1]??"",t)},sni:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return Ft(e[0],e[1]??"",t)},https:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");let r=Ft(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(n,t)=>{const e=A2(t),r=R2(t);if(e&&r!==null)return`wss://${r}`;const s=e?"wss://":"ws://",i=t.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=Ft(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},wss:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");let r=Ft(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`},"p2p-websocket-star":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${Ft(e[0],e[1]??"",t)}/p2p-websocket-star`},"p2p-webrtc-star":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${Ft(e[0],e[1]??"",t)}/p2p-webrtc-star`},"p2p-webrtc-direct":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${Ft(e[0],e[1]??"",t)}/p2p-webrtc-direct`}};function e7(n,t){const r=le(n).stringTuples(),s=r.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");const i=se(s[0]),o=J8[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",r);return $R.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var ks,xs,Ti,Di,Ts,kl,t7;class FR{constructor(t,e){fe(this,kl);u(this,"url");fe(this,ks,0);fe(this,xs,0);fe(this,Ti,0);fe(this,Di,0);fe(this,Ts,new Map);u(this,"log");this.url=t instanceof URL?t:new URL(t),this.log=e.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}async getRawBlock(t,e){const r=new URL(this.url.toString());if(r.pathname=`/ipfs/${t.toString()}`,r.search="?format=raw",(e==null?void 0:e.aborted)===!0)throw new Error(`Signal to fetch raw block for CID ${t} from gateway ${this.url} was aborted prior to fetch`);const s=re(this,kl,t7).call(this,t),i=new AbortController,o=()=>{i.abort()};e==null||e.addEventListener("abort",o);try{let a=F(this,Ts).get(s);return a==null&&(jn(this,ks)._++,a=fetch(r.toString(),{signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"}).then(async c=>{if(this.log("GET %s %d",r,c.status),!c.ok)throw jn(this,xs)._++,new Error(`unable to fetch raw block for CID ${t} from gateway ${this.url}`);return jn(this,Di)._++,new Uint8Array(await c.arrayBuffer())}),F(this,Ts).set(s,a)),await a}catch{throw(e==null?void 0:e.aborted)===!0?new Error(`fetching raw block for CID ${t} from gateway ${this.url} was aborted`):(jn(this,xs)._++,new Error(`unable to fetch raw block for CID ${t}`))}finally{e==null||e.removeEventListener("abort",o),F(this,Ts).delete(s)}}reliability(){return F(this,ks)===0?1:F(this,Ti)>0?-1/0:F(this,Di)/(F(this,ks)+F(this,xs)*3)}incrementInvalidBlocks(){jn(this,Ti)._++}getStats(){return{attempts:F(this,ks),errors:F(this,xs),invalidBlocks:F(this,Ti),successes:F(this,Di),pendingResponses:F(this,Ts).size}}}ks=new WeakMap,xs=new WeakMap,Ti=new WeakMap,Di=new WeakMap,Ts=new WeakMap,kl=new WeakSet,t7=function(t){const e=t.multihash.bytes;return ln.encode(e)};function VR(n,t,e){return n.filter(r=>{if(UR.matches(r)||t&&BR.matches(r))return e||W8.matches(r)?!0:rs(r.toOptions().host)===!1;if(!t&&e){const{host:s}=r.toOptions();if(s==="127.0.0.1"||s==="localhost"||s.endsWith(".localhost"))return!0}return!1})}async function*n7(n,t,e,r,s,i){for await(const o of t.findProviders(n,i)){const a=VR(o.multiaddrs,r,s);if(a.length===0)continue;const c=e7(a[0]);yield new FR(c,e)}}class HR extends D8{constructor(e,r){super(e,{...r,name:"helia:trustless-gateway:session"});u(this,"routing");u(this,"allowInsecure");u(this,"allowLocal");this.routing=e.routing,this.allowInsecure=r.allowInsecure??r7,this.allowLocal=r.allowLocal??s7}async queryProvider(e,r,s){var o;this.log("fetching BLOCK for %c from %s",e,r.url);const i=await r.getRawBlock(e,s.signal);return this.log.trace("got block for %c from %s",e,r.url),await((o=s.validateFn)==null?void 0:o.call(s,i)),i}async*findNewProviders(e,r={}){yield*n7(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,r)}toEvictionKey(e){return e.url.toString()}equals(e,r){return e.url.toString()===r.url.toString()}}function KR(n,t){return new HR(n,t)}class zR{constructor(t,e={}){u(this,"allowInsecure");u(this,"allowLocal");u(this,"routing");u(this,"log");u(this,"logger");this.log=t.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=t.logger,this.routing=t.routing,this.allowInsecure=e.allowInsecure??r7,this.allowLocal=e.allowLocal??s7}async retrieve(t,e={}){var s,i;const r=[];for await(const o of n7(t,this.routing,this.logger,this.allowInsecure,this.allowLocal,e)){this.log("getting block for %c from %s",t,o.url);try{const a=await o.getRawBlock(t,e.signal);this.log.trace("got block for %c from %s",t,o.url);try{await((s=e.validateFn)==null?void 0:s.call(e,a))}catch(c){this.log.error("failed to validate block for %c from %s",t,o.url,c);continue}return a}catch(a){if(this.log.error("failed to get block for %c from %s",t,o.url,a),a instanceof Error?r.push(a):r.push(new Error(`Unable to fetch raw block for CID ${t} from gateway ${o.url}`)),((i=e.signal)==null?void 0:i.aborted)===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",t,o.url);break}}}throw r.length>0?new AggregateError(r,`Unable to fetch raw block for CID ${t} from any gateway`):new Error(`Unable to fetch raw block for CID ${t} from any gateway`)}createSession(t={}){return KR({logger:this.logger,routing:this.routing},{...t,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure})}}const r7=!1,s7=!1;function qR(n={}){return t=>new zR(t,n)}async function*I2(n,t={}){const e=n.getReader();try{for(;;){const r=await e.read();if(r.done)return;yield r.value}}finally{t.preventCancel!==!0&&await e.cancel(),e.releaseLock()}}var i7={exports:{}};(function(n){(function(){n.exports=y;var t=86400,e=3200,r=146097*e/400,s=t*r,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",h=Math.trunc||function(S){var B=S-S%1;return B==0&&(S<0||S===0&&1/S!=1/0)?-0:B},d=y.prototype,f=(y.fromDate=function(S){return new y(+S)},y.fromInt64BE=A(0,1,2,3,0,4),y.fromInt64LE=A(3,2,1,0,4,0),y.fromString=function(M){var B,O=new y,M=(M+="").replace(/^\s*[+\-]?\d+/,function(N){var N=+N,D=1970+(N-1970)%400;return O.year=N-D,D}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(U,N,D){return N<0&&(D*=-1),B=6e4*(60*+N+ +D),""}).replace(/\.\d+$/,function(U){return O.nano=+(U+l).substr(1,9),""}).split(/\D+/);if(1<M.length?M[1]--:M[1]=0,O.time=B=Date.UTC.apply(Date,M)-(B||0),isNaN(B))throw new TypeError("Invalid Date");return w(O)},y.fromTimeT=function(S){return b(S,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(S){return this.nano+=+S||0,this},d.getNano=function(){var S=w(this);return(S.time%1e3*c+ +S.nano+1e9)%1e9},d.getTimeT=function(){var B=w(this),S=Math.floor(B.time/1e3),B=B.year;return B&&(S+=B*r*t/e),S},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return _(w(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(S){var B=this,O=B.toDate(),M={H:function(){return k(O.getUTCHours())},L:function(){return C(O.getUTCMilliseconds(),3)},M:function(){return k(O.getUTCMinutes())},N:function(){return C(B.getNano(),9)},S:function(){return k(O.getUTCSeconds())},Y:function(){var U=B.getYear();return 999999<U?"+"+U:9999<U?"+"+C(U,6):0<=U?C(U,4):-999999<=U?"-"+C(-U,6):U},a:function(){return m[O.getUTCDay()]},b:function(){return p[O.getUTCMonth()]},d:function(){return k(O.getUTCDate())},e:function(){return function(U){return(9<U?"":" ")+(0|U)}(O.getUTCDate())},m:function(){return k(O.getUTCMonth()+1)}};return function U(N){return N.replace(/%./g,function(D){var I=D[1],T=g[I],I=M[I];return T?U(T):I?I():D})}(S||f)},d.writeInt64BE=v(0,1,2,3,0,4),d.writeInt64LE=v(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return y;function y(S,B,O){var M=this;if(!(M instanceof y))return new y(S,B,O);M.time=+S||0,M.nano=+B||0,M.year=+O||0,w(M)}function w(S){var B,O,M,U=S.year,N=S.time,D=S.nano,T=((D<0||c<=D)&&(D-=(O=Math.floor(D/c))*c,N+=O,O=1),U%e);return(N<-o||o<N||T)&&((B=h(N/i))&&(U+=B*e,N-=B*i),(M=_(N)).setUTCFullYear(T+M.getUTCFullYear()),M=(N=+M)+(B=h((U-=T)/e))*i,B&&-o<=M&&M<=o&&(U-=B*e,N=M),O=1),O&&(S.year=U,S.time=N,S.nano=D),S}function _(S){var B=new Date(0);return B.setTime(S),B}function b(U,M){U=+U||0;var O=h((M=(M|0)*a)/s)+h(U/s),M=M%s+U%s,U=h(M/s);return U&&(O+=U,M-=U*s),new y(1e3*M,0,O*e)}function v(S,B,O,M,U,N){return function(T,I){var L=w(this);T=T||new Array(8),R(T,I|=0);var $=Math.floor(L.time/1e3),L=L.year*(r*t/e),P=h(L/a)+h($/a),L=L%a+$%a,$=Math.floor(L/a);return $&&(P+=$,L-=$*a),D(T,I+U,P),D(T,I+N,L),T};function D(T,I,P){T[I+S]=P>>24&255,T[I+B]=P>>16&255,T[I+O]=P>>8&255,T[I+M]=255&P}}function A(S,B,O,M,U,N){return function(T,I){R(T,I|=0);var P=D(T,I+U);return b(D(T,I+N),P)};function D(T,I){return 16777216*T[I+S]+(T[I+B]<<16|T[I+O]<<8|T[I+M])}}function R(S,B){if(S=S&&S.length,S==null)throw new TypeError("Invalid Buffer");if(S<B+8)throw new RangeError("Out of range")}function k(S){return(9<S?"":"0")+(0|S)}function C(S,B){return(l+(0|S)).substr(-B)}})()})(i7);var WR=i7.exports;const U1=Ir(WR),GR="ERR_IPNS_EXPIRED_RECORD",o7="ERR_UNRECOGNIZED_VALIDITY",Ss="ERR_SIGNATURE_VERIFICATION",k2="ERR_UNDEFINED_PARAMETER",YR="ERR_INVALID_RECORD_DATA",QR="ERR_INVALID_VALUE",XR="ERR_INVALID_EMBEDDED_KEY",ZR="ERR_RECORD_TOO_LARGE";var vn;(function(n){(function(r){r.EOL="EOL"})(n.ValidityType||(n.ValidityType={}));let t;(function(r){r[r.EOL=0]="EOL"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.ValidityType||(n.ValidityType={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.value!=null&&(s.uint32(10),s.bytes(r.value)),r.signatureV1!=null&&(s.uint32(18),s.bytes(r.signatureV1)),r.validityType!=null&&(s.uint32(24),n.ValidityType.codec().encode(r.validityType,s)),r.validity!=null&&(s.uint32(34),s.bytes(r.validity)),r.sequence!=null&&(s.uint32(40),s.uint64(r.sequence)),r.ttl!=null&&(s.uint32(48),s.uint64(r.ttl)),r.pubKey!=null&&(s.uint32(58),s.bytes(r.pubKey)),r.signatureV2!=null&&(s.uint32(66),s.bytes(r.signatureV2)),r.data!=null&&(s.uint32(74),s.bytes(r.data)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.value=r.bytes();break;case 2:i.signatureV1=r.bytes();break;case 3:i.validityType=n.ValidityType.codec().decode(r);break;case 4:i.validity=r.bytes();break;case 5:i.sequence=r.uint64();break;case 6:i.ttl=r.uint64();break;case 7:i.pubKey=r.bytes();break;case 8:i.signatureV2=r.bytes();break;case 9:i.data=r.bytes();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(vn||(vn={}));const x2=Tt("ipns:utils"),a7=V("/ipns/"),jR=114,JR=async(n,t)=>{if(t==null||n==null){const r=new Error("one or more of the provided parameters are not defined");throw x2.error(r),Fe(r,k2)}let e;if(t.pubKey!=null){try{e=ma(t.pubKey)}catch(s){throw x2.error(s),s}if(!(await Gn(t.pubKey)).equals(n))throw Fe(new Error("Embedded public key did not match PeerID"),XR)}else n.publicKey!=null&&(e=ma(n.publicKey));if(e!=null)return e;throw Fe(new Error("no public key is available"),k2)},eA=n=>{const t=V("ipns-signature:");return gt([t,n])},c7=n=>"signatureV1"in n?vn.encode({value:V(n.value),signatureV1:n.signatureV1,validityType:n.validityType,validity:V(n.validity),sequence:n.sequence,ttl:n.ttl,pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data}):vn.encode({pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data});function Ha(n){const t=vn.decode(n);if(t.sequence!=null&&(t.sequence=BigInt(t.sequence)),t.ttl!=null&&(t.ttl=BigInt(t.ttl)),t.signatureV2==null||t.data==null)throw Fe(new Error("missing data or signatureV2"),Ss);const e=l7(t.data),r=rA(e.Value),s=W(e.Validity);if(t.value!=null&&t.signatureV1!=null)return sA(t),{value:r,validityType:vn.ValidityType.EOL,validity:s,sequence:e.Sequence,ttl:e.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(t.signatureV2!=null)return{value:r,validityType:vn.ValidityType.EOL,validity:s,sequence:e.Sequence,ttl:e.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}const tA=n=>gt([a7,n.toBytes()]),nA=n=>Rn(n.slice(a7.length)),l7=n=>{const t=Cs(n);if(t.ValidityType===0)t.ValidityType=vn.ValidityType.EOL;else throw Fe(new Error("Unknown validity type"),o7);return Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t},rA=n=>{if(n!=null){if(Bl(n))return`/ipns/${n.toCID().toString(yr)}`;if(n instanceof Uint8Array){const r=W(n);r.startsWith("/")&&(n=r)}const t=n.toString().trim();if(t.startsWith("/")&&t.length>1)return t;const e=Q.asCID(n);if(e!=null)return e.code===jR?`/ipns/${e.toString(yr)}`:`/ipfs/${e.toV1().toString()}`;try{return n instanceof Uint8Array?`/ipfs/${Q.decode(n).toV1().toString()}`:`/ipfs/${Q.parse(t).toV1().toString()}`}catch{}}throw Fe(new Error("Value must be a valid content path starting with /"),QR)},sA=n=>{if(n.data==null)throw Fe(new Error("Record data is missing"),YR);const t=l7(n.data);if(!ve(t.Value,n.value??new Uint8Array(0)))throw Fe(new Error('Field "value" did not match between protobuf and CBOR'),Ss);if(!ve(t.Validity,n.validity??new Uint8Array(0)))throw Fe(new Error('Field "validity" did not match between protobuf and CBOR'),Ss);if(t.ValidityType!==n.validityType)throw Fe(new Error('Field "validityType" did not match between protobuf and CBOR'),Ss);if(t.Sequence!==n.sequence)throw Fe(new Error('Field "sequence" did not match between protobuf and CBOR'),Ss);if(t.TTL!==n.ttl)throw Fe(new Error('Field "ttl" did not match between protobuf and CBOR'),Ss)},lc=Tt("ipns:validator"),iA=1024*10,oA=async(n,t)=>{const e=Ha(t);let r;try{const s=eA(e.data);r=await n.verify(s,e.signatureV2)}catch{r=!1}if(!r)throw lc.error("record signature verification failed"),Fe(new Error("record signature verification failed"),Ss);if(e.validityType===vn.ValidityType.EOL){if(U1.fromString(e.validity).toDate().getTime()<Date.now())throw lc.error("record has expired"),Fe(new Error("record has expired"),GR)}else if(e.validityType!=null)throw lc.error("unrecognized validity type"),Fe(new Error("unrecognized validity type"),o7);lc("ipns record for %s is valid",e.value)};async function u7(n,t){if(t.byteLength>iA)throw Fe(new Error("record too large"),ZR);const e=nA(n),r=Ha(t),s=await JR(e,r);await oA(s,t)}async function*T2(n){const t=/\r?\n/,e=new TextDecoder("utf8");let r="";for await(let s of n){typeof s=="string"&&(s=new TextEncoder().encode(s)),r+=e.decode(s,{stream:!0});const i=r.split(t);r=i.pop()??"";for(let o=0;o<i.length;o++)yield JSON.parse(i[o])}r+=e.decode(),r!==""&&(yield JSON.parse(r))}function aA(n){return n[Symbol.asyncIterator]!=null}function Ji(n){if(aA(n))return(async()=>{for await(const t of n)return t})();for(const t of n)return t}const $1=V("/ipns/");function D2(n){return ve(n.subarray(0,$1.byteLength),$1)}const C2=n=>Rn(n.slice($1.length));class cA{constructor(t){u(this,"client");this.client=t}async*findProviders(t,e={}){yield*vr(this.client.getProviders(t,e),r=>({id:r.ID,multiaddrs:r.Addrs??[]}))}async provide(){}async put(t,e,r){if(!D2(t))return;const s=C2(t),i=Ha(e);await this.client.putIPNS(s,i,r)}async get(t,e){if(!D2(t))throw new E("Not found","ERR_NOT_FOUND");const r=C2(t);try{const s=await this.client.getIPNS(r,e);return c7(s)}catch(s){throw s.code==="ERR_BAD_RESPONSE"?new E("Not found","ERR_NOT_FOUND"):s}}}class lA{constructor(t){u(this,"client");this.client=t}async findPeer(t,e={}){const r=await Ji(this.client.getPeers(t,e));if(r!=null)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new E("Not found","ERR_NOT_FOUND")}async*getClosestPeers(t,e={}){}}const Dt=Tt("delegated-routing-v1-http-api-client"),N2={concurrentRequests:4,timeout:3e4};var Ds,Fo;class uA{constructor(t,e={}){fe(this,Ds);u(this,"started");u(this,"httpQueue");u(this,"shutDownController");u(this,"clientUrl");u(this,"timeout");u(this,"contentRouting");u(this,"peerRouting");this.started=!1,this.shutDownController=new AbortController,j(1/0,this.shutDownController.signal),this.httpQueue=new Zi({concurrency:e.concurrentRequests??N2.concurrentRequests}),this.clientUrl=t instanceof URL?t:new URL(t),this.timeout=e.timeout??N2.timeout,this.contentRouting=new cA(this),this.peerRouting=new lA(this)}get[Oi](){return this.contentRouting}get[Bi](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(t,e={}){Dt("getProviders starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Ze([this.shutDownController.signal,r,e.signal]);j(1/0,r,s);const i=pe(),o=pe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=`${this.clientUrl}routing/v1/providers/${t.toString()}`,l=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:s});if(l.status===404)throw new E("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new E("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new E("Routing response had no body","ERR_BAD_RESPONSE");if(l.headers.get("Content-Type")==="application/json"){const d=await l.json();for(const f of d.Providers){const p=re(this,Ds,Fo).call(this,f);p!=null&&(yield p)}}else for await(const d of T2(I2(l.body))){const f=re(this,Ds,Fo).call(this,d);f!=null&&(yield f)}}catch(a){Dt.error("getProviders errored:",a)}finally{s.clear(),o.resolve(),Dt("getProviders finished: %c",t)}}async*getPeers(t,e={}){Dt("getPeers starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Ze([this.shutDownController.signal,r,e.signal]);j(1/0,r,s);const i=pe(),o=pe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=`${this.clientUrl}routing/v1/peers/${t.toCID().toString()}`,l=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:s});if(l.status===404)throw new E("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new E("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new E("Routing response had no body","ERR_BAD_RESPONSE");if(l.headers.get("Content-Type")==="application/json"){const d=await l.json();for(const f of d.Peers){const p=re(this,Ds,Fo).call(this,f);p!=null&&(yield p)}}else for await(const d of T2(I2(l.body))){const f=re(this,Ds,Fo).call(this,d);f!=null&&(yield f)}}catch(a){Dt.error("getPeers errored:",a)}finally{s.clear(),o.resolve(),Dt("getPeers finished: %c",t)}}async getIPNS(t,e={}){Dt("getIPNS starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Ze([this.shutDownController.signal,r,e.signal]);j(1/0,r,s);const i=pe(),o=pe();this.httpQueue.add(async()=>(i.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${t.toCID().toString()}`;try{await i.promise;const l=await fetch(a,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:s});if(Dt("getIPNS GET %s %d",a,l.status),l.status===404)throw new E("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new E("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new E("GET ipns response had no body","ERR_BAD_RESPONSE");const h=await l.arrayBuffer(),d=new Uint8Array(h,0,h.byteLength);return e.validate!==!1&&await u7(tA(t),d),Ha(d)}catch(c){throw Dt.error("getIPNS GET %s error:",a,c),c}finally{s.clear(),o.resolve(),Dt("getIPNS finished: %c",t)}}async putIPNS(t,e,r={}){Dt("putIPNS starts: %c",t);const s=AbortSignal.timeout(this.timeout),i=Ze([this.shutDownController.signal,s,r.signal]);j(1/0,s,i);const o=pe(),a=pe();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${t.toCID().toString()}`;try{await o.promise;const l=c7(e),d=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i});if(Dt("putIPNS PUT %s %d",c,d.status),d.status!==200)throw new E("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(l){throw Dt.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),Dt("putIPNS finished: %c",t)}}}Ds=new WeakSet,Fo=function(t){var e;try{const r=[],s=((e=t.Addrs)==null?void 0:e.map(le))??[];return t.Protocols!=null&&r.push(...t.Protocols),t.Protocol!=null&&(r.push(t.Protocol),delete t.Protocol),{...t,Schema:"peer",ID:Je(t.ID),Addrs:s,Protocols:r}}catch(r){Dt.error("could not conform record to peer schema",r)}};function hA(n,t={}){return new uA(new URL(n),t)}const L2="[a-fA-F\\d:]",qr=n=>n&&n.includeBoundaries?`(?:(?<=\\s|^)(?=${L2})|(?<=${L2})(?=\\s|$))`:"",wn="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",it="[a-fA-F\\d]{1,4}",eu=`
(?:
(?:${it}:){7}(?:${it}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${it}:){6}(?:${wn}|:${it}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${it}:){5}(?::${wn}|(?::${it}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${it}:){4}(?:(?::${it}){0,1}:${wn}|(?::${it}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${it}:){3}(?:(?::${it}){0,2}:${wn}|(?::${it}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${it}:){2}(?:(?::${it}){0,3}:${wn}|(?::${it}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${it}:){1}(?:(?::${it}){0,4}:${wn}|(?::${it}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${it}){0,5}:${wn}|(?::${it}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),dA=new RegExp(`(?:^${wn}$)|(?:^${eu}$)`),fA=new RegExp(`^${wn}$`),gA=new RegExp(`^${eu}$`),tu=n=>n&&n.exact?dA:new RegExp(`(?:${qr(n)}${wn}${qr(n)})|(?:${qr(n)}${eu}${qr(n)})`,"g");tu.v4=n=>n&&n.exact?fA:new RegExp(`${qr(n)}${wn}${qr(n)}`,"g");tu.v6=n=>n&&n.exact?gA:new RegExp(`${qr(n)}${eu}${qr(n)}`,"g");function pA(n){const t=(...e)=>n(...e);return Object.defineProperty(t,"name",{value:`functionTimeout(${n.name||"<anonymous>"})`,configurable:!0}),t}const{toString:yA}=Object.prototype;function mA(n){return yA.call(n)==="[object RegExp]"}const P2={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function wA(n,t={}){if(!mA(n))throw new TypeError("Expected a RegExp instance");const e=Object.keys(P2).map(s=>(typeof t[s]=="boolean"?t[s]:n[s])?P2[s]:"").join(""),r=new RegExp(t.source||n.source,e);return r.lastIndex=typeof t.lastIndex=="number"?t.lastIndex:n.lastIndex,r}function h7(n,t,{timeout:e}={}){try{return pA(()=>wA(n).test(t),{timeout:e})()}catch(r){throw r}}const bA=15,EA=45,d7={timeout:400};function O2(n){return n.length>EA?!1:h7(tu.v6({exact:!0}),n,d7)}function _A(n){return n.length>bA?!1:h7(tu.v4({exact:!0}),n,d7)}const B2={http:"80",https:"443",ws:"80",wss:"443"},vA=["http","https","ws","wss"];function SA(n,t){t=t??{};const e=t.defaultDnsType??"dns4",{scheme:r,hostname:s,port:i}=RA(n),a="/"+[AA(s,e),IA(i,r),kA(r)].filter(c=>!!c).reduce((c,l)=>c.concat(l),[]).join("/");return le(a)}function RA(n){const[t]=n.split(":");vA.includes(t)||(n="http"+n.substring(t.length));let{protocol:e,hostname:r,port:s}=new URL(n);if(s==null||s===""){const i=xA(t);i!=null&&(s=i),i==null&&e==="http:"&&(s="80")}return{scheme:t,hostname:r,port:s}}function AA(n,t){if(!(n==null||n==="")){if(_A(n))return["ip4",n];if(O2(n))return["ip6",n];if(n[0]==="["){const e=n.substring(1,n.length-1);if(O2(e))return["ip6",e]}return[t,n]}}function IA(n,t){if(!(n==null||n===""))return t==="udp"?["udp",n]:["tcp",n]}function kA(n){if(n.match(/^tcp$|^udp$/)==null)return[n]}function xA(n){if(!(n==null||n===""||B2[n]==null))return B2[n]}const TA=["https://trustless-gateway.link","https://4everland.io"],DA=2336,CA=Symbol.for("nodejs.util.inspect.custom");var c3,l3;class NA{constructor(t){u(this,"type","url");u(this,"multihash");u(this,"privateKey");u(this,"publicKey");u(this,"url");u(this,c3,!0);this.url=t.toString(),this.multihash=Er.digest(V(this.url))}[(l3=CA,c3=Ol,l3)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return Q.createV1(DA,this.multihash)}toBytes(){return this.toCID().bytes}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=W(t)),t.toString()===this.toString())}}function LA(n){return n=n.toString(),{id:new NA(new URL(n)),multiaddrs:[SA(n)]}}class PA{constructor(t={}){u(this,"gateways");this.gateways=(t.gateways??TA).map(e=>LA(e))}async*findProviders(t,e){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(r=>({...r,protocols:["transport-ipfs-gateway-http"]}))}}function OA(n={}){return new PA(n)}class BA{constructor(t){u(this,"libp2p");this.libp2p=t}async provide(t,e){await this.libp2p.contentRouting.provide(t,e)}async*findProviders(t,e){yield*this.libp2p.contentRouting.findProviders(t,e)}async put(t,e,r){await this.libp2p.contentRouting.put(t,e,r)}async get(t,e){return this.libp2p.contentRouting.get(t,e)}async findPeer(t,e){return this.libp2p.peerRouting.findPeer(t,e)}async*getClosestPeers(t,e){yield*this.libp2p.peerRouting.getClosestPeers(t,e)}}function MA(n){return new BA(n)}function UA(n){return n=n??new Error("Not Found"),Fe(n,"ERR_NOT_FOUND")}const $A="SHARDING";function FA(n){return n[Symbol.asyncIterator]!=null}function rl(n){if(FA(n))return(async()=>{const e=[];for await(const r of n)e.push(r);return e})();const t=[];for(const e of n)t.push(e);return t}function VA(n){return n[Symbol.asyncIterator]!=null}function M2(n,t){return VA(n)?async function*(){yield*(await rl(n)).sort(t)}():function*(){yield*rl(n).sort(t)}()}class HA{put(t,e,r){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:r,value:s}of t)await this.put(r,s,e),yield r}async*getMany(t,e={}){for await(const r of t)yield{key:r,value:await this.get(r,e)}}async*deleteMany(t,e={}){for await(const r of t)await this.delete(r,e),yield r}batch(){let t=[],e=[];return{put(r,s){t.push({key:r,value:s})},delete(r){e.push(r)},commit:async r=>{await Bs(this.putMany(t,r)),t=[],await Bs(this.deleteMany(e,r)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let r=this._all(t,e);if(t.prefix!=null){const s=t.prefix;r=Mr(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>Mr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>M2(s,i),r)),t.offset!=null){let s=0;const i=t.offset;r=Mr(r,()=>s++>=i)}return t.limit!=null&&(r=qc(r,t.limit)),r}queryKeys(t,e){let r=this._allKeys(t,e);if(t.prefix!=null){const s=t.prefix;r=Mr(r,i=>i.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>Mr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>M2(s,i),r)),t.offset!=null){const s=t.offset;let i=0;r=Mr(r,()=>i++>=s)}return t.limit!=null&&(r=qc(r,t.limit)),r}}class f7 extends HA{constructor(){super();u(this,"data");this.data=new Map}put(e,r){return this.data.set(e.toString(),r),e}get(e){const r=this.data.get(e.toString());if(r==null)throw UA();return r}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,r]of this.data.entries())yield{key:new $e(e),value:r}}*_allKeys(){for(const e of this.data.keys())yield new $e(e)}}new $e($A);Tt("datastore:core:tiered");class KA extends MS{constructor(e){super({...e,components:{libp2p:e.libp2p}});u(this,"libp2p");this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}class zA{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");this.ended=!1,this.readNext=pe(),this.haveNext=pe()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=pe(),t}async throw(t){return this.ended=!0,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){const t={done:!0,value:void 0};return await this._push(void 0),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=pe(),await dt(this.readNext.promise,e==null?void 0:e.signal,e)}}function qA(){return new zA}class WA extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}}class GA extends Error{constructor(e,r){super(e);u(this,"code");this.code=r}}class YA extends GA{constructor(e){super(e,"ABORT_ERR");u(this,"type");this.type="aborted",this.name="AbortError"}}function g7(n,t){const e=qA();n.sink(e).catch(async o=>{await e.end(o)}),n.sink=async o=>{for await(const a of o)await e.push(a);await e.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new Ie;return{read:async(o,a)=>{var h,d;(h=a==null?void 0:a.signal)==null||h.throwIfAborted();let c;const l=new Promise((f,p)=>{var m;c=()=>{p(new YA("Read aborted"))},(m=a==null?void 0:a.signal)==null||m.addEventListener("abort",c)});try{if(o==null){const{done:p,value:m}=await Promise.race([r.next(),l]);return p===!0?new Ie:m}for(;s.byteLength<o;){const{value:p,done:m}=await Promise.race([r.next(),l]);if(m===!0)throw new WA("unexpected end of input");s.append(p)}const f=s.sublist(0,o);return s.consume(o),f}finally{c!=null&&((d=a==null?void 0:a.signal)==null||d.removeEventListener("abort",c))}},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await e.push(o,a):await e.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=n.source;n.source=async function*(){(t==null?void 0:t.yieldBytes)===!1?yield s:yield*s,yield*o}()}return n}}}class QA extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}}class XA extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}}class ZA extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}function eo(n,t={}){const e=g7(n,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=He(t.maxDataLength));const r=(t==null?void 0:t.lengthDecoder)??_r,s=(t==null?void 0:t.lengthEncoder)??Ot;return{read:async o=>{let a=-1;const c=new Ie;for(;;){c.append(await e.read(1,o));try{a=r(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new QA("Invalid message length");if((t==null?void 0:t.maxLengthLength)!=null&&c.byteLength>t.maxLengthLength)throw new ZA("message length length too long");if(a>-1)break}if((t==null?void 0:t.maxDataLength)!=null&&a>t.maxDataLength)throw new XA("message length too long");return e.read(a,o)},write:async(o,a)=>{await e.write(new Ie(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ie(...o.flatMap(l=>[s(l.byteLength),l]));await e.write(c,a)},unwrap:()=>e.unwrap()}}function U2(){const n=pe();let t=!1;return{sink:async e=>{if(t)throw new Error("already piped");t=!0,n.resolve(e)},source:async function*(){yield*await n.promise}()}}function jA(){const n=U2(),t=U2();return[{source:n.source,sink:t.sink},{source:t.source,sink:n.sink}]}const Ea=65535,$2=Ea-16;var u3,h3;const Ka=!!((h3=(u3=globalThis.process)==null?void 0:u3.env)!=null&&h3.DUMP_SESSION_KEYS);function Mu(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function F2(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function p7(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function Fn(n,...t){if(!p7(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${n.length}`)}function V2(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function JA(n,t){Fn(n);const e=t.outputLen;if(n.length<e)throw new Error(`digestInto() expects output buffer of length at least ${e}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const jr=n=>new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4)),eI=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),tI=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!tI)throw new Error("Non little-endian hardware is not supported");function nI(n){if(typeof n!="string")throw new Error(`string expected, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function F1(n){if(typeof n=="string")n=nI(n);else if(p7(n))n=V1(n);else throw new Error(`Uint8Array expected, got ${typeof n}`);return n}function rI(n,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(n,t)}function sI(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}const iI=(n,t)=>(Object.assign(t,n),t);function H2(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),c=4,l=0;n.setUint32(t+c,o,r),n.setUint32(t+l,a,r)}function V1(n){return Uint8Array.from(n)}function to(...n){for(let t=0;t<n.length;t++)n[t].fill(0)}const y7=n=>Uint8Array.from(n.split("").map(t=>t.charCodeAt(0))),oI=y7("expand 16-byte k"),aI=y7("expand 32-byte k"),cI=jr(oI),m7=jr(aI);m7.slice();function Re(n,t){return n<<t|n>>>32-t}function H1(n){return n.byteOffset%4===0}const uc=64,lI=16,w7=2**32-1,K2=new Uint32Array;function uI(n,t,e,r,s,i,o,a){const c=s.length,l=new Uint8Array(uc),h=jr(l),d=H1(s)&&H1(i),f=d?jr(s):K2,p=d?jr(i):K2;for(let m=0;m<c;o++){if(n(t,e,r,h,o,a),o>=w7)throw new Error("arx: counter overflow");const g=Math.min(uc,c-m);if(d&&g===uc){const y=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let w=0,_;w<lI;w++)_=y+w,p[_]=f[_]^h[w];m+=uc;continue}for(let y=0,w;y<g;y++)w=m+y,i[w]=s[w]^l[y];m+=g}}function hI(n,t){const{allowShortKeys:e,extendNonceFn:r,counterLength:s,counterRight:i,rounds:o}=rI({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof n!="function")throw new Error("core must be a function");return Mu(s),Mu(o),F2(i),F2(e),(a,c,l,h,d=0)=>{Fn(a),Fn(c),Fn(l);const f=l.length;if(h===void 0&&(h=new Uint8Array(f)),Fn(h),Mu(d),d<0||d>=w7)throw new Error("arx: counter overflow");if(h.length<f)throw new Error(`arx: output (${h.length}) is shorter than data (${f})`);const p=[];let m=a.length,g,y;if(m===32)p.push(g=V1(a)),y=m7;else if(m===16&&e)g=new Uint8Array(32),g.set(a),g.set(a,16),y=cI,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);H1(c)||p.push(c=V1(c));const w=jr(g);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(y,w,jr(c.subarray(0,16)),w),c=c.subarray(16)}const _=16-s;if(_!==c.length)throw new Error(`arx: nonce must be ${_} or 16 bytes`);if(_!==12){const v=new Uint8Array(12);v.set(c,i?0:12-c.length),c=v,p.push(c)}const b=jr(c);return uI(n,y,w,b,l,h,d,o),to(...p),h}}const yt=(n,t)=>n[t++]&255|(n[t++]&255)<<8;class dI{constructor(t){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,t=F1(t),Fn(t,32);const e=yt(t,0),r=yt(t,2),s=yt(t,4),i=yt(t,6),o=yt(t,8),a=yt(t,10),c=yt(t,12),l=yt(t,14);this.r[0]=e&8191,this.r[1]=(e>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=yt(t,16+2*h)}process(t,e,r=!1){const s=r?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],h=o[3],d=o[4],f=o[5],p=o[6],m=o[7],g=o[8],y=o[9],w=yt(t,e+0),_=yt(t,e+2),b=yt(t,e+4),v=yt(t,e+6),A=yt(t,e+8),R=yt(t,e+10),k=yt(t,e+12),C=yt(t,e+14);let S=i[0]+(w&8191),B=i[1]+((w>>>13|_<<3)&8191),O=i[2]+((_>>>10|b<<6)&8191),M=i[3]+((b>>>7|v<<9)&8191),U=i[4]+((v>>>4|A<<12)&8191),N=i[5]+(A>>>1&8191),D=i[6]+((A>>>14|R<<2)&8191),T=i[7]+((R>>>11|k<<5)&8191),I=i[8]+((k>>>8|C<<8)&8191),P=i[9]+(C>>>5|s),L=0,$=L+S*a+B*(5*y)+O*(5*g)+M*(5*m)+U*(5*p);L=$>>>13,$&=8191,$+=N*(5*f)+D*(5*d)+T*(5*h)+I*(5*l)+P*(5*c),L+=$>>>13,$&=8191;let z=L+S*c+B*a+O*(5*y)+M*(5*g)+U*(5*m);L=z>>>13,z&=8191,z+=N*(5*p)+D*(5*f)+T*(5*d)+I*(5*h)+P*(5*l),L+=z>>>13,z&=8191;let q=L+S*l+B*c+O*a+M*(5*y)+U*(5*g);L=q>>>13,q&=8191,q+=N*(5*m)+D*(5*p)+T*(5*f)+I*(5*d)+P*(5*h),L+=q>>>13,q&=8191;let te=L+S*h+B*l+O*c+M*a+U*(5*y);L=te>>>13,te&=8191,te+=N*(5*g)+D*(5*m)+T*(5*p)+I*(5*f)+P*(5*d),L+=te>>>13,te&=8191;let ne=L+S*d+B*h+O*l+M*c+U*a;L=ne>>>13,ne&=8191,ne+=N*(5*y)+D*(5*g)+T*(5*m)+I*(5*p)+P*(5*f),L+=ne>>>13,ne&=8191;let oe=L+S*f+B*d+O*h+M*l+U*c;L=oe>>>13,oe&=8191,oe+=N*a+D*(5*y)+T*(5*g)+I*(5*m)+P*(5*p),L+=oe>>>13,oe&=8191;let ce=L+S*p+B*f+O*d+M*h+U*l;L=ce>>>13,ce&=8191,ce+=N*c+D*a+T*(5*y)+I*(5*g)+P*(5*m),L+=ce>>>13,ce&=8191;let be=L+S*m+B*p+O*f+M*d+U*h;L=be>>>13,be&=8191,be+=N*l+D*c+T*a+I*(5*y)+P*(5*g),L+=be>>>13,be&=8191;let ye=L+S*g+B*m+O*p+M*f+U*d;L=ye>>>13,ye&=8191,ye+=N*h+D*l+T*c+I*a+P*(5*y),L+=ye>>>13,ye&=8191;let Le=L+S*y+B*g+O*m+M*p+U*f;L=Le>>>13,Le&=8191,Le+=N*d+D*h+T*l+I*c+P*a,L+=Le>>>13,Le&=8191,L=(L<<2)+L|0,L=L+$|0,$=L&8191,L=L>>>13,z+=L,i[0]=$,i[1]=z,i[2]=q,i[3]=te,i[4]=ne,i[5]=oe,i[6]=ce,i[7]=be,i[8]=ye,i[9]=Le}finalize(){const{h:t,pad:e}=this,r=new Uint16Array(10);let s=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=s,s=t[a]>>>13,t[a]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,r[0]=t[0]+5,s=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=t[a]+s,s=r[a]>>>13,r[a]&=8191;r[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)r[a]&=i;i=~i;for(let a=0;a<10;a++)t[a]=t[a]&i|r[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let o=t[0]+e[0];t[0]=o&65535;for(let a=1;a<8;a++)o=(t[a]+e[a]|0)+(o>>>16)|0,t[a]=o&65535;to(r)}update(t){V2(this);const{buffer:e,blockLen:r}=this;t=F1(t);const s=t.length;for(let i=0;i<s;){const o=Math.min(r-this.pos,s-i);if(o===r){for(;r<=s-i;i+=r)this.process(t,i);continue}e.set(t.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===r&&(this.process(e,0,!1),this.pos=0)}return this}destroy(){to(this.h,this.r,this.buffer,this.pad)}digestInto(t){V2(this),JA(t,this),this.finished=!0;const{buffer:e,h:r}=this;let{pos:s}=this;if(s){for(e[s++]=1;s<16;s++)e[s]=0;this.process(e,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)t[i++]=r[o]>>>0,t[i++]=r[o]>>>8;return t}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}}function fI(n){const t=(r,s)=>n(s).update(F1(r)).digest(),e=n(new Uint8Array(32));return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=r=>n(r),t}const gI=fI(n=>new dI(n));function pI(n,t,e,r,s,i=20){let o=n[0],a=n[1],c=n[2],l=n[3],h=t[0],d=t[1],f=t[2],p=t[3],m=t[4],g=t[5],y=t[6],w=t[7],_=s,b=e[0],v=e[1],A=e[2],R=o,k=a,C=c,S=l,B=h,O=d,M=f,U=p,N=m,D=g,T=y,I=w,P=_,L=b,$=v,z=A;for(let te=0;te<i;te+=2)R=R+B|0,P=Re(P^R,16),N=N+P|0,B=Re(B^N,12),R=R+B|0,P=Re(P^R,8),N=N+P|0,B=Re(B^N,7),k=k+O|0,L=Re(L^k,16),D=D+L|0,O=Re(O^D,12),k=k+O|0,L=Re(L^k,8),D=D+L|0,O=Re(O^D,7),C=C+M|0,$=Re($^C,16),T=T+$|0,M=Re(M^T,12),C=C+M|0,$=Re($^C,8),T=T+$|0,M=Re(M^T,7),S=S+U|0,z=Re(z^S,16),I=I+z|0,U=Re(U^I,12),S=S+U|0,z=Re(z^S,8),I=I+z|0,U=Re(U^I,7),R=R+O|0,z=Re(z^R,16),T=T+z|0,O=Re(O^T,12),R=R+O|0,z=Re(z^R,8),T=T+z|0,O=Re(O^T,7),k=k+M|0,P=Re(P^k,16),I=I+P|0,M=Re(M^I,12),k=k+M|0,P=Re(P^k,8),I=I+P|0,M=Re(M^I,7),C=C+U|0,L=Re(L^C,16),N=N+L|0,U=Re(U^N,12),C=C+U|0,L=Re(L^C,8),N=N+L|0,U=Re(U^N,7),S=S+B|0,$=Re($^S,16),D=D+$|0,B=Re(B^D,12),S=S+B|0,$=Re($^S,8),D=D+$|0,B=Re(B^D,7);let q=0;r[q++]=o+R|0,r[q++]=a+k|0,r[q++]=c+C|0,r[q++]=l+S|0,r[q++]=h+B|0,r[q++]=d+O|0,r[q++]=f+M|0,r[q++]=p+U|0,r[q++]=m+N|0,r[q++]=g+D|0,r[q++]=y+T|0,r[q++]=w+I|0,r[q++]=_+P|0,r[q++]=b+L|0,r[q++]=v+$|0,r[q++]=A+z|0}const yI=hI(pI,{counterRight:!1,counterLength:4,allowShortKeys:!1}),mI=new Uint8Array(16),z2=(n,t)=>{n.update(t);const e=t.length%16;e&&n.update(mI.subarray(e))},wI=new Uint8Array(32);function q2(n,t,e,r,s){const i=n(t,e,wI),o=gI.create(i);s&&z2(o,s),z2(o,r);const a=new Uint8Array(16),c=eI(a);H2(c,0,BigInt(s?s.length:0),!0),H2(c,8,BigInt(r.length),!0),o.update(a);const l=o.digest();return to(i,a),l}const bI=n=>(t,e,r)=>(Fn(t,32),Fn(e),{encrypt(i,o){const a=i.length,c=a+16;o?Fn(o,c):o=new Uint8Array(c),n(t,e,i,o,1);const l=q2(n,t,e,o.subarray(0,-16),r);return o.set(l,a),to(l),o},decrypt(i,o){const a=i.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Fn(o,c):o=new Uint8Array(c);const l=i.subarray(0,-16),h=i.subarray(-16),d=q2(n,t,e,l,r);if(!sI(h,d))throw new Error("invalid tag");return n(t,e,l,o,1),to(d),o}}),W2=iI({blockSize:64,nonceLength:12,tagLength:16},bI(yI));function EI(n,t,e){return Fl(n),e===void 0&&(e=new Uint8Array(n.outputLen)),Ua(n,$s(e),$s(t))}const Uu=new Uint8Array([0]),G2=new Uint8Array;function _I(n,t,e,r=32){if(Fl(n),bi(r),r>255*n.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/n.outputLen);e===void 0&&(e=G2);const i=new Uint8Array(s*n.outputLen),o=Ua.create(n,t),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let l=0;l<s;l++)Uu[0]=l+1,a.update(l===0?G2:c).update(e).update(Uu).digestInto(c),i.set(c,n.outputLen*l),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),Uu.fill(0),i.slice(0,r)}const vI={hashSHA256(n){return Qo(n.subarray())},getHKDF(n,t){const e=EI(Qo,t,n),s=_I(Qo,e,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const n=rc.utils.randomPrivateKey();return{publicKey:rc.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:rc.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,t){return rc.getSharedSecret(n.subarray(),t.subarray())},chaCha20Poly1305Encrypt(n,t,e,r){return W2(r,t,e).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,t,e,r,s){return W2(r,t,e).decrypt(n.subarray(),s)}},SI=vI;function RI(n){return{generateKeypair:n.generateX25519KeyPair,dh:(t,e)=>n.generateX25519SharedKey(t.privateKey,e).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const sl=n=>{const t=Jt(2);return t[0]=n>>8,t[1]=n,t};sl.bytes=2;const Ic=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let t=0;return t+=n[0]<<8,t+=n[1],t}return n.getUint16(0)};Ic.bytes=2;function AI(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function b7(n,t){!t.enabled||!Ka||(n?(t(`LOCAL_STATIC_PUBLIC_KEY ${W(n.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${W(n.privateKey,"hex")}`)):t("Missing local static keys."))}function E7(n,t){!t.enabled||!Ka||(n?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${W(n.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${W(n.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function II(n,t){!t.enabled||!Ka||t(n?`REMOTE_STATIC_PUBLIC_KEY ${W(n.subarray(),"hex")}`:"Missing remote static public key.")}function _7(n,t){!t.enabled||!Ka||t(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${W(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function v7(n,t,e){!e.enabled||!Ka||(e(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&W(n.k,"hex")}`),e(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&W(t.k,"hex")}`))}function no(n,t){if(n.length!==t.length)throw new Error("Inputs should have the same length");const e=Jt(n.length);for(let r=0;r<n.length;r++)e[r]=n[r]^t[r];return e}const xl=class xl extends Error{constructor(e="Unexpected Peer"){super(e);u(this,"code");this.code=xl.code}};u(xl,"code","ERR_UNEXPECTED_PEER");let K1=xl;const Tl=class Tl extends Error{constructor(e="Invalid crypto exchange"){super(e);u(this,"code");this.code=Tl.code}};u(Tl,"code","ERR_INVALID_CRYPTO_EXCHANGE");let Zo=Tl;const kI=0,xI=4294967295,TI="Cipherstate has reached maximum n, a new handshake must be performed";class DI{constructor(t=kI){u(this,"n");u(this,"bytes");u(this,"view");this.n=t,this.bytes=Pe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>xI)throw new Error(TI)}}const _i=Pe(0);class hc{constructor(t,e=void 0,r=0){u(this,"k");u(this,"n");u(this,"crypto");this.crypto=t,this.k=e,this.n=new DI(r)}hasKey(){return!!this.k}encryptWithAd(t,e){if(!this.hasKey())return e;this.n.assertValue();const r=this.crypto.encrypt(e,this.n.getBytes(),t,this.k);return this.n.increment(),r}decryptWithAd(t,e,r){if(!this.hasKey())return e;this.n.assertValue();const s=this.crypto.decrypt(e,this.n.getBytes(),t,this.k,r);return this.n.increment(),s}}class CI{constructor(t,e){u(this,"cs");u(this,"ck");u(this,"h");u(this,"crypto");this.crypto=t;const r=V(e,"utf-8");this.h=LI(t,r),this.ck=this.h,this.cs=new hc(t)}mixKey(t){const[e,r]=this.crypto.hkdf(this.ck,t);this.ck=e,this.cs=new hc(this.crypto,r)}mixHash(t){this.h=this.crypto.hash(new Ie(this.h,t))}encryptAndHash(t){const e=this.cs.encryptWithAd(this.h,t);return this.mixHash(e),e}decryptAndHash(t){const e=this.cs.decryptWithAd(this.h,t);return this.mixHash(t),e}split(){const[t,e]=this.crypto.hkdf(this.ck,_i);return[new hc(this.crypto,t),new hc(this.crypto,e)]}}class NI{constructor(t){u(this,"ss");u(this,"s");u(this,"e");u(this,"rs");u(this,"re");u(this,"initiator");u(this,"crypto");const{crypto:e,protocolName:r,prologue:s,initiator:i,s:o,e:a,rs:c,re:l}=t;this.crypto=e,this.ss=new CI(e,r),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const t=this.crypto.generateKeypair();return this.ss.mixHash(t.publicKey),this.e=t,t.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(t,e=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(t.byteLength<e+32)throw new Error("message is not long enough");this.re=t.sublist(e,e+32),this.ss.mixHash(this.re)}readS(t,e=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(t.byteLength<e+r)throw new Error("message is not long enough");const s=t.sublist(e,e+r);return this.rs=this.ss.decryptAndHash(s),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class S7 extends NI{writeMessageA(t){return new Ie(this.writeE(),this.ss.encryptAndHash(t))}writeMessageB(t){const e=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Ie(e,r,this.ss.encryptAndHash(t))}writeMessageC(t){const e=this.writeS();return this.writeSE(),new Ie(e,this.ss.encryptAndHash(t))}readMessageA(t){try{return this.readE(t),this.ss.decryptAndHash(t.sublist(32))}catch(e){throw new Zo(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(t){try{this.readE(t),this.readEE();const e=this.readS(t,32);return this.readES(),this.ss.decryptAndHash(t.sublist(32+e))}catch(e){throw new Zo(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(t){try{const e=this.readS(t);return this.readSE(),this.ss.decryptAndHash(t.sublist(e))}catch(e){throw new Zo(`handshake stage 2 validation fail: ${e.message}`)}}}function LI(n,t){if(t.length<=32){const e=Pe(32);return e.set(t),e}else return n.hash(t)}var il;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.webtransportCerthashes!=null)for(const i of e.webtransportCerthashes)r.uint32(10),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={webtransportCerthashes:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.webtransportCerthashes.push(e.bytes());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(il||(il={}));var ol;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.identityKey!=null&&e.identityKey.byteLength>0&&(r.uint32(10),r.bytes(e.identityKey)),e.identitySig!=null&&e.identitySig.byteLength>0&&(r.uint32(18),r.bytes(e.identitySig)),e.extensions!=null&&(r.uint32(34),il.codec().encode(e.extensions,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={identityKey:Pe(0),identitySig:Pe(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.identityKey=e.bytes();break}case 2:{s.identitySig=e.bytes();break}case 4:{s.extensions=il.codec().decode(e,e.uint32());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(ol||(ol={}));async function R7(n,t,e){const r=await n.sign(I7(t));return ol.encode({identityKey:n.public.bytes,identitySig:r,extensions:e})}async function A7(n,t,e){try{const r=ol.decode(n);if(e){const o=e.subarray();if(!ve(o,r.identityKey))throw new Error(`Payload identity key ${W(r.identityKey,"hex")} does not match expected remote identity key ${W(o,"hex")}`)}if(!t)throw new Error("Remote static does not exist");const s=I7(t);if(!await ma(r.identityKey).verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new K1(r.message)}}function I7(n){const t=V("noise-libp2p-static-key:");return n instanceof Uint8Array?gt([t,n],t.length+n.length):(n.prepend(t),n)}async function PI(n,t){const{log:e,connection:r,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=n,h=await R7(i,a.publicKey,l),d=new S7({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});b7(d.s,e),e.trace("Stage 0 - Initiator starting to send first message."),await r.write(d.writeMessageA(_i),t),e.trace("Stage 0 - Initiator finished sending first message."),E7(d.e,e),e.trace("Stage 1 - Initiator waiting to receive first message from responder...");const f=d.readMessageB(await r.read(t));e.trace("Stage 1 - Initiator received the message."),_7(d.re,e),II(d.rs,e),e.trace("Initiator going to check remote's signature...");const p=await A7(f,d.rs,c);e.trace("All good with the signature!"),e.trace("Stage 2 - Initiator sending third handshake message."),await r.write(d.writeMessageC(h),t),e.trace("Stage 2 - Initiator sent message with signed payload.");const[m,g]=d.ss.split();return v7(m,g,e),{payload:p,encrypt:y=>m.encryptWithAd(_i,y),decrypt:(y,w)=>g.decryptWithAd(_i,y,w)}}async function OI(n,t){const{log:e,connection:r,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=n,h=await R7(i,a.publicKey,l),d=new S7({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});b7(d.s,e),e.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await r.read(t)),e.trace("Stage 0 - Responder received first message."),_7(d.re,e),e.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(d.writeMessageB(h),t),e.trace("Stage 1 - Responder sent the second handshake message with signed payload."),E7(d.e,e),e.trace("Stage 2 - Responder waiting for third handshake message...");const f=d.readMessageC(await r.read(t));e.trace("Stage 2 - Responder received the message, finished handshake.");const p=await A7(f,d.rs,c),[m,g]=d.ss.split();return v7(m,g,e),{payload:p,encrypt:y=>g.encryptWithAd(_i,y),decrypt:(y,w)=>m.decryptWithAd(_i,y,w)}}const Y2=16;function BI(n,t){return async function*(e){for await(const r of e)for(let s=0;s<r.length;s+=$2){let i=s+$2;i>r.length&&(i=r.length);let o;r instanceof Uint8Array?o=n.encrypt(r.subarray(s,i)):o=n.encrypt(r.sublist(s,i)),t==null||t.encryptedPackets.increment(),yield new Ie(sl(o.byteLength),o)}}}function MI(n,t){return async function*(e){for await(const r of e)for(let s=0;s<r.length;s+=Ea){let i=s+Ea;if(i>r.length&&(i=r.length),i-Y2<s)throw new Error("Invalid chunk");const o=r.sublist(s,i),a=r.subarray(s,i-Y2);try{const c=n.decrypt(o,a);t==null||t.decryptedPackets.increment(),yield c}catch(c){throw t==null||t.decryptErrors.increment(),c}}}}var d3,f3;f3=Symbol.toStringTag,d3=Bt;class UI{constructor(t,e={}){u(this,"protocol","/noise");u(this,"crypto");u(this,"prologue");u(this,"staticKey");u(this,"extensions");u(this,"metrics");u(this,"components");u(this,f3,"@chainsafe/libp2p-noise");u(this,d3,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:r,extensions:s,crypto:i,prologueBytes:o}=e,{metrics:a}=t;this.components=t;const c=i??SI;this.crypto=RI(c),this.extensions=s,this.metrics=a?AI(a):void 0,r?this.staticKey=c.generateX25519KeyPairFromSeed(r):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Pe(0)}async secureOutbound(...t){const{localPeer:e,connection:r,remotePeer:s,signal:i}=this.parseArgs(t),o=eo(r,{lengthEncoder:sl,lengthDecoder:Ic,maxDataLength:Ea});if(!e.privateKey)throw new E("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const a=await Gi(e.privateKey),c=s==null?void 0:s.publicKey,l=await this.performHandshakeInitiator(o,a,c,{signal:i}),h=await this.createSecureConnection(o,l);return r.source=h.source,r.sink=h.sink,{conn:r,remoteExtensions:l.payload.extensions,remotePeer:await Gn(l.payload.identityKey)}}async secureInbound(...t){const{localPeer:e,connection:r,remotePeer:s,signal:i}=this.parseArgs(t),o=eo(r,{lengthEncoder:sl,lengthDecoder:Ic,maxDataLength:Ea});if(!e.privateKey)throw new E("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const a=await Gi(e.privateKey),c=s==null?void 0:s.publicKey,l=await this.performHandshakeResponder(o,a,c,{signal:i}),h=await this.createSecureConnection(o,l);return r.source=h.source,r.sink=h.sink,{conn:r,remoteExtensions:l.payload.extensions,remotePeer:await Gn(l.payload.identityKey)}}async performHandshakeInitiator(t,e,r,s){var o,a;let i;try{i=await PI({connection:t,privateKey:e,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return i}async performHandshakeResponder(t,e,r,s){var o,a;let i;try{i=await OI({connection:t,privateKey:e,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return i}async createSecureConnection(t,e){const[r,s]=jA(),i=t.unwrap();return await vt(r,BI(e,this.metrics),i,o=>ts(o,{lengthDecoder:Ic}),MI(e,this.metrics),r),s}parseArgs(t){var e,r;return Bl(t[0])?{localPeer:t[0],connection:t[1],remotePeer:t[2]}:{localPeer:this.components.peerId,connection:t[0],remotePeer:(e=t[1])==null?void 0:e.remotePeer,signal:(r=t[1])==null?void 0:r.signal}}}function Nd(n={}){return t=>new UI(t,n)}function k7(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}const Vo="ERR_INVALID_FRAME",x7="ERR_UNREQUESTED_PING",T7="ERR_NOT_MATCHING_PING",D7="ERR_STREAM_ALREADY_EXISTS",C7="ERR_DECODE_INVALID_VERSION",N7="ERR_BOTH_CLIENTS",L7="ERR_RECV_WINDOW_EXCEEDED",$I=new Set([Vo,x7,T7,D7,C7,N7,L7]),gs="ERR_INVALID_CONFIG",$u="ERR_MUXER_LOCAL_CLOSED",Q2="ERR_MUXER_REMOTE_CLOSED",FI="ERR_STREAM_ABORT",VI="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",HI="ERR_DECODE_IN_PROGRESS",Ld=256*1024,KI=16*1024*1024,zI={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Ld,maxStreamWindowSize:KI,maxMessageSize:64*1024};function qI(n){if(n.keepAliveInterval<=0)throw new E("keep-alive interval must be positive",gs);if(n.maxInboundStreams<0)throw new E("max inbound streams must be larger or equal 0",gs);if(n.maxOutboundStreams<0)throw new E("max outbound streams must be larger or equal 0",gs);if(n.initialStreamWindowSize<Ld)throw new E("InitialStreamWindowSize must be larger or equal 256 kB",gs);if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new E("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",gs);if(n.maxStreamWindowSize>2**32-1)throw new E("MaxStreamWindowSize must be less than equal MAX_UINT32",gs);if(n.maxMessageSize<1024)throw new E("MaxMessageSize must be greater than a kilobyte",gs)}var at;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(at||(at={}));var Xe;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(Xe||(Xe={}));Object.values(Xe).filter(n=>typeof n!="string");const WI=0;var Ln;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(Ln||(Ln={}));const jo=12,X2=2**24;function GI(n){if(n[0]!==WI)throw new E("Invalid frame version",C7);return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*X2+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*X2+(n[9]<<16)+(n[10]<<8)+n[11]}}let YI=class{constructor(t){u(this,"source");u(this,"buffer");u(this,"frameInProgress");this.source=QI(t),this.buffer=new Ie,this.frameInProgress=!1}async*emitFrames(){for await(const t of this.source)for(this.buffer.append(t);;){const e=this.readHeader();if(e===void 0)break;const{type:r,length:s}=e;r===at.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,s)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new E("decoding frame already in progress",HI);if(this.buffer.length<jo)return;const t=GI(this.buffer.subarray(0,jo));return this.buffer.consume(jo),t}async readBytes(t){if(this.buffer.length<t){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=t)break}const e=this.buffer.sublist(0,t);return this.buffer.consume(t),this.frameInProgress=!1,e}};function QI(n){if(n[Symbol.iterator]!==void 0){const t=n[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator](){return t}}}else if(n[Symbol.asyncIterator]!==void 0){const t=n[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator](){return t}}}else throw new Error("a source must be either an iterable or an async iterable")}function Z2(n){const t=new Uint8Array(jo);return t[1]=n.type,t[2]=n.flag>>>8,t[3]=n.flag,t[4]=n.streamID>>>24,t[5]=n.streamID>>>16,t[6]=n.streamID>>>8,t[7]=n.streamID,t[8]=n.length>>>24,t[9]=n.length>>>16,t[10]=n.length>>>8,t[11]=n.length,t}function XI(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function P7(n,t){var r,s;const e=(s=(r=k7(n)).return)==null?void 0:s.call(r);XI(e)&&e.catch(i=>{t.error("could not cause iterator to return",i)})}const ZI="ERR_STREAM_RESET",jI="ERR_SINK_INVALID_STATE",JI=5e3;function Fu(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class nu{constructor(t){u(this,"id");u(this,"direction");u(this,"timeline");u(this,"protocol");u(this,"metadata");u(this,"source");u(this,"status");u(this,"readStatus");u(this,"writeStatus");u(this,"log");u(this,"sinkController");u(this,"sinkEnd");u(this,"closed");u(this,"endErr");u(this,"streamSource");u(this,"onEnd");u(this,"onCloseRead");u(this,"onCloseWrite");u(this,"onReset");u(this,"onAbort");u(this,"sendCloseWriteTimeout");u(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=pe(),this.closed=pe(),this.log=t.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=t.id,this.metadata=t.metadata??{},this.direction=t.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=t.sendCloseWriteTimeout??JI,this.onEnd=t.onEnd,this.onCloseRead=t==null?void 0:t.onCloseRead,this.onCloseWrite=t==null?void 0:t.onCloseWrite,this.onReset=t==null?void 0:t.onReset,this.onAbort=t==null?void 0:t.onAbort,this.source=this.streamSource=ls({onEnd:e=>{e!=null?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(t){if(this.writeStatus!=="ready")throw new E(`writable end state is "${this.writeStatus}" not "ready"`,jI);try{this.writeStatus="writing";const e={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(e);Fu(s)&&await s}const r=()=>{P7(t,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let s of t){s=s instanceof Uint8Array?new Ie(s):s;const i=this.sendData(s,e);Fu(i)&&(this.sendingData=pe(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(t){var e;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),(e=this.onCloseRead)==null||e.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(t){var e;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),(e=this.onCloseWrite)==null||e.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(t){this.log.trace("closing gracefully"),this.status="closing",await dt(Promise.all([this.closeWrite(t),this.closeRead(t),this.closed.promise]),t==null?void 0:t.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(t={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const e=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(t)),e==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(t={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await dt(this.sink([]),t.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await dt(this.sendingData.promise,t.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await dt(this.sinkEnd.promise,t.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(t){var r;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",t),this.log("try to send reset to remote");const e=this.sendReset();Fu(e)&&e.catch(s=>{this.log.error("error sending reset message",s)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(t),(r=this.onAbort)==null||r.call(this,t)}reset(){var e;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const t=new E("stream reset",ZI);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(t),(e=this.onReset)==null||e.call(this)}_closeSinkAndSource(t){this._closeSink(t),this._closeSource(t)}_closeSink(t){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(t)}_closeSource(t){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(t))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(t){this.streamSource.push(t)}sourceReadableLength(){return this.streamSource.readableLength}}var bn;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(bn||(bn={}));class ek extends nu{constructor(e){super({...e,onEnd:r=>{var s;this.state=bn.Finished,(s=e.onEnd)==null||s.call(e,r)}});u(this,"name");u(this,"state");u(this,"config");u(this,"_id");u(this,"sendWindowCapacity");u(this,"sendWindowCapacityUpdate");u(this,"recvWindow");u(this,"recvWindowCapacity");u(this,"epochStart");u(this,"getRTT");u(this,"sendFrame");this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Ld,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=N1(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,r={}){var s,i;for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&((s=this.log)==null||s.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(i=this.log)==null||i.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-jo,e.length),a=this.getSendFlags();this.sendFrame({type:at.Data,flag:a,streamID:this._id,length:o},e.sublist(0,o)),this.sendWindowCapacity-=o,e.consume(o)}}async sendReset(){this.sendFrame({type:at.WindowUpdate,flag:Xe.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Xe.FIN;this.sendFrame({type:at.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){var o,a;if(this.sendWindowCapacity>0)return;let r,s;const i=()=>{this.status==="open"||this.status==="closing"?s(new E("stream aborted",FI)):r()};(o=e.signal)==null||o.addEventListener("abort",i);try{await new Promise((c,l)=>{this.sendWindowCapacityUpdate=()=>{c()},s=l,r=c})}finally{(a=e.signal)==null||a.removeEventListener("abort",i)}}handleWindowUpdate(e){var s,i;(s=this.log)==null||s.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,r===0&&e.length>0&&((i=this.sendWindowCapacityUpdate)==null||i.call(this))}async handleData(e,r){var i;if((i=this.log)==null||i.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new E("receive window exceeded",L7,{available:this.recvWindowCapacity,recv:e.length});const s=await r();this.recvWindowCapacity-=e.length,this.sourcePush(s)}processFlags(e){(e&Xe.ACK)===Xe.ACK&&this.state===bn.SYNSent&&(this.state=bn.Established),(e&Xe.FIN)===Xe.FIN&&this.remoteCloseWrite(),(e&Xe.RST)===Xe.RST&&this.reset()}getSendFlags(){switch(this.state){case bn.Init:return this.state=bn.SYNSent,Xe.SYN;case bn.SYNReceived:return this.state=bn.Established,Xe.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),r=Date.now(),s=this.getRTT();if(e===0&&s>-1&&r-this.epochStart<s*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:at.WindowUpdate,flag:e,streamID:this._id,length:i})}}const O7="/yamux/1.0.0",tk=500;class nk{constructor(t,e={}){u(this,"protocol",O7);u(this,"_components");u(this,"_init");this._components=t,this._init=e}createStreamMuxer(t){return new rk(this._components,{...this._init,...t})}}class rk{constructor(t,e){u(this,"protocol",O7);u(this,"source");u(this,"sink");u(this,"config");u(this,"log");u(this,"logger");u(this,"closeController");u(this,"nextStreamID");u(this,"_streams");u(this,"nextPingID");u(this,"activePing");u(this,"rtt");u(this,"client");u(this,"localGoAway");u(this,"remoteGoAway");u(this,"numInboundStreams");u(this,"numOutboundStreams");u(this,"onIncomingStream");u(this,"onStreamEnd");var r;this.client=e.direction==="outbound",this.config={...zI,...e},this.logger=t.logger,this.log=this.logger.forComponent("libp2p:yamux"),qI(this.config),this.closeController=new AbortController,j(1/0,this.closeController.signal),this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=ls({onEnd:()=>{var s;(s=this.log)==null||s.trace("muxer source ended"),this._streams.forEach(i=>{i.destroy()})}}),this.sink=async s=>{var c,l,h;const i=()=>{const d=k7(s);if(d.return!=null){const f=d.return();sk(f)&&f.catch(p=>{var m;(m=this.log)==null||m.call(this,"could not cause sink source to return",p)})}};let o,a;try{const d=new YI(s);try{this.closeController.signal.addEventListener("abort",i);for await(const f of d.emitFrames())await this.handleFrame(f.header,f.readData)}finally{this.closeController.signal.removeEventListener("abort",i)}o=Ln.NormalTermination}catch(d){const f=d.code;$I.has(f)?((c=this.log)==null||c.error("protocol error in sink",d),o=Ln.ProtocolError):((l=this.log)==null||l.error("internal error in sink",d),o=Ln.InternalError),a=d}(h=this.log)==null||h.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(r=this.log)==null||r.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("keepalive error: %s",s)}),this.ping().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("ping error: %s",s)})}get streams(){return Array.from(this._streams.values())}newStream(t){var s;if(this.remoteGoAway!==void 0)throw new E("muxer closed remotely",Q2);if(this.localGoAway!==void 0)throw new E("muxer closed locally",$u);const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new E("max outbound streams exceeded",VI);(s=this.log)==null||s.trace("new outgoing stream id=%s",e);const r=this._newStream(e,t,bn.Init,"outbound");return this._streams.set(e,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new E("muxer closed remotely",Q2);if(this.localGoAway!==void 0)throw new E("muxer closed locally",$u);if(this.activePing===void 0){let t=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new E("muxer closed locally",$u))};this.closeController.signal.addEventListener("abort",o,{once:!0}),t=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:t};const e=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-e}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(t={}){var r;if(this.closeController.signal.aborted)return;const e=(t==null?void 0:t.reason)??Ln.NormalTermination;if((r=this.log)==null||r.trace("muxer close reason=%s",e),t.signal==null){const s=AbortSignal.timeout(tk);j(1/0,s),t={...t,signal:s}}try{await Promise.all([...this._streams.values()].map(async s=>s.close(t))),this.sendGoAway(e),this._closeMuxer()}catch(s){this.abort(s)}}abort(t,e){var r;if(!this.closeController.signal.aborted){e=e??Ln.InternalError,(r=this.log)==null||r.error("muxer abort reason=%s error=%s",e,t);for(const s of this._streams.values())s.abort(t);this.sendGoAway(e),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(t,e,r,s){if(this._streams.get(t)!=null)throw new E("Stream already exists",D7,{id:t});const i=new ek({id:t.toString(),name:e,state:r,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(t),(o=this.onStreamEnd)==null||o.call(this,i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${t}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(t){this.client===(t%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(t)}async keepAliveLoop(){var e;const t=new Promise((r,s)=>{this.closeController.signal.addEventListener("abort",s,{once:!0})});for((e=this.log)==null||e.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let r;try{await Promise.race([t,new Promise(s=>{r=setTimeout(s,this.config.keepAliveInterval)})]),this.ping().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("ping error: %s",s)})}catch{clearInterval(r);return}}}async handleFrame(t,e){var o;const{streamID:r,type:s,length:i}=t;if((o=this.log)==null||o.trace("received frame %o",t),r===0)switch(s){case at.Ping:{this.handlePing(t);return}case at.GoAway:{this.handleGoAway(i);return}default:throw new E("Invalid frame type",Vo,{header:t})}else switch(t.type){case at.Data:case at.WindowUpdate:{await this.handleStreamMessage(t,e);return}default:throw new E("Invalid frame type",Vo,{header:t})}}handlePing(t){var e,r;if(t.flag===Xe.SYN)(e=this.log)==null||e.trace("received ping request pingId=%s",t.length),this.sendPing(t.length,Xe.ACK);else if(t.flag===Xe.ACK)(r=this.log)==null||r.trace("received ping response pingId=%s",t.length),this.handlePingResponse(t.length);else throw new E("Invalid frame flag",Vo,{header:t})}handlePingResponse(t){if(this.activePing===void 0)throw new E("ping not requested",x7);if(this.activePing.id!==t)throw new E("ping doesn't match our id",T7);this.activePing.resolve()}handleGoAway(t){var e;(e=this.log)==null||e.trace("received GoAway reason=%s",Ln[t]??"unknown"),this.remoteGoAway=t;for(const r of this._streams.values())r.reset();this._closeMuxer()}async handleStreamMessage(t,e){var a,c;const{streamID:r,flag:s,type:i}=t;(s&Xe.SYN)===Xe.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(i===at.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",r),e===void 0)throw new Error("unreachable");await e()}else(c=this.log)==null||c.call(this,"frame for missing stream id=%s",r);return}switch(i){case at.WindowUpdate:{o.handleWindowUpdate(t);return}case at.Data:{if(e===void 0)throw new Error("unreachable");await o.handleData(t,e);return}default:throw new Error("unreachable")}}incomingStream(t){var r,s,i;if(this.client!==(t%2===0))throw new E("both endpoints are clients",N7);if(this._streams.has(t))return;if((r=this.log)==null||r.trace("new incoming stream id=%s",t),this.localGoAway!==void 0){this.sendFrame({type:at.WindowUpdate,flag:Xe.RST,streamID:t,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(s=this.log)==null||s.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:at.WindowUpdate,flag:Xe.RST,streamID:t,length:0});return}const e=this._newStream(t,void 0,bn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(t,e),(i=this.onIncomingStream)==null||i.call(this,e)}sendFrame(t,e){var r;if((r=this.log)==null||r.trace("sending frame %o",t),t.type===at.Data){if(e===void 0)throw new E("invalid frame",Vo);this.source.push(new Ie(Z2(t),e))}else this.source.push(Z2(t))}sendPing(t,e=Xe.SYN){var r,s;e===Xe.SYN?(r=this.log)==null||r.trace("sending ping request pingId=%s",t):(s=this.log)==null||s.trace("sending ping response pingId=%s",t),this.sendFrame({type:at.Ping,flag:e,streamID:0,length:t})}sendGoAway(t=Ln.NormalTermination){var e;(e=this.log)==null||e.call(this,"sending GoAway reason=%s",Ln[t]),this.localGoAway=t,this.sendFrame({type:at.GoAway,flag:0,streamID:0,length:t})}}function sk(n){return n!=null&&typeof n.then=="function"}function ik(n={}){return t=>new nk(t,n)}const dc=globalThis.CustomEvent??Event;async function*hs(n,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);const r=t.ordered==null?!1:t.ordered,s=new EventTarget,i=[];let o=pe(),a=pe(),c=!1,l,h=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const m of n){if(i.length===e&&(o=pe(),await o.promise),h)break;const g={done:!1};i.push(g),m().then(y=>{g.done=!0,g.ok=!0,g.value=y,s.dispatchEvent(new dc("task-complete"))},y=>{g.done=!0,g.err=y,s.dispatchEvent(new dc("task-complete"))})}c=!0,s.dispatchEvent(new dc("task-complete"))}catch(m){l=m,s.dispatchEvent(new dc("task-complete"))}});function d(){var m;return r?(m=i[0])==null?void 0:m.done:!!i.find(g=>g.done)}function*f(){for(;i.length>0&&i[0].done;){const m=i[0];if(i.shift(),m.ok)yield m.value;else throw h=!0,o.resolve(),m.err;o.resolve()}}function*p(){for(;d();)for(let m=0;m<i.length;m++)if(i[m].done){const g=i[m];if(i.splice(m,1),m--,g.ok)yield g.value;else throw h=!0,o.resolve(),g.err;o.resolve()}}for(;;){if(d()||(a=pe(),await a.promise),l!=null)throw l;if(r?yield*f():yield*p(),c&&i.length===0)break}}const ok="libp2p",ak="autonat",ck="1.0.0",lk=3e4,uk=5e3,hk=6e4,dk=1,fk=1;var Ee;(function(n){(function(s){s.DIAL="DIAL",s.DIAL_RESPONSE="DIAL_RESPONSE"})(n.MessageType||(n.MessageType={}));let t;(function(s){s[s.DIAL=0]="DIAL",s[s.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(s){s.codec=()=>Mt(t)}(n.MessageType||(n.MessageType={})),function(s){s.OK="OK",s.E_DIAL_ERROR="E_DIAL_ERROR",s.E_DIAL_REFUSED="E_DIAL_REFUSED",s.E_BAD_REQUEST="E_BAD_REQUEST",s.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(n.ResponseStatus||(n.ResponseStatus={}));let e;(function(s){s[s.OK=0]="OK",s[s.E_DIAL_ERROR=100]="E_DIAL_ERROR",s[s.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",s[s.E_BAD_REQUEST=200]="E_BAD_REQUEST",s[s.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(e||(e={})),function(s){s.codec=()=>Mt(e)}(n.ResponseStatus||(n.ResponseStatus={})),function(s){let i;s.codec=()=>(i==null&&(i=de((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={addrs:[]},l=a==null?o.len:o.pos+a;for(;o.pos<l;){const h=o.uint32();switch(h>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;default:o.skipType(h&7);break}}return c})),i),s.encode=o=>he(o,s.codec()),s.decode=o=>ue(o,s.codec())}(n.PeerInfo||(n.PeerInfo={})),function(s){let i;s.codec=()=>(i==null&&(i=de((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),n.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={},l=a==null?o.len:o.pos+a;for(;o.pos<l;){const h=o.uint32();switch(h>>>3){case 1:c.peer=n.PeerInfo.codec().decode(o,o.uint32());break;default:o.skipType(h&7);break}}return c})),i),s.encode=o=>he(o,s.codec()),s.decode=o=>ue(o,s.codec())}(n.Dial||(n.Dial={})),function(s){let i;s.codec=()=>(i==null&&(i=de((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),n.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={},l=a==null?o.len:o.pos+a;for(;o.pos<l;){const h=o.uint32();switch(h>>>3){case 1:c.status=n.ResponseStatus.codec().decode(o);break;case 2:c.statusText=o.string();break;case 3:c.addr=o.bytes();break;default:o.skipType(h&7);break}}return c})),i),s.encode=o=>he(o,s.codec()),s.decode=o=>ue(o,s.codec())}(n.DialResponse||(n.DialResponse={}));let r;n.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),n.MessageType.codec().encode(s.type,i)),s.dial!=null&&(i.uint32(18),n.Dial.codec().encode(s.dial,i)),s.dialResponse!=null&&(i.uint32(26),n.DialResponse.codec().encode(s.dialResponse,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=n.MessageType.codec().decode(s);break;case 2:o.dial=n.Dial.codec().decode(s,s.uint32());break;case 3:o.dialResponse=n.DialResponse.codec().decode(s,s.uint32());break;default:s.skipType(c&7);break}}return o})),r),n.encode=s=>he(s,n.codec()),n.decode=s=>ue(s,n.codec())})(Ee||(Ee={}));const Vu=4;var g3;g3=Symbol.toStringTag;class gk{constructor(t,e){u(this,"components");u(this,"startupDelay");u(this,"refreshInterval");u(this,"protocol");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"verifyAddressTimeout");u(this,"started");u(this,"log");u(this,g3,"@libp2p/autonat");this.components=t,this.log=t.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${e.protocolPrefix??ok}/${ak}/${ck}`,this.timeout=e.timeout??lk,this.maxInboundStreams=e.maxInboundStreams??dk,this.maxOutboundStreams=e.maxOutboundStreams??fk,this.startupDelay=e.startupDelay??uk,this.refreshInterval=e.refreshInterval??hk,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,t=>{this.handleIncomingAutonatStream(t).catch(e=>{this.log.error("error handling incoming autonat stream",e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(t){const e=AbortSignal.timeout(this.timeout),r=()=>{t.stream.abort(new E("handleIncomingAutonatStream timeout",Mi))};e.addEventListener("abort",r,{once:!0}),j(1/0,e);try{const s=this;await vt(t.stream,i=>ts(i),async function*(i){const o=await Ji(i);if(o==null){s.log("no message received"),yield Ee.encode({type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});return}let a;try{a=Ee.decode(o)}catch(c){s.log.error("could not decode message",c),yield Ee.encode({type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});return}yield Ee.encode(await s.handleAutonatMessage(a,t.connection,{signal:e}))},i=>es(i),t.stream)}catch(s){this.log.error("error handling incoming autonat stream",s)}finally{e.removeEventListener("abort",r)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(t=>{this.log.error("error verifying external address",t)})}async handleAutonatMessage(t,e,r){const s=this.components.addressManager.getAddresses().map(d=>d.toOptions().host),i=t.dial;if(i==null)return this.log.error("dial was missing from message"),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=i.peer;if((a==null?void 0:a.id)==null)return this.log.error("PeerId missing from message"),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{o=Rn(a.id)}catch(d){return this.log.error("invalid PeerId",d),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!e.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,e.remotePeer),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(d=>le(d)).filter(d=>{const f=d.toOptions().host===e.remoteAddr.toOptions().host;return this.log.trace("request to dial %a was sent from %a is same host %s",d,e.remoteAddr,f),f}).filter(d=>{const f=d.toOptions().host,p=!(rs(f)??!1);return this.log.trace("host %s was public %s",f,p),p}).filter(d=>{const f=d.toOptions().host,p=!s.includes(f);return this.log.trace("host %s was not our host %s",f,p),p}).filter(d=>{const f=!!this.components.transportManager.dialTransportForMultiaddr(d);return this.log.trace("transport for %a is supported %s",d,f),f}).map(d=>(d.getPeerId()==null&&(d=d.encapsulate(`/p2p/${o.toString()}`)),d));if(c.length===0)return this.log("no valid multiaddrs for %p in message",o),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(d=>d.toString()).join(", "),o);let l="",h=c[0];for await(const d of c){let f;h=d;try{if(f=await this.components.connectionManager.openConnection(d,r),!f.remoteAddr.equals(d))throw this.log.error("tried to dial %a but dialed %a",d,f.remoteAddr),new Error("Unexpected remote address");return this.log("Success %p",o),{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.OK,addr:f.remoteAddr.decapsulateCode(se("p2p").code).bytes}}}catch(p){this.log("could not dial %p",o,p),l=p.message}finally{f!=null&&await f.close()}}return{type:Ee.MessageType.DIAL_RESPONSE,dialResponse:{status:Ee.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:h.bytes}}}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;const t=this.components.addressManager,e=t.getObservedAddrs().filter(i=>{const o=i.toOptions();return!(rs(o.host)??!1)});if(e.length===0){this.log("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval);return}const r=AbortSignal.timeout(this.timeout);j(1/0,r);const s=this;try{this.log("verify multiaddrs %s",e.map(l=>l.toString()).join(", "));const i=Ee.encode({type:Ee.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:e.map(l=>l.bytes)}}}),o={},a=[],c=async l=>{let h=()=>{};try{this.log("asking %p to verify multiaddr",l.id);const d=await s.components.connectionManager.openConnection(l.id,{signal:r}),f=await d.newStream(this.protocol,{signal:r});h=()=>{f.abort(new E("verifyAddress timeout",Mi))},r.addEventListener("abort",h,{once:!0});const p=await vt([i],g=>es(g),f,g=>ts(g),async g=>Ji(g));if(p==null){this.log("no response received from %p",d.remotePeer);return}const m=Ee.decode(p);if(m.type!==Ee.MessageType.DIAL_RESPONSE||m.dialResponse==null){this.log("invalid autonat response from %p",d.remotePeer);return}if(m.dialResponse.status===Ee.ResponseStatus.OK){const g=d.remoteAddr.toOptions();let y;if(g.family===4)y=g.host.split(".")[0];else if(g.family===6)y=g.host.split(":")[0];else{this.log('remote address "%s" was not IP4 or IP6?',g.host);return}if(a.includes(y)){this.log("already have response from network segment %d - %s",y,g.host);return}a.push(y)}return m.dialResponse}catch(d){this.log.error("error asking remote to verify multiaddr",d)}finally{r.removeEventListener("abort",h)}};for await(const l of hs(vr(this.components.randomWalk.walk({signal:r}),h=>async()=>c(h)),{concurrency:Vu}))try{if(l==null)continue;const h=l.addr==null?e[0]:le(l.addr);if(this.log("autonat response for %a is %s",h,l.status),l.status===Ee.ResponseStatus.E_BAD_REQUEST||l.status===Ee.ResponseStatus.E_DIAL_REFUSED||l.addr==null&&e.length>1)continue;if(!e.some(f=>f.equals(h))){this.log("peer reported %a as %s but it was not in our observed address list",h,l.status);continue}const d=h.toString();if(o[d]==null&&(o[d]={success:0,failure:0}),l.status===Ee.ResponseStatus.OK?o[d].success++:l.status===Ee.ResponseStatus.E_DIAL_ERROR&&o[d].failure++,o[d].success===Vu){this.log("%a is externally dialable",h),t.confirmObservedAddr(h);return}if(o[d].failure===Vu){this.log("%a is not externally dialable",h),t.removeObservedAddr(h);return}}catch(h){this.log.error("could not verify external address",h)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}}function pk(n={}){return t=>new gk(t,n)}const yk=Z("dns4"),mk=Z("dns6"),wk=Z("dnsaddr"),Ws=pt(Z("dns"),wk,yk,mk),ru=pt(Z("ip4"),Z("ip6")),ro=pt(ie(ru,Z("tcp")),ie(Ws,Z("tcp"))),su=ie(ru,Z("udp")),bk=ie(su,Z("utp")),Ek=ie(su,Z("quic")),_k=ie(su,Z("quic-v1")),z1=pt(ie(ro,Z("ws")),ie(Ws,Z("ws"))),q1=pt(ie(z1,Z("p2p")),z1),W1=pt(ie(ro,Z("wss")),ie(Ws,Z("wss")),ie(ro,Z("tls"),Z("ws")),ie(Ws,Z("tls"),Z("ws"))),al=pt(ie(W1,Z("p2p")),W1),G1=pt(ie(ro,Z("http")),ie(ru,Z("http")),ie(Ws,Z("http"))),Y1=pt(ie(ro,Z("https")),ie(ru,Z("https")),ie(Ws,Z("https"))),j2=ie(su,Z("webrtc-direct"),Z("certhash")),B7=pt(ie(j2,Z("p2p")),j2),J2=ie(_k,Z("webtransport"),Z("certhash"),Z("certhash")),M7=pt(ie(J2,Z("p2p")),J2),U7=pt(ie(q1,Z("p2p-webrtc-star"),Z("p2p")),ie(al,Z("p2p-webrtc-star"),Z("p2p")),ie(q1,Z("p2p-webrtc-star")),ie(al,Z("p2p-webrtc-star"))),$7=pt(ie(G1,Z("p2p-webrtc-direct"),Z("p2p")),ie(Y1,Z("p2p-webrtc-direct"),Z("p2p")),ie(G1,Z("p2p-webrtc-direct")),ie(Y1,Z("p2p-webrtc-direct"))),Q1=pt(z1,W1,G1,Y1,U7,$7,ro,bk,Ek,Ws,B7,M7),Wr=pt(ie(Q1,Z("p2p")),U7,$7,B7,M7,Z("p2p")),e0=pt(ie(Wr,Z("p2p-circuit"),Wr),ie(Wr,Z("p2p-circuit")),ie(Z("p2p-circuit"),Wr),ie(Q1,Z("p2p-circuit")),ie(Z("p2p-circuit"),Q1),Z("p2p-circuit")),F7=()=>pt(ie(e0,F7),e0),Rs=F7(),vk=pt(ie(Rs,Wr,Rs),ie(Wr,Rs),ie(Rs,Wr),Rs,Wr);function V7(n){function t(e){let r;try{r=le(e)}catch{return!1}const s=n(r.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return t}function ie(...n){function t(e){if(e.length<n.length)return null;let r=e;return n.some(s=>(r=typeof s=="function"?s().partialMatch(e):s.partialMatch(e),Array.isArray(r)&&(e=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:V7(t),partialMatch:t}}function pt(...n){function t(r){let s=null;return n.some(i=>{const o=typeof i=="function"?i().partialMatch(r):i.partialMatch(r);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:V7(t),partialMatch:t}}function Z(n){const t=n;function e(s){let i;try{i=le(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===t}function r(s){return s.length===0?null:s[0]===t?s.slice(1):null}return{toString:function(){return t},matches:e,partialMatch:r}}const Sk="bootstrap",Rk=50,Ak=12e4,Ik=1e3;var p3,y3,m3,w3;class H7 extends(w3=_t,m3=zc,y3=Symbol.toStringTag,p3=Bt,w3){constructor(e,r={list:[]}){if(r.list==null||r.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();u(this,"log");u(this,"timer");u(this,"list");u(this,"timeout");u(this,"components");u(this,"_init");u(this,m3,this);u(this,y3,"@libp2p/bootstrap");u(this,p3,["@libp2p/peer-discovery"]);this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=r.timeout??Ik,this.list=[];for(const s of r.list){if(!vk.matches(s)){this.log.error("Invalid multiaddr");continue}const i=le(s),o=i.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:Je(o),multiaddrs:[i]};this.list.push(a)}this._init=r}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??Sk]:{value:this._init.tagValue??Rk,ttl:this._init.tagTTL??Ak}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}u(H7,"tag","bootstrap");function kk(n){return t=>new H7(t,n)}const xk={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var cl;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(r.uint32(26),r.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.publicKey=e.bytes();break;case 2:s.payloadType=e.bytes();break;case 3:s.payload=e.bytes();break;case 5:s.signature=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(cl||(cl={}));const Ur=class Ur{constructor(t){u(this,"peerId");u(this,"payloadType");u(this,"payload");u(this,"signature");u(this,"marshaled");const{peerId:e,payloadType:r,payload:s,signature:i}=t;this.peerId=e,this.payloadType=r,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=cl.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return ve(this.marshal(),t.marshal())}async validate(t){const e=t0(t,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return ma(this.peerId.publicKey).verify(e.subarray(),this.signature)}};u(Ur,"createFromProtobuf",async t=>{const e=cl.decode(t),r=await Gn(e.publicKey);return new Ur({peerId:r,payloadType:e.payloadType,payload:e.payload,signature:e.signature})}),u(Ur,"seal",async(t,e)=>{if(e.privateKey==null)throw new Error("Missing private key");const r=t.domain,s=t.codec,i=t.marshal(),o=t0(r,s,i),c=await(await Gi(e.privateKey)).sign(o.subarray());return new Ur({peerId:e,payloadType:s,payload:i,signature:c})}),u(Ur,"openAndCertify",async(t,e)=>{const r=await Ur.createFromProtobuf(t);if(!await r.validate(e))throw new E("envelope signature is not valid for the given domain",xk.ERR_SIGNATURE_NOT_VALID);return r});let ss=Ur;const t0=(n,t,e)=>{const r=V(n),s=Ot(r.byteLength),i=Ot(t.length),o=Ot(e.length);return new Ie(s,r,i,t,o,e)};function Tk(n,t){const e=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==t.length?!1:(t.sort(e),n.sort(e).every((r,s)=>t[s].equals(r)))}const Dk="libp2p-peer-record",Ck=Uint8Array.from([3,1]);var ll;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={multiaddr:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.multiaddr=s.bytes();break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())})(n.AddressInfo||(n.AddressInfo={}));let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.peerId!=null&&e.peerId.byteLength>0&&(r.uint32(10),r.bytes(e.peerId)),e.seq!=null&&e.seq!==0n&&(r.uint32(16),r.uint64(e.seq)),e.addresses!=null)for(const i of e.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.peerId=e.bytes();break;case 2:s.seq=e.uint64();break;case 3:s.addresses.push(n.AddressInfo.codec().decode(e,e.uint32()));break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(ll||(ll={}));const ir=class ir{constructor(t){u(this,"peerId");u(this,"multiaddrs");u(this,"seqNumber");u(this,"domain",ir.DOMAIN);u(this,"codec",ir.CODEC);u(this,"marshaled");const{peerId:e,multiaddrs:r,seqNumber:s}=t;this.peerId=e,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=ll.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof ir)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!Tk(this.multiaddrs,t.multiaddrs))}};u(ir,"createFromProtobuf",t=>{const e=ll.decode(t),r=Rn(e.peerId),s=(e.addresses??[]).map(o=>le(o.multiaddr)),i=e.seq;return new ir({peerId:r,multiaddrs:s,seqNumber:i})}),u(ir,"DOMAIN",Dk),u(ir,"CODEC",Ck);let zn=ir;function Gt(n,t){const e=eo(n,t),r={read:async(s,i)=>{const o=await e.read(i);return s.decode(o)},write:async(s,i,o)=>{await e.write(i.encode(s),o)},writeV:async(s,i,o)=>{await e.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>r.read(s,i),write:async(i,o)=>r.write(i,s,o),writeV:async(i,o)=>r.writeV(i,s,o),unwrap:()=>r}),unwrap:()=>e.unwrap()};return r}const Nk=290,Lk=1,Pk=1e3,Ok=100,Bk="circuit-relay-relay";BigInt(1<<17);const ul="/libp2p/circuit/relay/0.2.0/hop",n0="/libp2p/circuit/relay/0.2.0/stop",r0=300,s0="ERR_RELAYED_DIAL",Mk="ERR_HOP_REQUEST_FAILED",Uk=4096,$k=.001;var so;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),io.codec().encode(r.peer,s)),r.reservation!=null&&(s.uint32(26),hl.codec().encode(r.reservation,s)),r.limit!=null&&(s.uint32(34),oo.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(40),Pt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{var c,l,h;const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const d=r.uint32();switch(d>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=io.codec().decode(r,r.uint32(),{limits:(c=i.limits)==null?void 0:c.peer});break}case 3:{o.reservation=hl.codec().decode(r,r.uint32(),{limits:(l=i.limits)==null?void 0:l.reservation});break}case 4:{o.limit=oo.codec().decode(r,r.uint32(),{limits:(h=i.limits)==null?void 0:h.limit});break}case 5:{o.status=Pt.codec().decode(r);break}default:{r.skipType(d&7);break}}}return o})),e),n.encode=r=>he(r,n.codec()),n.decode=(r,s)=>ue(r,n.codec(),s)})(so||(so={}));var sr;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),io.codec().encode(r.peer,s)),r.limit!=null&&(s.uint32(26),oo.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(32),Pt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{var c,l;const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const h=r.uint32();switch(h>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=io.codec().decode(r,r.uint32(),{limits:(c=i.limits)==null?void 0:c.peer});break}case 3:{o.limit=oo.codec().decode(r,r.uint32(),{limits:(l=i.limits)==null?void 0:l.limit});break}case 4:{o.status=Pt.codec().decode(r);break}default:{r.skipType(h&7);break}}}return o})),e),n.encode=r=>he(r,n.codec()),n.decode=(r,s)=>ue(r,n.codec(),s)})(sr||(sr={}));var io;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a;const i={id:Pe(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const c=e.uint32();switch(c>>>3){case 1:{i.id=e.bytes();break}case 2:{if(((a=s.limits)==null?void 0:a.addrs)!=null&&i.addrs.length===s.limits.addrs)throw new Us('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");i.addrs.push(e.bytes());break}default:{e.skipType(c&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(io||(io={}));var hl;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.expire!=null&&e.expire!==0n&&(r.uint32(8),r.uint64(e.expire)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);e.voucher!=null&&(r.uint32(26),r.bytes(e.voucher)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a;const i={expire:0n,addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const c=e.uint32();switch(c>>>3){case 1:{i.expire=e.uint64();break}case 2:{if(((a=s.limits)==null?void 0:a.addrs)!=null&&i.addrs.length===s.limits.addrs)throw new Us('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");i.addrs.push(e.bytes());break}case 3:{i.voucher=e.bytes();break}default:{e.skipType(c&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(hl||(hl={}));var oo;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.duration!=null&&(r.uint32(8),r.uint32(e.duration)),e.data!=null&&(r.uint32(16),r.uint64(e.data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.duration=e.uint32();break}case 2:{i.data=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(oo||(oo={}));var Pt;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Pt||(Pt={}));var X1;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(X1||(X1={}));(function(n){n.codec=()=>Mt(X1)})(Pt||(Pt={}));var i0;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.relay!=null&&e.relay.byteLength>0&&(r.uint32(10),r.bytes(e.relay)),e.peer!=null&&e.peer.byteLength>0&&(r.uint32(18),r.bytes(e.peer)),e.expiration!=null&&e.expiration!==0n&&(r.uint32(24),r.uint64(e.expiration)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={relay:Pe(0),peer:Pe(0),expiration:0n},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.relay=e.bytes();break}case 2:{i.peer=e.bytes();break}case 3:{i.expiration=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(i0||(i0={}));function o0(n){const t=n*BigInt(1e3),e=new Date().getTime();return Number(t-BigInt(e))}function a0(n){const{stream:t,remoteAddr:e,logger:r}=n,s=r.forComponent("libp2p:stream:converter");let i=!1,o=!1;const a=t.close.bind(t);t.close=async f=>{await a(f),d(!0)};const c=t.abort.bind(t);t.abort=f=>{c(f),d(!0)};const l=t.sink.bind(t);t.sink=async f=>{try{await l(f)}catch(p){p.type!=="aborted"&&s.error("%s error in sink",e,p)}finally{o=!0,d()}};const h={log:s,sink:t.sink,source:async function*(){try{for await(const f of t.source)f instanceof Uint8Array?yield f:yield*f}finally{i=!0,d()}}(),remoteAddr:e,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function d(f){f===!0&&(i=!0,o=!0),i&&o&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}class Fk extends _t{constructor(e,r={}){super();u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"randomWalk");u(this,"started");u(this,"running");u(this,"topologyId");u(this,"log");u(this,"discoveryController");u(this,"filter");this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=r.filter,this.discoveryController=new AbortController,j(1/0,this.discoveryController.signal)}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(ul,{filter:this.filter,onConnect:e=>{this.log("discovered relay %p",e),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){var e;this.topologyId!=null&&this.registrar.unregister(this.topologyId),(e=this.discoveryController)==null||e.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,j(1/0,this.discoveryController.signal),Promise.resolve().then(async()=>{var s;this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[i=>i.protocols.includes(ul)],orders:[()=>Math.random()<.5?1:-1]});for(const i of e)this.log.trace("found relay peer %p in peer store",i.id),this.safeDispatchEvent("relay:discover",{detail:i.id});this.log("found %d relay peers in peer store",e.length);const r=new So({concurrency:5});this.log("start random walk");for await(const i of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",i.id),r.has(i.id)){this.log.trace("random peer %p was already in queue",i.id);continue}if(((s=this.connectionManager.getConnections(i.id))==null?void 0:s.length)>0){this.log.trace("random peer %p was already connected",i.id);continue}if(!await this.connectionManager.isDialable(i.multiaddrs)){this.log.trace("random peer %p was not dialable",i.id,i.multiaddrs.map(o=>o.toString()));continue}this.log.trace("wait for space in queue for %p",i.id),await dt(r.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",i.id,r.size),r.add(async()=>{const o=Ze([this.discoveryController.signal,AbortSignal.timeout(5e3)]);j(1/0,o);try{await this.connectionManager.openConnection(i.id,{signal:o})}finally{o.clear()}},{peerId:i.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",i.id,o)})}await r.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){var e;this.log("stop discovery"),this.running=!1,(e=this.discoveryController)==null||e.abort()}}var Dl,K7;class Vk extends _t{constructor(e){super();fe(this,Dl);u(this,"connectionManager");u(this,"relayStore");u(this,"listeningAddrs");u(this,"log");u(this,"_onRemoveRelayPeer",e=>{re(this,Dl,K7).call(this,e.detail)});this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Sr,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(e){this.log("listen on %a",e);const r=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(r);if(!this.relayStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer),await this.relayStore.addRelay(s.remotePeer,"configured");return}const i=this.relayStore.getReservation(s.remotePeer);if(i==null)throw new E("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(s.remotePeer)){this.log("already listening on relay %p",s.remotePeer);return}this.listeningAddrs.set(s.remotePeer,i.addrs.map(o=>le(o).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}}Dl=new WeakSet,K7=function(e){const r=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,r),this.listeningAddrs.delete(e),r&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))};function Hk(n){return new Vk(n)}const Kk=60*1e3*10,zk=60*1e3*5,qk=30*1e3;var go,z7,q7;class Wk extends _t{constructor(e,r){super();fe(this,go);u(this,"peerId");u(this,"connectionManager");u(this,"transportManager");u(this,"peerStore");u(this,"events");u(this,"reserveQueue");u(this,"reservations");u(this,"maxDiscoveredRelays");u(this,"maxReservationQueueLength");u(this,"reservationCompletionTimeout");u(this,"started");u(this,"log");u(this,"relayFilter");this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Sr,this.maxDiscoveredRelays=(r==null?void 0:r.discoverRelays)??0,this.maxReservationQueueLength=(r==null?void 0:r.maxReservationQueueLength)??Ok,this.reservationCompletionTimeout=(r==null?void 0:r.reservationCompletionTimeout)??Pk,this.started=!1,this.relayFilter=P_(100),this.reserveQueue=new So({concurrency:(r==null?void 0:r.reservationConcurrency)??Lk,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",s=>{re(this,go,q7).call(this,s.detail)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,r){if(this.peerId.equals(e)){this.log("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){this.log("not adding potential relay peer %p as the queue is full",e);return}if(this.reserveQueue.has(e)){this.log("potential relay peer %p is already in the reservation queue",e);return}if(this.relayFilter.has(e.toBytes())){this.log("potential relay peer %p has failed previously, not trying again",e);return}this.log("try to reserve relay slot with %p",e),await this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){if(o0(i.reservation.expire)>Kk){this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(i.timeout),this.reservations.delete(e)}if(r==="discovered"&&[...this.reservations.values()].reduce((f,p)=>(p.type==="discovered"&&f++,f),0)>=this.maxDiscoveredRelays){this.log("already have enough discovered relays");return}const o=AbortSignal.timeout(this.reservationCompletionTimeout);j(1/0,o);const a=await this.connectionManager.openConnection(e,{signal:o});if(a.remoteAddr.protoNames().includes("p2p-circuit")){this.log("not creating reservation over relayed connection");return}const c=await re(this,go,z7).call(this,a,{signal:o});this.log("created reservation on relay peer %p",e);const l=o0(c.expire),h=Math.min(Math.max(l-zk,qk),Math.pow(2,31)-1),d=setTimeout(()=>{this.addRelay(e,r).catch(f=>{this.log.error("could not refresh reservation to relay %p",e,f)})},h);this.reservations.set(e,{timeout:d,reservation:c,type:r}),await this.peerStore.merge(e,{tags:{[Bk]:{value:1,ttl:l}}}),await this.transportManager.listen([le(`/p2p/${e.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:e})}catch(i){this.log.error("could not reserve slot on %p after %dms",e,Date.now()-s,i);const o=this.reservations.get(e);o!=null&&clearTimeout(o.timeout),this.reservations.delete(e),this.relayFilter.add(e.toBytes())}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){var r;return(r=this.reservations.get(e))==null?void 0:r.reservation}reservationCount(){return this.reservations.size}}go=new WeakSet,z7=async function(e,r){var l;(l=r.signal)==null||l.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const s=await e.newStream(ul,r),o=Gt(s).pb(so);await o.write({type:so.Type.RESERVE},r);let a;try{a=await o.read(r)}catch(h){throw s.abort(h),h}finally{s.status!=="closed"&&await s.close(r)}if(a.status===Pt.OK&&a.reservation!=null){let h=!1;const d=e.remoteAddr.bytes;for(const f of a.reservation.addrs)if(ve(d,f)){h=!0;break}return h||a.reservation.addrs.push(d),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},q7=function(e){const r=this.reservations.get(e);r!=null&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(r.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))};const Gk=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(le)}catch{return!1}return!0},Hu={maxInboundStopStreams:r0,maxOutboundStopStreams:r0,stopTimeout:3e4};var b3,E3,_3,v3;class Yk{constructor(t,e){u(this,"discovery");u(this,"registrar");u(this,"peerStore");u(this,"connectionManager");u(this,"transportManager");u(this,"peerId");u(this,"upgrader");u(this,"addressManager");u(this,"connectionGater");u(this,"reservationStore");u(this,"logger");u(this,"maxInboundStopStreams");u(this,"maxOutboundStopStreams");u(this,"stopTimeout");u(this,"started");u(this,"log");u(this,v3,"@libp2p/circuit-relay-v2-transport");u(this,_3,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);u(this,b3,!0);this.log=t.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.logger=t.logger,this.peerId=t.peerId,this.upgrader=t.upgrader,this.addressManager=t.addressManager,this.connectionGater=t.connectionGater,this.maxInboundStopStreams=e.maxInboundStopStreams??Hu.maxInboundStopStreams,this.maxOutboundStopStreams=e.maxOutboundStopStreams??Hu.maxOutboundStopStreams,this.stopTimeout=e.stopTimeout??Hu.stopTimeout;const r=e.discoverRelays??0;r>0&&(this.discovery=new Fk(t,{filter:e.discoveryFilter??G_(Uk,$k)}),this.discovery.addEventListener("relay:discover",s=>{this.reservationStore.addRelay(s.detail,"discovered").catch(i=>{this.log.error("could not add discovered relay %p",s.detail,i)})})),this.reservationStore=new Wk(t,e),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var s;(s=this.discovery)==null||s.startDiscovery()}),this.reservationStore.addEventListener("relay:created-reservation",()=>{var s;this.reservationStore.reservationCount()>=r&&((s=this.discovery)==null||s.stopDiscovery())}),this.started=!1}get[(v3=Symbol.toStringTag,_3=Bt,E3=Ui,b3=La,E3)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){await this.registrar.handle(n0,t=>{this.onStop(t).catch(e=>{this.log.error("error while handling STOP protocol",e),t.stream.abort(e)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await _o(this.discovery,this.reservationStore),this.started=!0}async stop(){await vo(this.discovery,this.reservationStore),await this.registrar.unhandle(n0),this.started=!1}async dial(t,e){var m,g,y;if(t.protoCodes().filter(w=>w===Nk).length!==1){const w="Invalid circuit relay address";throw this.log.error(w,t),new E(w,s0)}const r=t.toString().split("/p2p-circuit"),s=le(r[0]),i=le(r[r.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const w=`Circuit relay dial to ${t.toString()} failed as address did not have peer ids`;throw this.log.error(w),new E(w,s0)}const c=Je(o),l=Je(a);let h=!1,f=this.connectionManager.getConnections(c)[0];f==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),(m=e.onProgress)==null||m.call(e,new G("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(c,e),h=!0):(g=e.onProgress)==null||g.call(e,new G("circuit-relay:reuse-connection"));let p;try{return(y=e.onProgress)==null||y.call(e,new G("circuit-relay:open-hop-stream")),p=await f.newStream(ul),await this.connectV2({stream:p,connection:f,destinationPeer:l,destinationAddr:i,relayAddr:s,ma:t,disconnectOnFailure:h,onProgress:e.onProgress})}catch(w){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,w),p!=null&&p.abort(w),h&&await f.close(),w}}async connectV2({stream:t,connection:e,destinationPeer:r,destinationAddr:s,relayAddr:i,ma:o,disconnectOnFailure:a,onProgress:c}){var l;try{const h=Gt(t),d=h.pb(so);c==null||c(new G("circuit-relay:write-connect-message")),await d.write({type:so.Type.CONNECT,peer:{id:r.toBytes(),addrs:[le(s).bytes]}}),c==null||c(new G("circuit-relay:read-connect-response"));const f=await d.read();if(f.status!==Pt.OK)throw new E(`failed to connect via relay with status ${((l=f==null?void 0:f.status)==null?void 0:l.toString())??"undefined"}`,Mk);const p=a0({stream:h.unwrap(),remoteAddr:o,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",p.remoteAddr),await this.upgrader.upgradeOutbound(p,{transient:f.limit!=null,onProgress:c})}catch(h){throw this.log.error(`Circuit relay dial to destination ${r.toString()} via relay ${e.remotePeer.toString()} failed`,h),a&&await e.close(),h}}createListener(t){return Hk({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>Rs.matches(e))}dialFilter(t){return this.listenFilter(t)}async onStop({connection:t,stream:e}){var h,d;if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}const r=AbortSignal.timeout(this.stopTimeout),s=Gt(e).pb(sr),i=await s.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),(i==null?void 0:i.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:sr.Type.STATUS,status:Pt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}if(i.type!==sr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:sr.Type.STATUS,status:Pt.UNEXPECTED_MESSAGE},{signal:r}),await e.close();return}if(!Gk(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:sr.Type.STATUS,status:Pt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}const o=Rn(i.peer.id);if(await((d=(h=this.connectionGater).denyInboundRelayedConnection)==null?void 0:d.call(h,t.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:sr.Type.STATUS,status:Pt.PERMISSION_DENIED},{signal:r}),await e.close();return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:sr.Type.STATUS,status:Pt.OK},{signal:r});const a=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),c=this.addressManager.getAddresses()[0],l=a0({stream:s.unwrap().unwrap(),remoteAddr:a,localAddr:c,logger:this.logger});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:i.limit!=null}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function Qk(n={}){return t=>new Yk(t,n)}const c0=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},Xk=new WeakMap;function Zk({clearTimeout:n,setTimeout:t}={}){return(e,{value:r,signal:s}={})=>{if(s!=null&&s.aborted)return Promise.reject(c0());let i,o,a;const c=n??clearTimeout,l=()=>{c(i),a(c0())},h=()=>{s&&s.removeEventListener("abort",l)},d=new Promise((f,p)=>{o=()=>{h(),f(r)},a=p,i=(t??setTimeout)(o,e)});return s&&s.addEventListener("abort",l,{once:!0}),Xk.set(d,()=>{c(i),i=null,o()}),d}}const W7=Zk();var Pn;(function(n){(function(r){r.UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC"})(n.Type||(n.Type={}));let t;(function(r){r[r.UNUSED=0]="UNUSED",r[r.CONNECT=100]="CONNECT",r[r.SYNC=300]="SYNC"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.observedAddresses!=null)for(const o of r.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={observedAddresses:[]},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.type=n.Type.codec().decode(r);break;case 2:i.observedAddresses.push(r.bytes());break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(Pn||(Pn={}));function l0(n,t){return nl.matches(n)||t.dialTransportForMultiaddr(n)==null?!1:W8.matches(n)?!0:kR.matches(n)?rs(n.toOptions().host)===!1:!1}const u0=1024*4,h0=100,fc={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};var S3,R3;R3=Symbol.toStringTag,S3=Ui;class jk{constructor(t,e){u(this,"started");u(this,"timeout");u(this,"retries");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"addressManager");u(this,"transportManager");u(this,"topologyId");u(this,"log");u(this,R3,"@libp2p/dcutr");u(this,S3,["@libp2p/identify"]);this.log=t.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.timeout=e.timeout??fc.timeout,this.retries=e.retries??fc.retries,this.maxInboundStreams=e.maxInboundStreams??fc.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??fc.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(gc,{notifyOnTransient:!0,onConnect:(t,e)=>{e.transient&&e.direction==="inbound"&&this.upgradeInbound(e).catch(r=>{this.log.error("error during outgoing DCUtR attempt",r)})}}),await this.registrar.handle(gc,t=>{this.handleIncomingUpgrade(t.stream,t.connection).catch(e=>{this.log.error("error during incoming DCUtR attempt",e),t.stream.abort(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(gc),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(t){if(await this.attemptUnilateralConnectionUpgrade(t))return;let e;for(let r=0;r<this.retries;r++){const s={signal:AbortSignal.timeout(this.timeout)};try{e=await t.newStream([gc],{signal:s.signal,runOnTransientConnection:!0});const i=Gt(e,{maxDataLength:u0}).pb(Pn);this.log("B sending connect to %p",t.remotePeer);const o=Date.now();await i.write({type:Pn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},s),this.log("B receiving connect from %p",t.remotePeer);const a=await i.read(s);if(a.type!==Pn.Type.CONNECT)throw this.log("A sent wrong message type"),new E("DCUtR message type was incorrect",ws);const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new E("DCUtR connect message had no multiaddrs",ws);const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await i.write({type:Pn.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await W7(l/2),this.log("B dialing",c);const h=await this.connectionManager.openConnection(c,{signal:s.signal,priority:h0});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",t.remotePeer,h.remoteAddr),await t.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,i),e==null||e.abort(i),r===this.retries)throw i}finally{e!=null&&await e.close(s)}}}async attemptUnilateralConnectionUpgrade(t){const r=(await this.peerStore.get(t.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${t.remotePeer}`):i}).filter(s=>l0(s,this.transportManager));if(r.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",r);const i=await this.connectionManager.openConnection(r,{signal:s,force:!0});if(i.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",t.remotePeer,i.remoteAddr),await t.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",t.remotePeer,r,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",t.remotePeer);return!1}async handleIncomingUpgrade(t,e){const r={signal:AbortSignal.timeout(this.timeout)};try{const s=Gt(t,{maxDataLength:u0}).pb(Pn);this.log("A receiving connect");const i=await s.read(r);if(i.type!==Pn.Type.CONNECT)throw this.log("B sent wrong message type"),new E("DCUtR message type was incorrect",ws);if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new E("DCUtR connect message had no multiaddrs",ws);const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new E("DCUtR connect message had no dialable multiaddrs",ws);if(this.log("A sending connect"),await s.write({type:Pn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(r)).type!==Pn.Type.SYNC)throw new E("DCUtR message type was incorrect",ws);this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:r.signal,priority:h0,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",e.remotePeer,c.remoteAddr),await e.close(r)}catch(s){this.log.error("incoming DCUtR from %p failed",e.remotePeer,s),t.abort(s)}finally{await t.close(r)}}getDialableMultiaddrs(t){const e=[];for(const r of t)if(!(r==null||r.length===0))try{const s=le(r);if(!l0(s,this.transportManager))continue;e.push(s)}catch{}return e}}const gc="/libp2p/dcutr";function Jk(n={}){return t=>new jk(t,n)}const ex="0.1.0",tx="id",nx="id/push",rx="1.0.0",sx="1.0.0",ix=1024*8,ox=32;var ao;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.protocolVersion!=null&&(r.uint32(42),r.string(e.protocolVersion)),e.agentVersion!=null&&(r.uint32(50),r.string(e.agentVersion)),e.publicKey!=null&&(r.uint32(10),r.bytes(e.publicKey)),e.listenAddrs!=null)for(const i of e.listenAddrs)r.uint32(18),r.bytes(i);if(e.observedAddr!=null&&(r.uint32(34),r.bytes(e.observedAddr)),e.protocols!=null)for(const i of e.protocols)r.uint32(26),r.string(i);e.signedPeerRecord!=null&&(r.uint32(66),r.bytes(e.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={listenAddrs:[],protocols:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 5:s.protocolVersion=e.string();break;case 6:s.agentVersion=e.string();break;case 1:s.publicKey=e.bytes();break;case 2:s.listenAddrs.push(e.bytes());break;case 4:s.observedAddr=e.bytes();break;case 3:s.protocols.push(e.string());break;case 8:s.signedPeerRecord=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(ao||(ao={}));function ax(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var cx=ax;const lx=Ir(cx),Pd=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,iu=lx(),G7=Pd&&!iu,ux=iu&&!Pd,hx=iu&&Pd,dx=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!iu,Y7=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,fx=typeof navigator<"u"&&navigator.product==="ReactNative",on={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:ix,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnTransientConnection:!0,concurrency:ox};function gx(n){if(n!=null&&n.length>0)try{return le(n)}catch{}}function px(n,t){return t!=null||(t=`${n.name}/${n.version}`,dx||ux?t+=` UserAgent=${globalThis.process.version}`:(G7||Y7||hx||fx)&&(t+=` UserAgent=${globalThis.navigator.userAgent}`)),t}async function Q7(n,t,e,r,s){if(e("received identify from %p",r.remotePeer),s==null)throw new E("message was null or undefined","ERR_INVALID_MESSAGE");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:le(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null&&(i.publicKey=s.publicKey,!(await Gn(s.publicKey)).equals(r.remotePeer)))throw new E("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let o;if(s.signedPeerRecord!=null){e("received signedPeerRecord from %p",r.remotePeer);let c=s.signedPeerRecord;const l=await ss.openAndCertify(c,zn.DOMAIN);let h=zn.createFromProtobuf(l.payload);if(!h.peerId.equals(l.peerId))throw new E("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!r.remotePeer.equals(h.peerId))throw new E("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let d;try{d=await n.get(h.peerId)}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const f=await ss.createFromProtobuf(d.peerRecordEnvelope),p=zn.createFromProtobuf(f.payload);p.seqNumber>=h.seqNumber&&(e("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,h.seqNumber),h=p,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=h.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:h.seqNumber,addresses:h.multiaddrs}}else e("%p did not send a signed peer record",r.remotePeer);if(e("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=V(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=V(s.protocolVersion)),e("merging %p metadata",r.remotePeer,c),await n.merge(r.remotePeer,{metadata:c})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>le(c)),observedAddr:s.observedAddr==null?void 0:le(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class X7{constructor(t,e){u(this,"host");u(this,"protocol");u(this,"started");u(this,"timeout");u(this,"peerId");u(this,"peerStore");u(this,"registrar");u(this,"addressManager");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"maxMessageSize");u(this,"maxObservedAddresses");u(this,"events");u(this,"runOnTransientConnection");u(this,"log");this.protocol=e.protocol,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.events=t.events,this.log=e.log,this.timeout=e.timeout??on.timeout,this.maxInboundStreams=e.maxInboundStreams??on.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??on.maxOutboundStreams,this.maxMessageSize=e.maxMessageSize??on.maxMessageSize,this.maxObservedAddresses=e.maxObservedAddresses??on.maxObservedAddresses,this.runOnTransientConnection=e.runOnTransientConnection??on.runOnTransientConnection,this.host={protocolVersion:`${e.protocolPrefix??on.protocolPrefix}/${ex}`,agentVersion:px(t.nodeInfo,e.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:V(this.host.agentVersion),ProtocolVersion:V(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,t=>{this.handleProtocol(t).catch(e=>{this.log.error(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var A3,I3;class yx extends(I3=X7,A3=Bt,I3){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??on.protocolPrefix}/${nx}/${sx}`,log:e.logger.forComponent("libp2p:identify-push")});u(this,"connectionManager");u(this,"concurrency");u(this,A3,["@libp2p/identify-push"]);this.connectionManager=e.connectionManager,this.concurrency=r.concurrency??on.concurrency,(r.runOnSelfUpdate??on.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",s=>{this.push().catch(i=>{this.log.error(i)})})}async push(){if(!this.isStarted())return;const e=this.addressManager.getAddresses().map(d=>d.decapsulateCode(se("p2p").code)),r=new zn({peerId:this.peerId,multiaddrs:e}),s=await ss.seal(r,this.peerId),i=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=W(o.metadata.get("AgentVersion")??V(this.host.agentVersion)),c=W(o.metadata.get("ProtocolVersion")??V(this.host.protocolVersion)),l=this;async function*h(){for(const d of l.connectionManager.getConnections())(await l.peerStore.get(d.remotePeer)).protocols.includes(l.protocol)&&(yield async()=>{let p;const m=AbortSignal.timeout(l.timeout);j(1/0,m);try{p=await d.newStream(l.protocol,{signal:m,runOnTransientConnection:l.runOnTransientConnection}),await Gt(p,{maxDataLength:l.maxMessageSize}).pb(ao).write({listenAddrs:e.map(y=>y.bytes),signedPeerRecord:s.marshal(),protocols:i,agentVersion:a,protocolVersion:c},{signal:m}),await p.close({signal:m})}catch(g){l.log.error("could not push identify update to peer",g),p==null||p.abort(g)}})}await Bs(hs(h(),{concurrency:this.concurrency}))}async handleProtocol(e){const{connection:r,stream:s}=e;try{if(this.peerId.equals(r.remotePeer))throw new Error("received push from ourselves?");const i={signal:AbortSignal.timeout(this.timeout)},a=await Gt(s,{maxDataLength:this.maxMessageSize}).pb(ao).read(i);await s.close(i),await Q7(this.peerStore,this.events,this.log,r,a)}catch(i){this.log.error("received invalid message",i),s.abort(i);return}this.log("handled push from %p",r.remotePeer)}}var k3,x3;class mx extends(x3=X7,k3=Bt,x3){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??on.protocolPrefix}/${tx}/${rx}`,log:e.logger.forComponent("libp2p:identify")});u(this,k3,["@libp2p/identify"]);(r.runOnConnectionOpen??on.runOnConnectionOpen)&&e.events.addEventListener("connection:open",s=>{const i=s.detail;this.identify(i).catch(o=>{this.log.error("error during identify trigged by connection:open",o)})})}async _identify(e,r={}){let s;if(r.signal==null){const i=AbortSignal.timeout(this.timeout);j(1/0,i),r={...r,signal:i}}try{s=await e.newStream(this.protocol,{...r,runOnTransientConnection:this.runOnTransientConnection});const o=await Gt(s,{maxDataLength:this.maxMessageSize}).pb(ao).read(r);return await s.close(r),o}catch(i){throw this.log.error("error while reading identify message",i),s==null||s.abort(i),i}}async identify(e,r={}){const s=await this._identify(e,r),{publicKey:i,protocols:o,observedAddr:a}=s;if(i==null)throw new E("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const c=await Gn(i);if(!e.remotePeer.equals(c))throw new E("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(c))throw new E("identified peer is our own peer id?","ERR_INVALID_PEER");const l=gx(a);return this.log("identify completed for peer %p and protocols %o",c,o),this.log("our observed address is %a",l),l!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",l),this.addressManager.addObservedAddr(l)),Q7(this.peerStore,this.events,this.log,e,s)}async handleProtocol(e){const{connection:r,stream:s}=e,i=AbortSignal.timeout(this.timeout);j(1/0,i);try{const o=this.peerId.publicKey??new Uint8Array(0),a=await this.peerStore.get(this.peerId),c=this.addressManager.getAddresses().map(f=>f.decapsulateCode(se("p2p").code));let l=a.peerRecordEnvelope;if(c.length>0&&l==null){const f=new zn({peerId:this.peerId,multiaddrs:c});l=(await ss.seal(f,this.peerId)).marshal().subarray()}let h=r.remoteAddr.bytes;IR.matches(r.remoteAddr)||(h=void 0),await Gt(s).pb(ao).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:o,listenAddrs:c.map(f=>f.bytes),signedPeerRecord:l,observedAddr:h,protocols:a.protocols},{signal:i}),await s.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),s.abort(o)}}}function wx(n={}){return t=>new mx(t,n)}function bx(n={}){return t=>new yx(t,n)}const za=1e3,Od=60*za,Bd=60*Od,Ex=36*Bd,_x="/ipfs/kad/1.0.0",vx="/dht/record",Z7="/dht/provider",Sx=256,Rx=24*Bd,Ax=Bd,Z1=20,dl=3,Ix=5*Od,kx=za,xx=5*za,Tx=5*Od,Dx=30*za,Cx=180*za;var fl;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.key!=null&&e.key.byteLength>0&&(r.uint32(10),r.bytes(e.key)),e.value!=null&&e.value.byteLength>0&&(r.uint32(18),r.bytes(e.value)),e.timeReceived!=null&&e.timeReceived!==""&&(r.uint32(42),r.string(e.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={key:Pe(0),value:Pe(0),timeReceived:""},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.key=e.bytes();break}case 2:{i.value=e.bytes();break}case 5:{i.timeReceived=e.string();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(fl||(fl={}));function Nx(n){const t=n.getUTCFullYear(),e=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),s=String(n.getUTCHours()).padStart(2,"0"),i=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${t}-${e}-${r}T${s}:${i}:${o}.${c}Z`}function Lx(n){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),e=String(n).trim().match(t);if(e==null)throw new Error("Invalid format");const r=parseInt(e[1],10),s=parseInt(e[2],10)-1,i=parseInt(e[3],10),o=parseInt(e[4],10),a=parseInt(e[5],10),c=parseInt(e[6],10),l=parseInt(e[7].slice(0,-6),10);return new Date(Date.UTC(r,s,i,o,a,c,l))}class un{constructor(t,e,r){u(this,"key");u(this,"value");u(this,"timeReceived");if(!(t instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(e instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=t,this.value=e,this.timeReceived=r}serialize(){return fl.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:Nx(this.timeReceived)}}static deserialize(t){const e=fl.decode(t);return new un(e.key,e.value,new Date(e.timeReceived))}static fromDeserialized(t){const e=Lx(t.timeReceived);if(t.key==null)throw new Error("key missing from deserialized object");if(t.value==null)throw new Error("value missing from deserialized object");return new un(t.key,t.value,e)}}var d0;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.key!=null&&(r.uint32(10),r.bytes(e.key)),e.value!=null&&(r.uint32(18),r.bytes(e.value)),e.author!=null&&(r.uint32(26),r.bytes(e.author)),e.signature!=null&&(r.uint32(34),r.bytes(e.signature)),e.timeReceived!=null&&(r.uint32(42),r.string(e.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.key=e.bytes();break}case 2:{s.value=e.bytes();break}case 3:{s.author=e.bytes();break}case 4:{s.signature=e.bytes();break}case 5:{s.timeReceived=e.string();break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(d0||(d0={}));var Ue;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(Ue||(Ue={}));var gl;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(gl||(gl={}));(function(n){n.codec=()=>Mt(gl)})(Ue||(Ue={}));var co;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(co||(co={}));var j1;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(j1||(j1={}));(function(n){n.codec=()=>Mt(j1)})(co||(co={}));var ai;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.multiaddrs!=null)for(const i of e.multiaddrs)r.uint32(18),r.bytes(i);e.connection!=null&&(r.uint32(24),co.codec().encode(e.connection,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={id:Pe(0),multiaddrs:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.id=e.bytes();break}case 2:{s.multiaddrs.push(e.bytes());break}case 3:{s.connection=co.codec().decode(e);break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(ai||(ai={}));var wr;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.type!=null&&gl[e.type]!==0&&(r.uint32(8),Ue.codec().encode(e.type,r)),e.clusterLevel!=null&&(r.uint32(80),r.int32(e.clusterLevel)),e.key!=null&&(r.uint32(18),r.bytes(e.key)),e.record!=null&&(r.uint32(26),r.bytes(e.record)),e.closer!=null)for(const i of e.closer)r.uint32(66),ai.codec().encode(i,r);if(e.providers!=null)for(const i of e.providers)r.uint32(74),ai.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={type:Ue.PUT_VALUE,closer:[],providers:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.type=Ue.codec().decode(e);break}case 10:{s.clusterLevel=e.int32();break}case 2:{s.key=e.bytes();break}case 3:{s.record=e.bytes();break}case 8:{s.closer.push(ai.codec().decode(e,e.uint32()));break}case 9:{s.providers.push(ai.codec().decode(e,e.uint32()));break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(wr||(wr={}));function f0(n,t={}){var r;const e={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:send-query",{detail:e})),e}function J1(n,t={}){var r;const e={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:peer-response",{detail:e})),e}function Ku(n,t={}){var r;const e={...n,name:"FINAL_PEER",type:2};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:final-peer",{detail:e})),e}function is(n,t={}){var r;const e={...n,name:"QUERY_ERROR",type:3};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:query-error",{detail:e})),e}function g0(n,t={}){var r;const e={...n,name:"PROVIDER",type:4};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:provider",{detail:e})),e}function eh(n,t={}){var r;const e={...n,name:"VALUE",type:5};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:value",{detail:e})),e}function p0(n,t={}){var r;const e={...n,name:"DIAL_PEER",type:7};return(r=t.onProgress)==null||r.call(t,new Sn("kad-dht:query:dial-peer",{detail:e})),e}function Px(n,t,e){if(e.length===0){const o="No records given";throw new E(o,"ERR_NO_RECORDS_RECEIVED")}const s=W(t).split("/");if(s.length<3){const o="Record key does not have a selector function";throw new E(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=n[s[1].toString()];if(i==null){const o=`No selector function configured for key type "${s[1]}"`;throw new E(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return e.length===1?0:i(t,e)}function Ox(n,t){return 0}const Bx={pk:Ox};async function Md(n,t){const e=t.key,s=W(e).split("/");if(s.length<3)return;const i=n[s[1].toString()];if(i==null){const o=`No validator available for key type "${s[1]}"`;throw new E(o,"ERR_INVALID_RECORD_KEY_TYPE")}await i(e,t.value)}const Mx=async(n,t)=>{if(!(n instanceof Uint8Array))throw new E('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(n.byteLength<5)throw new E("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(W(n.subarray(0,4))!=="/pk/")throw new E("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");const r=n.slice(4),s=await We.digest(t);if(!ve(r,s.bytes))throw new E("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},Ux={pk:Mx},$x=V("/pk/");function Fx(n){return{...n,multiaddrs:n.multiaddrs.filter(t=>{const[[e,r]]=t.stringTuples();if(e===53||e===54||e===55)return r!=="localhost";if(e!==4&&e!==6||r==null)return!1;const s=rs(r);return s==null?!0:!s})}}async function _a(n){return(await We.digest(n)).digest}async function ur(n){return _a(n.toBytes())}function Jo(n){return new $e(`${vx}/${W(n,"base32")}`,!1)}function Vx(n){return gt([$x,n.toBytes()])}function Hx(n){return W(n.subarray(0,4))==="/pk/"}function Kx(n){return Rn(n.subarray(4))}function y0(n,t){const e=new Date;return new un(n,t,e).serialize()}function zx(n,t=100){let e;return()=>{clearTimeout(e),e=setTimeout(()=>{n()},t)}}const qx=290,Wx=54,Gx=55,Yx=56,Qx=4,Xx=41;function Zx(n){const t=n.stringTuples();for(const e of t)if(e[0]===qx)return!1;if(t[0][0]===Wx||t[0][0]===Gx||t[0][0]===Yx)return!0;if(t[0][0]===Qx||t[0][0]===Xx){const e=rs(`${t[0][1]}`);return e==null||!e}return!1}class jx{constructor(t,e){u(this,"log");u(this,"components");u(this,"validators");u(this,"selectors");u(this,"peerRouting");u(this,"queryManager");u(this,"network");const{validators:r,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=e;this.components=t,this.log=t.logger.forComponent(`${c}:content-fetching`),this.validators=r,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a}async getLocal(t){this.log("getLocal %b",t);const e=Jo(t);this.log("fetching record for key %k",e);const r=await this.components.datastore.get(e);this.log("found %k in local datastore",e);const s=un.deserialize(r);return await Md(this.validators,s),s}async*sendCorrectionRecord(t,e,r,s={}){this.log("sendCorrection for %b",t);const i=y0(t,r);for(const{value:o,from:a}of e){if(ve(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const h=Jo(t);this.log(`Storing corrected record for key ${h.toString()}`),await this.components.datastore.put(h,i.subarray())}catch(h){this.log.error("Failed error correcting self",h)}continue}let c=!1;const l={type:Ue.PUT_VALUE,key:t,record:i};for await(const h of this.network.sendRequest(a,l,s))h.name==="PEER_RESPONSE"&&h.record!=null&&ve(h.record.value,un.deserialize(i).value)&&(c=!0),yield h;c||(yield is({from:a,error:new E("value not put correctly","ERR_PUT_VALUE_INVALID")},s)),this.log.error("Failed error correcting entry")}}async*put(t,e,r={}){this.log("put key %b value %b",t,e);const s=y0(t,e),i=Jo(t);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*vt(this.peerRouting.getClosestPeers(t,{signal:r.signal}),o=>vr(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:Ue.PUT_VALUE,key:t,record:s};this.log("send put to %p",a.peer.id);for await(const h of this.network.sendRequest(a.peer.id,l,r))c.push(h),h.name==="PEER_RESPONSE"&&(h.record!=null&&ve(h.record.value,un.deserialize(s).value)||c.push(is({from:a.peer.id,error:new E("value not put correctly","ERR_PUT_VALUE_INVALID")},r)));return c}),o=>hs(o,{ordered:!1,concurrency:dl}),async function*(o){for await(const a of o)yield*a})}async*get(t,e={}){this.log("get %b",t);const r=[];for await(const a of this.getMany(t,e))a.name==="VALUE"&&r.push(a),yield a;if(r.length===0)return;const s=r.map(a=>a.value);let i=0;try{i=Px(this.selectors,t,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=s[i];if(this.log("GetValue %b %b",t,o),o==null)throw new E("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(t,r,o,e),yield r[i]}async*getMany(t,e={}){this.log("getMany values for %b",t);try{const i=await this.getLocal(t);yield eh({value:i.value,from:this.components.peerId},e)}catch(i){this.log("error getting local value for %b",t,i)}const r=this,s=async function*({peer:i,signal:o}){for await(const a of r.peerRouting.getValueOrPeers(i,t,{signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield eh({from:i,value:a.record.value},e))};yield*this.queryManager.run(t,s,e)}}function Jx(n,t){return{id:n.id.toBytes(),multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:t}}function pc(n){if(n.id==null)throw new Error("Invalid peer in message");return{id:Rn(n.id),multiaddrs:(n.multiaddrs??[]).map(t=>le(t))}}class eT{constructor(t,e){u(this,"log");u(this,"components");u(this,"network");u(this,"peerRouting");u(this,"queryManager");u(this,"routingTable");u(this,"providers");const{network:r,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=e;this.components=t,this.log=t.logger.forComponent(`${c}:content-routing`),this.network=r,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(t,e,r={}){this.log("provide %s",t);const s=t.multihash.bytes;await this.providers.addProvider(t,this.components.peerId);const i={type:Ue.ADD_PROVIDER,key:s,providers:[Jx({id:this.components.peerId,multiaddrs:e})]};let o=0;const a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const l=[];this.log("putProvider %s to %p",t,c.peer.id);try{this.log("sending provider record for %s to %p",t,c.peer.id);for await(const h of this.network.sendMessage(c.peer.id,i,r))h.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",t,c.peer.id),o++),l.push(h)}catch(h){this.log.error("error sending provide record to peer %p",c.peer.id,h),l.push(is({from:c.peer.id,error:h},r))}return l};yield*vt(this.peerRouting.getClosestPeers(s,r),c=>vr(c,l=>a(l)),c=>hs(c,{ordered:!1,concurrency:dl}),async function*(c){for await(const l of c)yield*l}),this.log("sent provider records to %d peers",o)}async*findProviders(t,e){const r=this.routingTable.kBucketSize;let s=0;const i=t.multihash.bytes,o=this;this.log("findProviders %c",t);const a=await this.providers.getProviders(t);if(a.length>0){const h=[];for(const d of a.slice(0,r))try{const f=await this.components.peerStore.get(d);h.push({id:d,multiaddrs:f.addresses.map(({multiaddr:p})=>p)})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",d)}if(yield J1({from:this.components.peerId,messageType:Ue.GET_PROVIDERS,providers:h},e),yield g0({from:this.components.peerId,providers:h},e),s+=h.length,s>=r)return}const c=async function*({peer:h,signal:d}){const f={type:Ue.GET_PROVIDERS,key:i};yield*o.network.sendRequest(h,f,{...e,signal:d})},l=new _n(a);for await(const h of this.queryManager.run(i,c,e))if(yield h,h.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",h.providers.length,t,h.closer.length);const d=[];for(const f of h.providers)l.has(f.id)||(l.add(f.id),d.push(f));if(d.length>0&&(yield g0({from:h.from,providers:d},e),s+=d.length,s>=r))return}}}class zu{constructor(t){u(this,"movingAverage");u(this,"variance");u(this,"deviation");u(this,"forecast");u(this,"timespan");u(this,"previousTime");this.timespan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timespan)}push(t,e=Date.now()){if(this.previousTime!=null){const r=this.alpha(e,this.previousTime),s=t-this.movingAverage,i=r*s;this.movingAverage=r*t+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=t;this.previousTime=e}}const tT=1.2,nT=2,rT=2e3;class j7{constructor(t={}){u(this,"success");u(this,"failure");u(this,"next");u(this,"metric");u(this,"timeoutMultiplier");u(this,"failureMultiplier");u(this,"minTimeout");var e;this.success=new zu(t.interval??5e3),this.failure=new zu(t.interval??5e3),this.next=new zu(t.interval??5e3),this.failureMultiplier=t.failureMultiplier??nT,this.timeoutMultiplier=t.timeoutMultiplier??tT,this.minTimeout=t.minTimeout??rT,t.metricName!=null&&(this.metric=(e=t.metrics)==null?void 0:e.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){const e=Math.max(Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(e),s=Ze([t.signal,r]);return j(1/0,s,r),s.start=Date.now(),s.timeout=e,s}cleanUp(t){var r,s;const e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),(r=this.metric)==null||r.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),(s=this.metric)==null||s.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}}class sT extends _t{constructor(e,r){super();u(this,"log");u(this,"protocol");u(this,"running");u(this,"components");u(this,"timeout");const{protocol:s}=r;this.components=e,this.log=e.logger.forComponent(`${r.logPrefix}:network`),this.running=!1,this.protocol=s,this.timeout=new j7({...r.timeout??{},metrics:e.metrics,metricName:`${r.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,r,s={}){if(!this.running)return;const i=r.type;if(i==null)throw new Us("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,e),yield p0({peer:e},s),yield f0({to:e,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{o=await(await this.components.connectionManager.openConnection(e,s)).newStream(this.protocol,s);const l=await this._writeReadMessage(o,r,s);o.close(s).catch(h=>{this.log.error("error closing stream to %p",e,h),o==null||o.abort(h)}),yield J1({from:e,messageType:l.type,closer:l.closer.map(pc),providers:l.providers.map(pc),record:l.record==null?void 0:un.deserialize(l.record)},s)}catch(c){o==null||o.abort(c),this.log.error("could not send %s to %p",r.type,e,c),yield is({from:e,error:c},s)}finally{this.timeout.cleanUp(a)}}async*sendMessage(e,r,s={}){if(!this.running)return;const i=r.type;if(i==null)throw new Us("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,e),yield p0({peer:e},s),yield f0({to:e,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{o=await(await this.components.connectionManager.openConnection(e,s)).newStream(this.protocol,s),await this._writeMessage(o,r,s),o.close(s).catch(l=>{this.log.error("error closing stream to %p",e,l),o==null||o.abort(l)}),yield J1({from:e,messageType:i},s)}catch(c){o==null||o.abort(c),yield is({from:e,error:c},s)}finally{this.timeout.cleanUp(a)}}async _writeMessage(e,r,s){const i=Gt(e);await i.write(r,wr,s),await i.unwrap().close(s)}async _writeReadMessage(e,r,s){const i=Gt(e);await i.write(r,wr,s);const o=await i.read(wr,s);return await i.unwrap().close(s),o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:pc(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:pc(a)})}),o}}function pl(n,t){if(n.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return n[e]<t[e]?-1:1;return 0}class J7{constructor(t,e){u(this,"originDhtKey");u(this,"capacity");u(this,"peerDistances");this.originDhtKey=t,this.capacity=e,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(t=>t.peer)}async add(t){const e=await ur(t.id);this.addWitKadId(t,e)}addWitKadId(t,e){if(this.peerDistances.find(s=>s.peer.id.equals(t.id))!=null)return;const r={peer:t,distance:no(this.originDhtKey,e)};this.peerDistances.push(r),this.peerDistances.sort((s,i)=>pl(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(t){if(this.length===0)return!0;const e=await ur(t),r=no(e,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return pl(r,s)===-1}async anyCloser(t){return t.length===0?!1:Promise.any(t.map(async e=>this.isCloser(e)))}}class iT{constructor(t,e){u(this,"log");u(this,"routingTable");u(this,"network");u(this,"validators");u(this,"queryManager");u(this,"peerStore");u(this,"peerId");const{routingTable:r,network:s,validators:i,queryManager:o,logPrefix:a}=e;this.routingTable=r,this.network=s,this.validators=i,this.queryManager=o,this.peerStore=t.peerStore,this.peerId=t.peerId,this.log=t.logger.forComponent(`${a}:peer-routing`)}async findPeerLocal(t){let e;const r=await this.routingTable.find(t);if(r!=null){this.log("findPeerLocal found %p in routing table",t);try{e=await this.peerStore.get(r)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(e==null)try{e=await this.peerStore.get(t)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(e!=null)return this.log("findPeerLocal found %p in peer store",t),{id:e.id,multiaddrs:e.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(t,e,r={}){const s={type:Ue.GET_VALUE,key:e};yield*this.network.sendRequest(t,s,r)}async*getPublicKeyFromNode(t,e={}){const r=Vx(t);for await(const s of this._getValueSingle(t,r,e))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=await Gn(X5({bytes:s.record.value}));if(!i.equals(t))throw new E("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw new E("public key missing","ERR_PUBLIC_KEY_MISSING");yield eh({from:t,value:i.publicKey},e)}throw new E(`Node not responding with its public key: ${t.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(t,e={}){if(this.log("findPeer %p",t),e.useCache!==!1){const s=await this.findPeerLocal(t);if(s!=null){this.log("found local"),yield Ku({from:this.peerId,peer:s},e);return}}let r=!1;if(e.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a}){const c={type:Ue.FIND_NODE,key:t.toBytes()};for await(const l of s.network.sendRequest(o,c,{...e,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){const h=l.closer.find(d=>d.id.equals(t));h!=null&&(yield Ku({from:l.from,peer:h},e))}};for await(const o of this.queryManager.run(t.toBytes(),i,e))o.name==="FINAL_PEER"&&(r=!0),yield o}r||(yield is({from:this.peerId,error:new E("Not found","ERR_NOT_FOUND")},e))}async*getClosestPeers(t,e={}){this.log("getClosestPeers to %b",t);const r=await _a(t),s=this.routingTable.closestPeers(r),i=this,o=new J7(r,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await o.add({id:c,multiaddrs:[]})}));const a=async function*({peer:c,signal:l}){i.log("closerPeersSingle %s from %p",W(t,"base32"),c);const h={type:Ue.FIND_NODE,key:t};yield*i.network.sendRequest(c,h,{...e,signal:l})};for await(const c of this.queryManager.run(t,a,e))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l)})),yield c;this.log("found %d peers close to %b",o.length,t);for(const c of o.peers)yield Ku({from:this.peerId,peer:c},e)}async*getValueOrPeers(t,e,r={}){for await(const s of this._getValueSingle(t,e,r)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield is({from:s.from,error:new E(o,"ERR_INVALID_RECORD")},r);continue}yield s}}async _verifyRecordOnline(t){if(t.timeReceived==null)throw new E("invalid record received","ERR_INVALID_RECORD");await Md(this.validators,new un(t.key,t.value,t.timeReceived))}async getCloserPeersOffline(t,e){const r=await _a(t),s=this.routingTable.closestPeers(r),i=[];for(const o of s)if(!o.equals(e))try{const a=await this.peerStore.get(o);i.push({id:o,multiaddrs:a.addresses.map(({multiaddr:c})=>c)})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,t,e):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",t,e,this.routingTable.size),i}}class oT{constructor(t,e={}){u(this,"log");u(this,"datastore");u(this,"cache");u(this,"cleanupInterval");u(this,"provideValidity");u(this,"syncQueue");u(this,"started");u(this,"cleaner");const{cacheSize:r,cleanupInterval:s,provideValidity:i}=e;this.log=t.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=t.datastore,this.cleanupInterval=s??Ax,this.provideValidity=i??Rx,this.cache=g8(r??Sx),this.syncQueue=new Zi({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(t=>{this.log.error(t)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{const t=Date.now();let e=0,r=0;const s=new Map,i=this.datastore.batch(),o=this.datastore.query({prefix:Z7});for await(const a of o)try{const{cid:c,peerId:l}=eg(a.key),h=tg(a.value).getTime(),d=Date.now(),f=d-h,p=f>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",d,h,f,this.provideValidity,p?"(expired)":""),p){r++,i.delete(a.key);const m=s.get(c)??new Set;m.add(l),s.set(c,m)}e++}catch(c){this.log.error(c.message)}s.size>0?(this.log("deleting %d / %d entries",r,e),await i.commit()):this.log("nothing to delete");for(const[a,c]of s){const l=ea(a),h=this.cache.get(l);if(h!=null){for(const d of c)h.delete(d);h.size===0?this.cache.remove(l):this.cache.set(l,h)}}this.log("Cleanup successful (%dms)",Date.now()-t)})}async _getProvidersMap(t){const e=ea(t);let r=this.cache.get(e);return r==null&&(r=await cT(this.datastore,t),this.cache.set(e,r)),r}async addProvider(t,e){await this.syncQueue.add(async()=>{this.log("%p provides %s",e,t);const r=await this._getProvidersMap(t);this.log("loaded %s provs",r.size);const s=new Date;r.set(e.toString(),s);const i=ea(t);this.cache.set(i,r),await aT(this.datastore,t,e,s)})}async getProviders(t){return this.syncQueue.add(async()=>(this.log("get providers for %s",t),[...(await this._getProvidersMap(t)).keys()].map(r=>Je(r))),{throwOnTimeout:!0})}}function ea(n){const t=typeof n=="string"?n:W(n.multihash.bytes,"base32");return`${Z7}/${t}`}async function aT(n,t,e,r){const s=[ea(t),"/",e.toString()].join(""),i=new $e(s),o=Ot(r.getTime());await n.put(i,o)}function eg(n){const t=n.toString().split("/");if(t.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:t[3],peerId:t[4]}}async function cT(n,t){const e=new Map,r=n.query({prefix:ea(t)});for await(const s of r){const{peerId:i}=eg(s.key);e.set(i,tg(s.value))}return e}function tg(n){return new Date(_r(n))}async function*lT(n){const{key:t,startingPeer:e,ourPeerId:r,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:h,peersSeen:d,connectionManager:f}=n,p=new $i({concurrency:o,sort:(y,w)=>pl(y.options.distance,w.options.distance)}),m=await _a(t);function g(y,w){if(y==null)return;d.add(y);const _=no(w,m);p.add(async()=>{const b=[s];l!=null&&b.push(AbortSignal.timeout(l));const v=Ze(b);j(1/0,v);try{for await(const A of i({key:t,peer:y,signal:v,pathIndex:a,numPaths:c})){if(v.aborted)return;if(A.name==="PEER_RESPONSE")for(const R of A.closer){if(d.has(R.id)){h("already seen %p in query",R.id);continue}if(r.equals(R.id)){h("not querying ourselves");continue}if(!await f.isDialable(R.multiaddrs)){h("not querying undialable peer");continue}const k=await ur(R.id),C=no(k,m);if(pl(C,_)!==-1){h("skipping %p as they are not closer to %b than %p",R.id,t,y);continue}h("querying closer peer %p",R.id),g(R.id,k)}p.safeDispatchEvent("completed",{detail:A})}}catch(A){if(!s.aborted)return is({from:y,error:A},n)}finally{v.clear()}},{distance:_}).catch(b=>{h.error(b)})}g(e,await ur(e));try{for await(const y of p.toGenerator({signal:s}))y!=null&&(yield y)}catch(y){throw s.aborted?new E("Query aborted","ERR_QUERY_ABORTED"):y}}class uT{constructor(t,e){u(this,"disjointPaths");u(this,"alpha");u(this,"shutDownController");u(this,"running");u(this,"queries");u(this,"logger");u(this,"peerId");u(this,"connectionManager");u(this,"routingTable");u(this,"initialQuerySelfHasRun");u(this,"logPrefix");u(this,"metrics");const{disjointPaths:r=Z1,alpha:s=dl,logPrefix:i}=e;this.logPrefix=i,this.disjointPaths=r??Z1,this.running=!1,this.alpha=s??dl,this.queries=0,this.initialQuerySelfHasRun=e.initialQuerySelfHasRun,this.routingTable=e.routingTable,this.logger=t.logger,this.peerId=t.peerId,this.connectionManager=t.connectionManager,t.metrics!=null&&(this.metrics={runningQueries:t.metrics.registerMetric(`${i.replaceAll(":","_")}_running_queries`),queryTime:t.metrics.registerMetric(`${i.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,j(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,j(1/0,this.shutDownController.signal)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(t,e,r={}){var h,d,f;if(!this.running)throw new Error("QueryManager not started");const s=(h=this.metrics)==null?void 0:h.queryTime.timer();if(r.signal==null){const p=AbortSignal.timeout(Cx);j(1/0,p),r={...r,signal:p}}const i=new AbortController,o=Ze([this.shutDownController.signal,i.signal,r.signal]);j(1/0,o,i.signal);const a=this.logger.forComponent(`${this.logPrefix}:query:`+W(t,"base58btc")),c=Date.now();let l=!1;try{r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial query-self query before continuing"),await dt(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),a("query:start"),this.queries++,(d=this.metrics)==null||d.runningQueries.update(this.queries);const p=await _a(t),m=this.routingTable.closestPeers(p),g=m.slice(0,Math.min(this.disjointPaths,m.length));if(m.length===0){a.error("Running query with no peers");return}const y=new _n,w=g.map((_,b)=>lT({key:t,startingPeer:_,ourPeerId:this.peerId,signal:o,query:e,pathIndex:b,numPaths:g.length,alpha:this.alpha,queryFuncTimeout:r.queryFuncTimeout,log:a,peersSeen:y,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const _ of Gr(...w)){if(_.name==="QUERY_ERROR"&&a.error("query error",_.error),_.name==="PEER_RESPONSE")for(const b of[..._.closer,..._.providers])await this.connectionManager.isDialable(b.multiaddrs)&&await this.routingTable.add(b.id);yield _}l=!0}catch(p){if(!(!this.running&&p.code==="ERR_QUERY_ABORTED"))throw p}finally{l||(a("query exited early"),i.abort()),o.clear(),this.queries--,(f=this.metrics)==null||f.runningQueries.update(this.queries),s!=null&&s(),a("query:done in %dms",Date.now()-c)}}}function hT(n){return n[Symbol.asyncIterator]!=null}function ng(n){if(hT(n))return(async()=>{let t=0;for await(const e of n)t++;return t})();{let t=0;for(const e of n)t++;return t}}const dT=n=>{const t=n.addEventListener||n.on||n.addListener,e=n.removeEventListener||n.off||n.removeListener;if(!t||!e)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(n),removeListener:e.bind(n)}};function fT(n,t,e){let r;const s=new Promise((i,o)=>{var p;if(e={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...e},!(e.count>=0&&(e.count===Number.POSITIVE_INFINITY||Number.isInteger(e.count))))throw new TypeError("The `count` option should be at least 0 or more");(p=e.signal)==null||p.throwIfAborted();const a=[t].flat(),c=[],{addListener:l,removeListener:h}=dT(n),d=(...m)=>{const g=e.multiArgs?m:m[0];e.filter&&!e.filter(g)||(c.push(g),e.count===c.length&&(r(),i(c)))},f=m=>{r(),o(m)};r=()=>{for(const m of a)h(m,d);for(const m of e.rejectionEvents)h(m,f)};for(const m of a)l(m,d);for(const m of e.rejectionEvents)l(m,f);e.signal&&e.signal.addEventListener("abort",()=>{f(e.signal.reason)},{once:!0}),e.resolveImmediately&&i(c)});if(s.cancel=r,typeof e.timeout=="number"){const i=Fa(s,{milliseconds:e.timeout});return i.cancel=r,i}return s}function th(n,t,e){typeof e=="function"&&(e={filter:e}),e={...e,count:1,resolveImmediately:!1};const r=fT(n,t,e),s=r.then(i=>i[0]);return s.cancel=r.cancel,s}class gT{constructor(t,e){u(this,"log");u(this,"peerId");u(this,"peerRouting");u(this,"routingTable");u(this,"count");u(this,"interval");u(this,"initialInterval");u(this,"queryTimeout");u(this,"started");u(this,"timeoutId");u(this,"controller");u(this,"initialQuerySelfHasRun");u(this,"querySelfPromise");const{peerRouting:r,logPrefix:s,count:i,interval:o,queryTimeout:a,routingTable:c}=e;this.peerId=t.peerId,this.log=t.logger.forComponent(`${s}:query-self`),this.started=!1,this.peerRouting=r,this.routingTable=c,this.count=i??Z1,this.interval=o??Ix,this.initialInterval=e.initialInterval??kx,this.queryTimeout=a??xx,this.initialQuerySelfHasRun=e.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(t=>{this.log.error("error running self-query",t)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=pe(),this.started){this.controller=new AbortController;const t=AbortSignal.timeout(this.queryTimeout),e=Ze([this.controller.signal,t]);j(1/0,e,this.controller.signal,t);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await th(this.routingTable,"peer:add",{signal:e})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),s=await vt(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:e,isSelfQuery:!0}),i=>qc(i,this.count),async i=>ng(i));this.log("self-query found %d peers in %dms",s,Date.now()-r)}catch(r){this.log.error("self-query error",r)}finally{e.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(t=>{this.log.error("error running self-query",t)})},this.interval))}}function pT(n,t){if(n===t)return!0;if(n.length!==t.length)return!1;for(let e=0,r=n.length;e<r;++e)if(n[e]!==t[e])return!1;return!0}function m0(n,t){if(!(t instanceof Uint8Array))throw new TypeError(n+" is not a Uint8Array");if(t.byteLength!==32)throw new TypeError(n+" had incorrect length")}function kc(n){return Array.isArray(n==null?void 0:n.peers)}class yT extends _t{constructor(e){super();u(this,"root");u(this,"localPeer");u(this,"prefixLength");u(this,"splitThreshold");u(this,"kBucketSize");u(this,"numberOfNodesToPing");this.localPeer=e.localPeer,this.prefixLength=e.prefixLength,this.kBucketSize=e.kBucketSize??xc,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfNodesToPing??3,m0("options.localPeer.kadId",e.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(e){m0("peer.kadId",e==null?void 0:e.kadId);const r=this._determineBucket(e.kadId);if(!(this._indexOf(r,e.kadId)>-1)){if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){this._split(r),this.add(e);return}if(r.peers.length<this.kBucketSize){r.peers.push(e),this.safeDispatchEvent("added",{detail:e});return}this.safeDispatchEvent("ping",{detail:{oldContacts:r.peers.slice(0,this.numberOfNodesToPing),newContact:e}})}}*closest(e,r=this.kBucketSize){const s=new J7(e,r);for(const i of this.toIterable())s.addWitKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*vr(s.peers,i=>i.id)}count(){function e(r){if(kc(r))return r.peers.length;let s=0;return r.left!=null&&(s+=e(r.left)),r.right!=null&&(s+=e(r.right)),s}return e(this.root)}get(e){const r=this._determineBucket(e),s=this._indexOf(r,e);return r.peers[s]}remove(e){const r=this._determineBucket(e),s=this._indexOf(r,e);if(s>-1){const i=r.peers.splice(s,1)[0];this.safeDispatchEvent("removed",{detail:i})}}*toIterable(){function*e(r){if(kc(r)){yield*r.peers;return}yield*e(r.left),yield*e(r.right)}yield*e(this.root)}distance(e,r){return BigInt("0x"+W(no(e,r),"base16"))}_determineBucket(e){const s=W(e,"base2").substring(0,this.prefixLength);function i(o,a=0){return kc(o)?o:s[a]==="0"?i(o.left,a+1):i(o.right,a+1)}return i(this.root)}_indexOf(e,r){return e.peers.findIndex(s=>pT(s.kadId,r))}_split(e){const r=e.depth+1,s={prefix:"0",depth:r,peers:[]},i={prefix:"1",depth:r,peers:[]};for(const o of e.peers)W(o.kadId,"base2")[r]==="0"?s.peers.push(o):i.peers.push(o);delete e.peers,e.left=s,e.right=i}}const mT="kad-close",wT=50,xc=20,bT=32,ET=1e4,_T=10;class vT extends _t{constructor(e,r){super();u(this,"kBucketSize");u(this,"kb");u(this,"pingQueue");u(this,"log");u(this,"components");u(this,"prefixLength");u(this,"splitThreshold");u(this,"pingTimeout");u(this,"pingConcurrency");u(this,"running");u(this,"protocol");u(this,"tagName");u(this,"tagValue");u(this,"metrics");this.components=e,this.log=e.logger.forComponent(`${r.logPrefix}:routing-table`),this.kBucketSize=r.kBucketSize??xc,this.pingTimeout=r.pingTimeout??ET,this.pingConcurrency=r.pingConcurrency??_T,this.running=!1,this.protocol=r.protocol,this.tagName=r.tagName??mT,this.tagValue=r.tagValue??wT,this.prefixLength=r.prefixLength??bT,this.splitThreshold=r.splitThreshold??xc,this.pingQueue=new So({concurrency:this.pingConcurrency,metricName:`${r.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",s=>{this.log.error("error pinging peer",s.detail)}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;const e=new yT({localPeer:{kadId:await ur(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",s=>{this._onPing(s).catch(i=>{this.log.error("could not process k-bucket ping event",i)})});let r=0;for(const s of await this.components.peerStore.all())if(s.protocols.includes(this.protocol)){const i=await ur(s.id);this.kb.add({kadId:i,peerId:s.id}),r++}this.log("added %d peer store peers to the routing table",r),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let r=new _n;const s=zx(()=>{const i=new _n(e.closest(e.localPeer.kadId,xc)),o=i.difference(r),a=r.difference(i);Promise.resolve().then(async()=>{for(const c of o)await this.components.peerStore.merge(c,{tags:{[this.tagName]:{value:this.tagValue}}});for(const c of a)await this.components.peerStore.merge(c,{tags:{[this.tagName]:void 0}})}).catch(c=>{this.log.error("Could not update peer tags",c)}),r=i});e.addEventListener("added",i=>{s(),this.safeDispatchEvent("peer:add",{detail:i.detail.peerId})}),e.addEventListener("removed",i=>{s(),this.safeDispatchEvent("peer:remove",{detail:i.detail.peerId})})}async _onPing(e){if(!this.running)return;const{oldContacts:r,newContact:s}=e.detail,o=(await Promise.all(r.map(async a=>{const c=this.pingQueue.find(a.peerId);return c!=null?c.join():this.pingQueue.add(async()=>{var h;let l;try{const d={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",a.peerId),l=await(await this.components.connectionManager.openConnection(a.peerId,d)).newStream(this.protocol,d);const p=Gt(l);await p.write({type:Ue.PING},wr,d);const m=await p.read(wr,d);if(await p.unwrap().close(),m.type!==Ue.PING)throw new E(`Incorrect message type received, expected PING got ${m.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(d){return this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",a.peerId,d),this.log("evicting old contact after ping failed %p",a.peerId),this.kb.remove(a.kadId)),l==null||l.abort(d),!1}finally{(h=this.metrics)==null||h.routingTableSize.update(this.size)}},{peerId:a.peerId})}))).filter(a=>a).length;this.running&&o<r.length&&this.kb!=null&&(this.log("adding new contact %p",s.peerId),this.kb.add(s))}get size(){return this.kb==null?0:this.kb.count()}async find(e){var s,i;const r=await ur(e);return(i=(s=this.kb)==null?void 0:s.get(r))==null?void 0:i.peerId}closestPeer(e){const r=this.closestPeers(e,1);if(r.length>0)return r[0]}closestPeers(e,r=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(e,r)]}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await ur(e);this.kb.add({kadId:r,peerId:e}),this.log("added %p with kad id %b",e,r),this.updateMetrics()}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await ur(e);this.kb.remove(r),this.updateMetrics()}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,r=0,s=0;function i(o){if(kc(o)){o.depth>s&&(s=o.depth),r++,e+=o.peers.length;return}i(o.left),i(o.right)}i(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(r),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/r)),this.metrics.routingTableKadBucketMaxDepth.update(s)}}const ST=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],yc=15;class RT{constructor(t,e){u(this,"log");u(this,"peerRouting");u(this,"routingTable");u(this,"refreshInterval");u(this,"refreshQueryTimeout");u(this,"commonPrefixLengthRefreshedAt");u(this,"refreshTimeoutId");const{peerRouting:r,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=e;this.log=t.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=s,this.refreshInterval=i??Tx,this.refreshQueryTimeout=o??Dx,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(t=!1){this.log("refreshing routing table");const e=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(e);this.log(`max common prefix length ${e}`),this.log(`tracked CPLs [ ${r.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(r.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,t),this._numPeersForCpl(e)===0){const o=Math.min(2*(i+1),r.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,t)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(t,e,r){if(!r&&e.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",t);return}const s=await this._generateRandomPeerId(t);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",t,s,this.routingTable.size);const i=AbortSignal.timeout(this.refreshQueryTimeout);j(1/0,i);const o=await ng(this.peerRouting.getClosestPeers(s.toBytes(),{signal:i}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",t,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(t){t>yc&&(t=yc);const e=[];for(let r=0;r<=t;r++)e[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return e}async _generateRandomPeerId(t){if(this.routingTable.kb==null)throw new Error("Routing table not started");const e=Yn(2),r=(e[1]<<8)+e[0],s=await this._makePeerId(this.routingTable.kb.localPeer.kadId,r,t);return Rn(s)}async _makePeerId(t,e,r){if(r>yc)throw new Error(`Cannot generate peer ID for common prefix length greater than ${yc}`);const o=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),c=o&a|e&~a,l=ST[c],h=new ArrayBuffer(34),d=new DataView(h,0,h.byteLength);return d.setUint8(0,We.code),d.setUint8(1,32),d.setUint32(2,l,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let t=0;for(const e of this._prefixLengths())e>t&&(t=e);return t}_numPeersForCpl(t){let e=0;for(const r of this._prefixLengths())r===t&&e++;return e}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const e=no(this.routingTable.kb.localPeer.kadId,t);let r=0;for(const s of e)if(s===0)r++;else break;yield r}}}class AT{constructor(t,e){u(this,"providers");u(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:add-provider`),this.providers=e.providers}async handle(t,e){if(this.log("start"),e.key==null||e.key.length===0)throw new E("Missing key","ERR_MISSING_KEY");let r;try{r=Q.decode(e.key)}catch{throw new E("Invalid CID","ERR_INVALID_CID")}(e.providers==null||e.providers.length===0)&&this.log.error("no providers found in message"),await Promise.all(e.providers.map(async s=>{if(!t.equals(s.id)){this.log("invalid provider peer %p from %p",s.id,t);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",t);return}this.log("received provider %p for %s (addrs %s)",t,r,s.multiaddrs.map(i=>le(i).toString())),await this.providers.addProvider(r,Rn(s.id))}))}}class IT{constructor(t,e){u(this,"peerRouting");u(this,"peerInfoMapper");u(this,"peerId");u(this,"addressManager");u(this,"log");const{peerRouting:r,logPrefix:s}=e;this.log=t.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=t.peerId,this.addressManager=t.addressManager,this.peerRouting=r,this.peerInfoMapper=e.peerInfoMapper}async handle(t,e){if(this.log("incoming request from %p for peers closer to %b",t,e.key),e.key==null)throw new E("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");const r=await this.peerRouting.getCloserPeersOffline(e.key,t);ve(this.peerId.toBytes(),e.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(se("p2p").code))});const s={type:Ue.FIND_NODE,clusterLevel:e.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toBytes(),multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0&&this.log("could not find any peers closer to %b than %p",e.key,t),s}}class kT{constructor(t,e){u(this,"peerRouting");u(this,"providers");u(this,"peerStore");u(this,"peerInfoMapper");u(this,"log");const{peerRouting:r,providers:s,logPrefix:i}=e;this.log=t.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerStore=t.peerStore,this.peerRouting=r,this.providers=s,this.peerInfoMapper=e.peerInfoMapper}async handle(t,e){if(e.key==null)throw new E("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let r;try{r=Q.decode(e.key)}catch{throw new E("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",t,r);const[s,i]=await Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(e.key,t)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:l})=>l)),c={type:Ue.GET_PROVIDERS,key:e.key,clusterLevel:e.clusterLevel,closer:a.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(h=>h.bytes)})),providers:o.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(h=>h.bytes)}))};return this.log("got %s providers %s closerPeers",c.providers.length,c.closer.length),c}async _getAddresses(t){return[]}async _getPeers(t){const e=[];for(const r of t)try{const s=await this.peerStore.get(r),i=this.peerInfoMapper({id:r,multiaddrs:s.addresses.map(({multiaddr:o})=>o)});i.multiaddrs.length>0&&e.push(i)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}return e}}class xT{constructor(t,e){u(this,"peerStore");u(this,"datastore");u(this,"peerRouting");u(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:get-value`),this.peerStore=t.peerStore,this.datastore=t.datastore,this.peerRouting=e.peerRouting}async handle(t,e){const r=e.key;if(this.log("%p asked for key %b",t,r),r==null||r.length===0)throw new E("Invalid key","ERR_INVALID_KEY");const s={type:Ue.GET_VALUE,key:r,clusterLevel:e.clusterLevel,closer:[],providers:[]};if(Hx(r)){this.log("is public key");const a=Kx(r);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new E("No public key found in key book","ERR_NOT_FOUND");c=l.id.publicKey}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null)return this.log("returning found public key"),s.record=new un(r,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(r,t)]);return i!=null&&(this.log("had record for %b in local datastore",r),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toBytes(),multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(t){this.log("checkLocalDatastore looking for %b",t);const e=Jo(t);let r;try{r=await this.datastore.get(e)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}const s=un.deserialize(r);if(s==null)throw new E("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>Ex){await this.datastore.delete(e);return}return s}}class TT{constructor(t,e){u(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:ping`)}async handle(t,e){return this.log("ping from %p",t),e}}class DT{constructor(t,e){u(this,"components");u(this,"validators");u(this,"log");const{validators:r}=e;this.components=t,this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:put-value`),this.validators=r}async handle(t,e){const r=e.key;if(this.log("%p asked us to store value for key %b",t,r),e.record==null){const s=`Empty record from: ${t.toString()}`;throw this.log.error(s),new E(s,"ERR_EMPTY_RECORD")}try{const s=un.deserialize(e.record);await Md(this.validators,s),s.timeReceived=new Date;const i=Jo(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,i)}catch(s){this.log("did not put record for key %b into datastore %o",r,s)}return e}}class CT{constructor(t,e){u(this,"handlers");u(this,"routingTable");u(this,"log");const{providers:r,peerRouting:s,validators:i,logPrefix:o,peerInfoMapper:a}=e;this.log=t.logger.forComponent(`${o}:rpc`),this.routingTable=e.routingTable,this.handlers={[Ue.GET_VALUE.toString()]:new xT(t,{peerRouting:s,logPrefix:o}),[Ue.PUT_VALUE.toString()]:new DT(t,{validators:i,logPrefix:o}),[Ue.FIND_NODE.toString()]:new IT(t,{peerRouting:s,logPrefix:o,peerInfoMapper:a}),[Ue.ADD_PROVIDER.toString()]:new AT(t,{providers:r,logPrefix:o}),[Ue.GET_PROVIDERS.toString()]:new kT(t,{peerRouting:s,providers:r,logPrefix:o,peerInfoMapper:a}),[Ue.PING.toString()]:new TT(t,{logPrefix:o})}}async handleMessage(t,e){try{await this.routingTable.add(t)}catch(s){this.log.error("Failed to update the kbucket store",s)}const r=this.handlers[e.type];if(r==null){this.log.error(`no handler found for message type: ${e.type}`);return}return r.handle(t,e)}onIncomingStream(t){Promise.resolve().then(async()=>{const{stream:e,connection:r}=t,s=r.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}const i=this;await vt(e,o=>ts(o),async function*(o){for await(const a of o){const c=wr.decode(a);i.log("incoming %s from %p",c.type,s);const l=await i.handleMessage(s,c);l!=null&&(yield wr.encode(l))}},o=>es(o),e)}).catch(e=>{this.log.error(e)})}}class NT extends _t{constructor(e,r){super();u(this,"log");u(this,"components");u(this,"protocol");u(this,"running");u(this,"registrarId");const{protocol:s,logPrefix:i}=r;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=s}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new Sn("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class LT{constructor(t){u(this,"dht");this.dht=t}async provide(t,e={}){await Bs(this.dht.provide(t,e))}async*findProviders(t,e={}){for await(const r of this.dht.findProviders(t,e))r.name==="PROVIDER"&&(yield*r.providers)}async put(t,e,r){await Bs(this.dht.put(t,e,r))}async get(t,e){for await(const r of this.dht.get(t,e))if(r.name==="VALUE")return r.value;throw new E("Not found","ERR_NOT_FOUND")}}class PT{constructor(t){u(this,"dht");this.dht=t}async findPeer(t,e={}){for await(const r of this.dht.findPeer(t,e))if(r.name==="FINAL_PEER")return r.peer;throw new E("Not found","ERR_NOT_FOUND")}async*getClosestPeers(t,e={}){for await(const r of this.dht.getClosestPeers(t,e))r.name==="FINAL_PEER"&&(yield r.peer)}}const OT=32,BT=64;var T3,D3,C3;class MT extends _t{constructor(e,r={}){super();u(this,"protocol");u(this,"routingTable");u(this,"providers");u(this,"network");u(this,"peerRouting");u(this,"components");u(this,"log");u(this,"running");u(this,"kBucketSize");u(this,"clientMode");u(this,"validators");u(this,"selectors");u(this,"queryManager");u(this,"contentFetching");u(this,"contentRouting");u(this,"routingTableRefresh");u(this,"rpc");u(this,"topologyListener");u(this,"querySelf");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"dhtContentRouting");u(this,"dhtPeerRouting");u(this,"peerInfoMapper");u(this,C3,"@libp2p/kad-dht");u(this,D3,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);u(this,T3,["@libp2p/identify"]);const{kBucketSize:s,clientMode:i,validators:o,selectors:a,querySelfInterval:c,protocol:l,logPrefix:h,pingTimeout:d,pingConcurrency:f,maxInboundStreams:p,maxOutboundStreams:m,providers:g}=r,y=h??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(y),this.protocol=l??_x,this.kBucketSize=s??20,this.clientMode=i??!0,this.maxInboundStreams=p??OT,this.maxOutboundStreams=m??BT,this.peerInfoMapper=r.peerInfoMapper??Fx,this.routingTable=new vT(e,{kBucketSize:s,pingTimeout:d,pingConcurrency:f,protocol:this.protocol,logPrefix:y}),this.providers=new oT(e,g??{}),this.validators={...Ux,...o},this.selectors={...Bx,...a},this.network=new sT(e,{protocol:this.protocol,logPrefix:y});const w=pe();r.allowQueryWithZeroPeers===!0&&w.resolve(),this.queryManager=new uT(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:y,initialQuerySelfHasRun:w,routingTable:this.routingTable}),this.peerRouting=new iT(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:y}),this.contentFetching=new jx(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:y}),this.contentRouting=new eT(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:y}),this.routingTableRefresh=new RT(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:y}),this.rpc=new CT(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:y,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new NT(e,{protocol:this.protocol,logPrefix:y}),this.querySelf=new gT(e,{peerRouting:this.peerRouting,interval:c,initialInterval:r.initialQuerySelfInterval,logPrefix:y,initialQuerySelfHasRun:w,routingTable:this.routingTable}),this.network.addEventListener("peer",_=>{const b=_.detail;this.onPeerConnect(b).catch(v=>{this.log.error("could not add %p to routing table",b.id,v)}),this.dispatchEvent(new Sn("peer",{detail:b}))}),this.topologyListener.addEventListener("peer",_=>{const b=_.detail;Promise.resolve().then(async()=>{const v=await this.components.peerStore.get(b),A={id:b,multiaddrs:v.addresses.map(({multiaddr:R})=>R),protocols:v.protocols};await this.onPeerConnect(A)}).catch(v=>{this.log.error("could not add %p to routing table",b,v)})}),this.dhtPeerRouting=new PT(this),this.dhtContentRouting=new LT(this),r.clientMode==null&&e.events.addEventListener("self:peer:update",_=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const b=_.detail.peer.addresses.some(({multiaddr:A})=>Zx(A)),v=this.getMode();b&&v==="client"?await this.setMode("server"):v==="server"&&!b&&await this.setMode("client")}).catch(b=>{this.log.error("error setting dht server mode",b)})})}get[(C3=Symbol.toStringTag,D3=Bt,T3=Ui,Oi)](){return this.dhtContentRouting}get[Bi](){return this.dhtPeerRouting}get[zc](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(r=>r.toString()));return}try{await this.routingTable.add(e.id)}catch(r){this.log.error("could not add %p to routing table",e.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await _o(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await vo(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(e,r,s={}){yield*this.contentFetching.put(e,r,s)}async*get(e,r={}){yield*this.contentFetching.get(e,r)}async*provide(e,r={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),r)}async*findProviders(e,r={}){yield*this.contentRouting.findProviders(e,r)}async*findPeer(e,r={}){yield*this.peerRouting.findPeer(e,r)}async*getClosestPeers(e,r={}){yield*this.peerRouting.getClosestPeers(e,r)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var w0;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER"})(w0||(w0={}));function UT(n={}){return t=>new MT(t,n)}var $T=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const t=Object.getPrototypeOf(n);return t===null||t===Object.prototype};const yl=$T,{hasOwnProperty:rg}=Object.prototype,{propertyIsEnumerable:FT}=Object,lo=(n,t,e)=>Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!0,configurable:!0}),VT=Z5,b0={concatArrays:!1,ignoreUndefined:!1},ou=n=>{const t=[];for(const e in n)rg.call(n,e)&&t.push(e);if(Object.getOwnPropertySymbols){const e=Object.getOwnPropertySymbols(n);for(const r of e)FT.call(n,r)&&t.push(r)}return t};function Io(n){return Array.isArray(n)?HT(n):yl(n)?KT(n):n}function HT(n){const t=n.slice(0,0);return ou(n).forEach(e=>{lo(t,e,Io(n[e]))}),t}function KT(n){const t=Object.getPrototypeOf(n)===null?Object.create(null):{};return ou(n).forEach(e=>{lo(t,e,Io(n[e]))}),t}const sg=(n,t,e,r)=>(e.forEach(s=>{typeof t[s]>"u"&&r.ignoreUndefined||(s in n&&n[s]!==Object.getPrototypeOf(n)?lo(n,s,nh(n[s],t[s],r)):lo(n,s,Io(t[s])))}),n),zT=(n,t,e)=>{let r=n.slice(0,0),s=0;return[n,t].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)rg.call(i,a)&&(o.push(String(a)),i===n?lo(r,s++,i[a]):lo(r,s++,Io(i[a])));r=sg(r,i,ou(i).filter(a=>!o.includes(a)),e)}),r};function nh(n,t,e){return e.concatArrays&&Array.isArray(n)&&Array.isArray(t)?zT(n,t,e):!yl(t)||!yl(n)?Io(t):sg(n,t,ou(t),e)}var qT=function(...n){const t=nh(Io(b0),this!==VT&&this||{},b0);let e={_:{}};for(const r of n)if(r!==void 0){if(!yl(r))throw new TypeError("`"+r+"` is not an Option Object");e=nh(e,{_:r},t)}return e._};const In=Ir(qT);function WT(n){return n>=55296&&n<=56319}function GT(n){return n>=56320&&n<=57343}var YT=function(t,e,r){if(typeof e!="string")throw new Error("Input must be string");for(var s=e.length,i=0,o,a,c=0;c<s;c+=1){if(o=e.charCodeAt(c),a=e[c],WT(o)&&GT(e.charCodeAt(c+1))&&(c+=1,a+=e[c]),i+=t(a),i===r)return e.slice(0,c+1);if(i>r)return e.slice(0,c-a.length+1)}return e};function QT(n){return n>=55296&&n<=56319}function XT(n){return n>=56320&&n<=57343}var ZT=function(t){if(typeof t!="string")throw new Error("Input must be string");for(var e=t.length,r=0,s=null,i=null,o=0;o<e;o++)s=t.charCodeAt(o),XT(s)?i!=null&&QT(i)?r+=1:r+=3:s<=127?r+=1:s>=128&&s<=2047?r+=2:s>=2048&&s<=65535&&(r+=3),i=s;return r},jT=YT,JT=ZT,eD=jT.bind(null,JT),tD=eD,nD=/[\/\?<>\\:\*\|"]/g,rD=/[\x00-\x1f\x80-\x9f]/g,sD=/^\.+$/,iD=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,oD=/[\. ]+$/;function E0(n,t){if(typeof n!="string")throw new Error("Input must be string");var e=n.replace(nD,t).replace(rD,t).replace(sD,t).replace(iD,t).replace(oD,t);return tD(e,255)}var aD=function(n,t){var e=t&&t.replacement||"",r=E0(n,e);return e===""?r:E0(r,"")};const cD=Ir(aD);var _e;(function(n){n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",n.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",n.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",n.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",n.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",n.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",n.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",n.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",n.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",n.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",n.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",n.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",n.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",n.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(_e||(_e={}));const lD="/pkcs8/",ig="/info/",ps=new WeakMap,ys={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},qu={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function tr(n){return n==null||typeof n!="string"?!1:n===cD(n.trim())&&n.length>0}async function Ce(){const e=Math.random()*800+200;await new Promise(r=>setTimeout(r,e))}function Dn(n){return new $e(lD+n)}function Or(n){return new $e(ig+n)}var N3,L3;L3=Symbol.toStringTag,N3=Bt;class uD{constructor(t,e){u(this,"components");u(this,"init");u(this,"log");u(this,L3,"@libp2p/keychain");u(this,N3,["@libp2p/keychain"]);var s,i,o,a,c,l,h,d,f,p;if(this.components=t,this.log=t.logger.forComponent("libp2p:keychain"),this.init=In(qu,e),this.init.pass!=null&&((s=this.init.pass)==null?void 0:s.length)<20)throw new Error("pass must be least 20 characters");if(((i=this.init.dek)==null?void 0:i.keyLength)!=null&&this.init.dek.keyLength<ys.minKeyLength)throw new Error(`dek.keyLength must be least ${ys.minKeyLength} bytes`);if(((a=(o=this.init.dek)==null?void 0:o.salt)==null?void 0:a.length)!=null&&this.init.dek.salt.length<ys.minSaltLength)throw new Error(`dek.saltLength must be least ${ys.minSaltLength} bytes`);if(((c=this.init.dek)==null?void 0:c.iterationCount)!=null&&this.init.dek.iterationCount<ys.minIterationCount)throw new Error(`dek.iterationCount must be least ${ys.minIterationCount}`);const r=this.init.pass!=null&&((l=this.init.dek)==null?void 0:l.salt)!=null?Xf(this.init.pass,(h=this.init.dek)==null?void 0:h.salt,(d=this.init.dek)==null?void 0:d.iterationCount,(f=this.init.dek)==null?void 0:f.keyLength,(p=this.init.dek)==null?void 0:p.hash):"";ps.set(this,{dek:r})}static generateOptions(){const t=Object.assign({},qu),e=Math.ceil(ys.minSaltLength/3)*3;return t.dek.salt=W(Yn(e),"base64"),t}static get options(){return qu}async createKey(t,e,r=2048){if(!tr(t)||t==="self")throw await Ce(),new E("Invalid key name",_e.ERR_INVALID_KEY_NAME);if(typeof e!="string")throw await Ce(),new E("Invalid key type",_e.ERR_INVALID_KEY_TYPE);const s=Dn(t);if(await this.components.datastore.has(s))throw await Ce(),new E("Key name already exists",_e.ERR_KEY_ALREADY_EXISTS);switch(e.toLowerCase()){case"rsa":if(!Number.isSafeInteger(r)||r<2048)throw await Ce(),new E("Invalid RSA key size",_e.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await Q5(e,r),c=await a.id(),l=ps.get(this);if(l==null)throw new E("dek missing",_e.ERR_INVALID_PARAMETERS);const h=l.dek,d=await a.export(h);o={name:t,id:c};const f=this.components.datastore.batch();f.put(s,V(d)),f.put(Or(t),V(JSON.stringify(o))),await f.commit()}catch(a){throw await Ce(),a}return o}async listKeys(){const t={prefix:ig},e=[];for await(const r of this.components.datastore.query(t))e.push(JSON.parse(W(r.value)));return e}async findKeyById(t){try{const r=(await this.listKeys()).find(s=>s.id===t);if(r==null)throw new E(`Key with id '${t}' does not exist.`,_e.ERR_KEY_NOT_FOUND);return r}catch(e){throw await Ce(),e}}async findKeyByName(t){if(!tr(t))throw await Ce(),new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);const e=Or(t);try{const r=await this.components.datastore.get(e);return JSON.parse(W(r))}catch(r){throw await Ce(),this.log.error(r),new E(`Key '${t}' does not exist.`,_e.ERR_KEY_NOT_FOUND)}}async removeKey(t){if(!tr(t)||t==="self")throw await Ce(),new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);const e=Dn(t),r=await this.findKeyByName(t),s=this.components.datastore.batch();return s.delete(e),s.delete(Or(t)),await s.commit(),r}async renameKey(t,e){if(!tr(t)||t==="self")throw await Ce(),new E(`Invalid old key name '${t}'`,_e.ERR_OLD_KEY_NAME_INVALID);if(!tr(e)||e==="self")throw await Ce(),new E(`Invalid new key name '${e}'`,_e.ERR_NEW_KEY_NAME_INVALID);const r=Dn(t),s=Dn(e),i=Or(t),o=Or(e);if(await this.components.datastore.has(s))throw await Ce(),new E(`Key '${e}' already exists`,_e.ERR_KEY_ALREADY_EXISTS);try{const c=await this.components.datastore.get(r),l=await this.components.datastore.get(i),h=JSON.parse(W(l));h.name=e;const d=this.components.datastore.batch();return d.put(s,c),d.put(o,V(JSON.stringify(h))),d.delete(r),d.delete(i),await d.commit(),h}catch(c){throw await Ce(),c}}async exportKey(t,e){if(!tr(t))throw await Ce(),new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);if(e==null)throw await Ce(),new E("Password is required",_e.ERR_PASSWORD_REQUIRED);const r=Dn(t);try{const s=await this.components.datastore.get(r),i=W(s),o=ps.get(this);if(o==null)throw new E("dek missing",_e.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await sc(i,a)).export(e)}catch(s){throw await Ce(),s}}async exportPeerId(t){const e="temporary-password",r=await this.exportKey(t,e),s=await sc(r,e);return Gn(s.public.bytes,s.bytes)}async importKey(t,e,r){if(!tr(t)||t==="self")throw await Ce(),new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);if(e==null)throw await Ce(),new E("PEM encoded key is required",_e.ERR_PEM_REQUIRED);const s=Dn(t);if(await this.components.datastore.has(s))throw await Ce(),new E(`Key '${t}' already exists`,_e.ERR_KEY_ALREADY_EXISTS);let o;try{o=await sc(e,r)}catch{throw await Ce(),new E("Cannot read the key, most likely the password is wrong",_e.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const h=ps.get(this);if(h==null)throw new E("dek missing",_e.ERR_INVALID_PARAMETERS);const d=h.dek;e=await o.export(d)}catch(h){throw await Ce(),h}const c={name:t,id:a},l=this.components.datastore.batch();return l.put(s,V(e)),l.put(Or(t),V(JSON.stringify(c))),await l.commit(),c}async importPeer(t,e){try{if(!tr(t))throw new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);if(e==null)throw new E("PeerId is required",_e.ERR_MISSING_PRIVATE_KEY);if(e.privateKey==null)throw new E("PeerId.privKey is required",_e.ERR_MISSING_PRIVATE_KEY);const r=await Gi(e.privateKey),s=Dn(t);if(await this.components.datastore.has(s))throw await Ce(),new E(`Key '${t}' already exists`,_e.ERR_KEY_ALREADY_EXISTS);const o=ps.get(this);if(o==null)throw new E("dek missing",_e.ERR_INVALID_PARAMETERS);const a=o.dek,c=await r.export(a),l={name:t,id:e.toString()},h=this.components.datastore.batch();return h.put(s,V(c)),h.put(Or(t),V(JSON.stringify(l))),await h.commit(),l}catch(r){throw await Ce(),r}}async getPrivateKey(t){if(!tr(t))throw await Ce(),new E(`Invalid key name '${t}'`,_e.ERR_INVALID_KEY_NAME);try{const e=Dn(t),r=await this.components.datastore.get(e);return W(r)}catch(e){throw await Ce(),this.log.error(e),new E(`Key '${t}' does not exist.`,_e.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(t,e){var a,c,l,h;if(typeof t!="string")throw await Ce(),new E(`Invalid old pass type '${typeof t}'`,_e.ERR_INVALID_OLD_PASS_TYPE);if(typeof e!="string")throw await Ce(),new E(`Invalid new pass type '${typeof e}'`,_e.ERR_INVALID_NEW_PASS_TYPE);if(e.length<20)throw await Ce(),new E(`Invalid pass length ${e.length}`,_e.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");const r=ps.get(this);if(r==null)throw new E("dek missing",_e.ERR_INVALID_PARAMETERS);const s=r.dek;this.init.pass=e;const i=e!=null&&((a=this.init.dek)==null?void 0:a.salt)!=null?Xf(e,this.init.dek.salt,(c=this.init.dek)==null?void 0:c.iterationCount,(l=this.init.dek)==null?void 0:l.keyLength,(h=this.init.dek)==null?void 0:h.hash):"";ps.set(this,{dek:i});const o=await this.listKeys();for(const d of o){const f=await this.components.datastore.get(Dn(d.name)),p=W(f),m=await sc(p,s),g=i.toString(),y=await m.export(g),w=this.components.datastore.batch(),_={name:d.name,id:d.id};w.put(Dn(d.name),V(y)),w.put(Or(d.name),V(JSON.stringify(_))),await w.commit()}this.log("keychain reconstructed")}}function og(n={}){return t=>new uD(t,n)}class ag{constructor(t={}){u(this,"memoryStorage");u(this,"points");u(this,"duration");u(this,"blockDuration");u(this,"execEvenly");u(this,"execEvenlyMinDelayMs");u(this,"keyPrefix");this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new hD}async consume(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(s,e,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+e&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new E("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await W7(a)}return o}penalty(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,-e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(t,e){const r=e*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(t),s,e),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(t,e,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:e,isFirstInDuration:!1}}get(t){const e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return(t==null?void 0:t.customDuration)!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}}class hD{constructor(){u(this,"storage");this.storage=new Map}incrby(t,e,r){const s=this.storage.get(t);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=e,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(t,e,r)}return this.set(t,e,r)}set(t,e,r){const s=r*1e3,i=this.storage.get(t);i!=null&&clearTimeout(i.timeoutId);const o={value:e,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(t,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(t)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(t){const e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){const e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}}var Ae;(function(n){n[n.NEW_STREAM=0]="NEW_STREAM",n[n.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",n[n.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",n[n.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",n[n.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",n[n.RESET_RECEIVER=5]="RESET_RECEIVER",n[n.RESET_INITIATOR=6]="RESET_INITIATOR"})(Ae||(Ae={}));const Ud=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),_0=Object.freeze({NEW_STREAM:Ae.NEW_STREAM,MESSAGE:Ae.MESSAGE_INITIATOR,CLOSE:Ae.CLOSE_INITIATOR,RESET:Ae.RESET_INITIATOR}),dD=Object.freeze({MESSAGE:Ae.MESSAGE_RECEIVER,CLOSE:Ae.CLOSE_RECEIVER,RESET:Ae.RESET_RECEIVER}),cg=1<<20,fD=4<<20;class gD{constructor(t=cg,e=fD){u(this,"_buffer");u(this,"_headerInfo");u(this,"_maxMessageSize");u(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Ie,this._headerInfo=null,this._maxMessageSize=t,this._maxUnprocessedMessageQueueSize=e}write(t){if(t==null||t.length===0)return[];if(this._buffer.append(t),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const e=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.code==="ERR_MSG_TOO_BIG")throw l;break}const{id:r,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:r,type:s};(s===Ae.NEW_STREAM||s===Ae.MESSAGE_INITIATOR||s===Ae.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),e.push(c),this._buffer.consume(o+i),this._headerInfo=null}return e}_decodeHeader(t){const{value:e,offset:r}=S0(t),{value:s,offset:i}=S0(t,r),o=e&7;if(Ud[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:e>>3,type:o,offset:r+i,length:s}}}const pD=128,v0=127;function S0(n,t=0){let e=0,r=0,s=t,i;const o=n.length;do{if(s>=o||r>49)throw t=0,new RangeError("Could not decode varint");i=n.get(s++),e+=r<28?(i&v0)<<r:(i&v0)*Math.pow(2,r),r+=7}while(i>=pD);return t=s-t,{value:e,offset:t}}const Wu=10*1024;class yD{constructor(){u(this,"_pool");u(this,"_poolOffset");this._pool=Jt(Wu),this._poolOffset=0}write(t,e){const r=this._pool;let s=this._poolOffset;Ot(t.id<<3|t.type,r,s),s+=He(t.id<<3|t.type),(t.type===Ae.NEW_STREAM||t.type===Ae.MESSAGE_INITIATOR||t.type===Ae.MESSAGE_RECEIVER)&&t.data!=null?(Ot(t.data.length,r,s),s+=He(t.data.length)):(Ot(0,r,s),s+=He(0));const i=r.subarray(this._poolOffset,s);Wu-s<100?(this._pool=Jt(Wu),this._poolOffset=0):this._poolOffset=s,e.append(i),(t.type===Ae.NEW_STREAM||t.type===Ae.MESSAGE_INITIATOR||t.type===Ae.MESSAGE_RECEIVER)&&t.data!=null&&e.append(t.data)}}const mD=new yD;async function*wD(n){for await(const t of n){const e=new Ie;mD.write(t,e),yield e}}class bD extends nu{constructor(e){super(e);u(this,"name");u(this,"streamId");u(this,"send");u(this,"types");u(this,"maxDataSize");this.types=e.direction==="outbound"?_0:dD,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:_0.NEW_STREAM,data:new Ie(V(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const r=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,r)}),e.consume(r)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function ED(n){const{id:t,name:e,send:r,onEnd:s,type:i="initiator",maxMsgSize:o=cg}=n;return new bD({id:i==="initiator"?`i${t}`:`r${t}`,streamId:t,name:`${e??t}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:s,send:r,log:n.logger.forComponent(`libp2p:mplex:stream:${i}:${t}`)})}const _D=1024,vD=1024,SD=1024*1024*4,RD=5,AD=500;function R0(n){const t={...n,type:`${Ud[n.type]} (${n.type})`};return n.type===Ae.NEW_STREAM&&(t.data=W(n.data instanceof Uint8Array?n.data:n.data.subarray())),(n.type===Ae.MESSAGE_INITIATOR||n.type===Ae.MESSAGE_RECEIVER)&&(t.data=W(n.data instanceof Uint8Array?n.data:n.data.subarray(),"base16")),t}class ID{constructor(t,e){u(this,"protocol","/mplex/6.7.0");u(this,"sink");u(this,"source");u(this,"log");u(this,"_streamId");u(this,"_streams");u(this,"_init");u(this,"_source");u(this,"closeController");u(this,"rateLimiter");u(this,"closeTimeout");u(this,"logger");e=e??{},this.log=t.logger.forComponent("libp2p:mplex"),this.logger=t.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.closeTimeout=e.closeTimeout??AD,this.sink=this._createSink(),this._source=ls({objectMode:!0,onEnd:()=>{for(const r of this._streams.initiators.values())r.destroy();for(const r of this._streams.receivers.values())r.destroy()}}),this.source=vt(this._source,r=>wD(r)),this.closeController=new AbortController,this.rateLimiter=new ag({points:e.disconnectThreshold??RD,duration:1})}get streams(){const t=[];for(const e of this._streams.initiators.values())t.push(e);for(const e of this._streams.receivers.values())t.push(e);return t}newStream(t){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const e=this._streamId++;t=t==null?e.toString():t.toString();const r=this._streams.initiators;return this._newStream({id:e,name:t,type:"initiator",registry:r})}async close(t){if(this.closeController.signal.aborted)return;const e=(t==null?void 0:t.signal)??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async r=>r.close({signal:e}))),this._source.end(),await this._source.onEmpty({signal:e}),this.closeController.abort()}catch(r){this.abort(r)}}abort(t){this.closeController.signal.aborted||(this.streams.forEach(e=>{e.abort(t)}),this.closeController.abort(t))}_newReceiverStream(t){const{id:e,name:r}=t,s=this._streams.receivers;return this._newStream({id:e,name:r,type:"receiver",registry:s})}_newStream(t){const{id:e,name:r,type:s,registry:i}=t;if(this.log("new %s stream %s",s,e),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??vD))throw new E("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(e))throw new Error(`${s} stream ${e} already exists!`);const c=ED({id:e,name:r,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",s,e,R0(l)),this._source.push(l)},type:s,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",s,e,c.protocol),i.delete(e),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(e,c),c}_createSink(){return async e=>{const r=()=>{P7(e,this.log)};this.closeController.signal.addEventListener("abort",r);try{const s=new gD(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of e)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){this.log("error in sink",s),this._source.end(s)}finally{this.closeController.signal.removeEventListener("abort",r)}}}async _handleIncoming(t){const{id:e,type:r}=t;if(this.log.enabled&&this.log.trace("incoming message",R0(t)),t.type===Ae.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??_D)){this.log("too many inbound streams open"),this._source.push({id:e,type:Ae.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:e,name:W(t.data instanceof Uint8Array?t.data:t.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((r&1)===1?this._streams.initiators:this._streams.receivers).get(e);if(i==null){this.log("missing stream %s for message type %s",e,Ud[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??SD;try{switch(r){case Ae.MESSAGE_INITIATOR:case Ae.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o)throw this._source.push({id:t.id,type:r===Ae.MESSAGE_INITIATOR?Ae.RESET_RECEIVER:Ae.RESET_INITIATOR}),new E("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");i.sourcePush(t.data);break;case Ae.CLOSE_INITIATOR:case Ae.CLOSE_RECEIVER:i.remoteCloseWrite();break;case Ae.RESET_INITIATOR:case Ae.RESET_RECEIVER:i.reset();break;default:this.log("unknown message type %s",r)}}catch(a){this.log.error("error while processing message",a),i.abort(a)}}}var P3,O3;O3=Symbol.toStringTag,P3=Bt;class kD{constructor(t,e={}){u(this,"protocol","/mplex/6.7.0");u(this,"_init");u(this,"components");u(this,O3,"@libp2p/mplex");u(this,P3,["@libp2p/stream-multiplexing"]);this.components=t,this._init=e}createStreamMuxer(t={}){return new ID(this.components,{...t,...this._init})}}function xD(n={}){return t=>new kD(t,n)}const A0=32,TD="1.0.0",DD="ping",CD="ipfs",ND=1e4,LD=2,PD=1,I0="ERR_WRONG_PING_ACK";var B3;B3=Symbol.toStringTag;class OD{constructor(t,e={}){u(this,"protocol");u(this,"components");u(this,"started");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"runOnTransientConnection");u(this,"log");u(this,B3,"@libp2p/ping");this.components=t,this.log=t.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${e.protocolPrefix??CD}/${DD}/${TD}`,this.timeout=e.timeout??ND,this.maxInboundStreams=e.maxInboundStreams??LD,this.maxOutboundStreams=e.maxOutboundStreams??PD,this.runOnTransientConnection=e.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(t){this.log("incoming ping from %p",t.connection.remotePeer);const{stream:e}=t,r=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",()=>{e==null||e.abort(new E("ping timeout",Mi))}),vt(e,async function*(i){let o=0;for await(const a of i){if(o+=a.byteLength,o>A0){e==null||e.abort(new E("Too much data received",ws));return}yield a}},e).catch(i=>{this.log.error("incoming ping from %p failed with error",t.connection.remotePeer,i),e==null||e.abort(i)}).finally(()=>{const i=Date.now()-r;this.log("incoming ping from %p complete in %dms",t.connection.remotePeer,i)})}async ping(t,e={}){var c,l;this.log("pinging %p",t);const r=Date.now(),s=Yn(A0),i=await this.components.connectionManager.openConnection(t,e);let o,a=()=>{};if(e.signal==null){const h=AbortSignal.timeout(this.timeout);e={...e,signal:h}}try{o=await i.newStream(this.protocol,{...e,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{o==null||o.abort(new E("ping timeout",Mi))},(c=e.signal)==null||c.addEventListener("abort",a,{once:!0});const h=await vt([s],o,async f=>Ji(f)),d=Date.now()-r;if(h==null)throw new E(`Did not receive a ping ack after ${d}ms`,I0);if(!ve(s,h.subarray()))throw new E(`Received wrong ping ack after ${d}ms`,I0);return this.log("ping %p complete in %dms",i.remotePeer,d),d}catch(h){throw this.log.error("error while pinging %p",i.remotePeer,h),o==null||o.abort(h),h}finally{(l=e.signal)==null||l.removeEventListener("abort",a),o!=null&&await o.close()}}}function BD(n={}){return t=>new OD(t,n)}var cn;(function(n){n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",n.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",n.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(cn||(cn={}));class ko extends E{constructor(t,e){super(`WebRTC transport error: ${t}`,e??""),this.name="WebRTCTransportError"}}class MD extends ko{constructor(t,e){super(`[stream: ${t}] data channel error: ${e}`,cn.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function k0(n,t){return new MD(n,t)}class UD extends ko{constructor(t){super(`There was a problem with the Multiaddr which was passed in: ${t}`,cn.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function lg(n){return new UD(n)}class $D extends ko{constructor(t){super(`There was a problem with a provided argument: ${t}`,cn.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function rh(n){return new $D(n)}class FD extends ko{constructor(t,e){super(`Invalid fingerprint "${t}" within ${e}`,cn.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function ug(n,t){return new FD(n,t)}class VD extends ko{constructor(t){super(`A method (${t}) was called though it has been intentionally left unimplemented.`,cn.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}function HD(n){return new VD(n)}class KD extends ko{constructor(t){super(`unsupported hash algorithm code: ${t} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,cn.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}function zD(n){return new KD(n)}var x0=function(n,t,e){if(e||arguments.length===2)for(var r=0,s=t.length,i;r<s;r++)(i||!(r in t))&&(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return n.concat(i||Array.prototype.slice.call(t))},qD=function(){function n(t,e,r){this.name=t,this.version=e,this.os=r,this.type="browser"}return n}(),WD=function(){function n(t){this.version=t,this.type="node",this.name="node",this.os=process.platform}return n}(),GD=function(){function n(t,e,r,s){this.name=t,this.version=e,this.os=r,this.bot=s,this.type="bot-device"}return n}(),YD=function(){function n(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return n}(),QD=function(){function n(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return n}(),XD=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,ZD=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,T0=3,jD=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",XD]],D0=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function JD(n){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new QD:typeof navigator<"u"?tC(navigator.userAgent):rC()}function eC(n){return n!==""&&jD.reduce(function(t,e){var r=e[0],s=e[1];if(t)return t;var i=s.exec(n);return!!i&&[r,i]},!1)}function tC(n){var t=eC(n);if(!t)return null;var e=t[0],r=t[1];if(e==="searchbot")return new YD;var s=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);s?s.length<T0&&(s=x0(x0([],s,!0),sC(T0-s.length),!0)):s=[];var i=s.join("."),o=nC(n),a=ZD.exec(n);return a&&a[1]?new GD(e,i,o,a[1]):new qD(e,i,o)}function nC(n){for(var t=0,e=D0.length;t<e;t++){var r=D0[t],s=r[0],i=r[1],o=i.exec(n);if(o)return s}return null}function rC(){var n=typeof process<"u"&&process.version;return n?new WD(process.version.slice(1)):null}function sC(n){for(var t=[],e=0;e<n;e++)t.push("0");return t}const iC=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],C0=JD(),$d=C0!=null&&C0.name==="firefox",hg=async function*(){},dg=async n=>{},oC=30*1e3;function aC(n,t,e=oC,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,n.bufferedAmount);const s=pe();let i=!1;n.bufferedAmountLowThreshold=0;const o=()=>{i||(r.log("%s drain channel closed before drain",t),s.resolve())};n.addEventListener("close",o,{once:!0}),n.addEventListener("bufferedamountlow",()=>{i=!0,n.removeEventListener("close",o),s.resolve()}),await Fa(s.promise,{milliseconds:e})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(s=>{r.log.error("error closing outbound stream",s)})}async function sh(n){return n=n??{},typeof n=="function"&&(n=await n()),n.iceServers=n.iceServers??iC.map(t=>({urls:[t]})),n}class ih{constructor(t,e){u(this,"log");u(this,"peerConnection");u(this,"remoteAddr");u(this,"timeline");u(this,"metrics");u(this,"source",hg());u(this,"sink",dg);this.log=t.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=e.remoteAddr,this.timeline=e.timeline,this.peerConnection=e.peerConnection;const r=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",r),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(t){var e;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(e=this.metrics)==null||e.increment({close:!0})}abort(t){var e;this.log.error("closing connection due to error",t),this.peerConnection.close(),this.timeline.close=Date.now(),(e=this.metrics)==null||e.increment({abort:!0})}}var Vt;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let t;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.Flag||(n.Flag={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.flag!=null&&(s.uint32(8),n.Flag.codec().encode(r.flag,s)),r.message!=null&&(s.uint32(18),s.bytes(r.message)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.flag=n.Flag.codec().decode(r);break;case 2:i.message=r.bytes();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(Vt||(Vt={}));const cC=2*1024*1024,lC=30*1e3,Fd=16*1024;function uC(n=Fd){const t=He(n-He(n)),e=1+He(Object.keys(Vt.Flag).length-1),r=1,s=n-t-e-r,i=He(s);return t+e+r+i}const hC=uC(),dC=5e3,fC=5e3;class gC extends nu{constructor(e){const r=e.onEnd;e.onEnd=i=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Fa(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),r==null||r(i)}).catch(o=>{this.log.error("error ending stream",o)})};super(e);u(this,"channel");u(this,"incomingData");u(this,"maxBufferedAmount");u(this,"bufferedAmountLowEventTimeout");u(this,"maxMessageSize");u(this,"receiveFinAck");u(this,"finAckTimeout");u(this,"openTimeout");switch(this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=ls(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??lC,this.maxBufferedAmount=e.maxBufferedAmount??cC,this.maxMessageSize=(e.maxMessageSize??Fd)-hC,this.receiveFinAck=pe(),this.finAckTimeout=e.closeTimeout??dC,this.openTimeout=e.openTimeout??fC,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new E("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime()},this.channel.onclose=i=>{this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=i=>{const o=i.error;this.abort(o)},this.channel.onmessage=async i=>{const{data:o}=i;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const s=this;Promise.resolve().then(async()=>{for await(const i of ts(this.incomingData)){const o=s.processIncomingProtobuf(i);o!=null&&s.sourcePush(new Ie(o))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,r=!0){if(r&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await th(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(s){throw s instanceof vd?new E(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):s}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new E(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");this.channel.readyState!=="open"&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await th(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const r=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,r),i=Vt.encode({message:s}),o=es.single(i);await this._sendMessage(o),e.consume(r)}}async sendReset(){await this._sendFlag(Vt.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(Vt.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await dt(this.receiveFinAck.promise,e==null?void 0:e.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(s){this.log.error("failed to await FIN_ACK",s)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(Vt.Flag.STOP_SENDING)}processIncomingProtobuf(e){const r=Vt.decode(e);if(r.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',r.flag,this.writeStatus,this.readStatus),r.flag===Vt.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Vt.Flag.FIN_ACK).catch(s=>{this.log.error("error sending FIN_ACK immediately",s)})),r.flag===Vt.Flag.RESET&&this.reset(),r.flag===Vt.Flag.STOP_SENDING&&this.remoteCloseRead(),r.flag===Vt.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return r.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const r=Vt.encode({flag:e}),s=es.single(r);try{return await this._sendMessage(s,!1),!0}catch(i){this.log.error("could not send flag %s",e.toString(),i)}return!1}}function ml(n){const{channel:t,direction:e}=n;return new gC({id:e==="inbound"?`i${t.id}`:`r${t.id}`,log:n.logger.forComponent(`libp2p:webrtc:stream:${e}:${t.id}`),...n})}const fg="/webrtc";class Vd{constructor(t,e){u(this,"protocol");u(this,"peerConnection");u(this,"bufferedStreams",[]);u(this,"metrics");u(this,"dataChannelOptions");u(this,"components");u(this,"log");this.components=t,this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??fg,this.dataChannelOptions=e.dataChannelOptions??{},this.log=t.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const s={},i=ml({channel:r,direction:"inbound",onEnd:o=>{s.onEnd(o)},logger:t.logger,...this.dataChannelOptions});s.stream=i,s.channel=r,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(t){return new pC(this.components,{...t,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var Ci,Tc;class pC{constructor(t,e){fe(this,Ci);u(this,"init");u(this,"streams");u(this,"protocol");u(this,"log");u(this,"peerConnection");u(this,"dataChannelOptions");u(this,"metrics");u(this,"logger");u(this,"source",hg());u(this,"sink",dg);this.init=e,this.log=t.logger.forComponent("libp2p:webrtc:muxer"),this.logger=t.logger,this.streams=e.streams.map(r=>r.stream),this.peerConnection=e.peerConnection,this.protocol=e.protocol??fg,this.metrics=e.metrics,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:r})=>{var i,o;if(this.log.trace("incoming datachannel with channel id %d",r.id),r.label==="init"){this.log.trace("closing init channel"),r.close();return}const s=ml({channel:r,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",r.id,r.readyState),re(this,Ci,Tc).call(this,s,r)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),(i=this.metrics)==null||i.increment({incoming_stream:!0}),(o=e==null?void 0:e.onIncomingStream)==null||o.call(e,s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(r=>{var s,i,o;r.onEnd=()=>{this.log("incoming early channel %s ended with state %s",r.channel.id,r.channel.readyState),re(this,Ci,Tc).call(this,r.stream,r.channel)},(s=this.metrics)==null||s.increment({incoming_stream:!0}),(o=(i=this.init)==null?void 0:i.onIncomingStream)==null||o.call(i,r.stream)})})}async close(t){try{await Promise.all(this.streams.map(async e=>e.close(t)))}catch(e){this.abort(e)}}abort(t){for(const e of this.streams)e.abort(t)}newStream(){var r;const t=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",t.id);const e=ml({channel:t,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",t.id,t.readyState),re(this,Ci,Tc).call(this,e,t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(e),(r=this.metrics)==null||r.increment({outgoing_stream:!0}),e}}Ci=new WeakSet,Tc=function(t,e){var r,s,i;this.log.trace("stream %s %s %s onEnd",t.direction,t.id,t.protocol),aC(e,`${t.direction} ${t.id} ${t.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==t.id),(r=this.metrics)==null||r.increment({stream_end:!0}),(i=(s=this.init)==null?void 0:s.onStreamEnd)==null||i.call(s,t)};const wl=globalThis.RTCPeerConnection,gg=globalThis.RTCSessionDescription,yC=globalThis.RTCIceCandidate;var En;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let t;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.data!=null&&(s.uint32(18),s.string(r.data)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.type=n.Type.codec().decode(r);break;case 2:i.data=r.string();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(En||(En={}));const pg=async(n,t,e)=>{var r,s,i,o;try{const a=pe();for(wC(n,a);;){const c=await Promise.race([a.promise,t.read({signal:e.signal}).catch(()=>{})]);if(c==null){(r=e.signal)==null||r.throwIfAborted();break}if(c.type!==En.Type.ICE_CANDIDATE)throw new E("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const l=JSON.parse(c.data??"null");if(l===""||l===null){(s=e.onProgress)==null||s.call(e,new G("webrtc:end-of-ice-candidates")),e.log.trace("end-of-candidates received");continue}const h=new yC(l);e.log.trace("%s received new ICE candidate %o",e.direction,l);try{(i=e.onProgress)==null||i.call(e,new G("webrtc:add-ice-candidate",h.candidate)),await n.addIceCandidate(h)}catch(d){e.log.error("%s bad candidate received",e.direction,l,d)}}}catch(a){if(e.log.error("%s error parsing ICE candidate",e.direction,a),((o=e.signal)==null?void 0:o.aborted)===!0)throw a}};function mC(n){return $d?n.iceConnectionState:n.connectionState}function wC(n,t){n[$d?"oniceconnectionstatechange":"onconnectionstatechange"]=e=>{switch(mC(n)){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new E("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break}}}async function bC({rtcConfiguration:n,dataChannel:t,signal:e,metrics:r,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:l}){const{baseAddr:h}=IC(s);r==null||r.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",h);const d=h.getPeerId();if(d==null)throw new E("Relay peer was missing","ERR_INVALID_ADDRESS");const f=i.getConnections(Je(d));let p,m=!1;f.length===0?(l==null||l(new G("webrtc:dial-relay")),p=await o.dial(h,{signal:e,onProgress:l}),m=!0):(l==null||l(new G("webrtc:reuse-relay-connection")),p=f[0]);try{l==null||l(new G("webrtc:open-signaling-stream"));const g=await p.newStream(oh,{signal:e,runOnTransientConnection:!0}),y=Gt(g).pb(En),w=new wl(n),_=new Vd({logger:c},{peerConnection:w,dataChannelOptions:t});try{const b=w.createDataChannel("init");w.onicecandidate=({candidate:k})=>{const C=JSON.stringify((k==null?void 0:k.toJSON())??null);a.trace("initiator sending ICE candidate %o",k),y.write({type:En.Type.ICE_CANDIDATE,data:C},{signal:e}).catch(S=>{a.error("error sending ICE candidate",S)})},w.onicecandidateerror=k=>{a.error("initiator ICE candidate error",k)};const v=await w.createOffer().catch(k=>{throw a.error("could not execute createOffer",k),new E("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});a.trace("initiator send SDP offer %s",v.sdp),l==null||l(new G("webrtc:send-sdp-offer")),await y.write({type:En.Type.SDP_OFFER,data:v.sdp},{signal:e}),await w.setLocalDescription(v).catch(k=>{throw a.error("could not execute setLocalDescription",k),new E("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),l==null||l(new G("webrtc:read-sdp-answer"));const A=await y.read({signal:e});if(A.type!==En.Type.SDP_ANSWER)throw new E("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",A.data);const R=new gg({type:"answer",sdp:A.data});return await w.setRemoteDescription(R).catch(k=>{throw a.error("could not execute setRemoteDescription",k),new E("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.trace("initiator read candidates until connected"),l==null||l(new G("webrtc:read-ice-candidates")),await pg(w,y,{direction:"initiator",signal:e,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),b.close(),l==null||l(new G("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:e}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:w,muxerFactory:_}}catch(b){throw a.error("outgoing signaling error",b),w.close(),g.abort(b),b}finally{w.onicecandidate=null,w.onicecandidateerror=null}}finally{if(m)try{await p.close({signal:e})}catch(g){p.abort(g)}}}class EC extends _t{constructor(e,r){super();u(this,"peerId");u(this,"transportManager");u(this,"shutdownController");this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=r.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(r=>Rs.matches(r)).map(r=>r.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}async function _C({peerConnection:n,stream:t,signal:e,connection:r,log:s}){s.trace("new inbound signaling stream");const i=Gt(t).pb(En);try{n.onicecandidate=({candidate:h})=>{const d=JSON.stringify((h==null?void 0:h.toJSON())??null);s.trace("recipient sending ICE candidate %s",d),i.write({type:En.Type.ICE_CANDIDATE,data:d},{signal:e}).catch(f=>{s.error("error sending ICE candidate",f)})};const a=await i.read({signal:e});if(a.type!==En.Type.SDP_OFFER)throw new E(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");s.trace("recipient receive SDP offer %s",a.data);const c=new gg({type:"offer",sdp:a.data});await n.setRemoteDescription(c).catch(h=>{throw s.error("could not execute setRemoteDescription",h),new E("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});const l=await n.createAnswer().catch(h=>{throw s.error("could not execute createAnswer",h),new E("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});s.trace("recipient send SDP answer %s",l.sdp),await i.write({type:En.Type.SDP_ANSWER,data:l.sdp},{signal:e}),await n.setLocalDescription(l).catch(h=>{throw s.error("could not execute setLocalDescription",h),new E("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),s.trace("recipient read candidates until connected"),await pg(n,i,{direction:"recipient",signal:e,log:s})}catch(a){if(n.connectionState!=="connected")throw s.error("error while handling signaling stream from peer %a",r.remoteAddr,a),n.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,a)}const o=le(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}const vC="/webrtc",SC="/p2p-circuit",oh="/webrtc-signaling/0.0.1",RC=30*1e3;var M3,U3,$3,F3;F3=La,$3=Symbol.toStringTag,U3=Bt,M3=Ui;class AC{constructor(t,e={}){u(this,"components");u(this,"init");u(this,"log");u(this,"_started",!1);u(this,"metrics");u(this,"shutdownController");u(this,F3,!0);u(this,$3,"@libp2p/webrtc");u(this,U3,["@libp2p/transport"]);u(this,M3,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=t,this.init=e,this.log=t.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,j(1/0,this.shutdownController.signal),t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:t.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(oh,t=>{this._onProtocol(t).catch(e=>{this.log.error("failed to handle incoming connect from %p",t.connection.remotePeer,e)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(oh),this._started=!1}createListener(t){return new EC(this.components,{shutdownController:this.shutdownController})}listenFilter(t){return t.filter(PR.exactMatch)}dialFilter(t){return this.listenFilter(t)}async dial(t,e){var c;this.log.trace("dialing address: %a",t);const{remoteAddress:r,peerConnection:s,muxerFactory:i}=await bC({rtcConfiguration:await sh(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:t,dataChannelOptions:this.init.dataChannel,signal:e.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:e.onProgress}),o=new ih(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:r,metrics:(c=this.metrics)==null?void 0:c.dialerEvents}),a=await e.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:e.onProgress});return this._closeOnShutdown(s,o),a}async _onProtocol({connection:t,stream:e}){var o;const r=AbortSignal.timeout(this.init.inboundConnectionTimeout??RC),s=new wl(await sh(this.init.rtcConfiguration)),i=new Vd(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await _C({peerConnection:s,connection:t,stream:e,signal:r,log:this.log});await e.close({signal:r});const c=new ih(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:i}),this._closeOnShutdown(s,c)}catch(a){throw this.log.error("incoming signaling error",a),s.close(),e.abort(a),a}}_closeOnShutdown(t,e){const r=()=>{e.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",r),t.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function IC(n){const t=n.toString().split(vC+"/");if(t.length!==2)throw new E("webrtc protocol was not present in multiaddr",cn.ERR_INVALID_MULTIADDR);if(!t[0].includes(SC))throw new E("p2p-circuit protocol was not present in multiaddr",cn.ERR_INVALID_MULTIADDR);let e=le(t[0]);const s=le("/"+t[1]).getPeerId();if(s==null)throw new E("destination peer id was missing",cn.ERR_INVALID_MULTIADDR);const i=e.protos().pop();if(i===void 0)throw new E("invalid multiaddr",cn.ERR_INVALID_MULTIADDR);return i.name!=="p2p"&&(e=e.encapsulate(`/p2p/${s}`)),{baseAddr:e,peerId:Je(s)}}const yg=Object.values(Ms).map(n=>n.decoder).reduce((n,t)=>n.or(t));function kC(n,t){var s;const e=(s=n.getConfiguration().certificates)==null?void 0:s.at(0);if((e==null?void 0:e.getFingerprints)==null){t.log.trace("fetching fingerprint from local SDP");const i=n.localDescription;return i==null?void 0:TC(i.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),e.getFingerprints().length===0)return;const r=e.getFingerprints()[0].value;if(r==null)throw ug("","no fingerprint on local certificate");return r}const xC=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function TC(n){var e;const t=n.match(xC);return(e=t==null?void 0:t.groups)==null?void 0:e.fingerprint}function DC(n){for(const t of n.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}function ah(n){const e=n.stringTuples().filter(r=>r[0]===MC).map(r=>r[1])[0];if(e===void 0||e==="")throw lg(`Couldn't find a certhash component of multiaddr: ${n.toString()}`);return e}function mg(n){return cs(yg.decode(n))}function CC(n){const t=mg(ah(n)),e=wg(t.code),r=t.digest.reduce((i,o)=>i+o.toString(16).padStart(2,"0"),""),s=r.match(/.{1,2}/g);if(s==null)throw ug(r,n.toString());return[`${e} ${s.join(":").toUpperCase()}`,r]}function wg(n){switch(n){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw zD(n)}}function NC(n,t){const{host:e,port:r}=n.toOptions(),s=DC(n),[i]=CC(n);return`v=0
o=- 0 0 IN ${s} ${e}
s=-
c=IN ${s} ${e}
t=0 0
a=ice-lite
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${t}
a=ice-pwd:${t}
a=fingerprint:${i}
a=sctp-port:5000
a=max-message-size:${Fd}
a=candidate:1467250027 1 UDP 1467250027 ${e} ${r} typ host\r
`}function LC(n,t){return{type:"answer",sdp:NC(n,t)}}function PC(n,t){if(n.sdp===void 0)throw rh("Can't munge a missing SDP");return n.sdp=n.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+t+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+t+`
`),n}const N0=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),OC=n=>[...Array(n)].map(()=>N0.at(Math.floor(Math.random()*N0.length))).join(""),BC=1e4;se("webrtc-direct").code;const MC=se("certhash").code;var V3,H3,K3;K3=La,H3=Symbol.toStringTag,V3=Bt;class UC{constructor(t,e={}){u(this,"log");u(this,"metrics");u(this,"components");u(this,"init");u(this,K3,!0);u(this,H3,"@libp2p/webrtc-direct");u(this,V3,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:webrtc-direct"),this.components=t,this.init=e,t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(t,e){const r=await this._connect(t,e);return this.log("dialing address: %a",t),r}createListener(t){throw HD("WebRTCTransport.createListener")}listenFilter(t){return t.filter(CR.exactMatch)}dialFilter(t){return this.listenFilter(t)}async _connect(t,e){var h,d,f;const r=new AbortController,s=r.signal,i=t.getPeerId();if(i===null)throw lg("we need to have the remote's PeerId");const o=Je(i),a=mg(ah(t)),c=await wl.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:wg(a.code)}),l=new wl({...await sh(this.init.rtcConfiguration),certificates:[c]});try{const p=new Promise((O,M)=>{const U=l.createDataChannel("",{negotiated:!0,id:0}),N=setTimeout(()=>{var T;const D=`Data channel was never opened: state: ${U.readyState}`;this.log.error(D),(T=this.metrics)==null||T.dialerEvents.increment({open_error:!0}),M(k0("data",D))},BC);U.onopen=D=>{clearTimeout(N),O(U)},U.onerror=D=>{var P,L;clearTimeout(N);const I=`Error opening a data channel for handshaking: ${((P=D.target)==null?void 0:P.toString())??"not specified"}`;this.log.error(I),(L=this.metrics)==null||L.dialerEvents.increment({unknown_error:!0}),M(k0("data",I))}}),m="libp2p+webrtc+v1/"+OC(32),g=await l.createOffer(),y=PC(g,m);await l.setLocalDescription(y);const w=LC(t,m);await l.setRemoteDescription(w);const _=await p,b=this.components.peerId,v=this.generateNoisePrologue(l,a.code,t),A=Nd({prologueBytes:v})(this.components),R=ml({channel:_,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),k={...R,sink:R.sink.bind(R),source:async function*(){for await(const O of R.source)for(const M of O)yield M}()},C=new ih(this.components,{peerConnection:l,remoteAddr:t,timeline:{open:Date.now()},metrics:(h=this.metrics)==null?void 0:h.dialerEvents}),S=$d?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(S,()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":C.close().catch(O=>{this.log.error("error closing connection",O)}).finally(()=>{r.abort()});break;default:break}},{signal:s}),(d=this.metrics)==null||d.dialerEvents.increment({peer_connection:!0});const B=new Vd(this.components,{peerConnection:l,metrics:(f=this.metrics)==null?void 0:f.dialerEvents,dataChannelOptions:this.init.dataChannel});return await A.secureInbound(b,k,o),await e.upgrader.upgradeOutbound(C,{skipProtection:!0,skipEncryption:!0,muxerFactory:B})}catch(p){throw l.close(),p}}generateNoisePrologue(t,e,r){var h;if(((h=t.getConfiguration().certificates)==null?void 0:h.length)===0)throw rh("no local certificate");const s=kC(t,{log:this.log});if(s==null)throw rh("no local fingerprint found");const i=s.trim().toLowerCase().replaceAll(":",""),o=V(i,"hex"),a=Os(e,o),c=yg.decode(ah(r)),l=V("libp2p-webrtc-noise:");return gt([l,a.bytes,c])}}function $C(n){return t=>new UC(t,n)}function FC(n){return t=>new AC(t,n)}const VC=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((t,e)=>{function r(){n.removeEventListener("open",s),n.removeEventListener("error",i)}function s(){r(),t()}function i(o){r(),e(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",s),n.addEventListener("error",i)})},HC=(n,t)=>(t=t??{},t.closeOnEnd=t.closeOnEnd!==!1,async r=>{for await(const s of r){try{await VC(n)}catch(i){if(i.message==="socket closed")break;throw i}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(s)}t.closeOnEnd!=null&&n.readyState<=1&&await new Promise((s,i)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{n.close()})})});var au={},cu={};Object.defineProperty(cu,"__esModule",{value:!0});class KC{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(t){if(this.isStopped)return;const e={value:t,done:!1};if(this.pullQueue.length){const r=this.pullQueue.shift();r&&r.resolve(e)}else this.pushQueue.push(Promise.resolve(e)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const t of this.pullQueue)t.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(t){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const e of this.pullQueue)e.reject(t);this.pullQueue.length=0}else{const e=Promise.reject(t);e.catch(()=>{}),this.pushQueue.push(e)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:t=>{const e=this.pushQueue.shift();return e?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),e):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((r,s)=>{this.pullQueue.push({resolve:r,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let bg=class{constructor(t,{highWaterMark:e=100,lowWaterMark:r=1}={}){const s=new KC;s.highWaterMark=e,s.lowWaterMark=r,s.removeCallback=t({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};cu.EventIterator=bg;cu.default=bg;Object.defineProperty(au,"__esModule",{value:!0});const Hd=cu;var zC=au.EventIterator=Hd.EventIterator;function qC(n,t,e){return new Hd.EventIterator(({push:r})=>(this.addEventListener(n,r,t),()=>this.removeEventListener(n,r,t)),e)}au.subscribe=qC;au.default=Hd.EventIterator;function L0(n){var t;return n instanceof ArrayBuffer||((t=n==null?void 0:n.constructor)==null?void 0:t.name)==="ArrayBuffer"&&typeof(n==null?void 0:n.byteLength)=="number"}const WC=n=>{n.binaryType="arraybuffer";const t=async()=>{await new Promise((i,o)=>{if(r){i();return}if(s!=null){o(s);return}const a=h=>{n.removeEventListener("open",c),n.removeEventListener("error",l),h()},c=()=>{a(i)},l=h=>{a(()=>{o(h.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",c),n.addEventListener("error",l)})},e=async function*(){const i=new zC(({push:o,stop:a,fail:c})=>{const l=d=>{let f=null;typeof d.data=="string"&&(f=V(d.data)),L0(d.data)&&(f=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(f=d.data),f!=null&&o(f)},h=d=>{c(d.error??new Error("Socket error"))};return n.addEventListener("message",l),n.addEventListener("error",h),n.addEventListener("close",a),()=>{n.removeEventListener("message",l),n.removeEventListener("error",h),n.removeEventListener("close",a)}},{highWaterMark:1/0});await t();for await(const o of i)yield L0(o)?new Uint8Array(o):o}();let r=n.readyState===1,s;return n.addEventListener("open",()=>{r=!0,s=null}),n.addEventListener("close",()=>{r=!1,s=null}),n.addEventListener("error",i=>{r||(s=i.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(e,{connected:t})},GC=(n,t)=>{t=t??{};const e=WC(n);let r=t.remoteAddress,s=t.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,s=parseInt(o.port,10)}catch{}if(r==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:HC(n,t),source:e,connected:async()=>{await e.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:s,socket:n}},YC=WebSocket,QC={"http:":"ws:","https:":"wss:"},P0="ws:",XC=(n,t)=>{if(n.startsWith("//")&&(n=`${(t==null?void 0:t.protocol)??P0}${n}`),n.startsWith("/")&&t!=null){const r=t.protocol??P0,s=t.host,i=t.port!=null&&(s==null?void 0:s.endsWith(`:${t.port}`))!==!0?`:${t.port}`:"";n=`${r}//${s}${i}${n}`}const e=new URL(n);for(const[r,s]of Object.entries(QC))e.protocol===r&&(e.protocol=s);return e};function ZC(n,t){const e=typeof window>"u"?void 0:window.location;t=t??{};const r=XC(n,e),s=new YC(r.toString(),t.websocket);return GC(s,t)}const Eg=421,_g=290,jC=500;function JC(n){return n.filter(t=>{if(t.protoCodes().includes(_g))return!1;const e=t.decapsulateCode(Eg);return q1.matches(e)||al.matches(e)})}function eN(n){return n.filter(t=>{if(t.protoCodes().includes(_g))return!1;const e=t.decapsulateCode(Eg);return al.matches(e)})}function tN(){throw new Error("WebSocket Servers can not be created in the browser!")}function nN(n,t,e){const r=e.logger.forComponent("libp2p:websockets:maconn"),s=e.metrics,i=e.metricPrefix??"",o={log:r,async sink(a){try{await n.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&r.error(c)}},source:n.source,remoteAddr:t,timeline:{open:Date.now()},async close(a={}){var h,d;const c=Date.now();if(a.signal==null){const f=AbortSignal.timeout(jC);a={...a,signal:f}}const l=()=>{const{host:f,port:p}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",f,p,Date.now()-c),this.abort(new E("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};(h=a.signal)==null||h.addEventListener("abort",l);try{await n.close()}catch(f){r.error("error closing WebSocket gracefully",f),this.abort(f)}finally{(d=a.signal)==null||d.removeEventListener("abort",l),o.timeline.close=Date.now()}},abort(a){const{host:c,port:l}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",c,l,a),n.destroy(),o.timeline.close=Date.now(),s==null||s.increment({[`${i}error`]:!0})}};return n.socket.addEventListener("close",()=>{s==null||s.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}var z3,q3,W3;W3=La,q3=Symbol.toStringTag,z3=Bt;class rN{constructor(t,e){u(this,"log");u(this,"init");u(this,"logger");u(this,"metrics");u(this,"components");u(this,W3,!0);u(this,q3,"@libp2p/websockets");u(this,z3,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:websockets"),this.logger=t.logger,this.components=t,this.init=e,t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(t,e){var o;this.log("dialing %s",t),e=e??{};const r=await this._connect(t,e),s=nN(r,t,{logger:this.logger,metrics:(o=this.metrics)==null?void 0:o.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await e.upgrader.upgradeOutbound(s,e);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(t,e){var o,a,c,l,h;(o=e==null?void 0:e.signal)==null||o.throwIfAborted();const r=t.toOptions();this.log("dialing %s:%s",r.host,r.port);const s=pe(),i=ZC(e7(t),this.init);i.socket.addEventListener("error",()=>{var f;const d=new E(`Could not connect to ${t.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",d),(f=this.metrics)==null||f.dialerEvents.increment({error:!0}),s.reject(d)});try{(a=e.onProgress)==null||a.call(e,new G("websockets:open-connection")),await dt(Promise.race([i.connected(),s.promise]),e.signal)}catch(d){throw((c=e.signal)==null?void 0:c.aborted)===!0&&((l=this.metrics)==null||l.dialerEvents.increment({abort:!0})),i.close().catch(f=>{this.log.error("error closing raw socket",f)}),d}return this.log("connected %s",t),(h=this.metrics)==null||h.dialerEvents.increment({connect:!0}),i}createListener(t){return tN({logger:this.logger,metrics:this.components.metrics},{...this.init,...t})}listenFilter(t){var e,r;return t=Array.isArray(t)?t:[t],((e=this.init)==null?void 0:e.filter)!=null?(r=this.init)==null?void 0:r.filter(t):G7||Y7?eN(t):JC(t)}dialFilter(t){return this.listenFilter(t)}}function sN(n={}){return t=>new rN(t,n)}function iN(n){throw new Error("Not implemented")}class oN extends nu{constructor(e){super(e);u(this,"writer");u(this,"reader");this.writer=e.bidiStream.writable.getWriter(),this.reader=e.bidiStream.readable.getReader(),Promise.resolve().then(async()=>{for(;;){const r=await this.reader.read();if(r.done){e.log("remote closed write");return}r.value!=null&&this.sourcePush(new Ie(r.value))}}).catch(r=>{e.log.error("error reading from stream",r),this.abort(r)}).finally(()=>{this.remoteCloseWrite()}),this.writer.closed.then(()=>{e.log("writer closed")}).catch(r=>{e.log("writer close promise rejected",r)}).finally(()=>{this.remoteCloseRead()})}sendNewStream(e){}async sendData(e,r){for await(const s of e)this.log("sendData waiting for writer to be ready"),await dt(this.writer.ready,r==null?void 0:r.signal),this.writer.write(s).catch(i=>{this.log.error("error sending stream data",i)})}async sendReset(e){this.log("sendReset aborting writer"),await dt(this.writer.abort(),e==null?void 0:e.signal),this.log("sendReset aborted writer")}async sendCloseWrite(e){this.log("sendCloseWrite closing writer"),await dt(this.writer.close(),e==null?void 0:e.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(e){this.log("sendCloseRead cancelling reader"),await dt(this.reader.cancel(),e==null?void 0:e.signal),this.log("sendCloseRead cancelled reader")}}async function O0(n,t,e,r,s,i){const o=i.forComponent(`libp2p:webtransport:stream:${e}:${t}`),a=new oN({bidiStream:n,id:t,direction:e,log:o,onEnd:()=>{const c=r.findIndex(l=>l===a);c!==-1&&r.splice(c,1),s==null||s(a)}});return a}function vg(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async n=>new Promise(()=>{})}}function aN(n,t,e,r){let s=0;const i=e.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:o=>{typeof o=="function"&&(o={onIncomingStream:o});const a=[];Promise.resolve().then(async()=>{//! TODO unclear how to add backpressure here?
var l;for(;;){const{done:h,value:d}=await t.read();if(h)break;if(a.length>=r.maxInboundStreams)i(`too many inbound streams open - ${a.length}/${r.maxInboundStreams}, closing new incoming stream`),d.writable.close().catch(f=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)}),d.readable.cancel().catch(f=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)});else{const f=await O0(d,String(s++),"inbound",a,o==null?void 0:o.onStreamEnd,e);a.push(f),(l=o==null?void 0:o.onIncomingStream)==null||l.call(o,f)}}}).catch(l=>{i.error("could not create a new stream",l)});const c={protocol:"webtransport",streams:a,newStream:async l=>{i("new outgoing stream",l);const h=await n.createBidirectionalStream(),d=await O0(h,String(s++),(o==null?void 0:o.direction)??"outbound",a,o==null?void 0:o.onStreamEnd,e);return a.push(d),d},close:async()=>{i("closing webtransport muxer gracefully");try{n.close()}catch(l){c.abort(l)}},abort:l=>{i("closing webtransport muxer with err:",l);try{n.close()}catch(h){i.error("webtransport session threw error during close",h)}},...vg()};return c}}}function cN(n,t){return t.filter(r=>!!n.find(s=>ve(r,s))).length===t.length}const lN=Object.values(Ms).map(n=>n.decoder).reduce((n,t)=>n.or(t));function uN(n){return cs(lN.decode(n))}function B0(n){if(!j8.matches(n))throw new E("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");const t=n.stringTuples(),e=t.filter(([o,a])=>o===se("certhash").code).map(([o,a])=>uN(a??"")),r=t.filter(([o,a])=>o===se("p2p").code).map(([o,a])=>Je(a??""))[0],s=n.toOptions();let i=s.host;return s.family===6&&(i!=null&&i.includes(":"))&&(i=`[${i}]`),{url:`https://${i}:${s.port}`,certhashes:e,remotePeer:r}}const hN=globalThis.WebTransport;var G3,Y3,Q3;Q3=Symbol.toStringTag,Y3=La,G3=Bt;class dN{constructor(t,e={}){u(this,"log");u(this,"components");u(this,"config");u(this,"metrics");u(this,Q3,"@libp2p/webtransport");u(this,Y3,!0);u(this,G3,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:webtransport"),this.components=t,this.config={...e,maxInboundStreams:e.maxInboundStreams??1e3,certificates:e.certificates??[]},t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}async dial(t,e){var p,m,g,y,w,_,b;if(((p=e==null?void 0:e.signal)==null?void 0:p.aborted)===!0)throw new Ml;this.log("dialing %s",t);const r=this.components.peerId;if(r===void 0)throw new E("Need a local peerid","ERR_INVALID_PARAMETERS");e=e??{};const{url:s,certhashes:i,remotePeer:o}=B0(t);let a,c,l=()=>{},h=!1,d=!1,f=!1;try{(m=this.metrics)==null||m.dialerEvents.increment({pending:!0});const v=new hN(`${s}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:i.map(A=>({algorithm:"sha-256",value:A.digest}))});if(l=A=>{var R;if(!h)try{(R=this.metrics)==null||R.dialerEvents.increment({[A]:!0}),v.close()}catch(k){this.log.error("error closing wt session",k)}finally{c!=null&&(c.timeline.close=Date.now()),h=!0}},a=()=>{l(d?"noise_timeout":"ready_timeout")},(g=e.signal)==null||g.addEventListener("abort",a,{once:!0}),this.log("wait for session to be ready"),(y=e.onProgress)==null||y.call(e,new G("webtransport:wait-for-session")),await Promise.race([v.closed,v.ready]),this.log("session became ready"),d=!0,(w=this.metrics)==null||w.dialerEvents.increment({ready:!0}),v.closed.catch(A=>{this.log.error("error on remote wt session close",A)}).finally(()=>{l("remote_close")}),f=await dt(this.authenticateWebTransport({wt:v,localPeer:r,remotePeer:o,certhashes:i,...e}),e.signal),!f)throw new E("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return(_=this.metrics)==null||_.dialerEvents.increment({open:!0}),c={close:async()=>{this.log("closing webtransport"),l("close")},abort:A=>{this.log("aborting webtransport due to passed err",A),l("abort")},remoteAddr:t,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...vg()},await e.upgrader.upgradeOutbound(c,{skipEncryption:!0,muxerFactory:aN(v,v.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0,onProgress:e.onProgress})}catch(v){throw this.log.error("caught wt session err",v),l(f?"upgrade_error":d?"noise_error":"ready_error"),v}finally{a!=null&&((b=e.signal)==null||b.removeEventListener("abort",a))}}async authenticateWebTransport({wt:t,localPeer:e,remotePeer:r,certhashes:s,onProgress:i,signal:o}){o==null||o.throwIfAborted(),i==null||i(new G("webtransport:open-authentication-stream"));const a=await t.createBidirectionalStream(),c=a.writable.getWriter(),l=a.readable.getReader(),h={source:async function*(){for(;;){const p=await l.read();if(p.value!=null&&(yield p.value),p.done)break}}(),sink:async p=>{for await(const m of p){await dt(c.ready,o);const g=m instanceof Uint8Array?m:m.subarray();c.write(g).catch(y=>{this.log.error("could not write chunk during authentication of WebTransport stream",y)})}}},d=Nd()(this.components);i==null||i(new G("webtransport:secure-outbound-connection"));const{remoteExtensions:f}=await d.secureOutbound(e,h,r);if(i==null||i(new G("webtransport:close-authentication-stream")),c.close().catch(p=>{this.log.error(`Failed to close authentication stream writer: ${p.message}`)}),l.cancel().catch(p=>{this.log.error(`Failed to close authentication stream reader: ${p.message}`)}),!cN((f==null?void 0:f.webtransportCerthashes)??[],s.map(p=>p.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}createListener(t){return iN(this.components,{...t,certificates:this.config.certificates,maxInboundStreams:this.config.maxInboundStreams})}listenFilter(){return[]}dialFilter(t){return globalThis.WebTransport==null?[]:t.filter(e=>{if(!j8.exactMatch(e))return!1;const{url:r,certhashes:s}=B0(e);return r!=null&&s.length>0})}}function fN(n={}){return t=>new dN(t,n)}function gN(n,t){const e=t.map((r,s)=>({record:Ha(r),index:s}));return e.sort((r,s)=>{const i=r.record.sequence,o=s.record.sequence;if(i>o)return-1;if(i<o)return 1;if(r.record.validityType===vn.ValidityType.EOL&&s.record.validityType===vn.ValidityType.EOL){const a=U1.fromString(r.record.validity).toDate(),c=U1.fromString(s.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),e[0].index}const Sg="1.9.4",Rg="libp2p",pN="4.2.6",yN="helia",mN={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function wN(n={}){const t=`${yN}/${pN} ${Rg}/${Sg} UserAgent=${globalThis.navigator.userAgent}`;return{peerId:n.peerId,dns:n.dns,addresses:{listen:["/webrtc"]},transports:[Qk({discoverRelays:1}),FC(),$C(),fN(),sN()],connectionEncryption:[Nd()],streamMuxers:[ik(),xD()],peerDiscovery:[kk(mN)],services:{autoNAT:pk(),dcutr:Jk(),delegatedRouting:()=>hA("https://delegated-ipfs.dev"),dht:UT({clientMode:!0,validators:{ipns:u7},selectors:{ipns:gN}}),identify:wx({agentVersion:t}),identifyPush:bx({agentVersion:t}),keychain:og(n.keychain),ping:BD()}}}const bN=async()=>{const n=await Q5("Ed25519"),t=await EN(n);if(t.type==="Ed25519")return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};async function EN(n){return Gn(X5(n.public),k_(n))}const Zt={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var bl;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={key:"",value:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.key=s.string();break;case 2:o.value=s.bytes();break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),_l.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={key:""},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.key=s.string();break;case 2:o.value=_l.codec().decode(s,s.uint32());break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.addresses!=null)for(const i of e.addresses)r.uint32(10),El.codec().encode(i,r);if(e.protocols!=null)for(const i of e.protocols)r.uint32(18),r.string(i);if(e.publicKey!=null&&(r.uint32(34),r.bytes(e.publicKey)),e.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(e.peerRecordEnvelope)),e.metadata!=null&&e.metadata.size!==0)for(const[i,o]of e.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:o},r);if(e.tags!=null&&e.tags.size!==0)for(const[i,o]of e.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:o},r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.addresses.push(El.codec().decode(e,e.uint32()));break;case 2:s.protocols.push(e.string());break;case 4:s.publicKey=e.bytes();break;case 5:s.peerRecordEnvelope=e.bytes();break;case 6:{const a=n.Peer$metadataEntry.codec().decode(e,e.uint32());s.metadata.set(a.key,a.value);break}case 7:{const a=n.Peer$tagsEntry.codec().decode(e,e.uint32());s.tags.set(a.key,a.value);break}default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(bl||(bl={}));var El;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(e.multiaddr)),e.isCertified!=null&&(r.uint32(16),r.bool(e.isCertified)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={multiaddr:new Uint8Array(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.multiaddr=e.bytes();break;case 2:s.isCertified=e.bool();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(El||(El={}));var _l;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.value!=null&&e.value!==0&&(r.uint32(8),r.uint32(e.value)),e.expiry!=null&&(r.uint32(16),r.uint64(e.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={value:0},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.value=e.uint32();break;case 2:s.expiry=e.uint64();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(_l||(_l={}));function Ho(n,t){const e=bl.decode(t);e.publicKey!=null&&n.publicKey==null&&(n=cb({...n,publicKey:n.publicKey}));const r=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||r.set(i,o);return{...e,id:n,addresses:e.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:le(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}const Ag="/peers/";function Po(n){if(!Bl(n)||n.type==null)throw new E("Invalid PeerId",Zt.ERR_INVALID_PARAMETERS);const t=n.toCID().toString();return new $e(`${Ag}${t}`)}async function _N(n,t,e){const r=new Map;for(const s of e){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=le(s.multiaddr)),!Xl(s.multiaddr))throw new E("Multiaddr was invalid",Zt.ERR_INVALID_PARAMETERS);if(!await t(n,s.multiaddr))continue;const i=s.isCertified??!1,o=s.multiaddr.toString(),a=r.get(o);a!=null?s.isCertified=a.isCertified||i:r.set(o,{multiaddr:s.multiaddr,isCertified:i})}return[...r.values()].sort((s,i)=>s.multiaddr.toString().localeCompare(i.multiaddr.toString())).map(({isCertified:s,multiaddr:i})=>({isCertified:s,multiaddr:i.bytes}))}async function Gu(n,t,e,r){if(t==null)throw new E("Invalid PeerData",Zt.ERR_INVALID_PARAMETERS);if(t.publicKey!=null&&n.publicKey!=null&&!ve(t.publicKey,n.publicKey))throw new E("publicKey bytes do not match peer id publicKey bytes",Zt.ERR_INVALID_PARAMETERS);const s=r.existingPeer;if(s!=null&&!n.equals(s.id))throw new E("peer id did not match existing peer id",Zt.ERR_INVALID_PARAMETERS);let i=(s==null?void 0:s.addresses)??[],o=new Set((s==null?void 0:s.protocols)??[]),a=(s==null?void 0:s.metadata)??new Map,c=(s==null?void 0:s.tags)??new Map,l=s==null?void 0:s.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(i=[],t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses)),t.protocols!=null&&(o=new Set(t.protocols)),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=mc(d,{validate:M0})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);c=mc(d,{validate:U0,map:$0})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses),t.protocols!=null&&(o=new Set([...o,...t.protocols])),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[f,p]of d)p==null?a.delete(f):a.set(f,p);a=mc([...a.entries()],{validate:M0})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),f=new Map(c);for(const[p,m]of d)m==null?f.delete(p):f.set(p,m);c=mc([...f.entries()],{validate:U0,map:$0})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}const h={addresses:await _N(n,r.addressFilter??(async()=>!0),i),protocols:[...o.values()].sort((d,f)=>d.localeCompare(f)),metadata:a,tags:c,publicKey:(s==null?void 0:s.id.publicKey)??t.publicKey??n.publicKey,peerRecordEnvelope:l};return n.type!=="RSA"&&delete h.publicKey,h}function mc(n,t){var r;const e=new Map;for(const[s,i]of n)i!=null&&t.validate(s,i);for(const[s,i]of n.sort(([o],[a])=>o.localeCompare(a)))i!=null&&e.set(s,((r=t.map)==null?void 0:r.call(t,s,i))??i);return e}function M0(n,t){if(typeof n!="string")throw new E("Metadata key must be a string",Zt.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new E("Metadata value must be a Uint8Array",Zt.ERR_INVALID_PARAMETERS)}function U0(n,t){if(typeof n!="string")throw new E("Tag name must be a string",Zt.ERR_INVALID_PARAMETERS);if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new E("Tag value must be an integer",Zt.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new E("Tag value must be between 0-100",Zt.ERR_INVALID_PARAMETERS)}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new E("Tag ttl must be an integer",Zt.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new E("Tag ttl must be between greater than 0",Zt.ERR_INVALID_PARAMETERS)}}function $0(n,t){let e;return t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:e}}function Dc(n,t,e){const r=n.toString().split("/")[2],s=zt.decode(r),i=Rn(s),o=e.get(i);if(o!=null)return o;const a=Ho(i,t);return e.set(i,a),a}function vN(n,t){return n==null?{}:{prefix:Ag,filters:(n.filters??[]).map(e=>({key:r,value:s})=>e(Dc(r,s,t))),orders:(n.orders??[]).map(e=>(r,s)=>e(Dc(r.key,r.value,t),Dc(s.key,s.value,t)))}}var qn,Cc,Nc;class SN{constructor(t,e={}){fe(this,qn);u(this,"peerId");u(this,"datastore");u(this,"lock");u(this,"addressFilter");this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.lock=w8({name:"peer-store",singleProcess:!0})}async has(t){return this.datastore.has(Po(t))}async delete(t){if(this.peerId.equals(t))throw new E("Cannot delete self peer",Zt.ERR_INVALID_PARAMETERS);await this.datastore.delete(Po(t))}async load(t){const e=await this.datastore.get(Po(t));return Ho(t,e)}async save(t,e){const{existingBuf:r,existingPeer:s}=await re(this,qn,Cc).call(this,t),i=await Gu(t,e,"patch",{addressFilter:this.addressFilter});return re(this,qn,Nc).call(this,t,i,r,s)}async patch(t,e){const{existingBuf:r,existingPeer:s}=await re(this,qn,Cc).call(this,t),i=await Gu(t,e,"patch",{addressFilter:this.addressFilter,existingPeer:s});return re(this,qn,Nc).call(this,t,i,r,s)}async merge(t,e){const{existingBuf:r,existingPeer:s}=await re(this,qn,Cc).call(this,t),i=await Gu(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:s});return re(this,qn,Nc).call(this,t,i,r,s)}async*all(t){const e=new Sr;for await(const{key:r,value:s}of this.datastore.query(vN(t??{},e))){const i=Dc(r,s,e);i.id.equals(this.peerId)||(yield i)}}}qn=new WeakSet,Cc=async function(t){try{const e=await this.datastore.get(Po(t)),r=Ho(t,e);return{existingBuf:e,existingPeer:r}}catch(e){if(e.code!=="ERR_NOT_FOUND")throw e}return{}},Nc=async function(t,e,r,s){const i=bl.encode(e);return r!=null&&ve(i,r)?{peer:Ho(t,i),previous:s,updated:!1}:(await this.datastore.put(Po(t),i),{peer:Ho(t,i),previous:s,updated:!0})};var X3,Ni,Lc;X3=Symbol.toStringTag;class RN{constructor(t,e={}){fe(this,Ni);u(this,"store");u(this,"events");u(this,"peerId");u(this,"log");u(this,X3,"@libp2p/peer-store");this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new SN(t,e)}async forEach(t,e){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const s of this.store.all(e))t(s)}finally{this.log.trace("forEach release read lock"),r()}}async all(t){this.log.trace("all await read lock");const e=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await rl(this.store.all(t))}finally{this.log.trace("all release read lock"),e()}}async delete(t){this.log.trace("delete await write lock");const e=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(t)}finally{this.log.trace("delete release write lock"),e()}}async has(t){this.log.trace("has await read lock");const e=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(t)}finally{this.log.trace("has release read lock"),e()}}async get(t){this.log.trace("get await read lock");const e=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(t)}finally{this.log.trace("get release read lock"),e()}}async save(t,e){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const s=await this.store.save(t,e);return re(this,Ni,Lc).call(this,t,s),s.peer}finally{this.log.trace("save release write lock"),r()}}async patch(t,e){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const s=await this.store.patch(t,e);return re(this,Ni,Lc).call(this,t,s),s.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(t,e){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const s=await this.store.merge(t,e);return re(this,Ni,Lc).call(this,t,s),s.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(t,e){const r=await ss.openAndCertify(t,zn.DOMAIN);if((e==null?void 0:e.equals(r.peerId))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",e,r.peerId),!1;const s=zn.createFromProtobuf(r.payload);let i;try{i=await this.get(r.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if((i==null?void 0:i.peerRecordEnvelope)!=null){const o=await ss.createFromProtobuf(i.peerRecordEnvelope),a=zn.createFromProtobuf(o.payload);if(a.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:t,addresses:s.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}}Ni=new WeakSet,Lc=function(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))};function AN(n,t){let e;return function(){const r=function(){e=void 0,n()};clearTimeout(e),e=setTimeout(r,t)}}const IN=n=>n;function Yu(n,t){const e=n.getPeerId();return e!=null&&Je(e).equals(t)&&(n=n.decapsulate(le(`/p2p/${t.toString()}`))),n}var Z3;Z3=Symbol.toStringTag;class kN{constructor(t,e={}){u(this,"log");u(this,"components");u(this,"listen");u(this,"announce");u(this,"observed");u(this,"announceFilter");u(this,Z3,"@libp2p/address-manager");const{listen:r=[],announce:s=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=r.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Map,this.announceFilter=e.announceFilter??IN,this._updatePeerStoreAddresses=AN(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const t=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([e,r])=>r.confident).map(([e])=>le(e))).map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>le(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>le(t))}getObservedAddrs(){return Array.from(this.observed).map(([t])=>le(t))}addObservedAddr(t){t=Yu(t,this.components.peerId);const e=t.toString();this.observed.has(e)||this.observed.set(e,{confident:!1})}confirmObservedAddr(t){t=Yu(t,this.components.peerId);const e=t.toString(),s=(this.observed.get(e)??{confident:!1}).confident;this.observed.set(e,{confident:!0}),s||this._updatePeerStoreAddresses()}removeObservedAddr(t){t=Yu(t,this.components.peerId);const e=t.toString();this.observed.delete(e)}getAddresses(){let t=this.getAnnounceAddrs().map(r=>r.toString());t.length===0&&(t=this.components.transportManager.getAddrs().map(r=>r.toString())),t=t.concat(Array.from(this.observed).filter(([r,s])=>s.confident).map(([r])=>r));const e=new Set(t);return this.announceFilter(Array.from(e).map(r=>le(r))).map(r=>{var s;return((s=r.protos().pop())==null?void 0:s.path)===!0||r.getPeerId()===this.components.peerId.toString()?r:r.encapsulate(`/p2p/${this.components.peerId.toString()}`)})}}class xN{constructor(t={}){u(this,"components",{});u(this,"_started",!1);this.components={};for(const[e,r]of Object.entries(t))this.components[e]=r;this.components.logger==null&&(this.components.logger=Yl())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>Fh(e)).map(async e=>{var r;await((r=e[t])==null?void 0:r.call(e))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const TN=["metrics","connectionProtector","dns"],DN=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function CN(n={}){const t=new xN(n);return new Proxy(t,{get(r,s,i){if(typeof s=="string"&&!DN.includes(s)){const o=t.components[s];if(o==null&&!TN.includes(s))throw new E(`${s} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?t.components[s]=i:Reflect.set(r,s,i),!0}})}function NN(n){const t={};for(const e of Object.values(n.components))for(const r of LN(e))t[r]=!0;for(const e of Object.values(n.components))for(const r of PN(e))if(t[r]!==!0)throw new E(`Service "${ON(e)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}function LN(n){return Array.isArray(n==null?void 0:n[Bt])?n[Bt]:[]}function PN(n){return Array.isArray(n==null?void 0:n[Ui])?n[Ui]:[]}function ON(n){return(n==null?void 0:n[Symbol.toStringTag])??(n==null?void 0:n.toString())??"unknown"}function BN(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{const e=t.stringTuples();return e[0][0]===4||e[0][0]===41?!!rs(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}function F0(n){try{const{address:t}=n.nodeAddress();return!!rs(t)}catch{return!0}}function MN(n,t){const e=F0(n.multiaddr),r=F0(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function UN(n,t){return n.isCertified&&!t.isCertified?-1:!n.isCertified&&t.isCertified?1:0}function $N(n,t){const e=nl.exactMatch(n.multiaddr),r=nl.exactMatch(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function Kd(n,t){const e=MN(n,t);if(e!==0)return e;const r=$N(n,t);return r!==0?r:UN(n,t)}const FN=32,{code:VN}=se("dnsaddr");class HN extends Error{constructor(t="Max recursive depth reached"){super(t),this.name="RecursionLimitError"}}const zd=async function(t,e={}){const r=e.maxRecursiveDepth??FN;if(r===0)throw new HN("Max recursive depth reached");const[,s]=t.stringTuples().find(([l])=>l===VN)??[],o=await((e==null?void 0:e.dns)??p8()).query(`_dnsaddr.${s}`,{signal:e==null?void 0:e.signal,types:[ns.TXT]}),a=t.getPeerId(),c=[];for(const l of o.Answer){const h=l.data.replace(/["']/g,"").trim().split("=")[1];if(h==null||a!=null&&!h.includes(a))continue;const d=le(h);if(h.startsWith("/dnsaddr")){const f=await d.resolve({...e,maxRecursiveDepth:r-1});c.push(...f.map(p=>p.toString()))}else c.push(d.toString())}return c};var uo;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",n.NOT_FOUND="Not found"})(uo||(uo={}));var X;(function(n){n.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",n.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",n.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",n.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",n.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",n.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",n.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",n.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",n.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",n.ERR_DIALED_SELF="ERR_DIALED_SELF",n.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",n.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",n.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",n.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",n.ERR_INVALID_KEY="ERR_INVALID_KEY",n.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_INVALID_PEER="ERR_INVALID_PEER",n.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",n.ERR_NOT_FOUND="ERR_NOT_FOUND",n.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",n.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",n.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",n.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",n.ERR_FIND_SELF="ERR_FIND_SELF",n.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",n.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",n.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",n.ERR_INVALID_CMS="ERR_INVALID_CMS",n.ERR_MISSING_KEYS="ERR_MISSING_KEYS",n.ERR_NO_KEY="ERR_NO_KEY",n.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",n.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",n.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",n.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",n.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",n.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",n.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",n.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",n.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",n.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",n.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",n.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",n.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",n.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",n.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",n.ERR_INVALID_RECORD="ERR_INVALID_RECORD",n.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",n.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",n.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(X||(X={}));const KN={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:zd},addressSorter:Kd},transportManager:{faultTolerance:wi.FATAL_ALL}};async function zN(n){var e,r;const t=In(KN,n);if(t.connectionProtector===null&&((r=(e=globalThis.process)==null?void 0:e.env)==null?void 0:r.LIBP2P_FORCE_PNET)!=null)throw new E(uo.ERR_PROTECTOR_REQUIRED,X.ERR_PROTECTOR_REQUIRED);if(t.privateKey!=null&&!(await Gn(t.privateKey.public.bytes,t.privateKey.bytes)).equals(t.peerId))throw new E("Private key doesn't match peer id",X.ERR_INVALID_KEY);return t}function Ig(n){if(Bl(n))return{peerId:n,multiaddrs:[]};Array.isArray(n)||(n=[n]);let t;if(n.length>0){const e=n[0].getPeerId();t=e==null?void 0:Je(e),n.forEach(r=>{if(!Xl(r))throw new E("Invalid Multiaddr",X.ERR_INVALID_MULTIADDR);const s=r.getPeerId();if(s==null){if(t!=null)throw new E("Multiaddrs must all have the same peer id or have no peer id",X.ERR_INVALID_PARAMETERS)}else{const i=Je(s);if((t==null?void 0:t.equals(i))!==!0)throw new E("Multiaddrs must all have the same peer id or have no peer id",X.ERR_INVALID_PARAMETERS)}})}return{peerId:t,multiaddrs:n}}const kg=5e3,qN=2e3,xg=25,WN=5e3,Tg=25,Dg=0,Cg=100,Ng=10,GN=5,YN=10,Lg="last-dial-failure",Pg=500,Og=5,Bg=100,Mg=50,Ug=1e3*60*7,ms={minConnections:Og,maxQueueLength:Cg,autoDialConcurrency:Tg,autoDialPriority:Dg,autoDialInterval:WN,autoDialPeerRetryThreshold:Ug,autoDialDiscoveredPeersDebounce:Ng};class QN{constructor(t,e){u(this,"connectionManager");u(this,"peerStore");u(this,"queue");u(this,"minConnections");u(this,"autoDialPriority");u(this,"autoDialIntervalMs");u(this,"autoDialMaxQueueLength");u(this,"autoDialPeerRetryThresholdMs");u(this,"autoDialDiscoveredPeersDebounce");u(this,"autoDialInterval");u(this,"started");u(this,"running");u(this,"log");this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.minConnections=e.minConnections??ms.minConnections,this.autoDialPriority=e.autoDialPriority??ms.autoDialPriority,this.autoDialIntervalMs=e.autoDialInterval??ms.autoDialInterval,this.autoDialMaxQueueLength=e.maxQueueLength??ms.maxQueueLength,this.autoDialPeerRetryThresholdMs=e.autoDialPeerRetryThreshold??ms.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=e.autoDialDiscoveredPeersDebounce??ms.autoDialDiscoveredPeersDebounce,this.log=t.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new So({concurrency:e.autoDialConcurrency??ms.autoDialConcurrency,metricName:"libp2p_autodial_queue",metrics:t.metrics}),this.queue.addEventListener("error",s=>{this.log.error("error during auto-dial",s.detail)}),t.events.addEventListener("connection:close",()=>{this.autoDial().catch(s=>{this.log.error(s)})});let r;t.events.addEventListener("peer:discovery",()=>{clearTimeout(r),r=setTimeout(()=>{this.autoDial().catch(s=>{this.log.error(s)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch(t=>{this.log.error("error while autodialing",t)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;const t=this.connectionManager.getConnectionsMap(),e=t.size;if(e>=this.minConnections){this.minConnections>0&&this.log.trace("have enough connections %d/%d",e,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){this.log("not enough connections %d/%d but auto dial queue is full",e,this.minConnections),this.sheduleNextAutodial();return}this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",e,this.minConnections);const r=new _n(this.connectionManager.getDialQueue().map(l=>l.peerId).filter(Boolean)),s=await this.peerStore.all({filters:[l=>l.addresses.length===0?(this.log.trace("not autodialing %p because they have no addresses",l.id),!1):t.has(l.id)?(this.log.trace("not autodialing %p because they are already connected",l.id),!1):r.has(l.id)?(this.log.trace("not autodialing %p because they are already being dialed",l.id),!1):this.queue.has(l.id)?(this.log.trace("not autodialing %p because they are already being autodialed",l.id),!1):!0]}),i=s.sort(()=>Math.random()>.5?1:-1),o=new Sr;for(const l of i)o.has(l.id)||o.set(l.id,[...l.tags.values()].reduce((h,d)=>h+d.value,0));const c=i.sort((l,h)=>{const d=o.get(l.id)??0,f=o.get(h.id)??0;return d>f?-1:d<f?1:0}).filter(l=>{const h=l.metadata.get(Lg);if(h==null)return!0;const d=parseInt(W(h));return isNaN(d)?!0:Date.now()-d>this.autoDialPeerRetryThresholdMs});this.log("selected %d/%d peers to dial",c.length,s.length);for(const l of c)this.queue.add(async()=>{const h=this.connectionManager.getConnectionsMap().size;if(h>=this.minConnections){this.log("got enough connections now %d/%d",h,this.minConnections),this.queue.clear();return}this.log("connecting to a peerStore stored peer %p",l.id),await this.connectionManager.openConnection(l.id,{priority:this.autoDialPriority})},{peerId:l.id}).catch(h=>{this.log.error("could not connect to peerStore stored peer",h)});this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(t=>{this.log.error("error while autodialing",t)})},this.autoDialIntervalMs))}}const XN=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function ZN(n,t){var s;const e=((s=n==null?void 0:n.streams)==null?void 0:s.map(i=>i.protocol))??[],r=(t==null?void 0:t.closableProtocols)??XN;if(!(e.filter(i=>i!=null&&!r.includes(i)).length>0))try{await(n==null?void 0:n.close(t))}catch(i){n==null||n.abort(i)}}const V0={maxConnections:Bg,allow:[]};class jN{constructor(t,e={}){u(this,"maxConnections");u(this,"connectionManager");u(this,"peerStore");u(this,"allow");u(this,"events");u(this,"log");this.maxConnections=e.maxConnections??V0.maxConnections,this.allow=e.allow??V0.allow,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),t.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(r=>{this.log.error(r)})})}async maybePruneConnections(){const t=this.connectionManager.getConnections(),e=t.length;if(this.log("checking max connections limit %d/%d",e,this.maxConnections),e<=this.maxConnections)return;const r=new Sr;for(const a of t){const c=a.remotePeer;if(!r.has(c)){r.set(c,0);try{const l=await this.peerStore.get(c);r.set(c,[...l.tags.values()].reduce((h,d)=>h+d.value,0))}catch(l){l.code!=="ERR_NOT_FOUND"&&this.log.error("error loading peer tags",l)}}}const s=this.sortConnections(t,r),i=Math.max(e-this.maxConnections,0),o=[];for(const a of s)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>a.remoteAddr.toString().startsWith(l.toString()))||o.push(a),o.length===i)break;await Promise.all(o.map(async a=>{await ZN(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(t,e){return t.sort((r,s)=>{const i=r.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=e.get(r.remotePeer)??0,o=e.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}class JN extends $i{constructor(t={}){super({...t,sort:(e,r)=>e.options.priority>r.options.priority?-1:e.options.priority<r.options.priority?1:0})}}async function eL(n,t){let e=!1;for(const s of Dd.keys())if(e=n.protoNames().includes(s),e)break;if(!e)return[n];const r=await n.resolve(t);return t.log("resolved %s to",n,r.map(s=>s.toString())),r}const Oo={addressSorter:Kd,maxParallelDials:Mg,maxDialQueueLength:Pg,maxPeerAddrsToDial:xg,dialTimeout:kg,resolvers:{dnsaddr:zd}};class tL{constructor(t,e={}){u(this,"queue");u(this,"components");u(this,"addressSorter");u(this,"maxPeerAddrsToDial");u(this,"maxDialQueueLength");u(this,"dialTimeout");u(this,"shutDownController");u(this,"connections");u(this,"log");this.addressSorter=e.addressSorter??Oo.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??Oo.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??Oo.maxDialQueueLength,this.dialTimeout=e.dialTimeout??Oo.dialTimeout,this.connections=e.connections??new Sr,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.shutDownController=new AbortController,j(1/0,this.shutDownController.signal);for(const[r,s]of Object.entries(e.resolvers??{}))Dd.set(r,s);this.queue=new JN({concurrency:e.maxParallelDials??Oo.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",r=>{this.log.error("error in dial queue",r.detail)})}start(){this.shutDownController=new AbortController,j(1/0,this.shutDownController.signal)}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){var a,c,l;const{peerId:r,multiaddrs:s}=Ig(t),i=Array.from(this.connections.values()).flat().find(h=>e.force===!0?!1:h.remotePeer.equals(r)?!0:s.find(d=>d.equals(h.remoteAddr)));if(i!=null)return this.log("already connected to %a",i.remoteAddr),(a=e.onProgress)==null||a.call(e,new G("dial-queue:already-connected")),i;const o=this.queue.queue.find(h=>{if((r==null?void 0:r.equals(h.options.peerId))===!0)return!0;const d=h.options.multiaddrs;if(d==null)return!1;for(const f of s)if(d.has(f.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const h of s)o.options.multiaddrs.add(h.toString());return(c=e.onProgress)==null||c.call(e,new G("dial-queue:already-in-dial-queue")),o.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new E("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",r,s.map(h=>h.toString())),(l=e.onProgress)==null||l.call(e,new G("dial-queue:add-to-dial-queue")),this.queue.add(async h=>{var p,m;(p=h==null?void 0:h.onProgress)==null||p.call(h,new G("dial-queue:start-dial"));const d=this.createDialAbortController(h==null?void 0:h.signal);let f;try{f=await this.calculateMultiaddrs(r,h==null?void 0:h.multiaddrs,{...h,signal:d}),(m=h==null?void 0:h.onProgress)==null||m.call(h,new G("dial-queue:calculated-addresses",f)),f.map(({multiaddr:g})=>g.toString()).forEach(g=>{h==null||h.multiaddrs.add(g)})}catch(g){throw d.clear(),g}try{let g=0;const y=[];for(const w of f){if(g===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",g,r),new E("Peer had more than maxPeerAddrsToDial",X.ERR_TOO_MANY_ADDRESSES);g++;try{const _=await this.components.transportManager.dial(w.multiaddr,{...h,signal:d});return this.log("dial to %a succeeded",w.multiaddr),_}catch(_){if(this.log.error("dial failed to %a",w.multiaddr,_),r!=null)try{await this.components.peerStore.patch(r,{metadata:{[Lg]:V(Date.now().toString())}})}catch(b){this.log.error("could not update last dial failure key for %p",r,b)}if(d.aborted)throw new E(_.message,Mi);y.push(_)}}throw y.length===1?y[0]:new Im(y,"All multiaddr dials failed",X.ERR_TRANSPORT_DIAL_FAILED)}finally{d.clear()}},{peerId:r,priority:e.priority??$g,multiaddrs:new Set(s.map(h=>h.toString())),signal:e.signal,onProgress:e.onProgress})}createDialAbortController(t){const e=Ze([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,t]);return j(1/0,e),e}async calculateMultiaddrs(t,e=new Set,r={}){var d,f;const s=[...e].map(p=>({multiaddr:le(p),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new E("Tried to dial self",X.ERR_DIALED_SELF);if(await((f=(d=this.components.connectionGater).denyDialPeer)==null?void 0:f.call(d,t))===!0)throw new E("The dial request is blocked by gater.allowDialPeer",X.ERR_PEER_DIAL_INTERCEPTED);if(s.length===0){this.log("loading multiaddrs for %p",t);try{const p=await this.components.peerStore.get(t);s.push(...p.addresses),this.log("loaded multiaddrs for %p",t,s.map(({multiaddr:m})=>m.toString()))}catch(p){if(p.code!==X.ERR_NOT_FOUND)throw p}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{const p=await this.components.peerRouting.findPeer(t);this.log("found multiaddrs for %p in the peer routing",t,s.map(({multiaddr:m})=>m.toString())),s.push(...p.multiaddrs.map(m=>({multiaddr:m,isCertified:!1})))}catch(p){p.code!==X.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",t,p)}}}let i=(await Promise.all(s.map(async p=>{const m=await eL(p.multiaddr,{dns:this.components.dns,...r,log:this.log});return m.length===1&&m[0].equals(p.multiaddr)?p:m.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(t!=null){const p=`/p2p/${t.toString()}`;i=i.map(m=>{const g=m.multiaddr.protos().pop();return(g==null?void 0:g.path)===!0?m:m.multiaddr.getPeerId()==null?{multiaddr:m.multiaddr.encapsulate(p),isCertified:m.isCertified}:m})}const o=i.filter(p=>{if(this.components.transportManager.dialTransportForMultiaddr(p.multiaddr)==null)return!1;const m=p.multiaddr.getPeerId();return t!=null&&m!=null?t.equals(m):!0}),a=new Map;for(const p of o){const m=p.multiaddr.toString(),g=a.get(m);if(g!=null){g.isCertified=g.isCertified||p.isCertified||!1;continue}a.set(m,p)}const c=[...a.values()];if(c.length===0)throw new E("The dial request has no valid addresses",X.ERR_NO_VALID_ADDRESSES);const l=[];for(const p of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(p.multiaddr)||l.push(p);const h=l.sort(this.addressSorter);if(h.length===0)throw new E("The connection gater denied all addresses in the dial request",X.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",t??"unknown peer",i.map(({multiaddr:p})=>p.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",h.map(({multiaddr:p})=>p.toString())),h}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{const r=await this.calculateMultiaddrs(void 0,new Set(t.map(s=>s.toString())),e);return e.runOnTransientConnection===!1?r.find(s=>!nl.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}const $g=50,nr={minConnections:Og,maxConnections:Bg,inboundConnectionThreshold:GN,maxIncomingPendingConnections:YN,autoDialConcurrency:Tg,autoDialPriority:Dg,autoDialMaxQueueLength:Cg,autoDialPeerRetryThreshold:Ug,autoDialDiscoveredPeersDebounce:Ng};var j3;j3=Symbol.toStringTag;class nL{constructor(t,e={}){u(this,"started");u(this,"connections");u(this,"allow");u(this,"deny");u(this,"maxIncomingPendingConnections");u(this,"incomingPendingConnections");u(this,"maxConnections");u(this,"dialQueue");u(this,"autoDial");u(this,"connectionPruner");u(this,"inboundConnectionRateLimiter");u(this,"peerStore");u(this,"metrics");u(this,"events");u(this,"log");u(this,j3,"@libp2p/connection-manager");this.maxConnections=e.maxConnections??nr.maxConnections;const r=e.minConnections??nr.minConnections;if(this.maxConnections<r)throw new E("Connection Manager maxConnections must be greater than minConnections",X.ERR_INVALID_PARAMETERS);this.connections=new Sr,this.started=!1,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(e.allow??[]).map(s=>le(s)),this.deny=(e.deny??[]).map(s=>le(s)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??nr.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new ag({points:e.inboundConnectionThreshold??nr.inboundConnectionThreshold,duration:1}),this.autoDial=new QN({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{minConnections:r,autoDialConcurrency:e.autoDialConcurrency??nr.autoDialConcurrency,autoDialPriority:e.autoDialPriority??nr.autoDialPriority,autoDialPeerRetryThreshold:e.autoDialPeerRetryThreshold??nr.autoDialPeerRetryThreshold,autoDialDiscoveredPeersDebounce:e.autoDialDiscoveredPeersDebounce??nr.autoDialDiscoveredPeersDebounce,maxQueueLength:e.autoDialMaxQueueLength??nr.autoDialMaxQueueLength}),this.connectionPruner=new jN({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new tL(t,{addressSorter:e.addressSorter??Kd,maxParallelDials:e.maxParallelDials??Mg,maxDialQueueLength:e.maxDialQueueLength??Pg,maxPeerAddrsToDial:e.maxPeerAddrsToDial??xg,dialTimeout:e.dialTimeout??kg,resolvers:e.resolvers??{dnsaddr:zd},connections:this.connections})}isStarted(){return this.started}async start(){var t,e,r;(t=this.metrics)==null||t.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const s={inbound:0,outbound:0};for(const i of this.connections.values())for(const o of i)o.direction==="inbound"?s.inbound++:s.outbound++;return s}}),(e=this.metrics)==null||e.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const s={};for(const i of this.connections.values())for(const o of i)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;s[c]=(s[c]??0)+1}return s}}),(r=this.metrics)==null||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const s={};for(const o of this.connections.values())for(const a of o){const c={};for(const l of a.streams){const h=`${l.direction} ${l.protocol??"unnegotiated"}`;c[h]=(c[h]??0)+1}for(const[l,h]of Object.entries(c))s[l]=s[l]??[],s[l].push(h)}const i={};for(let[o,a]of Object.entries(s)){a=a.sort((l,h)=>l-h);const c=Math.floor(a.length*.9);i[o]=a[c]}return i}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[e=>e.tags.has(Am)]});await Promise.all(t.map(async e=>{await this.openConnection(e.id).catch(r=>{this.log.error(r)})}))}).catch(t=>{this.log.error(t)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const t=[];for(const e of this.connections.values())for(const r of e)t.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){const{detail:e}=t;if(!this.started){await e.close();return}const r=e.remotePeer,s=this.connections.get(r);let i=!1;s!=null?s.push(e):(i=!0,this.connections.set(r,[e])),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){const{detail:e}=t;if(!this.started)return;const r=e.remotePeer;let s=this.connections.get(r);s!=null&&s.length>1?(s=s.filter(i=>i.id!==e.id),this.connections.set(r,s)):s!=null&&(this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(const r of this.connections.values())e=e.concat(r);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){var a,c;if(!this.isStarted())throw new E("Not started",X.ERR_NODE_NOT_STARTED);(a=e.signal)==null||a.throwIfAborted();const{peerId:r}=Ig(t);if(r!=null&&e.force!==!0){this.log("dial %p",r);const l=this.getConnections(r).find(h=>!h.transient);if(l!=null)return this.log("had an existing non-transient connection to %p",r),(c=e.onProgress)==null||c.call(e,new G("dial-queue:already-connected")),l}const s=await this.dialQueue.dial(t,{...e,priority:e.priority??$g});let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const l of i)l.id===s.id&&(o=!0);return o||i.push(s),s}async closeConnections(t,e={}){const r=this.connections.get(t)??[];await Promise.all(r.map(async s=>{try{await s.close(e)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(t){if(this.deny.some(s=>t.remoteAddr.toString().startsWith(s.toString())))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(s=>t.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){const s=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(r=>le(r))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}}const rL=1e4,sL="1.0.0",iL="ping",oL="ipfs",H0=32;var J3,e4;e4=Symbol.toStringTag,J3=Bt;class aL{constructor(t,e={}){u(this,"protocol");u(this,"components");u(this,"log");u(this,"heartbeatInterval");u(this,"pingIntervalMs");u(this,"abortController");u(this,"timeout");u(this,e4,"@libp2p/connection-monitor");u(this,J3,["@libp2p/connection-monitor"]);this.components=t,this.protocol=`/${e.protocolPrefix??oL}/${iL}/${sL}`,this.log=t.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=e.pingInterval??rL,this.timeout=new j7({...e.pingTimeout??{},metrics:t.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(t=>{Promise.resolve().then(async()=>{var r;let e=Date.now();try{const s=this.timeout.getTimeoutSignal({signal:(r=this.abortController)==null?void 0:r.signal}),i=await t.newStream(this.protocol,{signal:s,runOnTransientConnection:!0}),o=g7(i);e=Date.now(),await Promise.all([o.write(Yn(H0),{signal:s}),o.read(H0,{signal:s})]),t.rtt=Date.now()-e,await o.unwrap().close({signal:s})}catch(s){if(s.code!=="ERR_UNSUPPORTED_PROTOCOL")throw s;t.rtt=(Date.now()-e)/2}}).catch(e=>{this.log.error("error during heartbeat, aborting connection",e),t.abort(e)})})},this.pingIntervalMs)}stop(){var t;(t=this.abortController)==null||t.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var t4;t4=Symbol.toStringTag;class cL{constructor(t,e){u(this,"routers");u(this,"started");u(this,"components");u(this,t4,"@libp2p/content-routing");this.routers=e.routers??[],this.started=!1,this.components=t}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new E("No content routers available",X.ERR_NO_ROUTERS_AVAILABLE);const r=this,s=new _n;for await(const i of Gr(...r.routers.map(o=>o.findProviders(t,e))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(t,e={}){if(this.routers.length===0)throw new E("No content routers available",X.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async r=>{await r.provide(t,e)}))}async put(t,e,r){if(!this.isStarted())throw new E(uo.NOT_STARTED_YET,X.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map(async s=>{await s.put(t,e,r)}))}async get(t,e){if(!this.isStarted())throw new E(uo.NOT_STARTED_YET,X.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map(async r=>r.get(t,e)))}}var n4;n4=Symbol.toStringTag;class lL{constructor(t,e={}){u(this,"log");u(this,"peerId");u(this,"peerStore");u(this,"routers");u(this,n4,"@libp2p/peer-routing");this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[]}async findPeer(t,e){if(this.routers.length===0)throw new E("No peer routers available",X.ERR_NO_ROUTERS_AVAILABLE);if(t.toString()===this.peerId.toString())throw new E("Should not try to find self",X.ERR_FIND_SELF);const r=this,s=Gr(...this.routers.map(i=>async function*(){try{yield await i.findPeer(t,e)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),i;throw new E(uo.NOT_FOUND,X.ERR_NOT_FOUND)}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new E("No peer routers available",X.ERR_NO_ROUTERS_AVAILABLE);const r=this,s=t8(1024);for await(const i of hs(async function*(){const o=Gr(...r.routers.map(a=>a.getClosestPeers(t,e)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...e,useCache:!1})}catch(c){r.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id.toBytes())&&(s.add(i.id.toBytes()),yield i))}}var r4,s4;class uL extends(s4=_t,r4=Symbol.toStringTag,s4){constructor(e){super();u(this,"peerRouting");u(this,"log");u(this,"walking");u(this,"walkers");u(this,"shutdownController");u(this,"walkController");u(this,"needNext");u(this,r4,"@libp2p/random-walk");this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,j(1/0,this.shutdownController.signal)}start(){this.shutdownController=new AbortController,j(1/0,this.shutdownController.signal)}stop(){this.shutdownController.abort()}async*walk(e){var s,i;this.walking||this.startWalk(),this.walkers++;const r=Ze([this.shutdownController.signal,e==null?void 0:e.signal]);j(1/0,r);try{for(;;)(s=this.needNext)==null||s.resolve(),this.needNext=pe(),yield(await pr(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&((i=this.walkController)==null||i.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,j(1/0,this.walkController.signal);const e=Ze([this.walkController.signal,this.shutdownController.signal]);j(1/0,e);const r=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=Yn(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await dt(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,s)}catch(i){this.log.error("randomwalk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("randomwalk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-r),this.walking=!1})}}const Fg=32,Vg=64;var i4;i4=Symbol.toStringTag;class hL{constructor(t){u(this,"log");u(this,"topologies");u(this,"handlers");u(this,"components");u(this,i4,"@libp2p/registrar");this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){const e=this.handlers.get(t);if(e==null)throw new E(`No handler registered for protocol ${t}`,X.ERR_NO_HANDLER_FOR_PROTOCOL);return e}getTopologies(t){const e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,r){if(this.handlers.has(t))throw new E(`Handler already registered for protocol ${t}`,X.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=In.bind({ignoreUndefined:!0})({maxInboundStreams:Fg,maxOutboundStreams:Vg},r);this.handlers.set(t,{handler:e,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]})}async unhandle(t){(Array.isArray(t)?t:[t]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(t,e){if(e==null)throw new E("invalid topology",X.ERR_INVALID_PARAMETERS);const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(t);return s==null&&(s=new Map,this.topologies.set(t,s)),s.set(r,e),r}unregister(t){for(const[e,r]of this.topologies.entries())r.has(t)&&(r.delete(t),r.size===0&&this.topologies.delete(e))}_onDisconnect(t){const e=t.detail;this.components.peerStore.get(e).then(r=>{var s,i,o;for(const a of r.protocols){const c=this.topologies.get(a);if(c!=null)for(const l of c.values())((s=l.filter)==null?void 0:s.has(e))!==!1&&((i=l.filter)==null||i.remove(e),(o=l.onDisconnect)==null||o.call(l,e))}}).catch(r=>{r.code!==X.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",e,r)})}_onPeerUpdate(t){var i,o,a;const{peer:e,previous:r}=t.detail,s=((r==null?void 0:r.protocols)??[]).filter(c=>!e.protocols.includes(c));for(const c of s){const l=this.topologies.get(c);if(l!=null)for(const h of l.values())((i=h.filter)==null?void 0:i.has(e.id))!==!1&&((o=h.filter)==null||o.remove(e.id),(a=h.onDisconnect)==null||a.call(h,e.id))}}_onPeerIdentify(t){var i,o,a;const e=t.detail.protocols,r=t.detail.connection,s=t.detail.peerId;for(const c of e){const l=this.topologies.get(c);if(l!=null)for(const h of l.values())r.transient&&h.notifyOnTransient!==!0||((i=h.filter)==null?void 0:i.has(s))!==!0&&((o=h.filter)==null||o.add(s),(a=h.onConnect)==null||a.call(h,s,r))}}}var o4;o4=Symbol.toStringTag;class dL{constructor(t,e={}){u(this,"log");u(this,"components");u(this,"transports");u(this,"listeners");u(this,"faultTolerance");u(this,"started");u(this,o4,"@libp2p/transport-manager");this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=new Map,this.listeners=C8({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??wi.FATAL_ALL}add(t){const e=t[Symbol.toStringTag];if(e==null)throw new E("Transport must have a valid tag",X.ERR_INVALID_KEY);if(this.transports.has(e))throw new E(`There is already a transport with the tag ${e}`,X.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){const t=[];for(const[e,r]of this.listeners)for(this.log("closing listeners for %s",e);r.length>0;){const s=r.pop();s!=null&&t.push(s.close())}await Promise.all(t),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){var s;const r=this.dialTransportForMultiaddr(t);if(r==null)throw new E(`No transport available for address ${String(t)}`,X.ERR_TRANSPORT_UNAVAILABLE);(s=e==null?void 0:e.onProgress)==null||s.call(e,new G("transport-manager:selected-transport",r[Symbol.toStringTag]));try{return await r.dial(t,{...e,upgrader:this.components.upgrader})}catch(i){throw i.code==null&&(i.code=X.ERR_TRANSPORT_DIAL_FAILED),i}}getAddrs(){let t=[];for(const e of this.listeners.values())for(const r of e)t=[...t,...r.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(const e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(const e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new E("Not started",X.ERR_NODE_NOT_STARTED);if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const e=[];for(const[r,s]of this.transports.entries()){const i=s.listenFilter(t),o=[];for(const l of i){this.log("creating listener for %s on %a",r,l);const h=s.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(r)??[];d==null&&(d=[],this.listeners.set(r,d)),d.push(h),h.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:h})}),h.addEventListener("close",()=>{const f=d.findIndex(p=>p===h);d.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:h})}),o.push(h.listen(l))}if(o.length===0){e.push(r);continue}if((await Promise.allSettled(o)).find(l=>l.status==="fulfilled")==null&&this.faultTolerance!==wi.NO_FATAL)throw new E(`Transport (${r}) could not listen on any available address`,X.ERR_NO_VALID_ADDRESSES)}if(e.length===this.transports.size){const r=`no valid addresses were provided for transports [${e.join(", ")}]`;if(this.faultTolerance===wi.FATAL_ALL)throw new E(r,X.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${r}`)}}async remove(t){const e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);const r=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){const s=e.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){const t=[];for(const e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}}const Kt="/multistream/1.0.0",qd=1024,fL=V(`
`);async function Ko(n,t,e){await n.write(t,e)}async function gL(n,t,e){await n.writeV(t,e)}async function pL(n,t){const e=await n.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==fL[0])throw t.log.error("Invalid mss message - missing newline",e),new E("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return e.sublist(0,-1)}async function vi(n,t){const e=await pL(n,t);return W(e.subarray())}async function Qu(n,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return yL(n,t[0],e);const r=eo(n,{...e,maxDataLength:qd}),s=t.shift();if(s==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',Kt,s);const i=V(`${Kt}
`),o=V(`${s}
`);await gL(r,[i,o],e),e.log.trace("select: reading multistream-select header");let a=await vi(r,e);if(e.log.trace('select: read "%s"',a),a===Kt&&(e.log.trace("select: reading protocol response"),a=await vi(r,e),e.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const c of t){e.log.trace('select: write "%s"',c),await Ko(r,V(`${c}
`),e),e.log.trace("select: reading protocol response");const l=await vi(r,e);if(e.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:r.unwrap(),protocol:c}}throw new E("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function yL(n,t,e){const r=n.sink.bind(n),s=n.source;let i=!1,o=!1;const a=pe();let c=!1,l=!1;const h=pe();let d=!1,f=!1;const p=pe(),m=eo({sink:r,source:s},{...e,maxDataLength:qd});n.sink=async _=>{const{sink:b}=m.unwrap();await b(async function*(){let v=!1;for await(const A of _){if(l&&await h.promise,c)yield A;else{l=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Kt,t,A.byteLength);const R=`${t}
`;yield new Ie(Uint8Array.from([19]),V(`${Kt}
`),Ot(R.length),V(R),A).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Kt,t,A.byteLength),c=!0,l=!1,h.resolve(),g().catch(k=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,k)})}v=!0}v||await g()}())};async function g(){if(o){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}o=!0;try{c||(e.log.trace("optimistic: doing send protocol for %s stream",t),await y()),d||(e.log.trace("optimistic: doing read protocol for %s stream",t),await w())}finally{o=!1,i=!0,a.resolve()}}async function y(){if(l){await h.promise;return}l=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',Kt,t),await m.writeV([V(`${Kt}
`),V(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',Kt,t)}finally{c=!0,l=!1,h.resolve()}}async function w(){if(f){await p.promise;return}f=!0;try{e.log.trace("optimistic: reading multistream select header");let _=await vi(m,e);if(e.log.trace('optimistic: read multistream select header "%s"',_),_===Kt&&(_=await vi(m,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',_,t),_!==t)throw new E("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{d=!0,f=!1,p.resolve()}}if(n.source=async function*(){await g(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*m.unwrap().source}(),n.closeRead!=null){const _=n.closeRead.bind(n);n.closeRead=async b=>{i||await g().catch(v=>{e.log.error("could not negotiate protocol before close read",v)}),await _(b)}}if(n.closeWrite!=null){const _=n.closeWrite.bind(n);n.closeWrite=async b=>{i||await g().catch(v=>{e.log.error("could not negotiate protocol before close write",v)}),await _(b)}}if(n.close!=null){const _=n.close.bind(n);n.close=async b=>{const v=[];l&&v.push(h.promise),f&&v.push(p.promise),v.length>0?await dt(Promise.all(v),b==null?void 0:b.signal):(i=!0,o=!1,a.resolve()),await _(b)}}return{stream:n,protocol:t}}async function Xu(n,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);const r=eo(n,{...e,maxDataLength:qd,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");const s=await vi(r,e);if(e.log.trace('handle: read "%s"',s),s===Kt){e.log.trace('handle: respond with "%s" for "%s"',Kt,s),await Ko(r,V(`${Kt}
`),e),e.log.trace('handle: responded with "%s" for "%s"',Kt,s);continue}if(t.includes(s))return e.log.trace('handle: respond with "%s" for "%s"',s,s),await Ko(r,V(`${s}
`),e),e.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new Ie(...t.map(o=>es.single(V(`${o}
`))),V(`
`));e.log.trace('handle: respond with "%s" for %s',t,s),await Ko(r,i,e),e.log.trace('handle: responded with "%s" for %s',t,s);continue}e.log('handle: respond with "na" for "%s"',s),await Ko(r,V(`na
`),e),e.log('handle: responded with "na" for "%s"',s)}}const mL=500;var a4,c4;c4=Symbol.toStringTag,a4=Rm;class wL{constructor(t){u(this,"id");u(this,"remoteAddr");u(this,"remotePeer");u(this,"direction");u(this,"timeline");u(this,"multiplexer");u(this,"encryption");u(this,"status");u(this,"transient");u(this,"log");u(this,"tags");u(this,"_newStream");u(this,"_close");u(this,"_abort");u(this,"_getStreams");u(this,c4,"Connection");u(this,a4,!0);const{remoteAddr:e,remotePeer:r,newStream:s,close:i,abort:o,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=r,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.transient=t.transient??!1,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new E("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new E("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(t)||(t=[t]),this.transient&&(e==null?void 0:e.runOnTransientConnection)!==!0)throw new E("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const r=await this._newStream(t,e);return r.direction="outbound",r}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){const e=AbortSignal.timeout(mL);j(1/0,e),t={...t,signal:e}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map(async e=>e.close(t))),this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this.streams.forEach(e=>{e.abort(t)}),this.log.error("all streams aborted",this.streams.length),this._abort(t),this.timeline.close=Date.now(),this.status="closed"}}function bL(n){return new wL(n)}const EL=3e4;function _L(n,t){try{const{options:e}=t.getHandler(n);return e.maxInboundStreams}catch(e){if(e.code!==X.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return Fg}function vL(n,t,e={}){try{const{options:r}=t.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.code!==X.ERR_NO_HANDLER_FOR_PROTOCOL)throw r}return e.maxOutboundStreams??Vg}function K0(n,t,e){let r=0;return e.streams.forEach(s=>{s.direction===t&&s.protocol===n&&r++}),r}var l4;l4=Symbol.toStringTag;class SL{constructor(t,e){u(this,"components");u(this,"connectionEncryption");u(this,"muxers");u(this,"inboundUpgradeTimeout");u(this,"events");u(this,l4,"@libp2p/upgrader");this.components=t,this.connectionEncryption=new Map,e.connectionEncryption.forEach(r=>{this.connectionEncryption.set(r.protocol,r)}),this.muxers=new Map,e.muxers.forEach(r=>{this.muxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??qN,this.events=t.events}async shouldBlockConnection(t,e,r){const s=this.components.connectionGater[r];if(s!==void 0&&await s(t,e))throw new E(`The multiaddr connection is blocked by gater.${r}`,X.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(t,e){var d,f,p,m,g;if(!await this.components.connectionManager.acceptIncomingConnection(t))throw new E("connection denied",X.ERR_CONNECTION_DENIED);let s,i,o,a,c;const l=AbortSignal.timeout(this.inboundUpgradeTimeout),h=()=>{t.abort(new E("inbound upgrade timeout",Mi))};l.addEventListener("abort",h,{once:!0}),j(1/0,l);try{if(await((f=(d=this.components.connectionGater).denyInboundConnection)==null?void 0:f.call(d,t))===!0)throw new E("The multiaddr connection is blocked by gater.acceptConnection",X.ERR_CONNECTION_INTERCEPTED);(p=this.components.metrics)==null||p.trackMultiaddrConnection(t),t.log("starting the inbound connection upgrade");let y=t;if((e==null?void 0:e.skipProtection)!==!0){const w=this.components.connectionProtector;w!=null&&(t.log("protecting the inbound connection"),y=await w.protect(t))}try{if(s=y,(e==null?void 0:e.skipEncryption)!==!0){(m=e==null?void 0:e.onProgress)==null||m.call(e,new G("upgrader:encrypt-inbound-connection")),{conn:s,remotePeer:i,protocol:c}=await this._encryptInbound(y);const w={...y,...s};await this.shouldBlockConnection(i,w,"denyInboundEncryptedConnection")}else{const w=t.remoteAddr.getPeerId();if(w==null)throw new E("inbound connection that skipped encryption must have a peer id",X.ERR_INVALID_MULTIADDR);const _=Je(w);c="native",i=_}if(o=s,(e==null?void 0:e.muxerFactory)!=null)a=e.muxerFactory;else if(this.muxers.size>0){(g=e==null?void 0:e.onProgress)==null||g.call(e,new G("upgrader:multiplex-inbound-connection"));const w=await this._multiplexInbound({...y,...s},this.muxers);a=w.muxerFactory,o=w.stream}}catch(w){throw t.log.error("failed to upgrade inbound connection",w),w}return await this.shouldBlockConnection(i,t,"denyInboundUpgradedConnection"),t.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i,transient:e==null?void 0:e.transient})}finally{l.removeEventListener("abort",h),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){var d;const r=t.remoteAddr.getPeerId();let s;r!=null&&(s=Je(r),await this.shouldBlockConnection(s,t,"denyOutboundConnection"));let i,o,a,c,l;(d=this.components.metrics)==null||d.trackMultiaddrConnection(t),t.log("starting the outbound connection upgrade");let h=t;if((e==null?void 0:e.skipProtection)!==!0){const f=this.components.connectionProtector;f!=null&&(h=await f.protect(t))}try{if(i=h,(e==null?void 0:e.skipEncryption)!==!0){({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(h,s));const f={...h,...i};await this.shouldBlockConnection(o,f,"denyOutboundEncryptedConnection")}else{if(s==null)throw new E("Encryption was skipped but no peer id was passed",X.ERR_INVALID_PEER);c="native",o=s}if(a=i,(e==null?void 0:e.muxerFactory)!=null)l=e.muxerFactory;else if(this.muxers.size>0){const f=await this._multiplexOutbound({...h,...i},this.muxers);l=f.muxerFactory,a=f.stream}}catch(f){throw t.log.error("failed to upgrade outbound connection",f),await t.close(f),f}return await this.shouldBlockConnection(o,t,"denyOutboundUpgradedConnection"),t.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:t,upgradedConn:a,muxerFactory:l,remotePeer:o,transient:e==null?void 0:e.transient})}_createConnection(t){const{cryptoProtocol:e,direction:r,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,transient:c}=t;let l,h,d;a!=null&&(l=a.createStreamMuxer({direction:r,onIncomingStream:m=>{d!=null&&Promise.resolve().then(async()=>{var v;const g=this.components.registrar.getProtocols(),{stream:y,protocol:w}=await Xu(m,g,{log:m.log,yieldBytes:!1});if(d==null)return;d.log("incoming stream opened on %s",w);const _=_L(w,this.components.registrar);if(K0(w,"inbound",d)===_){const A=new E(`Too many inbound protocol streams for protocol "${w}" - limit ${_}`,X.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw m.abort(A),A}m.source=y.source,m.sink=y.sink,m.protocol=w,y.closeWrite!=null&&(m.closeWrite=y.closeWrite),y.closeRead!=null&&(m.closeRead=y.closeRead),y.close!=null&&(m.close=y.close),await this.components.peerStore.merge(o,{protocols:[w]}),(v=this.components.metrics)==null||v.trackProtocolStream(m,d),this._onStream({connection:d,stream:m,protocol:w})}).catch(async g=>{d.log.error("error handling incoming stream id %s",m.id,g.message,g.code,g.stack),m.timeline.close==null&&await m.close()})}}),h=async(m,g={})=>{var w;if(l==null)throw new E("Stream is not multiplexed",X.ERR_MUXER_UNAVAILABLE);d.log("starting new stream for protocols %s",m);const y=await l.newStream();d.log.trace("started new stream %s for protocols %s",y.id,m);try{if(g.signal==null){y.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",m);const R=AbortSignal.timeout(EL);j(1/0,R),g={...g,signal:R}}y.log.trace("selecting protocol from protocols %s",m);const{stream:_,protocol:b}=await Qu(y,m,{...g,log:y.log,yieldBytes:!0});y.log("selected protocol %s",b);const v=vL(b,this.components.registrar,g),A=K0(b,"outbound",d);if(A>=v){const R=new E(`Too many outbound protocol streams for protocol "${b}" - ${A}/${v}`,X.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw y.abort(R),R}return await this.components.peerStore.merge(o,{protocols:[b]}),y.source=_.source,y.sink=_.sink,y.protocol=b,_.closeWrite!=null&&(y.closeWrite=_.closeWrite),_.closeRead!=null&&(y.closeRead=_.closeRead),_.close!=null&&(y.close=_.close),(w=this.components.metrics)==null||w.trackProtocolStream(y,d),y}catch(_){throw d.log.error("could not create new stream for protocols %s",m,_),y.timeline.close==null&&y.abort(_),_.code!=null?_:new E(String(_),X.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(m=>{d.log.error("error piping data through muxer",m)}));const f=s.timeline;s.timeline=new Proxy(f,{set:(...m)=>(d!=null&&m[1]==="close"&&m[2]!=null&&f.close==null&&(async()=>{try{d.status==="open"&&await d.close()}catch(g){d.log.error("error closing connection after timeline close",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:d})}})().catch(g=>{d.log.error("error thrown while dispatching connection:close event",g)}),Reflect.set(...m))}),s.timeline.upgraded=Date.now();const p=()=>{throw new E("connection is not multiplexed",X.ERR_CONNECTION_NOT_MULTIPLEXED)};return d=bL({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:s.timeline,multiplexer:l==null?void 0:l.protocol,encryption:e,transient:c,logger:this.components.logger,newStream:h??p,getStreams:()=>l!=null?l.streams:[],close:async m=>{l!=null&&(d.log.trace("close muxer"),await l.close(m)),d.log.trace("close maconn"),await s.close(m),d.log.trace("closed maconn")},abort:m=>{s.abort(m),l!=null&&l.abort(m)}}),this.events.safeDispatchEvent("connection:open",{detail:d}),d}_onStream(t){const{connection:e,stream:r,protocol:s}=t,{handler:i,options:o}=this.components.registrar.getHandler(s);if(e.transient&&o.runOnTransientConnection!==!0)throw new E("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:e,stream:r})}async _encryptInbound(t){const e=Array.from(this.connectionEncryption.keys());t.log("handling inbound crypto protocol selection",e);try{const{stream:r,protocol:s}=await Xu(t,e,{log:t.log}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return t.log("encrypting inbound connection using",s),{...await i.secureInbound(this.components.peerId,r),protocol:s}}catch(r){throw t.log.error("encrypting inbound connection failed",r),new E(r.message,X.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(t,e){const r=Array.from(this.connectionEncryption.keys());t.log("selecting outbound crypto protocol",r);try{t.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await Qu(t,r,{log:t.log,yieldBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return t.log("encrypting outbound connection to %p using %s",e,o),{...await o.secureOutbound(this.components.peerId,s,e),protocol:i}}catch(s){throw t.log.error("encrypting outbound connection to %p failed",e,s),new E(s.message,X.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(t,e){const r=Array.from(e.keys());t.log("outbound selecting muxer %s",r);try{t.log.trace("selecting stream muxer from %s",r);const{stream:s,protocol:i}=await Qu(t,r,{log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",i);const o=e.get(i);return{stream:s,muxerFactory:o}}catch(s){throw t.log.error("error multiplexing outbound connection",s),new E(String(s),X.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(t,e){const r=Array.from(e.keys());t.log("inbound handling muxers %s",r);try{const{stream:s,protocol:i}=await Xu(t,r,{log:t.log}),o=e.get(i);return{stream:s,muxerFactory:o}}catch(s){throw t.log.error("error multiplexing inbound connection",s),new E(String(s),X.ERR_MUXER_UNAVAILABLE)}}}var Ta,ch;class RL extends _t{constructor(e){var c,l,h,d,f;super();fe(this,Ta);u(this,"peerId");u(this,"peerStore");u(this,"contentRouting");u(this,"peerRouting");u(this,"metrics");u(this,"services");u(this,"logger");u(this,"status");u(this,"components");u(this,"log");this.status="stopped";const r=new _t,s=r.dispatchEvent.bind(r);r.dispatchEvent=p=>{const m=s(p),g=this.dispatchEvent(new Sn(p.type,{detail:p.detail}));return m||g},j(1/0,r),this.peerId=e.peerId,this.logger=e.logger??Yl(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=this.components=CN({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:e.nodeInfo??{name:Rg,version:Sg},logger:this.logger,events:r,datastore:e.datastore??new f7,connectionGater:BN(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",new RN(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),i.events.addEventListener("peer:update",p=>{if(p.detail.previous==null){const m={id:p.detail.peer.id,multiaddrs:p.detail.peer.addresses.map(g=>g.multiaddr)};i.events.safeDispatchEvent("peer:discovery",{detail:m})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new SL(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((p,m)=>this.configureComponent(`connection-encryption-${m}`,p(this.components))),muxers:(e.streamMuxers??[]).map((p,m)=>this.configureComponent(`stream-muxers-${m}`,p(this.components))),inboundUpgradeTimeout:(c=e.connectionManager)==null?void 0:c.inboundUpgradeTimeout}),this.configureComponent("transportManager",new dL(this.components,e.transportManager)),this.configureComponent("connectionManager",new nL(this.components,e.connectionManager)),((l=e.connectionMonitor)==null?void 0:l.enabled)!==!1&&this.configureComponent("connectionMonitor",new aL(this.components,e.connectionMonitor)),this.configureComponent("registrar",new hL(this.components)),this.configureComponent("addressManager",new kN(this.components,e.addresses));const o=(e.peerRouters??[]).map((p,m)=>this.configureComponent(`peer-router-${m}`,p(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new lL(this.components,{routers:o}));const a=(e.contentRouters??[]).map((p,m)=>this.configureComponent(`content-router-${m}`,p(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new cL(this.components,{routers:a})),this.configureComponent("randomWalk",new uL(this.components)),(e.peerDiscovery??[]).forEach((p,m)=>{this.configureComponent(`peer-discovery-${m}`,p(this.components)).addEventListener("peer",y=>{re(this,Ta,ch).call(this,y)})}),(h=e.transports)==null||h.forEach((p,m)=>{this.components.transportManager.add(this.configureComponent(`transport-${m}`,p(this.components)))}),e.services!=null)for(const p of Object.keys(e.services)){const m=e.services[p],g=m(this.components);if(g==null){this.log.error("service factory %s returned null or undefined instance",p);continue}this.services[p]=g,this.configureComponent(p,g),g[Oi]!=null&&(this.log("registering service %s for content routing",p),a.push(g[Oi])),g[Bi]!=null&&(this.log("registering service %s for peer routing",p),o.push(g[Bi])),g[zc]!=null&&(this.log("registering service %s for peer discovery",p),(f=(d=g[zc]).addEventListener)==null||f.call(d,"peer",y=>{re(this,Ta,ch).call(this,y)}))}NN(i)}configureComponent(e,r){return r==null&&this.log.error("component %s was null or undefined",e),this.components[e]=r,r}async start(){var e,r,s,i;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((r=(e=this.components).beforeStart)==null?void 0:r.call(e)),await this.components.start(),await((i=(s=this.components).afterStart)==null?void 0:i.call(s)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var e,r,s,i;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((r=(e=this.components).beforeStop)==null?void 0:r.call(e)),await this.components.stop(),await((i=(s=this.components).afterStop)==null?void 0:i.call(s)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new _n;for(const r of this.components.connectionManager.getConnections())e.add(r.remotePeer);return Array.from(e)}async dial(e,r={}){return this.components.connectionManager.openConnection(e,{priority:75,...r})}async dialProtocol(e,r,s={}){if(r==null)throw new E("no protocols were provided to open a stream",X.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(r=Array.isArray(r)?r:[r],r.length===0)throw new E("no protocols were provided to open a stream",X.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,s)).newStream(r,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,r={}){Xl(e)&&(e=Je(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,r)}async getPublicKey(e,r={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.code!==X.ERR_NOT_FOUND)throw o}const s=gt([V("/pk/"),e.multihash.digest]),i=await this.contentRouting.get(s,r);return ma(i),await this.peerStore.patch(e,{publicKey:i}),i}async handle(e,r,s){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,r,s)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(e,r){return this.components.registrar.register(e,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,r={}){return this.components.connectionManager.isDialable(e,r)}}Ta=new WeakSet,ch=function(e){const{detail:r}=e;if(r.id.toString()===this.peerId.toString()){this.log.error(new Error(X.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(s=>{this.log.error(s)})};async function AL(n={}){const t=n.peerId??(n.peerId=await bN());if(t.privateKey==null)throw new E("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return n.privateKey??(n.privateKey=await Gi(t.privateKey)),new RL(await zN(n))}async function IL(n={}){const t=await AL(n);return n.start!==!1&&await t.start(),t}async function kL(n){var a;const t=(a=n.libp2p)==null?void 0:a.peerId,e=n.logger??Yl(),r=new $e("/pkcs8/self");let s;t==null&&n.datastore!=null&&(s=og(n.keychain)({datastore:n.datastore,logger:e}),await n.datastore.has(r)&&(n.libp2p=n.libp2p??{},n.libp2p.peerId=await s.exportPeerId("self")));const i=wN(n);i.datastore=i.datastore??n.datastore,n=n??{};const o=await IL({...i,...n.libp2p,start:!1});return t==null&&s!=null&&!await n.datastore.has(r)&&await s.importPeer("self",o.peerId),o}async function xL(n={}){const t=n.datastore??new f7,e=n.blockstore??new SS;let r;TL(n.libp2p)?r=n.libp2p:r=await kL({...n,libp2p:{dns:n.dns,...n.libp2p,start:void 0},datastore:t});const s=new KA({...n,libp2p:r,datastore:t,blockstore:e,blockBrokers:n.blockBrokers??[qR(),GS()],routers:[MA(r),OA()],metrics:r.metrics});return n.start!==!1&&await s.start(),s}function TL(n){return n==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(e=>typeof n[e]=="function")}function DL(n){return n[Symbol.asyncIterator]!=null}function Hg(n,t=1){return t=Number(t),DL(n)?async function*(){let e=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for await(const r of n)for(e.push(r);e.length>=t;)yield e.slice(0,t),e=e.slice(t);for(;e.length>0;)yield e.slice(0,t),e=e.slice(t)}():function*(){let e=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for(const r of n)for(e.push(r);e.length>=t;)yield e.slice(0,t),e=e.slice(t);for(;e.length>0;)yield e.slice(0,t),e=e.slice(t)}()}async function*Kg(n,t=1){for await(const e of Hg(n,t)){const r=e.map(async s=>s().then(i=>({ok:!0,value:i}),i=>({ok:!1,err:i})));for(let s=0;s<r.length;s++){const i=await r[s];if(i.ok)yield i.value;else throw i.err}}}const CL=262144,Wd=(n={})=>{const t=n.chunkSize??CL;return async function*(r){let s=new Ie,i=0,o=!1;for await(const a of r)for(s.append(a),i+=a.length;i>=t;)if(yield s.slice(0,t),o=!0,t===s.length)s=new Ie,i=0;else{const c=new Ie;c.append(s.sublist(t)),s=c,i-=t}(!o||i>0)&&(yield s.subarray(0,i))}},li=class li extends Error{constructor(e="Invalid type"){super(e);u(this,"name",li.name);u(this,"code",li.code)}};u(li,"name","InvalidTypeError"),u(li,"code","ERR_INVALID_TYPE");let vl=li;var On;(function(n){(function(r){r.Raw="Raw",r.Directory="Directory",r.File="File",r.Metadata="Metadata",r.Symlink="Symlink",r.HAMTShard="HAMTShard"})(n.DataType||(n.DataType={}));let t;(function(r){r[r.Raw=0]="Raw",r[r.Directory=1]="Directory",r[r.File=2]="File",r[r.Metadata=3]="Metadata",r[r.Symlink=4]="Symlink",r[r.HAMTShard=5]="HAMTShard"})(t||(t={})),function(r){r.codec=()=>Mt(t)}(n.DataType||(n.DataType={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),r.Type!=null&&(s.uint32(8),n.DataType.codec().encode(r.Type,s)),r.Data!=null&&(s.uint32(18),s.bytes(r.Data)),r.filesize!=null&&(s.uint32(24),s.uint64(r.filesize)),r.blocksizes!=null)for(const o of r.blocksizes)s.uint32(32),s.uint64(o);r.hashType!=null&&(s.uint32(40),s.uint64(r.hashType)),r.fanout!=null&&(s.uint32(48),s.uint64(r.fanout)),r.mode!=null&&(s.uint32(56),s.uint32(r.mode)),r.mtime!=null&&(s.uint32(66),Sl.codec().encode(r.mtime,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={blocksizes:[]},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.Type=n.DataType.codec().decode(r);break;case 2:i.Data=r.bytes();break;case 3:i.filesize=r.uint64();break;case 4:i.blocksizes.push(r.uint64());break;case 5:i.hashType=r.uint64();break;case 6:i.fanout=r.uint64();break;case 7:i.mode=r.uint32();break;case 8:i.mtime=Sl.codec().decode(r,r.uint32());break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(On||(On={}));var Sl;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Seconds!=null&&(r.uint32(8),r.int64(e.Seconds)),e.FractionalNanoseconds!=null&&(r.uint32(21),r.fixed32(e.FractionalNanoseconds)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.Seconds=e.int64();break;case 2:s.FractionalNanoseconds=e.fixed32();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Sl||(Sl={}));var z0;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.MimeType!=null&&(r.uint32(10),r.string(e.MimeType)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.MimeType=e.string();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(z0||(z0={}));const q0={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},NL=["directory","hamt-sharded-directory"],W0=parseInt("0644",8),G0=parseInt("0755",8);let Se=class zg{constructor(t={type:"file"}){u(this,"type");u(this,"data");u(this,"blockSizes");u(this,"hashType");u(this,"fanout");u(this,"mtime");u(this,"_mode");u(this,"_originalMode");const{type:e,data:r,blockSizes:s,hashType:i,fanout:o,mtime:a,mode:c}=t;if(e!=null&&!Object.values(q0).includes(e))throw new vl("Type: "+e+" is not valid");this.type=e??"file",this.data=r,this.hashType=i,this.fanout=o,this.blockSizes=s??[],this._originalMode=0,this.mode=c,this.mtime=a}static unmarshal(t){const e=On.decode(t),r=new zg({type:q0[e.Type!=null?e.Type.toString():"File"],data:e.Data,blockSizes:e.blocksizes,mode:e.mode,mtime:e.mtime!=null?{secs:e.mtime.Seconds??0n,nsecs:e.mtime.FractionalNanoseconds}:void 0,fanout:e.fanout});return r._originalMode=e.mode??0,r}set mode(t){t==null?this._mode=this.isDirectory()?G0:W0:this._mode=t&4095}get mode(){return this._mode}isDirectory(){return NL.includes(this.type)}addBlockSize(t){this.blockSizes.push(t)}removeBlockSize(t){this.blockSizes.splice(t,1)}fileSize(){if(this.isDirectory())return 0n;let t=0n;return this.blockSizes.forEach(e=>{t+=e}),this.data!=null&&(t+=BigInt(this.data.length)),t}marshal(){let t;switch(this.type){case"raw":t=On.DataType.Raw;break;case"directory":t=On.DataType.Directory;break;case"file":t=On.DataType.File;break;case"metadata":t=On.DataType.Metadata;break;case"symlink":t=On.DataType.Symlink;break;case"hamt-sharded-directory":t=On.DataType.HAMTShard;break;default:throw new vl(`Type: ${t} is not valid`)}let e=this.data;(this.data==null||this.data.length===0)&&(e=void 0);let r;this.mode!=null&&(r=this._originalMode&4294963200|(this.mode??0),r===W0&&!this.isDirectory()&&(r=void 0),r===G0&&this.isDirectory()&&(r=void 0));let s;return this.mtime!=null&&(s={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),On.encode({Type:t,Data:e,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:r,mtime:s})}};const ho=async(n,t,e)=>{e.codec==null&&(e.codec=Ql);const r=await We.digest(n),s=Q.create(e.cidVersion,e.codec.code,r);return await t.put(s,n,e),s};function LL(n){return async function*(e,r){let s=0n;for await(let i of e.content)yield async()=>{var l;let o;const a={codec:Ql,cidVersion:n.cidVersion,onProgress:n.onProgress};n.rawLeaves?(a.codec=$w,a.cidVersion=1):(o=new Se({type:n.leafType,data:i}),i=nt({Data:o.marshal(),Links:[]}));const c=await ho(i,r,a);return s+=BigInt(i.byteLength),(l=n.onProgress)==null||l.call(n,new G("unixfs:importer:progress:file:write",{bytesWritten:s,cid:c,path:e.path})),{cid:c,unixfs:o,size:BigInt(i.length),block:i}}}}var dr;let qg=(dr=class extends Error{constructor(e="Invalid parameters"){super(e);u(this,"name",dr.name);u(this,"code",dr.code)}},u(dr,"name","InvalidParametersError"),u(dr,"code","ERR_INVALID_PARAMS"),dr);const ui=class ui extends Error{constructor(e="Invalid content"){super(e);u(this,"name",ui.name);u(this,"code",ui.code)}};u(ui,"name","InvalidContentError"),u(ui,"code","ERR_INVALID_CONTENT");let fo=ui;const PL=async(n,t,e)=>{const r=new Se({type:"directory",mtime:n.mtime,mode:n.mode}),s=nt(en({Data:r.marshal()})),i=await ho(s,t,e),o=n.path;return{cid:i,path:o,unixfs:r,size:BigInt(s.length),originalPath:n.originalPath,block:s}};async function*OL(n,t,e){let r=-1,s;for await(const i of Kg(e.bufferImporter(n,t),e.blockWriteConcurrency)){if(r++,r===0){s={...i,single:!0};continue}else r===1&&s!=null&&(yield{...s,block:void 0,single:void 0},s=void 0);yield{...i,block:void 0}}s!=null&&(yield s)}function Y0(n){return n.single===!0}const BL=(n,t,e)=>async function(s){var h,d;if(s.length===1&&Y0(s[0])&&e.reduceSingleLeafToSelf){const f=s[0];let p=f.block;return Y0(f)&&(n.mtime!==void 0||n.mode!==void 0)&&(f.unixfs=new Se({type:"file",mtime:n.mtime,mode:n.mode,data:f.block}),p={Data:f.unixfs.marshal(),Links:[]},f.block=nt(en(p)),f.cid=await ho(f.block,t,{...e,cidVersion:e.cidVersion}),f.size=BigInt(f.block.length)),(h=e.onProgress)==null||h.call(e,new G("unixfs:importer:progress:file:layout",{cid:f.cid,path:f.originalPath})),{cid:f.cid,path:n.path,unixfs:f.unixfs,size:f.size,originalPath:f.originalPath}}const i=new Se({type:"file",mtime:n.mtime,mode:n.mode}),o=s.filter(f=>{var p,m;return f.cid.code===Wn&&f.size>0||f.unixfs!=null&&f.unixfs.data==null&&f.unixfs.fileSize()>0n?!0:!!((m=(p=f.unixfs)==null?void 0:p.data)!=null&&m.length)}).map(f=>{var p,m;return f.cid.code===Wn?(i.addBlockSize(f.size),{Name:"",Tsize:Number(f.size),Hash:f.cid}):(((p=f.unixfs)==null?void 0:p.data)==null?i.addBlockSize(((m=f.unixfs)==null?void 0:m.fileSize())??0n):i.addBlockSize(BigInt(f.unixfs.data.length)),{Name:"",Tsize:Number(f.size),Hash:f.cid})}),a={Data:i.marshal(),Links:o},c=nt(en(a)),l=await ho(c,t,e);return(d=e.onProgress)==null||d.call(e,new G("unixfs:importer:progress:file:layout",{cid:l,path:n.originalPath})),{cid:l,path:n.path,unixfs:i,size:BigInt(c.length+a.Links.reduce((f,p)=>f+(p.Tsize??0),0)),originalPath:n.originalPath,block:c}},ML=async(n,t,e)=>e.layout(OL(n,t,e),BL(n,t,e));function UL(n){return Symbol.iterator in n}function $L(n){return Symbol.asyncIterator in n}function FL(n){try{if(n instanceof Uint8Array)return async function*(){yield n}();if(UL(n))return async function*(){yield*n}();if($L(n))return n}catch{throw new fo("Content was invalid")}throw new fo("Content was invalid")}function VL(n){return async function*(e,r){for await(const s of e){let i;if(s.path!=null&&(i=s.path,s.path=s.path.split("/").filter(o=>o!=null&&o!==".").join("/")),HL(s)){const o={path:s.path,mtime:s.mtime,mode:s.mode,content:async function*(){var c;let a=0n;for await(const l of n.chunker(n.chunkValidator(FL(s.content)))){const h=BigInt(l.byteLength);a+=h,(c=n.onProgress)==null||c.call(n,new G("unixfs:importer:progress:file:read",{bytesRead:a,chunkSize:h,path:s.path})),yield l}}(),originalPath:i};yield async()=>ML(o,r,n)}else if(s.path!=null){const o={path:s.path,mtime:s.mtime,mode:s.mode,originalPath:i};yield async()=>PL(o,r,n)}else throw new Error("Import candidate must have content or path or both")}}}function HL(n){return n.content!=null}const KL=()=>async function*(t){for await(const e of t){if(e.length===void 0)throw new fo("Content was invalid");if(typeof e=="string"||e instanceof String)yield V(e.toString());else if(Array.isArray(e))yield Uint8Array.from(e);else if(e instanceof Uint8Array)yield e;else throw new fo("Content was invalid")}},zL=174;function Wg(n){const t=(n==null?void 0:n.maxChildrenPerNode)??zL;return async function e(r,s){const i=[];for await(const o of Hg(r,t))i.push(await s(o));return i.length>1?e(i,s):i[0]}}let va=class{constructor(t,e){u(this,"options");u(this,"root");u(this,"dir");u(this,"path");u(this,"dirty");u(this,"flat");u(this,"parent");u(this,"parentKey");u(this,"unixfs");u(this,"mode");u(this,"mtime");u(this,"cid");u(this,"size");u(this,"nodeSize");this.options=e??{},this.root=t.root,this.dir=t.dir,this.path=t.path,this.dirty=t.dirty,this.flat=t.flat,this.parent=t.parent,this.parentKey=t.parentKey,this.unixfs=t.unixfs,this.mode=t.mode,this.mtime=t.mtime}};const lh=Q.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),uh=Q.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class Gd extends va{constructor(e,r){super(e,r);u(this,"_children");this._children=new Map}async put(e,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,r)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}async*eachChildSeries(){for(const[e,r]of this._children.entries())yield{key:e,child:r}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(const[e,r]of this._children.entries())r.size!=null&&r.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?uh.bytes.byteLength:lh.bytes.byteLength));return this.nodeSize}async*flush(e){const r=[];for(const[l,h]of this._children.entries()){let d=h;if(h instanceof va)for await(const f of h.flush(e))d=f,yield f;d.size!=null&&d.cid!=null&&r.push({Name:l,Tsize:Number(d.size),Hash:d.cid})}const s=new Se({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:s.marshal(),Links:r},o=nt(en(i)),a=await ho(o,e,this.options),c=o.length+i.Links.reduce((l,h)=>l+(h.Tsize??0),0);this.cid=a,this.size=c,yield{cid:a,unixfs:s,path:this.path,size:BigInt(c)}}}const lu=Bh({name:"murmur3-128",code:34,encode:n=>ny(wa.x64.hash128(n))}),wc=7;var qL=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(t,e){let r=this._internalPositionFor(t,!1);if(e===void 0)r!==-1&&(this._unsetInternalPos(r),this._unsetBit(t),this._changedLength=!0,this._changedData=!0);else{let s=!1;r===-1?(r=this._data.length,this._setBit(t),this._changedData=!0):s=!0,this._setInternalPos(r,t,e,s),this._changedLength=!0}}unset(t){this.set(t,void 0)}get(t){this._sortData();const e=this._internalPositionFor(t,!0);if(e!==-1)return this._data[e][1]}push(t){return this.set(this.length,t),this.length}get length(){if(this._sortData(),this._changedLength){const t=this._data[this._data.length-1];this._length=t?t[0]+1:0,this._changedLength=!1}return this._length}forEach(t){let e=0;for(;e<this.length;)t(this.get(e),e,this),e++}map(t){let e=0,r=new Array(this.length);for(;e<this.length;)r[e]=t(this.get(e),e,this),e++;return r}reduce(t,e){let r=0,s=e;for(;r<this.length;){const i=this.get(r);s=t(s,i,r),r++}return s}find(t){let e=0,r,s;for(;e<this.length&&!r;)s=this.get(e),r=t(s),e++;return r?s:void 0}_internalPositionFor(t,e){const r=this._bytePosFor(t,e);if(r>=this._bitArrays.length)return-1;const s=this._bitArrays[r],i=t-r*wc;if(!((s&1<<i)>0))return-1;const a=this._bitArrays.slice(0,r).reduce(WL,0),c=~(4294967295<<i+1),l=Gg(s&c);return a+l-1}_bytePosFor(t,e){const r=Math.floor(t/wc),s=r+1;for(;!e&&this._bitArrays.length<s;)this._bitArrays.push(0);return r}_setBit(t){const e=this._bytePosFor(t,!1);this._bitArrays[e]|=1<<t-e*wc}_unsetBit(t){const e=this._bytePosFor(t,!1);this._bitArrays[e]&=~(1<<t-e*wc)}_setInternalPos(t,e,r,s){const i=this._data,o=[e,r];if(s)this._sortData(),i[t]=o;else{if(i.length)if(i[i.length-1][0]>=e)i.push(o);else if(i[0][0]<=e)i.unshift(o);else{const a=Math.round(i.length/2);this._data=i.slice(0,a).concat(o).concat(i.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(t){this._data.splice(t,1)}_sortData(){this._changedData&&this._data.sort(GL),this._changedData=!1}bitField(){const t=[];let e=8,r=0,s=0,i;const o=this._bitArrays.slice();for(;o.length||r;){r===0&&(i=o.shift(),r=7);const c=Math.min(r,e),l=~(255<<c),h=i&l;s|=h<<8-e,i=i>>>c,r-=c,e-=c,(!e||!r&&!o.length)&&(t.push(s),s=0,e=8)}for(var a=t.length-1;a>0&&t[a]===0;a--)t.pop();return t}compactArray(){return this._sortData(),this._data.map(YL)}};function WL(n,t){return n+Gg(t)}function Gg(n){let t=n;return t=t-(t>>1&1431655765),t=(t&858993459)+(t>>2&858993459),(t+(t>>4)&252645135)*16843009>>24}function GL(n,t){return n[0]-t[0]}function YL(n){return n[1]}const Rl=Ir(qL);class Lt{constructor(t,e,r=0){u(this,"_options");u(this,"_popCount");u(this,"_parent");u(this,"_posAtParent");u(this,"_children");u(this,"key");this._options=t,this._popCount=0,this._parent=e,this._posAtParent=r,this._children=new Rl,this.key=null}async put(t,e){const r=await this._findNewBucketAndPos(t);r.bucket._putAt(r,t,e)}async get(t){const e=await this._findChild(t);if(e!=null)return e.value}async del(t){const e=await this._findPlace(t),r=e.bucket._at(e.pos);r!=null&&r.key===t&&e.bucket._delAt(e.pos)}leafCount(){return this._children.compactArray().reduce((e,r)=>r instanceof Lt?e+r.leafCount():e+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const t=this._children.compactArray();for(const e of t)e instanceof Lt?yield*e.eachLeafSeries():yield e}serialize(t,e){const r=[];return e(this._children.reduce((s,i,o)=>(i!=null&&(i instanceof Lt?s.push(i.serialize(t,e)):s.push(t(i,o))),s),r))}async asyncTransform(t,e){return Yg(this,t,e)}toJSON(){return this.serialize(XL,ZL)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(t){const e=await this._findPlace(t),r=e.bucket._at(e.pos);if(!(r instanceof Lt)&&r!=null&&r.key===t)return r}async _findPlace(t){const e=this._options.hash(typeof t=="string"?V(t):t),r=await e.take(this._options.bits),s=this._children.get(r);return s instanceof Lt?s._findPlace(e):{bucket:this,pos:r,hash:e,existingChild:s}}async _findNewBucketAndPos(t){const e=await this._findPlace(t);if(e.existingChild!=null&&e.existingChild.key!==t){const r=new Lt(this._options,e.bucket,e.pos);e.bucket._putObjectAt(e.pos,r);const s=await r._findPlace(e.existingChild.hash);return s.bucket._putAt(s,e.existingChild.key,e.existingChild.value),r._findNewBucketAndPos(e.hash)}return e}_putAt(t,e,r){this._putObjectAt(t.pos,{key:e,value:r,hash:t.hash})}_putObjectAt(t,e){this._children.get(t)==null&&this._popCount++,this._children.set(t,e)}_delAt(t){if(t===-1)throw new Error("Invalid position");this._children.get(t)!=null&&this._popCount--,this._children.unset(t),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const t=this._children.find(QL);if(t!=null&&!(t instanceof Lt)){const e=t.hash;e.untake(this._options.bits);const r={pos:this._posAtParent,hash:e,bucket:this._parent};this._parent._putAt(r,t.key,t.value)}}else this._parent._delAt(this._posAtParent)}_at(t){return this._children.get(t)}}function QL(n){return!!n}function XL(n,t){return n.key}function ZL(n){return n}async function Yg(n,t,e){const r=[];for(const s of n._children.compactArray())if(s instanceof Lt)await Yg(s,t,e);else{const i=await t(s);r.push({bitField:n._children.bitField(),children:i})}return e(r)}const jL=[255,254,252,248,240,224,192,128],JL=[1,3,7,15,31,63,127,255];let eP=class{constructor(t){u(this,"_value");u(this,"_currentBytePos");u(this,"_currentBitPos");this._value=t,this._currentBytePos=t.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(t){let e=t,r=0;for(;e>0&&this._haveBits();){const s=this._value[this._currentBytePos],i=this._currentBitPos+1,o=Math.min(i,e),a=tP(s,i-o,o);r=(r<<o)+a,e-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(t){for(this._currentBitPos+=t;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function tP(n,t,e){const r=nP(t,e);return(n&r)>>>t}function nP(n,t){return jL[n]&JL[Math.min(t+n-1,7)]}function rP(n){function t(e){return e instanceof Q0?e:new Q0(e,n)}return t}let Q0=class{constructor(t,e){u(this,"_value");u(this,"_hashFn");u(this,"_depth");u(this,"_availableBits");u(this,"_currentBufferIndex");u(this,"_buffers");if(!(t instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=t,this._hashFn=e,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(t){let e=t;for(;this._availableBits<e;)await this._produceMoreBits();let r=0;for(;e>0;){const s=this._buffers[this._currentBufferIndex],i=Math.min(s.availableBits(),e),o=s.take(i);r=(r<<i)+o,e-=i,this._availableBits-=i,s.availableBits()===0&&this._currentBufferIndex++}return r}untake(t){let e=t;for(;e>0;){const r=this._buffers[this._currentBufferIndex],s=Math.min(r.totalBits()-r.availableBits(),e);r.untake(s),e-=s,this._availableBits+=s,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const t=this._depth>0?gt([this._value,Uint8Array.from([this._depth])]):this._value,e=await this._hashFn(t),r=new eP(e);this._buffers.push(r),this._availableBits+=r.availableBits()}};function Yd(n){if(n==null||n.hashFn==null)throw new Error("please define an options.hashFn");const t={bits:n.bits??8,hash:rP(n.hashFn)};return new Lt(t)}async function sP(n){return(await lu.encode(n)).slice(0,8).reverse()}const Qg=BigInt(34),iP=8;let oP=class extends va{constructor(e,r){super(e,r);u(this,"_bucket");this._bucket=Yd({hashFn:sP,bits:r.shardFanoutBits??iP})}async put(e,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,r)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:r}of this._bucket.eachLeafSeries())yield{key:e,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=Zg(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const r of Xg(this._bucket,e,this,this.options))yield{...r,path:this.path}}};async function*Xg(n,t,e,r){const s=n._children,i=(n.tableSize()-1).toString(16).length,o=[];let a=0n;for(let m=0;m<s.length;m++){const g=s.get(m);if(g==null)continue;const y=m.toString(16).toUpperCase().padStart(i,"0");if(g instanceof Lt){let w;for await(const _ of Xg(g,t,null,r))w=_;if(w==null)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:y,Tsize:Number(w.size),Hash:w.cid}),a+=w.size}else if(aP(g.value)){const w=g.value;let _;for await(const v of w.flush(t))_=v,yield _;if(_==null)throw new Error("Did not flush dir");const b=y+g.key;o.push({Name:b,Tsize:Number(_.size),Hash:_.cid}),a+=_.size}else{const w=g.value;if(w.cid==null)continue;const _=y+g.key,b=w.size;o.push({Name:_,Tsize:Number(b),Hash:w.cid}),a+=BigInt(b??0)}}const c=Uint8Array.from(s.bitField().reverse()),l=new Se({type:"hamt-sharded-directory",data:c,fanout:BigInt(n.tableSize()),hashType:Qg,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode}),h={Data:l.marshal(),Links:o},d=nt(en(h)),f=await ho(d,t,r),p=BigInt(d.byteLength)+a;yield{cid:f,unixfs:l,size:p}}function aP(n){return typeof n.flush=="function"}function Zg(n,t,e){const r=n._children,s=(n.tableSize()-1).toString(16).length,i=[];for(let l=0;l<r.length;l++){const h=r.get(l);if(h==null)continue;const d=l.toString(16).toUpperCase().padStart(s,"0");if(h instanceof Lt){const f=Zg(h,null,e);i.push({Name:d,Tsize:Number(f),Hash:e.cidVersion===0?lh:uh})}else if(typeof h.value.flush=="function"){const p=h.value.nodeSize();i.push({Name:d+h.key,Tsize:Number(p),Hash:e.cidVersion===0?lh:uh})}else{const f=h.value;if(f.cid==null)continue;const p=d+h.key,m=f.size;i.push({Name:p,Tsize:Number(m),Hash:f.cid})}}const o=Uint8Array.from(r.bitField().reverse()),a=new Se({type:"hamt-sharded-directory",data:o,fanout:BigInt(n.tableSize()),hashType:Qg,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode});return nt(en({Data:a.marshal(),Links:i})).length}async function jg(n,t,e,r){let s=t;t instanceof Gd&&t.estimateNodeSize()>e&&(s=await cP(t,r));const i=s.parent;if(i!=null){if(s!==t){if(n!=null&&(n.parent=s),s.parentKey==null)throw new Error("No parent key found");await i.put(s.parentKey,s)}return jg(s,i,e,r)}return s}async function cP(n,t){const e=new oP({root:n.root,dir:!0,parent:n.parent,parentKey:n.parentKey,path:n.path,dirty:n.dirty,flat:!1,mtime:n.mtime,mode:n.mode},t);for await(const{key:r,child:s}of n.eachChildSeries())await e.put(r,s);return e}const lP=(n="")=>n.split(new RegExp("(?<!\\\\)\\/")).filter(Boolean);async function uP(n,t,e){var a,c;const r=lP(n.path??""),s=r.length-1;let i=t,o="";for(let l=0;l<r.length;l++){const h=r[l];o+=`${o!==""?"/":""}${h}`;const d=l===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,d)await i.put(h,n),t=await jg(null,i,e.shardSplitThresholdBytes,e);else{let f=await i.get(h);(f==null||!(f instanceof va))&&(f=new Gd({root:!1,dir:!0,parent:i,parentKey:h,path:o,dirty:!0,flat:!0,mtime:(a=f==null?void 0:f.unixfs)==null?void 0:a.mtime,mode:(c=f==null?void 0:f.unixfs)==null?void 0:c.mode},e)),await i.put(h,f),i=f}}return t}async function*X0(n,t){var e;if(!(n instanceof va)){((e=n.unixfs)==null?void 0:e.isDirectory())===!0&&(yield n);return}yield*n.flush(t)}function hP(n){return async function*(e,r){var a;let s=new Gd({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n),i,o=!1;for await(const c of e){if(c==null)continue;const l=`${c.originalPath??""}`.split("/")[0];l!=null&&l!==""&&(i==null?(i=l,o=!0):i!==l&&(o=!1)),s=await uP(c,s,n),((a=c.unixfs)==null?void 0:a.isDirectory())!==!0&&(yield c)}if(n.wrapWithDirectory||o&&s.childCount()>1)yield*X0(s,r);else for await(const c of s.eachChildSeries())c!=null&&(yield*X0(c.child,r))}}async function*qa(n,t,e={}){let r;Symbol.asyncIterator in n||Symbol.iterator in n?r=n:r=[n];const s=e.wrapWithDirectory??!1,i=e.shardSplitThresholdBytes??262144,o=e.shardFanoutBits??8,a=e.cidVersion??1,c=e.rawLeaves??!0,l=e.leafType??"file",h=e.fileImportConcurrency??50,d=e.blockWriteConcurrency??10,f=e.reduceSingleLeafToSelf??!0,p=e.chunker??Wd(),m=e.chunkValidator??KL(),g=e.dagBuilder??VL({chunker:p,chunkValidator:m,wrapWithDirectory:s,layout:e.layout??Wg(),bufferImporter:e.bufferImporter??LL({cidVersion:a,rawLeaves:c,leafType:l,onProgress:e.onProgress}),blockWriteConcurrency:d,reduceSingleLeafToSelf:f,cidVersion:a,onProgress:e.onProgress}),y=e.treeBuilder??hP({wrapWithDirectory:s,shardSplitThresholdBytes:i,shardFanoutBits:o,cidVersion:a,onProgress:e.onProgress});for await(const w of y(Kg(g(r,t),h),t))yield{cid:w.cid,path:w.path,unixfs:w.unixfs,size:w.size}}async function Qd(n,t,e={}){const r=await Ji(qa([n],t,e));if(r==null)throw new qg("Nothing imported");return r}async function dP(n,t,e={}){const r=await Ji(qa([n],t,e));if(r==null)throw new qg("Nothing imported");return r}async function fP(n,t,e={}){return Qd({content:n},t,e)}async function gP(n,t,e={}){return Qd({content:n},t,e)}const Wa={cidVersion:1,rawLeaves:!0,layout:Wg({maxChildrenPerNode:1024}),chunker:Wd({chunkSize:1048576})};async function*pP(n,t,e={}){yield*qa(n,t,{...Wa,...e})}async function yP(n,t,e={}){const{cid:r}=await fP(n,t,{...Wa,...e});return r}async function mP(n,t,e={}){const{cid:r}=await gP(n,t,{...Wa,...e});return r}async function wP(n,t,e={}){const{cid:r}=await Qd(n,t,{...Wa,...e});return r}async function bP(n,t,e={}){const{cid:r}=await dP({...n,path:n.path??"-"},t,{...Wa,...e});return r}function EP(n){return n[Symbol.asyncIterator]!=null}function uu(n){if(EP(n))return(async()=>{let e;for await(const r of n)e=r;return e})();let t;for(const e of n)t=e;return t}const hi=class hi extends Error{constructor(e="Bad path"){super(e);u(this,"name",hi.name);u(this,"code",hi.code)}};u(hi,"name","BadPathError"),u(hi,"code","ERR_BAD_PATH");let hh=hi;const di=class di extends Error{constructor(e="Not found"){super(e);u(this,"name",di.name);u(this,"code",di.code)}};u(di,"name","NotFoundError"),u(di,"code","ERR_NOT_FOUND");let os=di;const fi=class fi extends Error{constructor(e="No resolver"){super(e);u(this,"name",fi.name);u(this,"code",fi.code)}};u(fi,"name","NoResolverError"),u(fi,"code","ERR_NO_RESOLVER");let dh=fi;var fr;let jt=(fr=class extends Error{constructor(e="Not UnixFS"){super(e);u(this,"name",fr.name);u(this,"code",fr.code)}},u(fr,"name","NotUnixFSError"),u(fr,"code","ERR_NOT_UNIXFS"),fr);const gi=class gi extends Error{constructor(e="Over read"){super(e);u(this,"name",gi.name);u(this,"code",gi.code)}};u(gi,"name","OverReadError"),u(gi,"code","ERR_OVER_READ");let fh=gi;const pi=class pi extends Error{constructor(e="Under read"){super(e);u(this,"name",pi.name);u(this,"code",pi.code)}};u(pi,"name","UnderReadError"),u(pi,"code","ERR_UNDER_READ");let gh=pi;const yi=class yi extends Error{constructor(e="No Property found"){super(e);u(this,"name",yi.name);u(this,"code",yi.code)}};u(yi,"name","NoPropError"),u(yi,"code","ERR_NO_PROP");let ph=yi;var gr;let bc=(gr=class extends Error{constructor(e="Invalid parameters"){super(e);u(this,"name",gr.name);u(this,"code",gr.code)}},u(gr,"name","InvalidParametersError"),u(gr,"code","ERR_INVALID_PARAMS"),gr);function Xd(n,t,e,r,s,i,o){let a=n,c=s;for(;i.length>0;){const l=i[0];if(l in a){i.shift(),c=`${c}/${l}`;const h=Q.asCID(a[l]);if(h!=null)return{entry:{type:"object",name:r,path:s,cid:e,node:t,depth:o,size:BigInt(t.length),content:async function*(){yield n}},next:{cid:h,name:l,path:c,toResolve:i}};a=a[l]}else throw new ph(`No property named ${l} found in node ${e}`)}return{entry:{type:"object",name:r,path:s,cid:e,node:t,depth:o,size:BigInt(t.length),content:async function*(){yield n}}}}const _P=async(n,t,e,r,s,i,o,a)=>{const c=await o.get(n,a),l=Oh(c);return Xd(l,c,n,t,e,r,i)},vP=async(n,t,e,r,s,i,o,a)=>{const c=await o.get(n,a),l=Vv(c);return Xd(l,c,n,t,e,r,i)};function Al(n,t,e,r){const s=BigInt(n.length),i=BigInt(t+s);return e>=i||r<t?new Uint8Array(0):(r>=t&&r<i&&(n=n.subarray(0,Number(r-t))),e>=t&&e<i&&(n=n.subarray(Number(e-t))),n)}const Zd=(n,t=0,e=n)=>{const r=BigInt(n),s=BigInt(t??0);let i=BigInt(e);if(i!==r&&(i=s+i),i>r&&(i=r),s<0n)throw new bc("Offset must be greater than or equal to 0");if(s>r)throw new bc("Offset must be less than the file size");if(i<0n)throw new bc("Length must be greater than or equal to 0");if(i>r)throw new bc("Length must be less than the file size");return{start:s,end:i}},SP=n=>{async function*t(e={}){var o;const{start:r,end:s}=Zd(n.length,e.offset,e.length),i=Al(n,0n,r,s);(o=e.onProgress)==null||o.call(e,new G("unixfs:exporter:progress:identity",{bytesRead:BigInt(i.byteLength),totalBytes:s-r,fileSize:BigInt(n.byteLength)})),yield i}return t},RP=async(n,t,e,r,s,i,o,a)=>{if(r.length>0)throw new os(`No link named ${e} found in raw node ${n}`);const c=cs(n.multihash.bytes);return{entry:{type:"identity",name:t,path:e,cid:n,content:SP(c.digest),depth:i,size:BigInt(c.digest.length),node:c.digest}}},AP=async(n,t,e,r,s,i,o,a)=>{const c=await o.get(n,a),l=Ow(c);return Xd(l,c,n,t,e,r,i)},IP=n=>{async function*t(e={}){var o;const{start:r,end:s}=Zd(n.length,e.offset,e.length),i=Al(n,0n,r,s);(o=e.onProgress)==null||o.call(e,new G("unixfs:exporter:progress:raw",{bytesRead:BigInt(i.byteLength),totalBytes:s-r,fileSize:BigInt(n.byteLength)})),yield i}return t},kP=async(n,t,e,r,s,i,o,a)=>{if(r.length>0)throw new os(`No link named ${e} found in raw node ${n}`);const c=await o.get(n,a);return{entry:{type:"raw",name:t,path:e,cid:n,content:IP(c),depth:i,size:BigInt(c.length),node:c}}},xP=async function(n){return(await lu.encode(n)).slice(0,8).reverse()},TP=async(n,t,e)=>{const r=(t.tableSize()-1).toString(16).length;await Promise.all(n.map(async s=>{if(s.Name==null)throw new Error("Unexpected Link without a Name");if(s.Name.length===r){const i=parseInt(s.Name,16);t._putObjectAt(i,new Lt({hash:e._options.hash,bits:e._options.bits},t,i));return}await e.put(s.Name.substring(2),!0)}))},Z0=(n,t)=>n.toString(16).toUpperCase().padStart(t,"0").substring(0,t),DP=n=>{let t=n.bucket;const e=[];for(;t._parent!=null;)e.push(t),t=t._parent;return e.push(t),e.reverse()},Jg=async(n,t,e,r,s)=>{if(r==null){if(n.Data==null)throw new jt("no data in PBNode");let d;try{d=Se.unmarshal(n.Data)}catch(p){throw new jt(p.message)}if(d.type!=="hamt-sharded-directory")throw new jt("not a HAMT");if(d.fanout==null)throw new jt("missing fanout");const f=Yd({hashFn:xP,bits:Math.log2(Number(d.fanout))});r={rootBucket:f,hamtDepth:1,lastBucket:f}}const i=(r.lastBucket.tableSize()-1).toString(16).length;await TP(n.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(t);let a=Z0(o.pos,i);const c=DP(o);c.length>r.hamtDepth&&(r.lastBucket=c[r.hamtDepth],a=Z0(r.lastBucket._posAtParent,i));const l=n.Links.find(d=>{if(d.Name==null)return!1;const f=d.Name.substring(0,i),p=d.Name.substring(i);return!(f!==a||p!==""&&p!==t)});if(l==null)return;if(l.Name!=null&&l.Name.substring(i)===t)return l.Hash;r.hamtDepth++;const h=await e.get(l.Hash,s);return n=gn(h),Jg(n,t,e,r,s)},CP=(n,t,e,r,s,i,o)=>{async function*a(c={}){var f;const l=c.offset??0,h=c.length??t.Links.length,d=t.Links.slice(l,h);(f=c.onProgress)==null||f.call(c,new G("unixfs:exporter:walk:directory",{cid:n})),yield*vt(d,p=>vr(p,m=>async()=>{const g=m.Name??"",y=`${r}/${g}`;return(await s(m.Hash,g,y,[],i+1,o,c)).entry}),p=>hs(p,{ordered:!0,concurrency:c.blockReadConcurrency}),p=>Mr(p,m=>m!=null))}return a};async function e9(n,t,e,r,s,i,o){if(t instanceof Uint8Array){const l=Al(t,r,s,i);e.push(l);return}if(t.Data==null)throw new jt("no data in PBNode");let a;try{a=Se.unmarshal(t.Data)}catch(l){throw new jt(l.message)}if(a.data!=null){const l=a.data,h=Al(l,r,s,i);e.push(h),r+=BigInt(h.byteLength)}const c=[];if(t.Links.length!==a.blockSizes.length)throw new jt("Inconsistent block sizes and dag links");for(let l=0;l<t.Links.length;l++){const h=t.Links[l],d=r,f=d+a.blockSizes[l];if((s>=d&&s<f||i>=d&&i<=f||s<d&&i>f)&&c.push({link:h,blockStart:r}),r=f,r>i)break}await vt(c,l=>vr(l,h=>async()=>{const d=await n.get(h.link.Hash,o);return{...h,block:d}}),l=>hs(l,{ordered:!0,concurrency:o.blockReadConcurrency}),async l=>{for await(const{link:h,block:d,blockStart:f}of l){let p;switch(h.Hash.code){case Zn:p=gn(d);break;case Wn:p=d;break;default:e.end(new jt(`Unsupported codec: ${h.Hash.code}`));return}const m=new Zi({concurrency:1});m.on("error",g=>{e.end(g)}),m.add(async()=>{var g;(g=o.onProgress)==null||g.call(o,new G("unixfs:exporter:walk:file",{cid:h.Hash})),await e9(n,p,e,f,s,i,o)}),await m.onIdle()}}),r>=i&&e.end()}const j0=(n,t,e,r,s,i,o)=>{async function*a(c={}){var g,y;const l=e.fileSize();if(l===void 0)throw new Error("File was a directory");const{start:h,end:d}=Zd(l,c.offset,c.length);if(d===0n)return;let f=0n;const p=d-h,m=ls();(g=c.onProgress)==null||g.call(c,new G("unixfs:exporter:walk:file",{cid:n})),e9(o,t,m,0n,h,d,c).catch(w=>{m.end(w)});for await(const w of m)if(w!=null){if(f+=BigInt(w.byteLength),f>p)throw m.end(),new fh("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");f===p&&m.end(),(y=c.onProgress)==null||y.call(c,new G("unixfs:exporter:progress:unixfs:file",{bytesRead:f,totalBytes:p,fileSize:l})),yield w}if(f<p)throw new gh("Traversed entire DAG but did not read enough bytes")}return a},NP=(n,t,e,r,s,i,o)=>{function a(c={}){var l;return(l=c.onProgress)==null||l.call(c,new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:n})),t9(t,r,s,i,o,c)}return a};async function*t9(n,t,e,r,s,i){const o=n.Links;if(n.Data==null)throw new jt("no data in PBNode");let a;try{a=Se.unmarshal(n.Data)}catch(h){throw new jt(h.message)}if(a.fanout==null)throw new jt("missing fanout");const c=(a.fanout-1n).toString(16).length,l=vt(o,h=>vr(h,d=>async()=>{var p;const f=d.Name!=null?d.Name.substring(c):null;if(f!=null&&f!==""){const m=await e(d.Hash,f,`${t}/${f}`,[],r+1,s,i);return{entries:m.entry==null?[]:[m.entry]}}else{const m=await s.get(d.Hash,i);return n=gn(m),(p=i.onProgress)==null||p.call(i,new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:d.Hash})),{entries:t9(n,t,e,r,s,i)}}}),h=>hs(h,{ordered:!0,concurrency:i.blockReadConcurrency}));for await(const{entries:h}of l)yield*h}const LP=(n,t)=>{const e=n.Links.find(r=>r.Name===t);return e==null?void 0:e.Hash},PP={raw:j0,file:j0,directory:CP,"hamt-sharded-directory":NP,metadata:(n,t,e,r,s,i,o)=>()=>[],symlink:(n,t,e,r,s,i,o)=>()=>[]},OP=async(n,t,e,r,s,i,o,a)=>{const c=await o.get(n,a),l=gn(c);let h,d;if(t==null&&(t=n.toString()),l.Data==null)throw new jt("no data in PBNode");try{h=Se.unmarshal(l.Data)}catch(p){throw new jt(p.message)}if(e==null&&(e=t),r.length>0){let p;if((h==null?void 0:h.type)==="hamt-sharded-directory"?p=await Jg(l,r[0],o):p=LP(l,r[0]),p==null)throw new os("file does not exist");const m=r.shift(),g=`${e}/${m}`;d={cid:p,toResolve:r,name:m??"",path:g}}const f=PP[h.type](n,l,h,e,s,i,o);if(f==null)throw new os("could not find content exporter");return h.isDirectory()?{entry:{type:"directory",name:t,path:e,cid:n,content:f,unixfs:h,depth:i,node:l,size:h.fileSize()},next:d}:{entry:{type:"file",name:t,path:e,cid:n,content:f,unixfs:h,depth:i,node:l,size:h.fileSize()},next:d}},BP={[Zn]:OP,[Wn]:kP,[Ph]:_P,[E8]:vP,[Er.code]:RP,[X4]:AP},n9=async(n,t,e,r,s,i,o)=>{const a=BP[n.code];if(a==null)throw new dh(`No resolver for code ${n.code}`);return a(n,t,e,r,n9,s,i,o)},MP=(n="")=>(n.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),UP=n=>{if(n instanceof Uint8Array)return{cid:Q.decode(n),toResolve:[]};const t=Q.asCID(n);if(t!=null)return{cid:t,toResolve:[]};if(typeof n=="string"){n.indexOf("/ipfs/")===0&&(n=n.substring(6));const e=MP(n);return{cid:Q.parse(e[0]),toResolve:e.slice(1)}}throw new hh(`Unknown path type ${n}`)};async function*r9(n,t,e={}){let{cid:r,toResolve:s}=UP(n),i=r.toString(),o=i;const a=s.length;for(;;){const c=await n9(r,i,o,s,a,t,e);if(c.entry==null&&c.next==null)throw new os(`Could not resolve ${n}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;s=c.next.toResolve,r=c.next.cid,i=c.next.name,o=c.next.path}}async function ds(n,t,e={}){const r=await uu(r9(n,t,e));if(r==null)throw new os(`Could not resolve ${n}`);return r}async function*s9(n,t,e={}){const r=await ds(n,t,e);if(r==null)return;if(yield r,r.type==="directory")for await(const i of s(r,e))yield i;async function*s(i,o){for await(const a of i.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*s(a,o))}}class xr extends Error{constructor(e,r,s){super(e);u(this,"name");u(this,"code");this.name=r,this.code=s}}class hu extends xr{constructor(t="not a Unixfs node"){super(t,"NotUnixFSError","ERR_NOT_UNIXFS")}}class as extends xr{constructor(t="invalid PBNode"){super(t,"InvalidPBNodeError","ERR_INVALID_PBNODE")}}class jd extends xr{constructor(t="unknown error"){super(t,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class i9 extends xr{constructor(t="path already exists"){super(t,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class $P extends xr{constructor(t="path does not exist"){super(t,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class o9 extends xr{constructor(t="no content"){super(t,"NoContentError","ERR_NO_CONTENT")}}class FP extends xr{constructor(t="not a file"){super(t,"NotAFileError","ERR_NOT_A_FILE")}}class Jd extends xr{constructor(t="not a directory"){super(t,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}class xo extends xr{constructor(t="invalid parameters"){super(t,"InvalidParametersError","ERR_INVALID_PARAMETERS")}}function a9(n){function t(e){return e instanceof J0?e:new J0(e,n)}return t}class J0{constructor(t,e){u(this,"_value");u(this,"_hashFn");u(this,"_depth");u(this,"_availableBits");u(this,"_currentBufferIndex");u(this,"_buffers");if(!(t instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=t,this._hashFn=e,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(t){let e=t;for(;this._availableBits<e;)await this._produceMoreBits();let r=0;for(;e>0;){const s=this._buffers[this._currentBufferIndex],i=Math.min(s.availableBits(),e),o=s.take(i);r=(r<<i)+o,e-=i,this._availableBits-=i,s.availableBits()===0&&this._currentBufferIndex++}return r}untake(t){let e=t;for(;e>0;){const r=this._buffers[this._currentBufferIndex],s=Math.min(r.totalBits()-r.availableBits(),e);r.untake(s),e-=s,this._availableBits+=s,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const t=this._depth>0?gt([this._value,Uint8Array.from([this._depth])]):this._value,e=await this._hashFn(t),r=new KP(e);this._buffers.push(r),this._availableBits+=r.availableBits()}}const VP=[255,254,252,248,240,224,192,128],HP=[1,3,7,15,31,63,127,255];class KP{constructor(t){u(this,"_value");u(this,"_currentBytePos");u(this,"_currentBitPos");this._value=t,this._currentBytePos=t.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(t){let e=t,r=0;for(;e>0&&this._haveBits();){const s=this._value[this._currentBytePos],i=this._currentBitPos+1,o=Math.min(i,e),a=zP(s,i-o,o);r=(r<<o)+a,e-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(t){for(this._currentBitPos+=t;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function zP(n,t,e){const r=qP(t,e);return(n&r)>>>t}function qP(n,t){return VP[n]&HP[Math.min(t+n-1,7)]}const ef=BigInt(lu.code),ta=8;async function tf(n){return(await lu.encode(n)).subarray(0,8).reverse()}const To=async(n,t,e)=>{e.codec==null&&(e.codec=Ql);const r=await We.digest(n),s=Q.create(e.cidVersion,e.codec.code,r);return await t.put(s,n,{...e,signal:e.signal}),s};class WP{constructor(t,e){u(this,"options");u(this,"root");u(this,"dir");u(this,"path");u(this,"dirty");u(this,"flat");u(this,"parent");u(this,"parentKey");u(this,"unixfs");u(this,"mode");u(this,"mtime");u(this,"cid");u(this,"size");u(this,"nodeSize");this.options=e??{},this.root=t.root,this.dir=t.dir,this.path=t.path,this.dirty=t.dirty,this.flat=t.flat,this.parent=t.parent,this.parentKey=t.parentKey,this.unixfs=t.unixfs,this.mode=t.mode,this.mtime=t.mtime}}class GP extends WP{constructor(e,r){super(e,r);u(this,"_bucket");this._bucket=Yd({hashFn:tf,bits:8})}async put(e,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,r)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:r}of this._bucket.eachLeafSeries())yield{key:e,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=l9(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const r of c9(this._bucket,e,this,this.options))yield{...r,path:this.path}}}async function*c9(n,t,e,r){const s=n._children,i=[];let o=0n;for(let p=0;p<s.length;p++){const m=s.get(p);if(m==null)continue;const g=p.toString(16).toUpperCase().padStart(2,"0");if(m instanceof Lt){let y;for await(const w of c9(m,t,null,r))y=w;if(y==null)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:g,Tsize:Number(y.size),Hash:y.cid}),o+=y.size}else if(YP(m.value)){const y=m.value;let w;for await(const b of y.flush(t))w=b,yield w;if(w==null)throw new Error("Did not flush dir");const _=g+m.key;i.push({Name:_,Tsize:Number(w.size),Hash:w.cid}),o+=w.size}else{const y=m.value;if(y.cid==null)continue;const w=g+m.key,_=y.size;i.push({Name:w,Tsize:Number(_),Hash:y.cid}),o+=BigInt(_??0)}}const a=Uint8Array.from(s.bitField().reverse()),c=new Se({type:"hamt-sharded-directory",data:a,fanout:BigInt(n.tableSize()),hashType:ef,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode}),l={Data:c.marshal(),Links:i},h=nt(en(l)),d=await To(h,t,r),f=BigInt(h.byteLength)+o;yield{cid:d,unixfs:c,size:f}}function YP(n){return typeof n.flush=="function"}function l9(n,t,e){const r=n._children,s=[];for(let c=0;c<r.length;c++){const l=r.get(c);if(l==null)continue;const h=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof Lt){const d=l9(l,null,e);s.push({Name:h,Tsize:Number(d),Hash:e.cidVersion===0?yh:mh})}else if(typeof l.value.flush=="function"){const f=l.value.nodeSize();s.push({Name:h+l.key,Tsize:Number(f),Hash:e.cidVersion===0?yh:mh})}else{const d=l.value;if(d.cid==null)continue;const f=h+l.key,p=d.size;s.push({Name:f,Tsize:Number(p),Hash:d.cid})}}const i=Uint8Array.from(r.bitField().reverse()),o=new Se({type:"hamt-sharded-directory",data:i,fanout:BigInt(n.tableSize()),hashType:ef,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode});return nt(en({Data:o.marshal(),Links:s})).length}const yh=Q.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),mh=Q.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),wh=Tt("helia:unixfs:commands:utils:hamt-utils"),bh=n=>n.toString(16).toUpperCase().padStart(2,"0").substring(0,2),QP=async(n,t,e)=>{const r=new GP({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:e.mtime,mode:e.mode},e);for(let i=0;i<t.length;i++)await r._bucket.put(t[i].name,{size:t[i].size,cid:t[i].cid});const s=await uu(r.flush(n));if(s==null)throw new Error("Flushing shard yielded no result");return s},u9=async(n,t,e)=>{const r=Se.unmarshal(n[0].node.Data??new Uint8Array(0)),s=BigInt(Math.pow(2,ta));n.reverse();let i,o;for(let a=0;a<n.length;a++){const c=a===n.length-1,l=n[a],h=Uint8Array.from(l.children.bitField().reverse()),d=new Se({type:"hamt-sharded-directory",data:h,fanout:s,hashType:ef});c&&(d.mtime=r.mtime,d.mode=r.mode),o={Data:d.marshal(),Links:l.node.Links};const f=nt(en(o));if(i=await To(f,t,e),!c){const p=n[a+1];if(p==null)throw new Error("Was not operating on shard root but also had no parent?");wh("updating link in parent sub-shard with prefix %s",p.prefix),p.node.Links=p.node.Links.filter(m=>m.Name!==p.prefix),p.node.Links.push({Name:p.prefix,Hash:i,Tsize:l.node.Links.reduce((m,g)=>m+(g.Tsize??0),f.byteLength)})}}if(i==null||o==null)throw new Error("Noting persisted");return{cid:i,node:o}},h9=async(n,t,e,r)=>{const i=a9(tf)(V(t)),o=[];for(;;){const a=await e.get(n,r),c=gn(a),l=new Rl,h=await i.take(ta),d=bh(h);o.push({prefix:d,children:l,node:c});let f;for(const m of c.Links){const g=m.Name??"";if(g.length<2)throw new Error("Invalid HAMT - link name was too short");const y=parseInt(g.substring(0,2),16);l.set(y,!0),g.startsWith(d)&&(f=m)}if(f==null){wh("no link found with prefix %s for %s",d,t);break}const p=f.Name??"";if(p.length<2)throw new Error("Invalid HAMT - link name was too short");if(p.length===2){n=f.Hash,wh("descend into sub-shard with prefix %s",p);continue}break}return{path:o,hash:i}};async function d9(n,t,e,r){if(n.Data==null)throw new Error("DagPB node had no data");const s=Se.unmarshal(n.Data);let i;if(s.type==="directory")i=XP(n);else if(s.type==="hamt-sharded-directory")i=await f9(n,0,e,t,r);else throw new Error("Can only estimate the size of directories or shards");return i>e}function XP(n){let t=0;for(const e of n.Links)t+=(e.Name??"").length,t+=e.Hash.version===1?mh.bytes.byteLength:yh.bytes.byteLength;return t}async function f9(n,t,e,r,s){if(t>e)return e;if(n.Data==null||!Se.unmarshal(n.Data).isDirectory())return t;for(const o of n.Links){let a=o.Name??"";if(a=a.substring(2),t+=a.length,t+=o.Hash.bytes.byteLength,o.Hash.code===Zn){const c=await r.get(o.Hash,s),l=gn(c);t+=await f9(l,t,e,r,s)}}return t}const $n=Tt("helia:unixfs:components:utils:add-link");async function nf(n,t,e,r){if(n.node.Data==null)throw new xo("Invalid parent passed to addLink");if(Se.unmarshal(n.node.Data).type==="hamt-sharded-directory")return $n("adding link to sharded directory"),JP(n,t,e,r);$n(`adding ${t.Name} (${t.Hash}) to regular directory`);const i=await jP(n,t,e,r);if(await d9(i.node,e,r.shardSplitThresholdBytes,r)){$n("converting directory to sharded directory");const o=await ZP(i,e);i.cid=o.cid,i.node=gn(await e.get(o.cid,r))}return i}const ZP=async(n,t)=>{if(n.node.Data==null)throw new xo("Invalid parent passed to convertToShardedDirectory");const e=Se.unmarshal(n.node.Data),r=await QP(t,n.node.Links.map(s=>({name:s.Name??"",size:BigInt(s.Tsize??0),cid:s.Hash})),{mode:e.mode,mtime:e.mtime,cidVersion:n.cid.version});return $n(`converted directory to sharded directory ${r.cid}`),r},jP=async(n,t,e,r)=>{const s=n.node.Links.filter(h=>{const d=h.Name===t.Name;if(d&&!r.allowOverwriting)throw new i9;return!d});if(s.push(t),n.node.Data==null)throw new as("Parent node with no data passed to addToDirectory");const i=Se.unmarshal(n.node.Data);let o;if(i.mtime!=null){const h=Date.now(),d=Math.floor(h/1e3);i.mtime={secs:BigInt(d),nsecs:(h-d*1e3)*1e3},o=i.marshal()}else o=n.node.Data;n.node=en({Data:o,Links:s});const a=nt(n.node),c=await We.digest(a),l=Q.create(n.cid.version,Zn,c);return await e.put(l,a),{node:n.node,cid:l}},JP=async(n,t,e,r)=>{var d;const{path:s,hash:i}=await h9(n.cid,t.Name,e,r),o=s[s.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,c=parseInt(a,16);$n("next prefix for %s is %s",t.Name,a);const l=`${a}${t.Name}`,h=o.node.Links.find(f=>(f.Name??"").startsWith(a));if(h!=null)if($n("link %s was present in shard",l),h.Name===l){if(!r.allowOverwriting)throw new i9;$n("overwriting %s in subshard",t.Name),o.node.Links=o.node.Links.filter(f=>f.Name!==l),o.node.Links.push({Name:l,Hash:t.Hash,Tsize:t.Tsize})}else{if(((d=h.Name)==null?void 0:d.length)===2)throw new Error("Existing link was subshard?!");{$n("prefix %s already exists, creating new subshard",a);const f=o.node.Links.findIndex(w=>{var _;return(_=w.Name)==null?void 0:_.startsWith(a)}),p=o.node.Links.splice(f,1)[0],m=(p.Name??"").substring(2),y=a9(tf)(V(m));for(let w=0;w<s.length;w++)await y.take(ta);for(;;){const w=await y.take(ta),_=bh(w);p.Name=`${_}${m}`;const b=await i.take(ta),v=bh(b);if(_===v){const R=new Rl;R.set(b,!0),s.push({prefix:v,children:R,node:{Links:[]}});continue}const A=new Rl;A.set(b,!0),A.set(w,!0),s.push({prefix:a,children:A,node:{Links:[p,{Name:`${v}${t.Name}`,Hash:t.Hash,Tsize:t.Tsize}]}});break}}}else $n("link %s was not present in sub-shard",l),t.Name=l,o.node.Links.push(t),o.children.set(c,!0),$n("adding %s to existing sub-shard",l);return u9(s,e,r)};async function du(n,t,e={}){const r=await ds(n,t,e);if(r.type!=="directory")throw new Jd(`${n.toString()} was not a UnixFS directory`);return{cid:n,node:r.node}}async function rf(n,t,e,r){const s=await ds(n,e,r);if(s.type!=="directory"&&s.type!=="file"&&s.type!=="raw")throw new hu(`${n.toString()} was not a UnixFS node`);return{Name:t,Tsize:s.node instanceof Uint8Array?s.node.byteLength:eO(s.node),Hash:n}}function eO(n){const t=n.Links.reduce((e,r)=>e+(r.Tsize??0),0);return nt(n).byteLength+t}const tO=Tt("helia:unixfs:components:utils:resolve");async function Ga(n,t,e,r){if(t==null||t==="")return{cid:n};const s=`/ipfs/${n}${t==null?"":`/${t}`}`,i=await rl(r9(s,e,r));if(i.length===0)throw new $P("Could not find path in directory");return tO("resolved %s to %c",t,n),{cid:i[i.length-1].cid,path:t,segments:i}}async function Il(n,t,e,r){if(t.segments==null||t.segments.length===0)return n;let s=t.segments.pop();if(s==null)throw new Error("Insufficient segments");s.cid=n,t.segments.reverse();for(const i of t.segments){const[o,a]=await Promise.all([du(i.cid,e,r),rf(s.cid,s.name,e,r)]);n=(await nf(o,a,e,{...r,allowOverwriting:!0,cidVersion:n.version})).cid,i.cid=n,s=i}return n}const nO=In.bind({ignoreUndefined:!0}),rO={};async function*sO(n,t,e={}){const r=nO(rO,e),s=await Ga(n,r.path,t,r),i=await ds(s.cid,t,r);if(i.type!=="file"&&i.type!=="raw")throw new FP;if(i.content==null)throw new o9;yield*i.content(r)}const Ya=262144,iO=In.bind({ignoreUndefined:!0}),oO=Tt("helia:unixfs:chmod"),aO={recursive:!1,shardSplitThresholdBytes:Ya};async function cO(n,t,e,r={}){const s=iO(aO,r),i=await Ga(n,s.path,e,r);if(oO("chmod %c %d",i.cid,t),s.recursive){const f=await vt(async function*(){for await(const p of s9(i.cid,e,r)){let m,g=[];if(p.type==="raw")m=new Se({type:"file",data:p.node});else if(p.type==="file"||p.type==="directory")m=p.unixfs,g=p.node.Links;else throw new hu;m.mode=t;const y={Data:m.marshal(),Links:g};yield{path:p.path,content:y}}},p=>qa(p,e,{...s,dagBuilder:async function*(m,g){for await(const y of m)yield async function(){const w=y.content,_=nt(w),b=await To(_,g,{...s,cidVersion:n.version});if(w.Data==null)throw new as(`${b} had no data`);const v=Se.unmarshal(w.Data);return{cid:b,size:BigInt(_.length),path:y.path,unixfs:v}}}}),async p=>uu(p));if(f==null)throw new jd(`Could not chmod ${i.cid.toString()}`);return Il(f.cid,i,e,s)}const o=await e.get(i.cid,r);let a,c=[];if(i.cid.code===Wn)a=new Se({type:"file",data:o});else{const f=gn(o);if(f.Data==null)throw new as(`${i.cid.toString()} had no data`);c=f.Links,a=Se.unmarshal(f.Data)}a.mode=t;const l=nt({Data:a.marshal(),Links:c}),h=await We.digest(l),d=Q.create(i.cid.version,Zn,h);return await e.put(d,l),Il(d,i,e,s)}const lO=In.bind({ignoreUndefined:!0}),uO=Tt("helia:unixfs:cp"),hO={force:!1,shardSplitThresholdBytes:Ya};async function dO(n,t,e,r,s={}){const i=lO(hO,s);if(e.includes("/"))throw new xo("Name must not have slashes");const[o,a]=await Promise.all([du(t,r,i),rf(n,e,r,i)]);return uO('Adding %c as "%s" to %c',n,e,t),(await nf(o,a,r,{allowOverwriting:i.force,cidVersion:t.version,...i})).cid}const fO=In.bind({ignoreUndefined:!0}),gO={};async function*pO(n,t,e={}){const r=fO(gO,e),s=await Ga(n,r.path,t,r),i=await ds(s.cid,t);if(i.type==="file"||i.type==="raw"){yield i;return}if(i.content==null)throw new o9;if(i.type!=="directory")throw new Jd;yield*i.content({offset:e.offset,length:e.length})}const yO=In.bind({ignoreUndefined:!0}),e3=Tt("helia:unixfs:mkdir"),mO={cidVersion:1,force:!1,shardSplitThresholdBytes:Ya};async function wO(n,t,e,r={}){const s=yO(mO,r);if(t.includes("/"))throw new xo("Path must not have slashes");if((await ds(n,e,r)).type!=="directory")throw new Jd(`${n.toString()} was not a UnixFS directory`);e3("creating %s",t);const a={Data:new Se({type:"directory",mode:s.mode,mtime:s.mtime}).marshal(),Links:[]},c=nt(a),l=await We.digest(c),h=Q.create(s.cidVersion,Zn,l);await e.put(h,c);const[d,f]=await Promise.all([du(n,e,s),rf(h,t,e,s)]);return e3("adding empty dir called %s to %c",t,n),(await nf(d,f,e,{...s,allowOverwriting:s.force})).cid}const Pc=Tt("helia:unixfs:utils:remove-link");async function bO(n,t,e,r){if(n.node.Data==null)throw new as("Parent node had no data");if(Se.unmarshal(n.node.Data).type==="hamt-sharded-directory"){Pc(`removing ${t} from sharded directory`);const i=await _O(n,t,e,r);return await d9(i.node,e,r.shardSplitThresholdBytes,r)?i:(Pc("converting shard to flat directory %c",n.cid),vO(i,e,r))}return Pc(`removing link ${t} regular directory`),EO(n,t,e,r)}const EO=async(n,t,e,r)=>{n.node.Links=n.node.Links.filter(o=>o.Name!==t);const s=nt(n.node),i=await To(s,e,{...r,cidVersion:n.cid.version});return Pc(`Updated regular directory ${i}`),{node:n.node,cid:i}},_O=async(n,t,e,r)=>{const{path:s}=await h9(n.cid,t,e,r),i=s[s.length-1];if(i==null)throw new Error("Invalid HAMT, could not generate path");const o=i.node.Links.filter(l=>(l.Name??"").substring(2)===t).map(l=>l.Name).pop();if(o==null)throw new Error("File not found");const a=o.substring(0,2),c=parseInt(a,16);if(i.node.Links=i.node.Links.filter(l=>l.Name!==o),i.children.unset(c),i.node.Links.length===1)for(;s.length!==1;){const l=s[s.length-1];if(l==null||l.node.Links.length>1)break;s.pop();const h=s[s.length-1];if(h==null)break;const d=l.node.Links[0];h.node.Links=h.node.Links.filter(f=>!(f.Name??"").startsWith(h.prefix)),h.node.Links.push({Hash:d.Hash,Name:`${h.prefix}${(d.Name??"").substring(2)}`,Tsize:d.Tsize})}return u9(s,e,r)},vO=async(n,t,e)=>{if(n.node.Data==null)throw new xo("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},s=await ds(n.cid,t);if(s.type!=="directory")throw new Error("Unexpected node type");for await(const c of s.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=nt(c.node).length,r.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}const i=Se.unmarshal(n.node.Data);r.Data=new Se({type:"directory",mode:i.mode,mtime:i.mtime}).marshal();const o=nt(en(r));return{cid:await To(o,t,{codec:Ql,cidVersion:n.cid.version,signal:e.signal}),node:r}},SO=In.bind({ignoreUndefined:!0}),RO=Tt("helia:unixfs:rm"),AO={shardSplitThresholdBytes:Ya};async function IO(n,t,e,r={}){const s=SO(AO,r);if(t.includes("/"))throw new xo("Name must not have slashes");const i=await du(n,e,s);return RO("Removing %s from %c",t,n),(await bO(i,t,e,{...s,cidVersion:n.version})).cid}const kO=In.bind({ignoreUndefined:!0}),xO=Tt("helia:unixfs:stat"),TO={};async function DO(n,t,e={}){var g;const r=kO(TO,e),s=await Ga(n,e.path,t,r);xO("stat %c",s.cid);const i=await ds(s.cid,t,r);if(i.type!=="file"&&i.type!=="directory"&&i.type!=="raw")throw new hu;let o=0n,a=0n,c=0n,l=0n,h=0,d,f;const p=i.type;let m;if(i.type==="raw"&&(o=BigInt(i.node.byteLength),a=BigInt(i.node.byteLength),c=BigInt(i.node.byteLength),l=BigInt(i.node.byteLength),h=1),i.type==="directory"&&(o=0n,a=BigInt(i.unixfs.marshal().byteLength),c=0n,l=a,h=1,d=i.unixfs.mode,f=i.unixfs.mtime,m=i.unixfs),i.type==="file"){const y=await g9(s.cid,t,r);o=i.unixfs.fileSize(),a=BigInt((((g=i.node.Data)==null?void 0:g.byteLength)??0)+i.node.Links.reduce((w,_)=>w+(_.Tsize??0),0)),c=BigInt(y.localFileSize),l=BigInt(y.localDagSize),h=y.blocks,d=i.unixfs.mode,f=i.unixfs.mtime,m=i.unixfs}return{cid:s.cid,mode:d,mtime:f,fileSize:o,dagSize:a,localFileSize:c,localDagSize:l,blocks:h,type:p,unixfs:m}}async function g9(n,t,e){const r={localFileSize:0,localDagSize:0,blocks:0};if(await t.has(n,e)){const s=await t.get(n,e);if(r.blocks++,r.localDagSize+=s.byteLength,n.code===Wn)r.localFileSize+=s.byteLength;else if(n.code===Zn){const i=gn(s);if(i.Links.length>0)for(const o of i.Links){const a=await g9(o.Hash,t,e);r.localFileSize+=a.localFileSize,r.localDagSize+=a.localDagSize,r.blocks+=a.blocks}else{if(i.Data==null)throw new as(`PBNode ${n.toString()} had no data`);const o=Se.unmarshal(i.Data);if(o.data==null)throw new as(`UnixFS node ${n.toString()} had no data`);r.localFileSize+=o.data.byteLength??0}}else throw new jd(`${n.toString()} was neither DAG_PB nor RAW`)}return r}const CO=In.bind({ignoreUndefined:!0}),NO=Tt("helia:unixfs:touch"),LO={recursive:!1,shardSplitThresholdBytes:Ya};async function PO(n,t,e={}){const r=CO(LO,e),s=await Ga(n,r.path,t,r),i=r.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(NO("touch %c %o",s.cid,i),r.recursive){const f=await vt(async function*(){for await(const p of s9(s.cid,t)){let m,g;if(p.type==="raw")m=new Se({data:p.node}),g=[];else if(p.type==="file"||p.type==="directory")m=p.unixfs,g=p.node.Links;else throw new hu;m.mtime=i;const y={Data:m.marshal(),Links:g};yield{path:p.path,content:y}}},p=>qa(p,t,{...r,dagBuilder:async function*(m,g){for await(const y of m)yield async function(){const w=y.content,_=nt(w),b=await To(_,g,{...r,cidVersion:n.version});if(w.Data==null)throw new as(`${b} had no data`);const v=Se.unmarshal(w.Data);return{cid:b,size:BigInt(_.length),path:y.path,unixfs:v}}}}),async p=>uu(p));if(f==null)throw new jd(`Could not chmod ${s.cid.toString()}`);return Il(f.cid,s,t,r)}const o=await t.get(s.cid,e);let a,c=[];if(s.cid.code===Wn)a=new Se({data:o});else{const f=gn(o);if(c=f.Links,f.Data==null)throw new as(`${s.cid.toString()} had no data`);a=Se.unmarshal(f.Data)}a.mtime=i;const l=nt({Data:a.marshal(),Links:c}),h=await We.digest(l),d=Q.create(s.cid.version,Zn,h);return await t.put(d,l),Il(d,s,t,r)}class OO{constructor(t){u(this,"components");this.components=t}async*addAll(t,e={}){yield*pP(t,this.components.blockstore,e)}async addBytes(t,e={}){return yP(t,this.components.blockstore,e)}async addByteStream(t,e={}){return mP(t,this.components.blockstore,e)}async addFile(t,e={}){return wP(t,this.components.blockstore,e)}async addDirectory(t={},e={}){return bP(t,this.components.blockstore,e)}async*cat(t,e={}){yield*sO(t,this.components.blockstore,e)}async chmod(t,e,r={}){return cO(t,e,this.components.blockstore,r)}async cp(t,e,r,s={}){return dO(t,e,r,this.components.blockstore,s)}async*ls(t,e={}){yield*pO(t,this.components.blockstore,e)}async mkdir(t,e,r={}){return wO(t,e,this.components.blockstore,r)}async rm(t,e,r={}){return IO(t,e,this.components.blockstore,r)}async stat(t,e={}){return DO(t,this.components.blockstore,e)}async touch(t,e={}){return PO(t,this.components.blockstore,e)}}function BO(n){return new OO(n)}function MO(n){let t,e,r,s,i,o,a,c,l,h;const d=[FO,$O],f=[];function p(m,g){return m[1]!=null?0:1}return s=p(n),i=f[s]=d[s](n),{c(){t=me("hr"),e=wt(),r=me("article"),i.c(),o=wt(),a=me("button"),a.textContent="Check another"},m(m,g){qe(m,t,g),qe(m,e,g),qe(m,r,g),f[s].m(r,null),qe(m,o,g),qe(m,a,g),c=!0,l||(h=Bo(a,"click",n[7]),l=!0)},p(m,g){let y=s;s=p(m),s===y?f[s].p(m,g):(g4(),Li(f[y],1,1,()=>{f[y]=null}),p4(),i=f[s],i?i.p(m,g):(i=f[s]=d[s](m),i.c()),Ps(i,1),i.m(r,null))},i(m){c||(Ps(i),c=!0)},o(m){Li(i),c=!1},d(m){m&&(Ve(t),Ve(e),Ve(r),Ve(o),Ve(a)),f[s].d(),l=!1,h()}}}function UO(n){let t,e,r,s,i;return s=new b4({}),s.$on("fileUpload",n[5]),{c(){t=me("p"),t.textContent="Upload a Verifiable Credentials file to verify",e=wt(),r=me("div"),y4(s.$$.fragment),ze(t,"class","center svelte-9iin4r"),ze(r,"id","upload-vc"),ze(r,"class","svelte-9iin4r")},m(o,a){qe(o,t,a),qe(o,e,a),qe(o,r,a),Eh(s,r,null),i=!0},p:Vn,i(o){i||(Ps(s.$$.fragment,o),i=!0)},o(o){Li(s.$$.fragment,o),i=!1},d(o){o&&(Ve(t),Ve(e),Ve(r)),_h(s)}}}function $O(n){let t,e,r,s,i,o,a=n[2].attr+"",c,l,h,d,f=JSON.stringify(n[2].val)+"",p,m,g,y,w,_,b,v=n[2].pubKey+"",A,R,k,C,S,B,O=new Date(n[2].ts)+"",M,U,N,D,T,I,P,L=n[2].fileCid+"",$,z,q,te,ne,oe,ce,be,ye;function Le(we,Rt){return we[2].goodSig===!0?HO:VO}let rt=Le(n),Ke=rt(n);function Qe(we,Rt){if(we[3]==="progress")return zO;if(we[3]==="done")return KO}let lt=Qe(n),st=lt&&lt(n);return be=new b4({}),be.$on("fileUpload",n[6]),{c(){Ke.c(),t=wt(),e=me("div"),r=me("table"),s=me("tbody"),i=me("tr"),o=me("td"),c=cr(a),l=wt(),h=me("td"),d=me("code"),p=cr(f),m=wt(),g=me("tr"),y=me("td"),y.textContent="Signer",w=wt(),_=me("td"),b=me("code"),A=cr(v),R=wt(),k=me("tr"),C=me("td"),C.textContent="Time",S=wt(),B=me("td"),M=cr(O),U=wt(),N=me("tr"),D=me("td"),D.textContent="Media",T=wt(),I=me("td"),P=me("code"),$=cr(L),z=wt(),q=me("div"),st&&st.c(),te=wt(),ne=me("p"),ne.textContent="Upload a file to see if it matches this claim:",oe=wt(),ce=me("div"),y4(be.$$.fragment),ze(r,"class","striped"),ze(e,"class","overflow-auto"),ze(ne,"class","center svelte-9iin4r"),ze(ce,"id","upload-media-component"),ze(ce,"class","svelte-9iin4r"),ze(q,"id","upload-media"),ze(q,"class","svelte-9iin4r")},m(we,Rt){Ke.m(we,Rt),qe(we,t,Rt),qe(we,e,Rt),ge(e,r),ge(r,s),ge(s,i),ge(i,o),ge(o,c),ge(i,l),ge(i,h),ge(h,d),ge(d,p),ge(s,m),ge(s,g),ge(g,y),ge(g,w),ge(g,_),ge(_,b),ge(b,A),ge(s,R),ge(s,k),ge(k,C),ge(k,S),ge(k,B),ge(B,M),ge(s,U),ge(s,N),ge(N,D),ge(N,T),ge(N,I),ge(I,P),ge(P,$),qe(we,z,Rt),qe(we,q,Rt),st&&st.m(q,null),ge(q,te),ge(q,ne),ge(q,oe),ge(q,ce),Eh(be,ce,null),ye=!0},p(we,Rt){rt!==(rt=Le(we))&&(Ke.d(1),Ke=rt(we),Ke&&(Ke.c(),Ke.m(t.parentNode,t))),(!ye||Rt&4)&&a!==(a=we[2].attr+"")&&bs(c,a),(!ye||Rt&4)&&f!==(f=JSON.stringify(we[2].val)+"")&&bs(p,f),(!ye||Rt&4)&&v!==(v=we[2].pubKey+"")&&bs(A,v),(!ye||Rt&4)&&O!==(O=new Date(we[2].ts)+"")&&bs(M,O),(!ye||Rt&4)&&L!==(L=we[2].fileCid+"")&&bs($,L),lt===(lt=Qe(we))&&st?st.p(we,Rt):(st&&st.d(1),st=lt&&lt(we),st&&(st.c(),st.m(q,te)))},i(we){ye||(Ps(be.$$.fragment,we),ye=!0)},o(we){Li(be.$$.fragment,we),ye=!1},d(we){we&&(Ve(t),Ve(e),Ve(z),Ve(q)),Ke.d(we),st&&st.d(),_h(be)}}}function FO(n){let t,e,r;return{c(){t=me("p"),e=cr("Couldn't verify your file: "),r=cr(n[1]),ze(t,"class","center svelte-9iin4r")},m(s,i){qe(s,t,i),ge(t,e),ge(t,r)},p(s,i){i&2&&bs(r,s[1])},i:Vn,o:Vn,d(s){s&&Ve(t)}}}function VO(n){let t;return{c(){t=me("h2"),t.textContent="Invalid signature ",ze(t,"class","svelte-9iin4r")},m(e,r){qe(e,t,r)},d(e){e&&Ve(t)}}}function HO(n){let t;return{c(){t=me("h2"),t.textContent="Valid signature ",ze(t,"class","svelte-9iin4r")},m(e,r){qe(e,t,r)},d(e){e&&Ve(t)}}}function KO(n){let t,e;return{c(){t=me("p"),e=cr(n[4]),ze(t,"class","center svelte-9iin4r")},m(r,s){qe(r,t,s),ge(t,e)},p(r,s){s&16&&bs(e,r[4])},d(r){r&&Ve(t)}}}function zO(n){let t;return{c(){t=me("button"),ze(t,"aria-busy","true"),ze(t,"aria-label","Please wait"),ze(t,"class","secondary")},m(e,r){qe(e,t,r)},p:Vn,d(e){e&&Ve(t)}}}function qO(n){let t,e,r,s,i,o,a;const c=[UO,MO],l=[];function h(d,f){return d[0]==="home"?0:d[0]==="verify"?1:-1}return~(r=h(n))&&(s=l[r]=c[r](n)),{c(){t=me("h1"),t.textContent="Authenticated Attributes Verifier",e=wt(),s&&s.c(),i=wt(),o=me("footer"),o.innerHTML=`<hr/> <p>Produced by <a href="https://www.starlinglab.org/">Starling Lab</a>. Source
    code <a href="https://github.com/starlinglab/aa-verify">available</a>.</p>`,ze(t,"class","svelte-9iin4r"),ze(o,"class","svelte-9iin4r")},m(d,f){qe(d,t,f),qe(d,e,f),~r&&l[r].m(d,f),qe(d,i,f),qe(d,o,f),a=!0},p(d,[f]){let p=r;r=h(d),r===p?~r&&l[r].p(d,f):(s&&(g4(),Li(l[p],1,1,()=>{l[p]=null}),p4()),~r?(s=l[r],s?s.p(d,f):(s=l[r]=c[r](d),s.c()),Ps(s,1),s.m(i.parentNode,i)):s=null)},i(d){a||(Ps(s),a=!0)},o(d){Li(s),a=!1},d(d){d&&(Ve(t),Ve(e),Ve(i),Ve(o)),~r&&l[r].d(d)}}}function Zu(n){const t=atob(n);return Uint8Array.from(t,e=>e.codePointAt(0))}function WO(n,t,e){let r="home",s,i,o,a={goodSig:null,val:"",attr:"",pubKey:"",isEncrypted:!1,fileCid:null,ts:""},c,l="";async function h(m){const g=new FileReader;g.addEventListener("load",async()=>{s=g.result,await d(),e(0,r="verify")},!1),g.readAsText(m.detail.file)}async function d(){try{if(i=JSON.parse(s),JSON.stringify(i["@context"])!=JSON.stringify(["https://www.w3.org/2018/credentials/v1","urn:authattr:vc-schema:1"])){e(1,o="Not a VC, or using unknown schema");return}if(i.proof.type!="authattr_ed25519_v1"){e(1,o="unknown VC proof type");return}if(i.proof.pubKey!=i.issuer.substring(20)){e(1,o="proof public key and issuer don't match");return}switch(e(2,a.attr=i.credentialSubject.attribute,a),e(2,a.ts=i.issuanceDate,a),e(2,a.fileCid=Q.parse(i.credentialSubject.id.substring(8)),a),e(2,a.pubKey=i.proof.pubKey,a),i.credentialSubject.encoding){case"json":e(2,a.val=i.credentialSubject.value,a);break;case"base64_dag-cbor":e(2,a.val=Oh(Zu(i.credentialSubject.value)),a);break;case"base64_encrypted_dag-cbor":e(2,a.isEncrypted=!0,a);break;default:e(1,o="unknown value encoding type");return}const m={};m.CID=a.fileCid,m.value=a.val,m.attribute=a.attr,m.encrypted=a.isEncrypted,m.timestamp=a.ts;const g=await hm({value:m,codec:im,hasher:We});if(g.cid.toString()!=i.id.substring(8)){e(1,o="calculated attestation CID doesn't match VC id");return}e(2,a.goodSig=await _m(Zu(i.proof.sig),g.cid.bytes,Zu(a.pubKey)),a)}catch(m){console.log(m),e(1,o=m)}}async function f(m){e(3,c="progress");const g=new FileReader;g.addEventListener("load",async()=>{let y=new Uint8Array(g.result);const w=await xL();(await BO(w).addBytes(y,{chunker:Wd({chunkSize:262144})})).toString()===a.fileCid?e(4,l="File matches VC "):e(4,l="File doesn't match VC "),e(3,c="done"),w.gc(),w.stop()},!1),g.readAsArrayBuffer(m.detail.file)}return[r,o,a,c,l,h,f,()=>{e(0,r="home"),e(1,o=null),e(3,c=null)}]}class GO extends w4{constructor(t){super(),m4(this,t,WO,qO,d4,{})}}new GO({target:document.getElementById("app")});
